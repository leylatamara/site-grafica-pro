<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Pedido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .a4-sheet {
            background: white;
            width: 21cm;
            height: 29.7cm;
            display: block;
            margin: 2rem auto;
            padding: 2.5cm;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.1);
            box-sizing: border-box;
            color: #374151;
        }
        @media print {
            body, .a4-sheet {
                margin: 0;
                box-shadow: none;
                background: white;
            }
            .no-print {
                display: none;
            }
            .a4-sheet {
                padding: 1.5cm;
                width: 100%;
                height: auto;
            }
        }
        @media screen and (max-width: 8.5in) {
            .a4-sheet {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 1.5rem;
                box-shadow: none;
            }
            body {
                background-color: white;
            }
        }
        .info-icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="a4-sheet">
        <header class="flex justify-between items-start pb-8 border-b">
            <div>
                <h1 class="text-2xl font-bold text-gray-800" id="nomeEmpresa">Gráfica Exemplo</h1>
                <p class="text-sm" id="cnpjEmpresa">CNPJ: 00.000.000/0001-00</p>
                <p class="text-sm" id="enderecoEmpresa">Rua Exemplo, 123, Cidade</p>
                <p class="text-sm" id="telefoneEmpresa">Telefone: (00) 0000-0000</p>
                <p class="text-sm" id="emailEmpresa">Email: contato@suagrafica.com</p>
            </div>
            <div class="text-right">
                <h2 class="text-3xl font-bold text-gray-800">PEDIDO</h2>
                <p class="text-lg font-semibold text-gray-500" id="numeroPedido">#PED-000000</p>
            </div>
        </header>

        <main class="mt-8">
            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">CLIENTE</h3>
                    <p class="text-lg font-medium text-gray-800" id="nomeCliente">-</p>
                </div>
                <div class="text-right">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">VENDEDOR</h3>
                    <p class="text-lg font-medium text-gray-800" id="nomeVendedor">-</p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-8 mt-6 bg-gray-50 p-4 rounded-lg border">
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">DATA DO PEDIDO</h3>
                    <p class="font-medium text-gray-800" id="dataPedido">-</p>
                </div>
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">PREVISÃO DE ENTREGA</h3>
                    <p class="font-medium text-gray-800" id="previsaoEntrega">-</p>
                </div>
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">ESTADO</h3>
                    <p class="font-bold text-green-600" id="estadoPedido">-</p>
                    <p class="text-xs text-gray-500" id="confirmacaoEstado">-</p>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">ITENS</h3>
                <div class="flow-root">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th scope="col" class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="itensPedido">
                            <!-- Itens serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção de Preview da Imagem -->
            <div class="mt-10">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">PREVIEW DO PEDIDO</h3>
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div id="previewContainer" class="relative">
                        <img id="previewImagem" src="" alt="Preview do pedido" class="max-w-full h-auto rounded-lg hidden">
                        <div id="previewPlaceholder" class="text-center py-8 text-gray-500">
                            <i class="fas fa-image text-4xl mb-2"></i>
                            <p>Nenhuma imagem disponível</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-10 grid grid-cols-2 gap-16 items-start">
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">PAGAMENTOS</h3>
                    <div class="space-y-2 text-sm" id="pagamentosPedido">
                        <!-- Pagamentos serão inseridos aqui via JavaScript -->
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <div class="flex justify-between text-gray-600">
                        <span>Total Pedido</span>
                        <span id="totalPedido">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-gray-600 mt-2">
                        <span>Total Pago</span>
                        <span class="font-bold" id="totalPago">R$ 0,00</span>
                    </div>
                    <div class="mt-4 pt-4 border-t-2 border-dashed">
                        <div class="flex justify-between items-center text-lg font-bold text-green-600">
                            <span>Status</span>
                            <span id="statusPagamento">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-20 pt-8 border-t text-center text-sm text-gray-500">
            <button onclick="window.print()" class="no-print bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Imprimir Pedido
            </button>
            <p class="mt-6 text-xs" id="dataGeracao">Gerado em: -</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDOg6A8HFA_JCP_4iS7JcRCTRgdnzcP4Xk",
            authDomain: "sistema-grafica-pro.firebaseapp.com",
            projectId: "sistema-grafica-pro",
            storageBucket: "sistema-grafica-pro.firebasestorage.app",
            messagingSenderId: "1043193530848",
            appId: "1:1043193530848:web:b0effc9640a2e8ed6f8385"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const shopInstanceAppId = 'KepzIFlUZ432Os7';

        console.log('Firebase inicializado com configuração:', firebaseConfig);
        console.log('Shop Instance ID:', shopInstanceAppId);

        // Função para formatar data
        function formatarData(timestamp) {
            if (!timestamp) return '-';
            const data = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return data.toLocaleDateString('pt-BR');
        }

        // Função para formatar valores monetários
        function formatarValor(valor) {
            if (!valor) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Função para marcar item como impresso
        async function marcarItemComoImpresso(pedidoId, itemIndex) {
            try {
                console.log('Iniciando marcarItemComoImpresso:', { pedidoId, itemIndex });
                
                const userRole = localStorage.getItem('loggedInUserRole');
                const userName = localStorage.getItem('loggedInUserName');
                
                console.log('Dados do usuário:', { userRole, userName });

                if (!['impressor', 'admin'].includes(userRole)) {
                    alert('Você não tem permissão para marcar itens como impressos');
                    return;
                }

                const pedidoRef = doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId);
                console.log('Referência do pedido:', pedidoRef.path);
                
                const pedidoDoc = await getDoc(pedidoRef);
                console.log('Pedido existe:', pedidoDoc.exists());

                if (!pedidoDoc.exists()) {
                    console.log('Pedido não encontrado no caminho:', pedidoRef.path);
                    // Tentar caminho alternativo
                    const pedidoRefAlt = doc(db, `pedidos`, pedidoId);
                    console.log('Tentando caminho alternativo:', pedidoRefAlt.path);
                    const pedidoDocAlt = await getDoc(pedidoRefAlt);
                    
                    if (pedidoDocAlt.exists()) {
                        console.log('Pedido encontrado no caminho alternativo');
                        const pedido = pedidoDocAlt.data();
                        console.log('Dados do pedido:', pedido);
                        // Continuar com o processamento do pedido...
                    } else {
                        console.log('Pedido não encontrado em nenhum caminho');
                        alert('Pedido não encontrado');
                        return;
                    }
                } else {
                    const pedido = pedidoDoc.data();
                    console.log('Dados do pedido:', pedido);
                }
                
                if (!pedido.itens || !pedido.itens[itemIndex]) {
                    alert('Item não encontrado');
                    return;
                }

                // Criar objeto de atualização
                const updateData = {
                    [`itens.${itemIndex}.productionSteps`]: {
                        ...pedido.itens[itemIndex].productionSteps,
                        impressao: {
                            concluido: true,
                            responsavel: userName,
                            data: new Date().toISOString()
                        }
                    }
                };
                
                console.log('Dados para atualização:', updateData);

                // Atualizar no banco de dados
                await updateDoc(pedidoRef, updateData);
                console.log('Atualização concluída com sucesso');

                alert('Item marcado como impresso com sucesso!');
                
                // Recarregar os dados
                await carregarDadosPedido();
            } catch (error) {
                console.error('Erro ao marcar item como impresso:', error);
                alert('Erro ao marcar item como impresso: ' + error.message);
            }
        }

        // Função para marcar item como acabado
        async function marcarItemComoAcabado(pedidoId, itemIndex) {
            try {
                console.log('Iniciando marcarItemComoAcabado:', { pedidoId, itemIndex });
                
                const userRole = localStorage.getItem('loggedInUserRole');
                const userName = localStorage.getItem('loggedInUserName');
                
                console.log('Dados do usuário:', { userRole, userName });

                if (!['producao', 'admin'].includes(userRole)) {
                    alert('Você não tem permissão para marcar itens como acabados');
                    return;
                }

                const pedidoRef = doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId);
                console.log('Referência do pedido:', pedidoRef.path);
                
                const pedidoDoc = await getDoc(pedidoRef);
                console.log('Pedido existe:', pedidoDoc.exists());

                if (!pedidoDoc.exists()) {
                    alert('Pedido não encontrado');
                    return;
                }

                const pedido = pedidoDoc.data();
                console.log('Dados do pedido:', pedido);
                
                if (!pedido.itens || !pedido.itens[itemIndex]) {
                    alert('Item não encontrado');
                    return;
                }

                // Criar objeto de atualização
                const updateData = {
                    [`itens.${itemIndex}.productionSteps`]: {
                        ...pedido.itens[itemIndex].productionSteps,
                        acabamento: {
                            concluido: true,
                            responsavel: userName,
                            data: new Date().toISOString()
                        }
                    }
                };
                
                console.log('Dados para atualização:', updateData);

                // Atualizar no banco de dados
                await updateDoc(pedidoRef, updateData);
                console.log('Atualização concluída com sucesso');

                alert('Item marcado como acabado com sucesso!');
                
                // Recarregar os dados
                await carregarDadosPedido();
            } catch (error) {
                console.error('Erro ao marcar item como acabado:', error);
                alert('Erro ao marcar item como acabado: ' + error.message);
            }
        }

        // Função para carregar os dados do pedido
        async function carregarDadosPedido() {
            const urlParams = new URLSearchParams(window.location.search);
            const pedidoId = urlParams.get('id');
            
            console.log('URL completa:', window.location.href);
            console.log('Parâmetros da URL:', Object.fromEntries(urlParams.entries()));
            console.log('ID do pedido da URL:', pedidoId);
            
            if (!pedidoId) {
                console.error('ID do pedido não fornecido na URL');
                alert('ID do pedido não fornecido');
                return;
            }

            try {
                // Fazer login anônimo se necessário
                if (!auth.currentUser) {
                    console.log('Fazendo login anônimo...');
                    await signInAnonymously(auth);
                    console.log('Login anônimo realizado com sucesso');
                }

                // Obter o papel do usuário logado
                const userRole = localStorage.getItem('loggedInUserRole');
                const userName = localStorage.getItem('loggedInUserName');
                window.loggedInUserRole = userRole;
                window.loggedInUserName = userName;

                console.log('Usuário logado:', { role: userRole, name: userName });

                // Tentar diferentes caminhos para o pedido
                const caminhos = [
                    `artifacts/${shopInstanceAppId}/pedidos`,
                    'pedidos',
                    `artifacts/pedidos`,
                    `pedidos/${shopInstanceAppId}`
                ];

                let pedidoEncontrado = false;
                let pedido = null;

                for (const caminho of caminhos) {
                    console.log(`Tentando buscar pedido no caminho: ${caminho}`);
                    const pedidoRef = doc(db, caminho, pedidoId);
                    const pedidoDoc = await getDoc(pedidoRef);
                    
                    if (pedidoDoc.exists()) {
                        console.log(`Pedido encontrado no caminho: ${caminho}`);
                        pedido = pedidoDoc.data();
                        pedidoEncontrado = true;
                        break;
                    }
                }

                if (!pedidoEncontrado) {
                    console.error('Pedido não encontrado em nenhum caminho');
                    alert('Pedido não encontrado');
                    return;
                }

                console.log('Dados do pedido:', pedido);
                
                // Preencher dados básicos
                document.getElementById('numeroPedido').textContent = pedido.numeroPedido || `#PED-${pedidoId}`;
                document.getElementById('nomeCliente').textContent = pedido.clienteNome || '-';
                document.getElementById('nomeVendedor').textContent = pedido.vendedorNome || '-';
                document.getElementById('dataPedido').textContent = formatarData(pedido.dataPedido);
                document.getElementById('previsaoEntrega').textContent = formatarData(pedido.dataEntrega);
                document.getElementById('estadoPedido').textContent = pedido.status || '-';
                document.getElementById('confirmacaoEstado').textContent = pedido.confirmacaoEstado || '-';
                
                // Preencher itens
                const itensContainer = document.getElementById('itensPedido');
                itensContainer.innerHTML = '';
                
                if (pedido.itens && pedido.itens.length > 0) {
                    pedido.itens.forEach((item, index) => {
                        console.log('Item:', item, 'Index:', index);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-4 px-4 whitespace-nowrap">${item.quantidade}x</td>
                            <td class="py-4 px-4">
                                <p class="font-semibold text-gray-800">${item.produtoNome}</p>
                                <p class="text-gray-500 text-sm mt-1">${item.descricao || ''}</p>
                                <div class="flex items-center space-x-4 text-sm text-gray-600 mt-2">
                                    <div class="flex items-center space-x-2">
                                        <span>Impressão</span>
                                        ${item.productionSteps?.impressao?.concluido ? 
                                            `<span class="text-green-600">
                                                <i class="fas fa-check-circle"></i>
                                                ${item.productionSteps?.impressao?.responsavel ? 
                                                    `por ${item.productionSteps.impressao.responsavel}` : 
                                                    'Concluído'}
                                            </span>` :
                                            `<span class="text-gray-400">
                                                <i class="fas fa-clock"></i>
                                                Pendente
                                                ${['impressor', 'admin'].includes(window.loggedInUserRole) ? 
                                                    `<button onclick="marcarItemComoImpresso('${pedidoId}', ${index})" class="ml-2 text-blue-600 hover:text-blue-800">
                                                        <i class="fas fa-check"></i> Marcar como impresso
                                                    </button>` : 
                                                    ''}
                                            </span>`
                                        }
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span>Acabamento</span>
                                        ${item.productionSteps?.acabamento?.concluido ? 
                                            `<span class="text-green-600">
                                                <i class="fas fa-check-circle"></i>
                                                ${item.productionSteps?.acabamento?.responsavel ? 
                                                    `por ${item.productionSteps.acabamento.responsavel}` : 
                                                    'Concluído'}
                                            </span>` :
                                            `<span class="text-gray-400">
                                                <i class="fas fa-clock"></i>
                                                Pendente
                                                ${['producao', 'admin'].includes(window.loggedInUserRole) ? 
                                                    `<button onclick="marcarItemComoAcabado('${pedidoId}', ${index})" class="ml-2 text-blue-600 hover:text-blue-800">
                                                        <i class="fas fa-check"></i> Marcar como acabado
                                                    </button>` : 
                                                    ''}
                                            </span>`
                                        }
                                    </div>
                                    <span>Preview</span>
                                </div>
                            </td>
                            <td class="py-4 px-4 text-right font-medium">${formatarValor(item.valorItem)}</td>
                        `;
                        itensContainer.appendChild(tr);
                    });
                }

                // Preencher pagamentos
                const pagamentosContainer = document.getElementById('pagamentosPedido');
                pagamentosContainer.innerHTML = '';
                
                if (pedido.pagamentos && pedido.pagamentos.length > 0) {
                    pedido.pagamentos.forEach(pagamento => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between';
                        div.innerHTML = `
                            <span>${pagamento.forma} <span class="text-gray-400">(${formatarData(pagamento.dataPagamento)})</span></span>
                            <span class="font-medium">${formatarValor(pagamento.valorPago)}</span>
                        `;
                        pagamentosContainer.appendChild(div);
                    });
                }

                // Preencher totais
                document.getElementById('totalPedido').textContent = formatarValor(pedido.valorTotal);
                const totalPago = pedido.pagamentos?.reduce((acc, p) => acc + (p.valorPago || 0), 0) || 0;
                document.getElementById('totalPago').textContent = formatarValor(totalPago);
                document.getElementById('statusPagamento').textContent = totalPago >= pedido.valorTotal ? 'Pago' : 'Pendente';

                // Preencher preview da imagem
                const previewImagem = document.getElementById('previewImagem');
                const previewPlaceholder = document.getElementById('previewPlaceholder');
                
                if (pedido.imagemPreviewPedidoBase64) {
                    previewImagem.src = pedido.imagemPreviewPedidoBase64;
                    previewImagem.classList.remove('hidden');
                    previewPlaceholder.classList.add('hidden');
                } else {
                    previewImagem.classList.add('hidden');
                    previewPlaceholder.classList.remove('hidden');
                }

                // Data de geração
                document.getElementById('dataGeracao').textContent = `Gerado em: ${formatarData(new Date())}`;

            } catch (error) {
                console.error('Erro ao carregar dados do pedido:', error);
                alert('Erro ao carregar dados do pedido: ' + error.message);
            }
        }

        // Expor as funções globalmente
        window.marcarItemComoImpresso = marcarItemComoImpresso;
        window.marcarItemComoAcabado = marcarItemComoAcabado;
        window.carregarDadosPedido = carregarDadosPedido;

        // Carregar dados ao iniciar a página
        document.addEventListener('DOMContentLoaded', carregarDadosPedido);
    </script>
</body>
</html>