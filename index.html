<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gráfica Rápida - Design Interativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Variáveis do tema Interativo (escuro com gradientes) */
            --interactive-font-family: 'Inter', sans-serif;
            --interactive-bg-dark-primary: #1a1a2e; /* Fundo principal da aplicação */
            --interactive-bg-dark-secondary: #24283b; /* Fundo de containers de seção, barra de info usuário */
            --interactive-bg-dark-tertiary: #2a2f45; /* Fundo para tabelas/elementos destacados */
            --interactive-header-top-bg: #2c3e50; /* Fundo da barra do topo */
            
            --interactive-bg-gradient-main: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); /* Para cards principais, menu */
            --interactive-bg-gradient-alt: linear-gradient(135deg, #2575fc 0%, #5a89e0 100%); /* Para submenus, modais */
            --interactive-bg-gradient-header-text: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); /* Para títulos H1 */

            --interactive-text-light-primary: #ffffff;
            --interactive-text-light-secondary: #e0e7ff; /* Um pouco mais suave */
            --interactive-text-muted: #c0c5e0; /* Para texto menos importante, placeholders */
            
            --interactive-border-color-soft: rgba(255, 255, 255, 0.15);
            --interactive-border-color-medium: rgba(255, 255, 255, 0.25);
            --interactive-border-color-strong: rgba(255, 255, 255, 0.4);

            --interactive-input-bg: rgba(255, 255, 255, 0.08); /* Mantendo o fundo sutil */
            --interactive-input-border: #38bdf8; /* Cor da borda azul claro (sky-400) */
            --interactive-input-focus-border: #0ea5e9; /* Cor da borda em foco azul (sky-500) */
            --interactive-input-focus-shadow: 0 0 0 3px rgba(14, 165, 233, 0.4); /* Sombra azul claro */

            --interactive-button-primary-bg: rgba(255, 255, 255, 0.1);
            --interactive-button-primary-border: rgba(255, 255, 255, 0.3);
            --interactive-button-primary-hover-bg: rgba(255, 255, 255, 0.2);
            
            --interactive-button-secondary-bg: rgba(0,0,0,0.2);
            --interactive-button-secondary-border: rgba(255,255,255,0.15);
            --interactive-button-secondary-hover-bg: rgba(0,0,0,0.3);

            --interactive-button-action-text: #9fa8da; /* Para ícones de ação em tabelas */
            --interactive-button-action-hover-text: #ffffff;
            --interactive-button-action-hover-bg: rgba(255,255,255,0.1);

            --interactive-shadow-md: 0 8px 15px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.15);
            --interactive-shadow-lg: 0 15px 30px rgba(0,0,0,0.4), 0 10px 15px rgba(0,0,0,0.3);
            --interactive-shadow-xl: 0 20px 40px rgba(0,0,0,0.5), 0 12px 20px rgba(0,0,0,0.35);
        }

        body {
            font-family: 'Poppins', sans-serif; 
            background-color: var(--interactive-bg-dark-primary); 
            color: var(--interactive-text-light-secondary); 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease;
            display: flex; 
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            padding: 0; 
            box-sizing: border-box;
        }
        body.app-visible {
            font-family: var(--interactive-font-family);
            display: flex; /* Alterado para flex para o rodapé */
            flex-direction: column; /* Empilhar conteúdo e rodapé */
            /* Padding será definido dinamicamente por ajustarPaddingBody() */
        }
        
        .hidden { display: none !important; }

        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--interactive-bg-dark-primary); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; font-family: var(--interactive-font-family); 
            z-index: 10000; box-sizing: border-box;
        }
        #loginScreen .login-card { background: var(--interactive-bg-gradient-main); padding: 35px 40px; border-radius: 12px; box-shadow: var(--interactive-shadow-lg); color: var(--interactive-text-light-primary); width: 100%; max-width: 400px; text-align: center; transition: all 0.3s ease-in-out; }
        #loginScreen .login-card:hover { transform: translateY(-5px); box-shadow: var(--interactive-shadow-xl); }
        #loginScreen .login-card img { margin-bottom: 1.5rem; height: 3rem; margin-left: auto; margin-right: auto; }
        #loginScreen h2.login-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.75rem; }
        #loginScreen p.login-subtitle { color: var(--interactive-text-light-secondary); margin-bottom: 2rem; font-size: 0.95rem; }
        #loginScreen input#codigoAcesso { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-input-border); color: var(--interactive-text-light-primary); border-radius: 8px; padding: 14px 18px; width: 100%; margin-bottom: 1.5rem; font-size: 1rem; box-sizing: border-box; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #loginScreen input#codigoAcesso::placeholder { color: var(--interactive-text-muted); opacity: 1; }
        #loginScreen input#codigoAcesso:focus { background-color: rgba(255,255,255,0.12); border-color: var(--interactive-input-focus-border); outline: none; box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        #loginScreen button.login-button { background-color: var(--interactive-button-primary-bg); border: 1px solid var(--interactive-button-primary-border); color: var(--interactive-text-light-primary); padding: 14px 20px; border-radius: 8px; width: 100%; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        #loginScreen button.login-button:hover { background-color: var(--interactive-button-primary-hover-bg); border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }
        #loginScreen button.login-button:focus { outline: none; box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        #loginScreen p#loginErrorMessage { color: #ffcdd2; background-color: rgba(239,83,80,0.2); border: 1px solid rgba(239,83,80,0.4); padding: 0.75rem 1rem; border-radius: 6px; margin-top: 1.5rem; font-size: 0.875rem; }
        #loginScreen p#loginErrorMessage.hidden { display: none; }

        /* Header Superior (Logotipo e Sair) */
        .exo-menu-container {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; 
            box-shadow: var(--interactive-shadow-md);
        }
        .exo-menu-container .header-top-row { 
            background-color: var(--interactive-header-top-bg); 
            color: var(--interactive-text-light-primary); 
            padding: 0.75rem 1.5rem; 
            border-bottom: 1px solid #34495e; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 60px; 
            box-sizing: border-box;
        }
        .exo-menu-container .header-top-row .logo-area { flex-shrink: 0; }
        .exo-menu-container .header-top-row .site-title { 
            color: #ecf0f1; 
            font-weight: 600; 
            font-family: var(--interactive-font-family); 
            font-size: 1.25rem; 
            text-align: center;
            flex-grow: 1; 
        }
        .exo-menu-container .header-top-row .actions-area { 
            flex-shrink: 0; 
            width: auto; 
        }
        .exo-menu-container .header-top-row .actions-area #logoutButton { 
            background-color: var(--interactive-button-secondary-bg); 
            border: 1px solid var(--interactive-button-secondary-border); 
            color: var(--interactive-text-light-secondary); 
            font-family: var(--interactive-font-family);
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
            border-radius: 8px;
        }
        .exo-menu-container .header-top-row .actions-area #logoutButton:hover { 
            background-color: var(--interactive-button-secondary-hover-bg); 
            color: var(--interactive-text-light-primary);
        }
        /* Notification message */
#notificationMessage{
 background-position-x:0%;
}

/* Button */
#notificationActions .btn-cancel-action{
 background-color:#0c60dd !important;
}

/* Notification bar */
#notificationBar{
 background-color:#053a7f;
}

/* Pedido total pago */
#pedidoTotalPago{
 width:235px;
}

/* Pedido valor total */
#pedidoValorTotal{
 width:238px;
}

/* Pedido valor restante */
#pedidoValorRestante{
 width:240px;
}

/* Button */
#formNovoPedido .justify-end .btn-primary{
 border-top-left-radius:5px;
 padding-left:15px;
 padding-right:10px;
 padding-top:11px;
 padding-bottom:11px;
}

/* Button */
#formNovoPedido .justify-end .btn-secondary{
 padding-left:12px;
 padding-right:16px;
 padding-top:18px;
 padding-bottom:21px;
}

/* Button */
#formNovoPedido .btn-outline{
 margin-left:-3px;
 padding-left:14px;
 padding-right:10px;
 padding-top:10px;
 padding-bottom:12px;
}

/* Pedido image Unknown area */
#pedidoImageDropArea{
 padding-left:11px;
 padding-right:15px;
 padding-top:15px;
 padding-bottom:15px;
 border-top-left-radius:4px;
 border-top-right-radius:2px;
 border-bottom-left-radius:4px;
 border-bottom-right-radius:3px;
}

/* Relative */
#formNovoPedido .grid .relative{
 padding-left:0px;
 padding-top:21px;
}

/* Column 2/12 */
#cadastrarCliente .grid .lg\:col-span-2{
 padding-left:116px;
}

/* Pesquisa cliente input */
#pesquisaClienteInput{
 transform:translatex(0px) translatey(0px);
}

/* Division */
#formCadastrarCliente .grid div{
 transform:translatex(0px) translatey(0px);
 position:relative;
 left:-70px;
 padding-left:64px;
 top:4px;
}

/* Grid */
#formCadastrarCliente .grid{
 position:static;
}

/* Filtro classificacao pedido */
#filtroClassificacaoPedido{
 background-size:auto;
}

/* Filtro vendedor */
#filtroVendedor{
 transform:translatex(0px) translatey(0px);
}

/* User info bar */
#appContainer .user-info-bar{
 background-color:#09182e;
}

/* Button */
#notificationActions .btn-confirm-action{
 background-color:#b60b0b !important;
}

/* Justify between */
#appContainer .exo-menu-container .justify-between{
 background-color:#083390;
 background-size:auto;
 background-image:linear-gradient(to right, #c94b4b 0%, #4b134f 100%);
}
        /* NOVA BARRA DE INFORMAÇÕES DO USUÁRIO */
        .exo-menu-container .user-info-bar {
            background-color: var(--interactive-bg-dark-secondary);
            color: var(--interactive-text-light-secondary);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 1rem;
            font-family: var(--interactive-font-family);
            border-bottom: 1px solid var(--interactive-border-color-soft); 
        }
        .exo-menu-container .user-info-bar #loggedInUserNameDisplay {
            font-weight: 600;
            font-size: 1rem;
            color: var(--interactive-text-light-primary);
        }
        .exo-menu-container .user-info-bar .user-stats {
            display: flex;
            gap: 1.5rem; 
            font-size: 0.875rem;
        }
        .exo-menu-container .user-info-bar .user-stats span {
            color: var(--interactive-text-muted);
        }
        .exo-menu-container .user-info-bar .user-stats strong {
            color: var(--interactive-text-light-primary);
            font-weight: 500;
        }
        
        /* Barra de Menu Principal (com gradiente) */
        .exo-menu-container .menu-bar-wrapper { background: var(--interactive-bg-gradient-main); padding: 10px 20px; border-radius: 0 0 10px 10px; box-shadow: var(--interactive-shadow-md); margin: 0; display: block; font-family: var(--interactive-font-family); position: relative; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu { list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; gap: 8px; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li { position: relative; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a { color: var(--interactive-text-light-primary); text-decoration: none; padding: 10px 15px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: all 0.2s ease-in-out; position: relative; overflow: hidden; font-size: 0.9rem; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a .icon,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a .icon { transition: transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a .icon .fa,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a .icon .fa { font-size: 16px; line-height: 1; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a::before { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: #f0f0f0; opacity: 0.8; transition: width 0.25s ease-in-out; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a.active::before { width: 70%; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active { background-color: rgba(255,255,255,0.1); color: #f0f0f0; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover .icon,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active .icon { transform: scale(1.05); }
        .exo-menu-container .menu-bar-wrapper li.drop-down > a .arrow { margin-left: auto; padding-left: 8px; transition: transform 0.3s ease-in-out; font-size: 0.7em; display: inline-block; }
        .exo-menu-container .menu-bar-wrapper li.drop-down:hover > a .arrow,
        .exo-menu-container .menu-bar-wrapper li.drop-down.open > a .arrow { transform: rotate(180deg); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul { list-style: none; padding: 8px 0; margin: 0; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--interactive-bg-gradient-alt); border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.25); z-index: 100; min-width: 220px; opacity: 0; visibility: hidden; transform-origin: top center; transition: opacity 0.25s ease-in-out, visibility 0.25s ease-in-out, transform 0.25s ease-in-out; border-top: 1px solid var(--interactive-border-color-soft); }
        .exo-menu-container .menu-bar-wrapper li.drop-down:hover > ul.drop-down-ul { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0) scaleY(1); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a { padding: 10px 20px; display: block; white-space: nowrap; border-radius: 0; font-size: 0.85rem; }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a:hover,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a.active { background-color: rgba(255,255,255,0.15); transform: translateX(3px); color: var(--interactive-text-light-primary); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a.active::before { width: 60%; }
        .exo-menu-container .menu-bar-wrapper .toggle-menu { display: none; color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-border-color-medium); padding: 8px 10px; border-radius: 6px; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); cursor: pointer; }
        .exo-menu-container .menu-bar-wrapper .toggle-menu:hover { background-color: rgba(255,255,255,0.1); }
        @media (max-width: 768px) {
            .exo-menu-container .header-top-row { flex-direction: column; height: auto; gap: 0.5rem; padding: 0.75rem; }
            .exo-menu-container .header-top-row .site-title { order: -1; margin-bottom: 0.5rem; font-size: 1.1rem;}
            .exo-menu-container .header-top-row .logo-area { order: -2; margin-bottom: 0.5rem; }
            .exo-menu-container .header-top-row .actions-area { width: 100%; text-align: center; margin-top: 0.5rem; }
            .exo-menu-container .user-info-bar { flex-direction: column; align-items: flex-start; text-align: left; padding: 0.75rem; }
            .exo-menu-container .user-info-bar .user-stats { flex-direction: column; gap: 0.5rem; align-items: flex-start;}

            .exo-menu-container .menu-bar-wrapper { padding: 10px; margin: 5px 0; } 
            .exo-menu-container .menu-bar-wrapper .toggle-menu { display: block; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu { display: none; flex-direction: column; align-items: stretch; width: 100%; gap: 5px; padding-top: 10px; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu.display { display: flex; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu > li { width: 100%; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a { justify-content: flex-start; padding: 12px 15px; }
            .exo-menu-container .menu-bar-wrapper ul.drop-down-ul { position: static; width: 100%; box-shadow: none; border-radius: 6px; margin-top: 5px; background: rgba(0,0,0,0.15); opacity: 1; visibility: visible; transform: none; display: none; padding: 5px; }
            .exo-menu-container .menu-bar-wrapper li.drop-down.open > ul.drop-down-ul { display: block; }
            .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a { padding: 10px 15px; }
        }

        /* Container de Conteúdo Principal da Aplicação */
        .main-layout { width: 100%; flex-grow: 1; /* Para ocupar o espaço restante */ }
        .content-area {  padding: 20px; width: 100%; box-sizing: border-box;} /* Adicionado padding lateral ao content-area */
        
        .main-content-section.interactive-theme { background-color: var(--interactive-bg-dark-secondary); color: var(--interactive-text-light-secondary); padding: 20px; border-radius: 16px; box-shadow: var(--interactive-shadow-lg); margin-bottom: 2rem; }
        .main-content-section.interactive-theme:hover { box-shadow: var(--interactive-shadow-xl); }
        .main-content-section.interactive-theme h2,
        .main-content-section.interactive-theme h3,
        .main-content-section.interactive-theme h4 { color: var(--interactive-text-light-primary); border-bottom-color: var(--interactive-border-color-soft); }
        .main-content-section.interactive-theme .label-text { color: var(--interactive-text-muted); font-weight: 500; }
        .main-content-section.interactive-theme .input-field,
        .main-content-section.interactive-theme select.input-field { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-input-border); color: var(--interactive-text-light-primary); border-radius: 8px; box-shadow: none; padding: 10px 14px; }
        .main-content-section.interactive-theme select.input-field option {
            background-color: var(--interactive-bg-dark-tertiary);
            color: var(--interactive-text-light-primary);
        }
        .main-content-section.interactive-theme .input-field::placeholder { color: var(--interactive-text-muted); opacity: 0.8; }
        .main-content-section.interactive-theme .input-field:focus,
        .main-content-section.interactive-theme select.input-field:focus { background-color: rgba(255,255,255,0.1); border-color: var(--interactive-input-focus-border); box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        .main-content-section.interactive-theme .input-field[readonly] { background-color: rgba(255,255,255,0.04) !important; color: var(--interactive-text-muted) !important; cursor: not-allowed; }
        .main-content-section.interactive-theme .input-field[readonly].text-\[\!var\(--color-primary\)\] { color: var(--interactive-text-light-primary) !important; }
        .main-content-section.interactive-theme .input-field[readonly].text-green-600 { color: theme('colors.green.400') !important; }
        .main-content-section.interactive-theme .input-field[readonly].text-red-600 { color: theme('colors.red.400') !important; }
        
        .main-content-section.interactive-theme .btn { font-family: var(--interactive-font-family); border-radius: 8px; }
        .main-content-section.interactive-theme .btn:hover { transform: translateY(-2px); }
        .main-content-section.interactive-theme .btn-primary { background-color: var(--interactive-button-primary-bg); color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-button-primary-border); }
        .main-content-section.interactive-theme .btn-primary:hover { background-color: var(--interactive-button-primary-hover-bg); }
        .main-content-section.interactive-theme .btn-secondary { background-color: var(--interactive-button-secondary-bg); color: var(--interactive-text-muted); border: 1px solid var(--interactive-button-secondary-border); }
        .main-content-section.interactive-theme .btn-secondary:hover { background-color: var(--interactive-button-secondary-hover-bg); color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .btn-outline { background-color: transparent; border: 2px solid var(--interactive-button-primary-border); color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .btn-outline:hover { background-color: var(--interactive-button-primary-bg); }
        .main-content-section.interactive-theme .btn-link { color: theme('colors.purple.400'); background: none; border: none; padding: 0; text-decoration: underline; }
        .main-content-section.interactive-theme .btn-link:hover { color: theme('colors.purple.300'); }

        /* Estilos de Alerta de Pedidos */
        .pedido-numero.late { color: theme('colors.red.400'); font-weight: 700; }
        .pedido-numero.late::before { content: '⚠️ '; color: theme('colors.red.400'); }
        .pedido-numero.nearly-late { color: theme('colors.amber.400'); font-weight: 700; }
        .pedido-numero.nearly-late::before { content: '⏳ '; color: theme('colors.amber.400'); }


        /* Tela Inicial Dashboard (#telaInicial) */
        #telaInicial.interactive-theme-dashboard { background-color: transparent; padding: 0; box-shadow: none; }
        #telaInicial.interactive-theme-dashboard .dashboard-header h1 { font-size: 2.25rem; font-weight: 800; color: var(--interactive-text-light-primary); text-align: center; background: var(--interactive-bg-gradient-header-text); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 25px; }
        #telaInicial.interactive-theme-dashboard .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard { background: var(--interactive-bg-gradient-main); padding: 20px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); color: var(--interactive-text-light-primary); display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s ease-in-out; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 25px rgba(40, 10, 90, 0.5); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-header-color { display:none; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-content { display: block; padding: 0;}
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .icon-wrapper-dashboard { width: 32px; height: 32px; background-color: rgba(255,255,255,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard:hover .icon-wrapper-dashboard { transform: rotate(10deg) scale(1.1); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .icon-wrapper-dashboard i { font-size: 18px; color: var(--interactive-text-light-primary); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-label-dashboard { font-size: 0.9rem; font-weight: 500; color: var(--interactive-text-light-secondary); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-value-dashboard { font-size: 1.8rem; font-weight: 700; margin-top: auto; line-height: 1.2; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-value-dashboard.currency { font-size: 1.6rem; }

        #telaInicial.interactive-theme-dashboard .material-table-card { background-color: var(--interactive-bg-dark-tertiary); padding: 25px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); margin-top: 30px; }
        #telaInicial.interactive-theme-dashboard .material-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: none; padding: 0; }
        #telaInicial.interactive-theme-dashboard .material-table-header h2 { font-size: 1.5rem; font-weight: 700; color: var(--interactive-text-light-primary); }
        #telaInicial.interactive-theme-dashboard .material-table-header .btn-primary { background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(46,204,113,0.3); }
        #telaInicial.interactive-theme-dashboard .material-table-header .btn-primary:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 12px rgba(46,204,113,0.5); background: linear-gradient(45deg, #27ae60, #2ecc71); }
        #telaInicial.interactive-theme-dashboard .material-table-container { overflow-x: auto; }
        #telaInicial.interactive-theme-dashboard .material-data-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 700px; }
        #telaInicial.interactive-theme-dashboard .material-data-table th, #telaInicial.interactive-theme-dashboard .material-data-table td { padding: 12px 15px; text-align: left; vertical-align: middle; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th { background-color: rgba(76,84,119,0.5); color: var(--interactive-text-muted); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th:first-child { border-radius: 8px 0 0 8px; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th:last-child { border-radius: 0 8px 8px 0; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody tr { background-color: #343a50; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, background-color 0.2s ease; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody tr:hover { transform: scale(1.015); background-color: #3e445c; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #telaInicial.interactive-theme-dashboard .material-data-table td { font-size: 0.9rem; color: var(--interactive-text-light-secondary); }
        #telaInicial.interactive-theme-dashboard .material-data-table td.font-medium { color: var(--interactive-text-light-primary); } 
        #telaInicial.interactive-theme-dashboard .material-data-table tbody td:first-child { border-radius: 8px 0 0 8px; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody td:last-child { border-radius: 0 8px 8px 0; }
        #telaInicial.interactive-theme-dashboard .status-badge-simple { padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; display: inline-block; color: #fff; }
        #telaInicial.interactive-theme-dashboard .status-badge-simple.warning { background-color: #f39c12; } 
        #telaInicial.interactive-theme-dashboard .status-badge-simple.info { background-color: #3498db; }   
        #telaInicial.interactive-theme-dashboard .status-badge-simple.danger { background-color: #e74c3c; }  
        #telaInicial.interactive-theme-dashboard .status-badge-simple.success { background-color: #2ecc71; } 
        #telaInicial.interactive-theme-dashboard .btn-icon-action { color: var(--interactive-button-action-text); margin-right: 8px; transition: color 0.2s ease; }
        #telaInicial.interactive-theme-dashboard .btn-icon-action:hover { color: var(--interactive-button-action-hover-text); }
        #telaInicial.interactive-theme-dashboard .btn-icon-action i { font-size: 18px; }

        /* Tabela Visualizar Pedidos */
        #visualizarPedidos.interactive-theme { background-color: var(--interactive-bg-dark-secondary); }
        #visualizarPedidos.interactive-theme .pedidos-table-container { background-color: var(--interactive-bg-dark-tertiary); padding: 25px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); }
        #visualizarPedidos.interactive-theme .pedidos-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 700px; }
        #visualizarPedidos.interactive-theme .pedidos-table th { background-color: rgba(76,84,119,0.5); color: var(--interactive-text-muted); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 15px; text-align: left; }
        #visualizarPedidos.interactive-theme .pedidos-table th:first-child { border-radius: 8px 0 0 8px; }
        #visualizarPedidos.interactive-theme .pedidos-table th:last-child { border-radius: 0 8px 8px 0; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody tr { background-color: #343a50; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, background-color 0.2s ease; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody tr:hover { transform: scale(1.015); background-color: #3e445c; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #visualizarPedidos.interactive-theme .pedidos-table td { padding: 12px 15px; text-align: left; vertical-align: middle; font-size: 0.9rem; color: var(--interactive-text-light-secondary); }
        #visualizarPedidos.interactive-theme .pedidos-table tbody td:first-child { border-radius: 8px 0 0 8px; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody td:last-child { border-radius: 0 8px 8px 0; }
        #visualizarPedidos.interactive-theme .pedidos-table .pedido-numero,
        #visualizarPedidos.interactive-theme .pedidos-table .cliente-nome,
        #visualizarPedidos.interactive-theme .pedidos-table .font-medium { 
            color: var(--interactive-text-light-primary); font-weight: 500;
        }
        #visualizarPedidos.interactive-theme .btn-icon-action { color: var(--interactive-button-action-text); }
        #visualizarPedidos.interactive-theme .btn-icon-action:hover { color: var(--interactive-button-action-hover-text); background-color: var(--interactive-button-action-hover-bg); }
        #visualizarPedidos.interactive-theme .status-badge-simple { padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; display: inline-block; color: #fff; }
        #visualizarPedidos.interactive-theme .status-badge-simple.warning { background-color: #f39c12; }
        #visualizarPedidos.interactive-theme .status-badge-simple.info { background-color: #3498db; }
        #visualizarPedidos.interactive-theme .status-badge-simple.danger { background-color: #e74c3c; }
        #visualizarPedidos.interactive-theme .status-badge-simple.success { background-color: #2ecc71; }
        #visualizarPedidos.interactive-theme .status-badge-simple.primary { background-color: theme('colors.indigo.500'); }
        #visualizarPedidos.interactive-theme .status-badge-simple.neutral { background-color: theme('colors.slate.500'); }

        #visualizarPedidos.interactive-theme .mb-6.p-4 { 
            background-color: rgba(255,255,255,0.03); 
            border-color: var(--interactive-border-color-soft);
        }

        .main-content-section.interactive-theme .image-drop-area { border-color: var(--interactive-border-color-medium); background-color: var(--interactive-input-bg); }
        .main-content-section.interactive-theme .image-drop-area:hover { border-color: var(--interactive-border-color-strong); background-color: rgba(255,255,255,0.1); }
        .main-content-section.interactive-theme .image-drop-area .text-\[\!var\(--color-text-muted\)\] { color: var(--interactive-text-muted) !important; }
        .main-content-section.interactive-theme .image-drop-area .text-slate-400 { color: var(--interactive-text-muted) !important; opacity: 0.7; }

        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-overlay .modal-content-wrapper {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content-wrapper {
            transform: scale(1);
        }
        .modal-overlay.interactive-theme-modal .modal-content-wrapper { 
            background: var(--interactive-bg-gradient-alt); color: var(--interactive-text-light-primary); 
            border-radius: 12px; 
            box-shadow: var(--interactive-shadow-xl); 
        }
        .modal-overlay.interactive-theme-modal .modal-content-wrapper .h-2 { background-color: rgba(255,255,255,0.2); }
        .modal-overlay.interactive-theme-modal .universal-modal-close-x { color: var(--interactive-text-muted); }
        .modal-overlay.interactive-theme-modal .universal-modal-close-x:hover { color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal h3,
        .modal-overlay.interactive-theme-modal .universal-modal-title { color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal p, 
        .modal-overlay.interactive-theme-modal .universal-modal-body,
        .modal-overlay.interactive-theme-modal .text-slate-600 { color: var(--interactive-text-light-secondary); }
        .modal-overlay.interactive-theme-modal .label-text { color: var(--interactive-text-muted); }
        .modal-overlay.interactive-theme-modal .input-field { background-color: var(--interactive-input-bg); border-color: var(--interactive-input-border); color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal .input-field:focus { box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        .modal-overlay.interactive-theme-modal .universal-modal-footer { background-color: rgba(0,0,0,0.25); border-top-color: var(--interactive-border-color-soft); }
        .modal-overlay.interactive-theme-modal .btn-primary { background-color: var(--interactive-button-primary-bg); color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-button-primary-border); }
        .modal-overlay.interactive-theme-modal .btn-primary:hover { background-color: var(--interactive-button-primary-hover-bg); }
        .modal-overlay.interactive-theme-modal .btn-secondary { background-color: var(--interactive-button-secondary-bg); color: var(--interactive-text-muted); border: 1px solid var(--interactive-button-secondary-border); }
        .modal-overlay.interactive-theme-modal .btn-secondary:hover { background-color: var(--interactive-button-secondary-hover-bg); color: var(--interactive-text-light-primary); }
        
        /* Notification Bar Styles */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            color: var(--interactive-text-light-primary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10001; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transform: translateY(-150%); 
            opacity: 0;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            font-family: var(--interactive-font-family);
            box-sizing: border-box;
        }
        .notification-bar.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-bar .notification-content { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .notification-bar #notificationIcon i { font-size: 1.5rem; }
        .notification-bar #notificationMessage { font-size: 0.95rem; flex-grow: 1; }
        .notification-bar #notificationActions { display: flex; gap: 10px; }
        .notification-bar #notificationActions .btn { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; color: var(--interactive-text-light-primary); border: 1px solid transparent; cursor: pointer; }
        .notification-bar #notificationActions .btn-confirm-action { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); }
        .notification-bar #notificationActions .btn-confirm-action:hover { background-color: rgba(255,255,255,0.3); }
        .notification-bar #notificationActions .btn-cancel-action { background-color: rgba(0,0,0,0.25); border-color: rgba(255,255,255,0.15); }
        .notification-bar #notificationActions .btn-cancel-action:hover { background-color: rgba(0,0,0,0.35); }

        .notification-bar.success { background: linear-gradient(135deg, theme('colors.green.600') 0%, theme('colors.green.400') 100%); }
        .notification-bar.success #notificationIcon i { color: theme('colors.green.100'); }
        .notification-bar.error { background: linear-gradient(135deg, theme('colors.red.700') 0%, theme('colors.red.500') 100%); }
        .notification-bar.error #notificationIcon i { color: theme('colors.red.100'); }
        .notification-bar.warning { background: linear-gradient(135deg, theme('colors.amber.600') 0%, theme('colors.amber.400') 100%); }
        .notification-bar.warning #notificationIcon i { color: theme('colors.amber.100'); }
        .notification-bar.info { background: linear-gradient(135deg, theme('colors.sky.700') 0%, theme('colors.sky.500') 100%); }
        .notification-bar.info #notificationIcon i { color: theme('colors.sky.100'); }
        .notification-bar.confirm-delete { background: linear-gradient(135deg, theme('colors.red.700') 0%, theme('colors.red.500') 100%); }
        .notification-bar.confirm-delete #notificationIcon i { color: theme('colors.red.100'); }
        .notification-bar.confirm-delete #notificationActions .btn-confirm-action { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); } 
        .notification-bar.confirm-delete #notificationActions .btn-confirm-action:hover { background-color: rgba(255,255,255,0.3); }
        
        .main-content-section.interactive-theme #pedidoClienteResultados { background-color: #3a3163; border-color: var(--interactive-border-color-medium); }
        .main-content-section.interactive-theme #pedidoClienteResultados div { color: var(--interactive-text-muted); }
        .main-content-section.interactive-theme #pedidoClienteResultados div:hover { background-color: #4a3c80; color: var(--interactive-text-light-primary); }
        
        .main-content-section.interactive-theme .item-list-display { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-border-color-soft); color: var(--interactive-text-muted); padding: 0.65rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; }
        .main-content-section.interactive-theme .item-list-display strong { color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .item-list-display .meta { font-size: 0.8rem; opacity: 0.8; }
        .main-content-section.interactive-theme .item-list-display.selected { background-color: rgba(106,27,154,0.5); border-color: rgba(171,71,188,0.7); }
        .main-content-section.interactive-theme #infoCliente { background-color: rgba(0,0,0,0.15); border-color: var(--interactive-border-color-soft); color: var(--interactive-text-muted); }
        .main-content-section.interactive-theme #pedidosDoClienteLista { background-color: rgba(0,0,0,0.1); border-color: var(--interactive-border-color-soft); }
        .main-content-section.interactive-theme #pedidosDoClienteLista .p-2\.5 { border-bottom-color: var(--interactive-border-color-soft) !important; }
        .main-content-section.interactive-theme #pedidosDoClienteLista .font-medium { color: theme('colors.purple.300') !important; }
        #appContainer .main-layout { /* O padding-top é controlado pelo JS (ajustarPaddingBody) */ }

        /* NOVO RODAPÉ */
        .site-footer {
            background-color: var(--interactive-header-top-bg); /* Mesmo fundo da barra do topo */
            color: var(--interactive-text-muted);
            padding: 1.5rem 1rem;
            text-align: center;
            font-family: var(--interactive-font-family);
            font-size: 0.875rem;
            border-top: 1px solid #34495e;
            margin-top: auto; /* Empurra o rodapé para baixo se o conteúdo for curto */
        }
        .site-footer p {
            margin: 0.25rem 0;
        }
        .site-footer strong {
            color: var(--interactive-text-light-secondary);
        }

    </style>
</head>
<body>
    <!-- Barra de Notificações (NOVA) -->
    <div id="notificationBar" class="notification-bar">
        <div class="notification-content">
            <span id="notificationIcon" class="text-xl"></span>
            <span id="notificationMessage"></span>
        </div>
        <div id="notificationActions">
            <!-- Botões serão injetados aqui -->
        </div>
    </div>

    <!-- Container da Tela de Login -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="https://placehold.co/150x60/0ea5e9/FFFFFF?text=SuaGraficaPRO&font=poppins" alt="Logo Gráfica PRO">
            <h2 class="login-title">Acesso ao Sistema</h2>
            <p class="login-subtitle">Insira o seu código de funcionário para continuar.</p>
            <form id="loginForm">
                <input type="password" id="codigoAcesso" placeholder="Código de Acesso" required>
                <button type="submit" class="login-button">Entrar</button>
            </form>
            <p id="loginErrorMessage" class="hidden"></p>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="appContainer" class="hidden">
        <div class="exo-menu-container"> <!-- Este é o container geral do cabeçalho agora -->
            <div class="header-top-row flex justify-between items-center">
                <div class="logo-area flex-shrink-0">
                    <img src="https://placehold.co/120x32/ffffff/1e293b?text=SuaLogo&font=poppins" alt="Logo Gráfica" class="h-6 sm:h-8">
                </div>
                <h1 class="site-title text-lg sm:text-xl">Sistema de Gestão PRO</h1>
                <div class="actions-area flex-shrink-0"> 
                    <button id="logoutButton" class="text-xs py-1.5 px-3 rounded"><i class="fas fa-sign-out-alt mr-1.5"></i>Sair</button>
                </div>
            </div>

            <div class="user-info-bar">
                <span id="loggedInUserNameDisplay" class="font-semibold"></span>
                <div class="user-stats">
                    <span>Pedidos Mês: <strong id="userPedidosMes">0</strong></span>
                    <span>Em Finalização: <strong id="userPedidosFinalizacao">0</strong></span>
                    <span>Finalizados: <strong id="userPedidosFinalizados">0</strong></span>
                </div>
            </div>
        
            <div class="menu-bar-wrapper"> 
                <ul class="exo-menu clearfix">
                    <li data-role-access="all">
                        <a href="#" onclick="mostrarSecao('telaInicial', true)" data-section="telaInicial">
                            <span class="icon"><i class="fa fa-home"></i></span>Home
                        </a>
                    </li>
                    <li data-role-access="admin,vendedor">
                        <a href="#" onclick="mostrarSecao('novoPedido', true)" data-section="novoPedido">
                            <span class="icon"><i class="fa fa-plus"></i></span>Novo Pedido
                        </a>
                    </li>
                    <li class="drop-down" data-role-access="admin,vendedor,designer" id="dropdownCadastrosMenu">
                        <a href="#">
                            <span class="icon"><i class="fa fa-archive"></i></span>
                            Cadastros
                            <span class="arrow">&#9662;</span>
                        </a>
                        <ul class="drop-down-ul">
                            <li data-role-access="admin,vendedor">
                                <a href="#" onclick="mostrarSecao('cadastrarCliente', true)" data-section="cadastrarCliente">
                                     <span class="icon"><i class="fa fa-users"></i></span>Clientes
                                </a>
                            </li>
                            <li data-role-access="admin,designer">
                                <a href="#" onclick="mostrarSecao('cadastrarProduto', true)" data-section="cadastrarProduto">
                                    <span class="icon"><i class="fa fa-box"></i></span>Produtos
                                </a>
                            </li>
                            <li data-role-access="admin">
                                <a href="#" onclick="mostrarSecao('cadastrarFuncionario', true)" data-section="cadastrarFuncionario">
                                    <span class="icon"><i class="fa fa-user-tie"></i></span>Funcionários
                                </a>
                            </li>
                            <li data-role-access="admin">
                                <a href="#" onclick="mostrarSecao('cadastrarFornecedor', true)" data-section="cadastrarFornecedor">
                                    <span class="icon"><i class="fa fa-truck"></i></span>Fornecedores
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li data-role-access="all">
                        <a href="#" onclick="mostrarSecao('visualizarPedidos', true)" data-section="visualizarPedidos">
                            <span class="icon"><i class="fa fa-list-alt"></i></span>Pedidos
                        </a>
                    </li>
                </ul>
                <a href="#" class="toggle-menu"><i class="fas fa-bars"></i></a>
            </div>
        </div>

        <div class="main-layout"> <main id="mainContentArea" class="content-area w-full"> 
                <section id="telaInicial" class="main-content-section max-w-7xl mx-auto"> 
                    <h1 class="dashboard-header">Painel de Controlo</h1> 
                    <div class="summary-cards">
                        <div class="metric-card-dashboard card">
                            <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-calendar-day"></i></span>
                                <h3 class="metric-label-dashboard card-title">Pedidos Hoje</h3>
                            </div>
                            <p id="metricPedidosHoje" class="metric-value-dashboard card-value">0</p>
                        </div>
                        <div class="metric-card-dashboard card">
                             <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-hourglass-half"></i></span>
                                <h3 class="metric-label-dashboard card-title">Pendentes</h3>
                            </div>
                            <p id="metricPedidosPendentes" class="metric-value-dashboard card-value">0</p>
                        </div>
                        <div class="metric-card-dashboard card">
                            <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-dollar-sign"></i></span>
                                <h3 class="metric-label-dashboard card-title">Faturamento Mês</h3>
                            </div>
                            <p id="metricFaturamentoMes" class="metric-value-dashboard card-value currency">R$0,00</p>
                        </div>
                        <div class="metric-card-dashboard card">
                           <div class="card-header">
                               <span class="icon-wrapper-dashboard icon"><i class="fas fa-users"></i></span>
                                <h3 class="metric-label-dashboard card-title">Total Clientes</h3>
                            </div>
                            <p id="metricTotalClientes" class="metric-value-dashboard card-value">0</p>
                        </div>
                    </div>

                    <div class="material-table-card recent-orders">
                        <div class="material-table-header recent-orders-header">
                            <h2>Últimos Pedidos</h2>
                            <button onclick="mostrarSecao('visualizarPedidos', true)" class="btn btn-primary btn-view-all text-xs py-2 px-3"><i class="fas fa-list-ul mr-2"></i>Ver Todos</button>
                        </div>
                        <div class="material-table-container orders-table-wrapper">
                            <table class="material-data-table orders-table">
                                <thead>
                                    <tr>
                                        <th>Nº Pedido</th>
                                        <th>Cliente</th>
                                        <th>Data</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ultimosPedidosTableBody">
                                    <tr><td colspan="6" class="text-center py-10">Nenhum pedido recente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="novoPedido" class="main-content-section interactive-theme hidden max-w-3xl mx-auto">
                    <h2 class="text-xl font-semibold mb-6 pb-4 border-b">Novo Pedido</h2>
                    <form id="formNovoPedido" class="space-y-6">
                        <input type="hidden" id="editingOrderIdField"> 
                        <div>
                            <label for="pedidoDataHora" class="label-text">Data e Hora do Pedido:</label>
                            <input type="text" id="pedidoDataHora" class="input-field" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="relative">
                                <label for="pedidoClienteSearch" class="label-text">Cliente:</label>
                                <input type="text" id="pedidoClienteSearch" class="input-field" placeholder="Pesquisar cliente...">
                                <input type="hidden" id="pedidoClienteId">
                                <div id="pedidoClienteResultados" class="absolute z-20 w-full border rounded-md mt-1 shadow-lg max-h-48 overflow-y-auto hidden">
                                </div>
                                <button type="button" onclick="abrirModalNovoClienteRapido()" class="mt-2 btn btn-link text-xs">Registar novo cliente</button>
                            </div>
                            <div>
                                <label for="pedidoVendedor" class="label-text">Funcionário (Vendedor):</label>
                                <select id="pedidoVendedor" class="input-field">
                                    <option value="">Selecione um funcionário</option>
                                </select>
                            </div>
                        </div>

                        <div class="pt-5 border-t">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Itens do Pedido</h3>
                            </div>
                            <div id="itensPedidoContainer" class="space-y-4"></div>
                            <button type="button" onclick="adicionarItemPedidoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-plus mr-1.5"></i>Adicionar Produto</button>
                        </div>
                        
                        <div class="pt-5 border-t space-y-4">
                            <div>
                                <label for="pedidoDescricaoGeral" class="label-text">Descrição Geral do Pedido:</label>
                                <textarea id="pedidoDescricaoGeral" rows="2" class="input-field text-lg font-semibold" placeholder="Ex: Kit Adesivos para Vitrine..."></textarea>
                            </div>

                            <div>
                                <label class="label-text">Preview do Pedido (Opcional):</label>
                                <div id="pedidoImageDropArea" class="image-drop-area" onclick="document.getElementById('pedidoImagemFile').click();">
                                    <input type="file" accept="image/*" class="hidden" id="pedidoImagemFile" onchange="handleImagemFilePedido(event)">
                                    <img src="#" alt="Preview do Pedido" id="pedidoImagemPreview" class="hidden preview-image">
                                    <span id="pedidoImagemPreviewPlaceholder" class="text-sm">
                                        <i class="fas fa-image fa-2x mb-1.5"></i><br>
                                        Cole ou clique para carregar imagem
                                    </span>
                                </div>
                            </div>
                        </div>


                        <div class="pt-5 border-t">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Detalhes do Pagamento</h3>
                            </div>
                            <div id="pagamentosContainer" class="space-y-4">
                            </div>
                            <button type="button" onclick="adicionarPagamentoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-dollar-sign mr-1.5"></i>Adicionar Pagamento</button>
                            
                            <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label class="label-text">Valor Total do Pedido:</label>
                                    <input type="text" id="pedidoValorTotal" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                                <div>
                                    <label class="label-text">Total Pago:</label>
                                    <input type="text" id="pedidoTotalPago" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                                 <div>
                                    <label class="label-text">Valor Restante:</label>
                                    <input type="text" id="pedidoValorRestante" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-5 border-t">
                            <div class="grid grid-cols-2 gap-4">
                                 <div>
                                    <label for="pedidoDataEntrega" class="label-text">Data Entrega:</label>
                                    <input type="date" id="pedidoDataEntrega" class="input-field">
                                </div>
                                <div>
                                    <label for="pedidoHoraEntrega" class="label-text">Hora Entrega:</label>
                                    <input type="time" id="pedidoHoraEntrega" class="input-field">
                                </div>
                            </div>
                             <div>
                                <label for="pedidoStatus" class="label-text">Estado do Pedido:</label>
                                <select id="pedidoStatus" class="input-field">
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                       
                        <div class="flex justify-end space-x-3 pt-6 border-t">
                            <button type="button" onclick="mostrarSecao('telaInicial', true); document.getElementById('editingOrderIdField').value = ''; document.querySelector('#formNovoPedido button[type=\'submit\']').innerHTML = '<i class=\'fas fa-check mr-1.5\'></i>Guardar Pedido';" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-check mr-1.5"></i>Guardar Pedido</button>
                        </div>
                    </form>
                </section>

                <section id="cadastrarCliente" class="main-content-section interactive-theme hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-5">Registar Cliente</h2>
                            <form id="formCadastrarCliente" class="space-y-4">
                                <div>
                                    <label for="clienteNome" class="label-text">Nome Completo / Razão Social:</label>
                                    <input type="text" id="clienteNome" class="input-field" required>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteTipo" class="label-text">Tipo de Cliente:</label>
                                        <select id="clienteTipo" class="input-field">
                                            <option value="final">Cliente Final</option>
                                            <option value="revenda">Revenda</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="clienteTelefone" class="label-text">Telefone:</label>
                                        <input type="tel" id="clienteTelefone" class="input-field">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteEmail" class="label-text">Email:</label>
                                        <input type="email" id="clienteEmail" class="input-field">
                                    </div>
                                    <div>
                                        <label for="clienteCpfCnpj" class="label-text">CPF/CNPJ (Opcional):</label>
                                        <input type="text" id="clienteCpfCnpj" class="input-field">
                                    </div>
                                </div>
                                <div>
                                    <label for="clienteEndereco" class="label-text">Endereço (Opcional):</label>
                                    <input type="text" id="clienteEndereco" class="input-field">
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Cliente</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-lg font-semibold mb-1">Clientes Registados</h3>
                            <div class="search-input-wrapper relative">
                                <i class="fas fa-search absolute top-1/2 left-3.5 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="pesquisaClienteInput" class="input-field w-full pl-10" placeholder="Pesquisar cliente por nome, telefone...">
                            </div>
                            <div id="listaClientes" class="space-y-2.5 max-h-60 sm:max-h-72 lg:max-h-[calc(100vh-340px)] overflow-y-auto pr-1 mt-3">
                                <p class="text-sm text-center py-3">Nenhum cliente registado.</p>
                            </div>
                            
                            <div id="detalhesClienteSelecionado" class="mt-6 hidden">
                                <h4 class="text-md font-semibold mb-2 border-t pt-4">Detalhes do Cliente</h4>
                                <div id="infoCliente" class="p-3 border rounded-md mb-4 text-sm space-y-1">
                                </div>
                                <h4 class="text-md font-semibold mb-2">Pedidos do Cliente</h4>
                                <div id="pedidosDoClienteLista" class="space-y-2.5 max-h-40 sm:max-h-48 overflow-y-auto pr-1 border rounded-md p-2">
                                    <p class="text-xs text-center py-2">Selecione um cliente para ver os seus pedidos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="cadastrarProduto" class="main-content-section interactive-theme hidden max-w-xl mx-auto">
                     <h2 class="text-xl font-semibold mb-5 pb-3 border-b">Registar Produto</h2>
                    <form id="formCadastrarProduto" class="space-y-4">
                        <div>
                            <label for="produtoNome" class="label-text">Nome do Produto:</label>
                            <input type="text" id="produtoNome" class="input-field" required> </div>
                        <div>
                            <label for="produtoTipoPreco" class="label-text">Tipo de Precificação:</label>
                            <select id="produtoTipoPreco" class="input-field" onchange="togglePrecoFields()">
                                <option value="unidade">Por Unidade/Pacote</option>
                                <option value="metro">Por Metro Quadrado (m²)</option>
                            </select>
                        </div>
                        <div id="precoUnidadeFields">
                            <label for="produtoPrecoUnidade" class="label-text">Preço Unitário (R$):</label>
                            <input type="number" step="0.01" id="produtoPrecoUnidade" class="input-field">
                        </div>
                        <div id="precoMetroFields" class="hidden">
                            <label for="produtoPrecoMetro" class="label-text">Preço por Metro Quadrado (R$/m²):</label>
                            <input type="number" step="0.01" id="produtoPrecoMetro" class="input-field">
                        </div>
                        <div>
                            <label for="produtoDescricao" class="label-text">Descrição (Opcional):</label>
                            <textarea id="produtoDescricao" rows="3" class="input-field"></textarea>
                            </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-box mr-1.5"></i>Guardar Produto</button>
                        </div>
                    </form>
                     <div class="mt-8">
                        <h3 class="text-md font-semibold mb-3 border-b pb-2">Produtos Registados</h3>
                        <div id="listaProdutos" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                             <p class="text-sm text-center py-3">Nenhum produto registado.</p>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFuncionario" class="main-content-section interactive-theme hidden max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold mb-5 pb-3 border-b">Registar Funcionário</h2>
                    <form id="formCadastrarFuncionario" class="space-y-4">
                        <div>
                            <label for="funcionarioNome" class="label-text">Nome do Funcionário:</label>
                            <input type="text" id="funcionarioNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="funcionarioContato" class="label-text">Contacto (Telefone/Email - Opcional):</label>
                            <input type="text" id="funcionarioContato" class="input-field">
                        </div>
                        <div>
                            <label for="funcionarioCargo" class="label-text">Cargo:</label>
                            <select id="funcionarioCargo" class="input-field">
                                <option value="Administrador">Administrador</option>
                                <option value="Vendedor" selected>Vendedor</option>
                                <option value="Produção">Produção</option>
                                <option value="Impressor">Impressor</option>
                                <option value="Designer">Designer</option>
                                <option value="Freelancer">Freelancer</option>
                            </select>
                        </div>
                         <div>
                            <label for="funcionarioCodigoAcesso" class="label-text">Código de Acesso:</label>
                            <input type="text" id="funcionarioCodigoAcesso" class="input-field" placeholder="Ex: 123456" required>
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Funcionário</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold mb-3 border-b pb-2">Funcionários Registados</h3>
                        <div id="listaFuncionarios" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-sm text-center py-3">Nenhum funcionário registado.</p>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFornecedor" class="main-content-section interactive-theme hidden max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold mb-5 pb-3 border-b">Registar Fornecedor</h2>
                    <form id="formCadastrarFornecedor" class="space-y-4">
                        <div>
                            <label for="fornecedorNome" class="label-text">Nome do Fornecedor:</label>
                            <input type="text" id="fornecedorNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="fornecedorContato" class="label-text">Contacto (Telefone/Email):</label>
                            <input type="text" id="fornecedorContato" class="input-field">
                        </div>
                        <div>
                            <label for="fornecedorMaterial" class="label-text">Tipo de Material Fornecido:</label>
                            <input type="text" id="fornecedorMaterial" class="input-field">
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-1.5"></i>Guardar Fornecedor</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold mb-3 border-b pb-2">Fornecedores Registados</h3>
                        <div id="listaFornecedores" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-sm text-center py-3">Nenhum fornecedor registado.</p>
                        </div>
                    </div>
                </section>

                <section id="visualizarPedidos" class="main-content-section interactive-theme hidden">
                     <h2 class="text-xl font-semibold mb-5 pb-3 border-b">Todos os Pedidos</h2>
                    <div class="mb-6 p-4 border rounded-lg bg-[rgba(255,255,255,0.05)]"> {/* Fundo sutil para filtros */}
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3 items-end">
                            <div>
                                <label for="filtroNomeCliente" class="label-text text-xs">Nome do Cliente:</label>
                                <input type="text" id="filtroNomeCliente" class="input-field input-field-sm py-1.5" placeholder="Pesquisar nome...">
                            </div>
                            <div>
                                <label for="filtroNumeroPedido" class="label-text text-xs">Nº do Pedido:</label>
                                <input type="text" id="filtroNumeroPedido" class="input-field input-field-sm py-1.5" placeholder="Pesquisar número...">
                            </div>
                            <div>
                                <label for="filtroDataPedido" class="label-text text-xs">Data do Pedido:</label>
                                <input type="date" id="filtroDataPedido" class="input-field input-field-sm py-1.5">
                            </div>
                            <div>
                                <label for="filtroMaterialProduto" class="label-text text-xs">Produto/Material (nos Itens):</label>
                                <input type="text" id="filtroMaterialProduto" class="input-field input-field-sm py-1.5" placeholder="Pesquisar item...">
                            </div>
                            <div>
                                <label for="filtroStatusPedido" class="label-text text-xs">Estado do Pedido:</label>
                                <select id="filtroStatusPedido" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Estados</option>
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroVendedor" class="label-text text-xs">Funcionário (Vendedor):</label>
                                <select id="filtroVendedor" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Funcionários</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroClassificacaoPedido" class="label-text text-xs">Classificar por:</label>
                                <select id="filtroClassificacaoPedido" class="input-field input-field-sm py-1.5">
                                    <option value="dataPedido_desc">Data Pedido (Mais Recentes)</option>
                                    <option value="dataPedido_asc">Data Pedido (Mais Antigos)</option>
                                    <option value="dataEntrega_asc">Data Entrega (Mais Próximos)</option>
                                    <option value="dataEntrega_desc">Data Entrega (Mais Distantes)</option>
                                    <option value="clienteNome_asc">Nome Cliente (A-Z)</option>
                                    <option value="clienteNome_desc">Nome Cliente (Z-A)</option>
                                    <option value="numeroPedido_asc">Nº Pedido (Crescente)</option>
                                    <option value="numeroPedido_desc">Nº Pedido (Decrescente)</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 lg:col-span-1 lg:col-start-3">
                                 <button id="limparFiltrosPedidos" class="btn btn-secondary w-full text-sm py-2"><i class="fas fa-times mr-2"></i>Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    <div id="listaTodosPedidosContainer" class="pedidos-table-container">
                        <table class="pedidos-table">
                            <thead>
                                <tr>
                                    <th>Nº Pedido</th>
                                    <th>Cliente</th>
                                    <th>Data Pedido</th>
                                    <th>Data Entrega</th>
                                    <th>Valor Total</th>
                                    <th>Estado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaTodosPedidos">
                                <tr><td colspan="7" class="text-center py-10">Nenhum pedido encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
        <footer class="site-footer">
            <p>Sistema de Gestão PRO para Gráficas: Crie pedidos, controle clientes, produtos e o fluxo de produção de forma eficiente.</p>
            <p><strong>Criado por: Jeffweb3</strong></p>
        </footer>
    </div>

    <!-- Modal Novo Cliente Rápido -->
    <div id="modalNovoClienteRapidoOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div id="modalNovoClienteRapidoContent" class="modal-content-wrapper max-w-md">
            <div class="h-2"></div> 
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalNovoClienteRapido()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Registo Rápido de Cliente</h3>
                <form id="formNovoClienteRapido" class="space-y-4">
                    <div>
                        <label for="clienteRapidoNome" class="label-text">Nome:</label>
                        <input type="text" id="clienteRapidoNome" class="input-field" required>
                    </div>
                    <div>
                        <label for="clienteRapidoTelefone" class="label-text">Telefone:</label>
                        <input type="tel" id="clienteRapidoTelefone" class="input-field">
                    </div>
                    <div>
                        <label for="clienteRapidoTipo" class="label-text">Tipo de Cliente:</label>
                        <select id="clienteRapidoTipo" class="input-field">
                            <option value="final" selected>Cliente Final</option>
                            <option value="revenda">Revenda</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2.5 pt-4">
                        <button type="button" onclick="fecharModalNovoClienteRapido()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Código Funcionário -->
    <div id="modalEditarCodigoFuncionarioOverlay" class="modal-overlay interactive-theme-modal hidden">
         <div id="modalEditarCodigoFuncionarioContent" class="modal-content-wrapper max-w-sm">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarCodigoFuncionario()">&times;</button>
                <h3 class="text-lg font-semibold mb-2">Editar Código de Acesso</h3>
                <p class="text-sm mb-4" id="nomeFuncionarioParaEditarCodigo"></p>
                <form id="formEditarCodigoFuncionario">
                    <input type="hidden" id="funcionarioIdParaEditarCodigo">
                    <div>
                        <label for="novoCodigoAcesso" class="label-text">Novo Código:</label>
                        <input type="text" id="novoCodigoAcesso" class="input-field" required>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalEditarCodigoFuncionario()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Código</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Universal (DEPRECATED - use notification bar instead) -->
    <div id="universalModalOverlay" class="modal-overlay hidden">
        <div id="universalModalContent" class="modal-content-wrapper max-w-md">
            {/* O conteúdo será injetado aqui pelo JavaScript */}
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDocs, 
            query, 
            limit,
            onSnapshot, 
            Timestamp,
            writeBatch,
            deleteDoc, 
            setDoc,
            updateDoc, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyDOg6A8HFA_JCP_4iS7JcRCTRgdnzcP4Xk",
             authDomain: "sistema-grafica-pro.firebaseapp.com",
             projectId: "sistema-grafica-pro",
             storageBucket: "sistema-grafica-pro.firebasestorage.app",
             messagingSenderId: "1043193530848",
             appId: "1:1043193530848:web:b0effc9640a2e8ed6f8385"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const shopInstanceAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let userId = null, produtosCache = [], pedidoImagemBase64 = null, todosOsPedidosCache = [], clientesCache = [], fornecedoresCache = [], funcionariosCache = [];
        let itemPedidoCount = 0, pagamentoCount = 0, clienteSelecionadoId = null, editingOrderId = null, loggedInUserRole = null, loggedInUserName = null, loggedInUserIdGlobal = null; 
        let currentUniversalModalConfirmCallback = null;
        let currentUniversalModalCancelCallback = null;
        let originalBodyOverflow = "", originalDocOverflow = ""; 
        let originalBodyOverflowEspecifico = "", originalDocOverflowEspecifico = ""; 
        let notificationTimeout;


        async function criarDadosIniciaisSeNaoExistirem() {
            if (!auth.currentUser) { return; }
            const clientesPath = `artifacts/${shopInstanceAppId}/clientes`;
            let clientesSnapshot = await getDocs(query(collection(db, clientesPath), limit(1)));
            if (clientesSnapshot.empty) {
                const clientesAmostra = [
                    { nome: "Carlos Silva", tipoCliente: "final", telefone: "(11) 98765-4321", email: "carlos.silva@example.com", cpfCnpj: "123.456.789-00", endereco: "Rua das Palmeiras, 123", criadoEm: Timestamp.now() },
                    { nome: "Padaria Pão Quente Ltda", tipoCliente: "revenda", telefone: "(21) 91234-5678", email: "contato@paoquente.com.br", cpfCnpj: "12.345.678/0001-99", endereco: "Av. Central, 456", criadoEm: Timestamp.now() }
                ];
                const batchClientes = writeBatch(db);
                clientesAmostra.forEach(cliente => { batchClientes.set(doc(collection(db, clientesPath)), cliente); });
                await batchClientes.commit();
            }
            const produtosPath = `artifacts/${shopInstanceAppId}/produtos`;
            let produtosSnapshot = await getDocs(query(collection(db, produtosPath), limit(1)));
            if (produtosSnapshot.empty) {
                const produtosAmostra = [
                    { nome: "Banner Lona Fosca 440g", tipoPreco: "metro", precoMetro: 55.00, precoUnidade: 0, descricao: "Banner em lona fosca.", criadoEm: Timestamp.now() },
                    { nome: "Cartão de Visita Couchê 300g (Milheiro)", tipoPreco: "unidade", precoUnidade: 120.00, precoMetro: 0, descricao: "Milheiro de cartões.", criadoEm: Timestamp.now() },
                    { nome: "Adesivo Vinil Recorte", tipoPreco: "metro", precoMetro: 70.00, precoUnidade: 0, descricao: "Adesivo com recorte.", criadoEm: Timestamp.now() }
                ];
                const batchProdutos = writeBatch(db);
                produtosAmostra.forEach(produto => { batchProdutos.set(doc(collection(db, produtosPath)), produto); });
                await batchProdutos.commit();
            }
            const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`; 
            let funcionariosSnapshot = await getDocs(query(collection(db, funcionariosPath), limit(1)));
            if (funcionariosSnapshot.empty) {
                const batchFuncionarios = writeBatch(db);
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Admin Master", contato: "admin@grafica.com", cargo: "admin", codigoAcesso: "010101", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Vendedor Padrão", contato: "vendedor@grafica.com", cargo: "vendedor", codigoAcesso: "111111", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Impressor Teste", contato: "impressor@grafica.com", cargo: "impressor", codigoAcesso: "222222", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Produção Teste", contato: "producao@grafica.com", cargo: "producao", codigoAcesso: "333333", criadoEm: Timestamp.now() });
                await batchFuncionarios.commit();
            }
            const fornecedoresPath = `artifacts/${shopInstanceAppId}/fornecedores`;
            let fornecedoresSnapshot = await getDocs(query(collection(db, fornecedoresPath), limit(1)));
            if (fornecedoresSnapshot.empty) {
                const fornecedoresAmostra = [
                    { nome: "Fornecedor de Lonas ABC", contato: "vendas@lonasabc.com", tipoMaterial: "Lonas e Vinis", criadoEm: Timestamp.now() },
                    { nome: "Papelaria Central", contato: "(11) 3333-4444", tipoMaterial: "Papéis Especiais", criadoEm: Timestamp.now() }
                ];
                const batchFornecedores = writeBatch(db);
                fornecedoresAmostra.forEach(fornecedor => { batchFornecedores.set(doc(collection(db, fornecedoresPath)), fornecedor); });
                await batchFornecedores.commit();
            }
            const pedidosPath = `artifacts/${shopInstanceAppId}/pedidos`;
            const pedidosQuery = query(collection(db, pedidosPath), limit(1));
            const pedidosSnapshot = await getDocs(pedidosQuery);
            const clientesAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/clientes`));
            let tempClientesCache = [];
            clientesAtualizadosSnapshot.forEach(doc => tempClientesCache.push({ id: doc.id, ...doc.data() }));
            const produtosAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/produtos`));
            let tempProdutosCache = [];
            produtosAtualizadosSnapshot.forEach(doc => tempProdutosCache.push({ id: doc.id, ...doc.data() }));
            const funcionariosAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`));
            let tempFuncionariosCache = [];
            funcionariosAtualizadosSnapshot.forEach(doc => tempFuncionariosCache.push({ id: doc.id, ...doc.data() }));

            if (pedidosSnapshot.empty && tempClientesCache.length > 0 && tempProdutosCache.length > 0 && tempFuncionariosCache.length > 0) {
                const batchPedidos = writeBatch(db);
                const statusPossiveis = ["Aguardando Aprovação", "Em Produção (Arte)", "Em Produção (Impressão)", "Pronto para Retirada", "Entregue", "Cancelado"];
                const formasPagamentoPossiveis = ["Dinheiro", "Cartão de Crédito", "PIX", "Pendente"];
                for (let i = 0; i < 20; i++) {
                    const clienteAleatorio = tempClientesCache[Math.floor(Math.random() * tempClientesCache.length)];
                    const funcionarioAleatorio = tempFuncionariosCache[Math.floor(Math.random() * tempFuncionariosCache.length)]; 
                    const dataPedido = new Date(); dataPedido.setDate(dataPedido.getDate() - Math.floor(Math.random() * 30)); 
                    const dataEntrega = new Date(dataPedido); dataEntrega.setDate(dataPedido.getDate() + Math.floor(Math.random() * 7) + 1); 
                    const itensPedidoExemplo = []; let valorTotalPedidoExemplo = 0;
                    const numItens = Math.floor(Math.random() * 3) + 1; 
                    for (let j = 0; j < numItens; j++) {
                        const produtoAleatorio = tempProdutosCache[Math.floor(Math.random() * tempProdutosCache.length)];
                        const quantidade = Math.floor(Math.random() * 5) + 1; let valorItem = 0; let largura = null, altura = null;
                        if (produtoAleatorio.tipoPreco === 'metro') {
                            largura = parseFloat((Math.random() * 2 + 0.5).toFixed(2)); altura = parseFloat((Math.random() * 2 + 0.5).toFixed(2));  
                            valorItem = largura * altura * (produtoAleatorio.precoMetro || 0) * quantidade;
                        } else { valorItem = (produtoAleatorio.precoUnidade || 0) * quantidade; }
                        itensPedidoExemplo.push({ produtoId: produtoAleatorio.id, produtoNome: produtoAleatorio.nome, tipoProduto: produtoAleatorio.tipoPreco, quantidade, largura, altura, valorItem, concluido: false, concluidoPor: null, concluidoEm: null });
                        valorTotalPedidoExemplo += valorItem;
                    }
                    const pagamentosExemplo = []; const numPagamentos = Math.random() > 0.6 ? 2 : 1; let valorPagoTotalExemplo = 0;
                    if (numPagamentos === 1) {
                        pagamentosExemplo.push({ forma: formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)], valorPago: valorTotalPedidoExemplo, observacao: "Pagamento integral", dataPagamento: Timestamp.fromDate(dataPedido) });
                        valorPagoTotalExemplo = valorTotalPedidoExemplo;
                    } else {
                        const valorMetade = parseFloat((valorTotalPedidoExemplo / 2).toFixed(2));
                        pagamentosExemplo.push({ forma: formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)], valorPago: valorMetade, observacao: "50% de entrada", dataPagamento: Timestamp.fromDate(dataPedido) });
                        valorPagoTotalExemplo += valorMetade;
                        const formaSegundoPagamento = formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)];
                        if (formaSegundoPagamento !== "Pendente") {
                             pagamentosExemplo.push({ forma: formaSegundoPagamento, valorPago: valorTotalPedidoExemplo - valorMetade, observacao: "Restante", dataPagamento: Timestamp.fromDate(dataEntrega) });
                            valorPagoTotalExemplo += (valorTotalPedidoExemplo - valorMetade);
                        } else { pagamentosExemplo.push({ forma: "Pendente", valorPago: 0, observacao: "Restante pendente", dataPagamento: null }); }
                    }
                    const novoPedidoExemplo = { clienteId: clienteAleatorio.id, clienteNome: clienteAleatorio.nome, vendedorId: funcionarioAleatorio.id, vendedorNome: funcionarioAleatorio.nome, pagamentos: pagamentosExemplo, dataEntrega: Timestamp.fromDate(dataEntrega), status: statusPossiveis[Math.floor(Math.random() * statusPossiveis.length)], valorTotal: valorTotalPedidoExemplo, itens: itensPedidoExemplo, imagemPreviewPedidoBase64: null, dataPedido: Timestamp.fromDate(dataPedido), numeroPedido: `PED-EX${Date.now().toString().slice(-5) + i}` };
                    batchPedidos.set(doc(collection(db, pedidosPath)), novoPedidoExemplo);
                }
                await batchPedidos.commit();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid; 
                await criarDadosIniciaisSeNaoExistirem(); 
                await Promise.all([ carregarClientes(), carregarProdutos(), carregarFuncionarios(), carregarFornecedores() ]);
                carregarTodosPedidos(); 
                
                const loginForm = document.getElementById('loginForm');
                if(loginForm) loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('codigoAcesso').value); });
                
                const logoutButton = document.getElementById('logoutButton');
                if(logoutButton) logoutButton.addEventListener('click', logout);

                const dropdowns = document.querySelectorAll('.exo-menu-container .menu-bar-wrapper li.drop-down');
                dropdowns.forEach(dropdown => {
                    const link = dropdown.querySelector('a');
                    const submenu = dropdown.querySelector('.drop-down-ul');
                    if(link && submenu){
                        link.addEventListener('click', function(event) {
                            if (window.innerWidth <= 768) { 
                                event.preventDefault();
                                dropdown.classList.toggle('open');
                            }
                        });
                    }
                });
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 768) {
                        dropdowns.forEach(dropdown => {
                            if (!dropdown.contains(event.target) && dropdown.classList.contains('open')) {
                                dropdown.classList.remove('open');
                            }
                        });
                    }
                });

                const storedRole = localStorage.getItem('loggedInUserRole');
                const storedName = localStorage.getItem('loggedInUserName');
                const storedId = localStorage.getItem('loggedInUserId');

                if (storedRole && storedName && storedId) {
                    loggedInUserRole = storedRole;
                    loggedInUserName = storedName;
                    loggedInUserIdGlobal = storedId;
                    
                    const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
                    if (loggedInUserNameDisplay) {
                        loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`;
                    }
                    
                    atualizarEstatisticasUsuario();

                    document.body.classList.add('app-visible'); 
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    configurarAcessoPorCargo(loggedInUserRole);
                    setActiveMenuLink('telaInicial');
                    mostrarSecao('telaInicial', false); 
                    ajustarPaddingBody();
                } else {
                    document.body.classList.remove('app-visible');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('appContainer').classList.add('hidden');
                    document.body.style.paddingTop = '0px'; 
                }
                
                const pedidoDropArea = document.getElementById('pedidoImageDropArea');
                if (pedidoDropArea) pedidoDropArea.addEventListener('paste', handlePasteImagePedido);
                
                const pesquisaClienteInputEl = document.getElementById('pesquisaClienteInput');
                if(pesquisaClienteInputEl) pesquisaClienteInputEl.addEventListener('input', () => renderizarListaClientes());
                
                const toggleMenuBtn = document.querySelector('.exo-menu-container .toggle-menu');
                const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                if (toggleMenuBtn && exoMenuEl) {
                    toggleMenuBtn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        exoMenuEl.classList.toggle('display'); 
                        ajustarPaddingBody(); 
                    });
                }

                const formEditarCodigoFuncionarioEl = document.getElementById('formEditarCodigoFuncionario');
                if(formEditarCodigoFuncionarioEl) formEditarCodigoFuncionarioEl.addEventListener('submit', handleSalvarNovoCodigoFuncionario);

                const filtroNomeClienteEl = document.getElementById('filtroNomeCliente');
                const filtroNumeroPedidoEl = document.getElementById('filtroNumeroPedido');
                const filtroDataPedidoEl = document.getElementById('filtroDataPedido');
                const filtroMaterialProdutoEl = document.getElementById('filtroMaterialProduto');
                const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
                const filtroClassificacaoPedidoEl = document.getElementById('filtroClassificacaoPedido');
                const filtroVendedorEl = document.getElementById('filtroVendedor'); 
                const limparFiltrosPedidosBtn = document.getElementById('limparFiltrosPedidos');

                if (filtroNomeClienteEl) filtroNomeClienteEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroNumeroPedidoEl) filtroNumeroPedidoEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroDataPedidoEl) filtroDataPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroMaterialProdutoEl) filtroMaterialProdutoEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroStatusPedidoEl) filtroStatusPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroClassificacaoPedidoEl) filtroClassificacaoPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroVendedorEl) filtroVendedorEl.addEventListener('change', renderizarListaCompletaPedidos); 

                if (limparFiltrosPedidosBtn) {
                    limparFiltrosPedidosBtn.addEventListener('click', () => {
                        if (filtroNomeClienteEl) filtroNomeClienteEl.value = '';
                        if (filtroNumeroPedidoEl) filtroNumeroPedidoEl.value = '';
                        if (filtroDataPedidoEl) filtroDataPedidoEl.value = '';
                        if (filtroMaterialProdutoEl) filtroMaterialProdutoEl.value = '';
                        if (filtroStatusPedidoEl) filtroStatusPedidoEl.value = '';
                        if (filtroClassificacaoPedidoEl) filtroClassificacaoPedidoEl.value = 'dataPedido_desc'; 
                        if (filtroVendedorEl) filtroVendedorEl.value = ''; 
                        renderizarListaCompletaPedidos(); 
                    });
                }

            } else { 
                document.body.classList.remove('app-visible');
                try { await signInAnonymously(auth); } catch (error) { console.error("Erro login anônimo:", error); exibirMensagem("Erro autenticação.", "error");}
            }
        });

        async function handleLogin(codigo) {
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('appContainer');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            const codigoAcessoInput = document.getElementById('codigoAcesso');
            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
            
            loginErrorMessage.classList.add('hidden'); 
            if (!auth.currentUser) { loginErrorMessage.textContent = "Aguardando autenticação. Tente novamente."; loginErrorMessage.classList.remove('hidden'); return; }

            try {
                const funcionariosRef = collection(db, `artifacts/${shopInstanceAppId}/funcionarios`);
                const q = query(funcionariosRef, where("codigoAcesso", "==", codigo));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const funcionarioData = querySnapshot.docs[0].data();
                    const funcionarioId = querySnapshot.docs[0].id;
                    loggedInUserRole = funcionarioData.cargo.toLowerCase(); 
                    loggedInUserName = funcionarioData.nome; 
                    loggedInUserIdGlobal = funcionarioId;

                    localStorage.setItem('loggedInUserRole', loggedInUserRole);
                    localStorage.setItem('loggedInUserName', loggedInUserName);
                    localStorage.setItem('loggedInUserId', loggedInUserIdGlobal);

                    if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`; }
                    
                    atualizarEstatisticasUsuario();

                    document.body.classList.add('app-visible'); 
                    loginScreen.classList.add('hidden'); appContainer.classList.remove('hidden'); codigoAcessoInput.value = ''; 
                    configurarAcessoPorCargo(loggedInUserRole); setActiveMenuLink('telaInicial'); mostrarSecao('telaInicial', false); ajustarPaddingBody();
                } else {
                    loginErrorMessage.textContent = "Código inválido."; loginErrorMessage.classList.remove('hidden'); loggedInUserRole = null; loggedInUserName = null; loggedInUserIdGlobal = null;
                }
            } catch (error) { console.error("Erro login:", error); loginErrorMessage.textContent = "Erro. Tente novamente."; loginErrorMessage.classList.remove('hidden'); loggedInUserRole = null; loggedInUserName = null; loggedInUserIdGlobal = null;}
        }

        function logout() {
            loggedInUserRole = null; loggedInUserName = null; loggedInUserIdGlobal = null;
            localStorage.removeItem('loggedInUserRole');
            localStorage.removeItem('loggedInUserName');
            localStorage.removeItem('loggedInUserId');

            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
             if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = '';}
            document.body.classList.remove('app-visible');
            document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('codigoAcesso').value = ''; 
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) filtroStatusPedidoEl.value = '';
            document.body.style.paddingTop = '0px'; 
        }

        function atualizarEstatisticasUsuario() {
            if (!loggedInUserIdGlobal || !todosOsPedidosCache) {
                document.getElementById('userPedidosMes').textContent = '0';
                document.getElementById('userPedidosFinalizacao').textContent = '0';
                document.getElementById('userPedidosFinalizados').textContent = '0';
                return;
            }

            let pedidosFiltrados = todosOsPedidosCache;
            // Admin vê todos os pedidos, outros cargos veem apenas os seus.
            if (loggedInUserRole !== 'admin') {
                pedidosFiltrados = todosOsPedidosCache.filter(p => p.vendedorId === loggedInUserIdGlobal);
            }
            
            const agora = new Date();
            const inicioDoMes = new Date(agora.getFullYear(), agora.getMonth(), 1);

            // Pedidos Mês: Todos os pedidos da lista filtrada no mês corrente.
            const pedidosEsteMes = pedidosFiltrados.filter(p => {
                if (!p.dataPedido || typeof p.dataPedido.toDate !== 'function') return false;
                const dataPedido = p.dataPedido.toDate();
                return dataPedido >= inicioDoMes;
            });

            // Em Finalização: Pedidos com os estados definidos pelo utilizador.
            const statusEmFinalizacao = [
                "Aguardando Aprovação", 
                "Em Produção (Arte)", 
                "Em Produção (Impressão)",
                "Em Produção (Acabamento)",
                "Pronto para Retirada", 
                "Em Rota de Entrega"
            ];
            const pedidosEmFinalizacao = pedidosFiltrados.filter(p => 
                statusEmFinalizacao.includes(p.status)
            );

            // Finalizados: Pedidos com o estado "Entregue".
            const pedidosFinalizados = pedidosFiltrados.filter(p => p.status === 'Entregue');

            // Atualiza a UI
            document.getElementById('userPedidosMes').textContent = pedidosEsteMes.length;
            document.getElementById('userPedidosFinalizacao').textContent = pedidosEmFinalizacao.length;
            document.getElementById('userPedidosFinalizados').textContent = pedidosFinalizados.length;
        }

        function configurarAcessoPorCargo(role) {
            document.querySelectorAll('.exo-menu > li, .exo-menu .drop-down-ul > li').forEach(item => {
                const acessoPermitido = item.dataset.roleAccess;
                if (acessoPermitido) { item.classList.toggle('hidden', !(acessoPermitido === "all" || (role && acessoPermitido.includes(role)))); }
            });
            const cadastrosDropdown = document.querySelector('.exo-menu-container .menu-bar-wrapper li.drop-down'); 
            if (cadastrosDropdown) {
                const subItensVisiveis = cadastrosDropdown.querySelectorAll('ul.drop-down-ul > li:not(.hidden)');
                cadastrosDropdown.classList.toggle('hidden', subItensVisiveis.length === 0);
            }
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) {
                if (role === 'impressor') filtroStatusPedidoEl.value = 'Em Produção (Impressão)';
                else filtroStatusPedidoEl.value = ''; 
            }
            if (activeSectionId === 'visualizarPedidos') renderizarListaCompletaPedidos();
        }

        function ajustarPaddingBody() {
            const appContainer = document.getElementById('appContainer');
            const menuGlobalContainer = document.querySelector('.exo-menu-container'); 
            const notificationBar = document.getElementById('notificationBar');
            const bodyEl = document.body;
            
            let totalOffset = 0;
            if (menuGlobalContainer && appContainer && !appContainer.classList.contains('hidden')) {
                totalOffset += menuGlobalContainer.offsetHeight;
                 if (notificationBar && notificationBar.classList.contains('visible')) {
                    totalOffset += notificationBar.offsetHeight;
                }
                bodyEl.style.paddingTop = totalOffset + 'px';
                // Aplicar padding lateral e inferior apenas se o app estiver visível e NÃO for a tela de login
                if (bodyEl.classList.contains('app-visible') && !document.getElementById('loginScreen').classList.contains('hidden')) {
                    bodyEl.style.paddingLeft = '20px'; 
                    bodyEl.style.paddingRight = '20px';
                    bodyEl.style.paddingBottom = '20px'; 
                } else {
                     bodyEl.style.paddingLeft = '0px'; 
                    bodyEl.style.paddingRight = '0px';
                    bodyEl.style.paddingBottom = '0px';
                }

            } else { // Para tela de login
                bodyEl.style.paddingTop = '0px'; 
                bodyEl.style.paddingLeft = '0px'; 
                bodyEl.style.paddingRight = '0px';
                bodyEl.style.paddingBottom = '0px';
            }
        }
        window.addEventListener('resize', ajustarPaddingBody); 
        
        const toggleMenuBtnObserver = document.querySelector('.exo-menu-container .toggle-menu');
        if (toggleMenuBtnObserver) {
            const observer = new MutationObserver(() => {
                ajustarPaddingBody();
            });
            const exoMenuToObserve = document.querySelector('.exo-menu-container .exo-menu');
            if (exoMenuToObserve) {
                 observer.observe(exoMenuToObserve, { attributes: true, attributeFilter: ['class', 'style'] });
            }
        }


        let activeSectionId = 'telaInicial';
        function setActiveMenuLink(targetSectionId) { 
            document.querySelectorAll('.exo-menu > li > a, .drop-down-ul > li > a').forEach(link => { 
                link.classList.remove('active'); 
                if (link.dataset.section === targetSectionId) {
                    link.classList.add('active');
                    const parentLi = link.closest('li.drop-down');
                    if (parentLi) {
                        parentLi.querySelector('a:first-child').classList.add('active');
                    }
                }
            });
        }
        
        function mostrarSecao(idSecao, isMenuLink = false) { 
            if (!loggedInUserRole && idSecao !== 'loginScreen') { logout(); return; }
            
            document.querySelectorAll('.main-content-section').forEach(secao => {
                secao.classList.add('hidden');
                secao.classList.remove('active-section'); 
                secao.classList.remove('interactive-theme', 'interactive-theme-dashboard');
            });

            const targetSection = document.getElementById(idSecao);
            if (targetSection) {
                if (idSecao === 'telaInicial') {
                    targetSection.classList.add('interactive-theme-dashboard');
                } else if (idSecao !== 'loginScreen') { 
                    targetSection.classList.add('interactive-theme');
                }

                targetSection.classList.remove('hidden');
                void targetSection.offsetWidth; 
                targetSection.classList.add('active-section');

                activeSectionId = idSecao; 
                if(document.getElementById('mainContentArea')) document.getElementById('mainContentArea').scrollTop = 0;
                if (isMenuLink) {
                    setActiveMenuLink(idSecao);
                    const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                    const toggleMenu = document.querySelector('.exo-menu-container .toggle-menu');
                    if (window.innerWidth <= 768 && exoMenuEl && exoMenuEl.classList.contains('display')) {
                        if (toggleMenu) toggleMenu.click(); 
                    }
                    document.querySelectorAll('.exo-menu-container li.drop-down.open').forEach(openDropdown => {
                        const linkClickedIsChild = openDropdown.contains(document.querySelector(`.exo-menu a[data-section="${idSecao}"]`));
                        if(!linkClickedIsChild || !openDropdown.querySelector('a:first-child').isEqualNode(document.querySelector(`.exo-menu a[data-section="${idSecao}"]`))) {
                           openDropdown.classList.remove('open');
                        }
                    });
                }
            } else { if (loggedInUserRole) mostrarSecao('telaInicial', true); return; }

            if (idSecao === 'novoPedido') {
                 if (!editingOrderId) { 
                    document.getElementById('pedidoDataHora').value = new Date().toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                    document.getElementById('formNovoPedido').reset(); 
                    document.getElementById('itensPedidoContainer').innerHTML = ''; document.getElementById('pagamentosContainer').innerHTML = ''; 
                    itemPedidoCount = 0; pagamentoCount = 0; pedidoImagemBase64 = null; 
                    const prevImg = document.getElementById('pedidoImagemPreview'), ph = document.getElementById('pedidoImagemPreviewPlaceholder');
                    if (prevImg && ph) { prevImg.src = "#"; prevImg.classList.add('hidden'); ph.classList.remove('hidden'); }
                    atualizarValorTotalPedido(); 
                    document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
                    document.getElementById('editingOrderIdField').value = ''; document.getElementById('pedidoClienteSearch').value = ''; 
                    document.getElementById('pedidoClienteId').value = ''; document.getElementById('pedidoClienteResultados').classList.add('hidden'); 
                }
            } else {
                if (editingOrderId && activeSectionId !== 'novoPedido') {
                    editingOrderId = null; document.getElementById('editingOrderIdField').value = '';
                    document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
                }
            }
            if (idSecao === 'telaInicial') atualizarDashboard(); 
            if (idSecao === 'cadastrarCliente') { document.getElementById('pesquisaClienteInput').value = ''; renderizarListaClientes(); document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; }
            if (idSecao === 'cadastrarFornecedor') document.getElementById('formCadastrarFornecedor').reset();
            if (idSecao === 'visualizarPedidos') renderizarListaCompletaPedidos();
            ajustarPaddingBody();
        }
        window.mostrarSecao = mostrarSecao; 
        
        // --- FUNÇÕES DA BARRA DE NOTIFICAÇÃO ---
        function showNotification(config) {
            const notificationBar = document.getElementById('notificationBar');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationActions = document.getElementById('notificationActions');

            if (!notificationBar || !notificationIcon || !notificationMessage || !notificationActions) {
                console.error("Elementos da barra de notificação não encontrados.");
                return;
            }

            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }

            notificationBar.className = 'notification-bar'; 
            notificationActions.innerHTML = '';
            notificationIcon.innerHTML = '';

            let iconClass = '';
            let barTypeClass = '';

            switch (config.type) {
                case 'success': iconClass = 'fas fa-check-circle'; barTypeClass = 'success'; break;
                case 'error': iconClass = 'fas fa-times-circle'; barTypeClass = 'error'; break;
                case 'warning': iconClass = 'fas fa-exclamation-triangle'; barTypeClass = 'warning'; break;
                case 'info': iconClass = 'fas fa-info-circle'; barTypeClass = 'info'; break;
                case 'confirm-delete': iconClass = 'fas fa-exclamation-triangle'; barTypeClass = 'confirm-delete'; break;
                default: iconClass = 'fas fa-info-circle'; barTypeClass = 'info';
            }

            notificationIcon.innerHTML = `<i class="${iconClass}"></i>`;
            notificationMessage.textContent = config.message;
            notificationBar.classList.add(barTypeClass);

            if (config.type === 'confirm-delete') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = config.confirmText || 'Excluir';
                confirmBtn.className = 'btn btn-confirm-action';
                confirmBtn.onclick = () => {
                    if (config.onConfirm) config.onConfirm();
                    hideNotification();
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = config.cancelText || 'Cancelar';
                cancelBtn.className = 'btn btn-cancel-action';
                cancelBtn.onclick = () => {
                    if (config.onCancel) config.onCancel();
                    hideNotification();
                };
                notificationActions.appendChild(confirmBtn);
                notificationActions.appendChild(cancelBtn);
            } else {
                const duration = config.duration || 5000;
                notificationTimeout = setTimeout(() => {
                    hideNotification();
                }, duration);
            }
            
            notificationBar.classList.add('visible');
            ajustarPaddingBody(); 
        }

        function hideNotification() {
            const notificationBar = document.getElementById('notificationBar');
            if (notificationBar) {
                notificationBar.classList.remove('visible');
            }
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            setTimeout(ajustarPaddingBody, 400);
        }
        window.exibirMensagem = (mensagem, tipo = 'info', duracao = 5000) => { 
            // Esta função agora usa a barra de notificação
            showNotification({ 
                message: mensagem, 
                type: tipo, 
                duration: duracao 
            });
        }
        // --- FIM FUNÇÕES DA BARRA DE NOTIFICAÇÃO ---

        // --- MODAL FUNCTIONS (Sem bloqueio de scroll) ---
        function abrirModalEspecifico(overlayId, contentId) {
            const overlay = document.getElementById(overlayId); if (!overlay) return;
            // originalBodyOverflowEspecifico = document.body.style.overflow; 
            // originalDocOverflowEspecifico = document.documentElement.style.overflow;
            // document.documentElement.style.overflow = 'hidden'; 
            // document.body.style.overflow = 'hidden'; 
            overlay.classList.add('interactive-theme-modal'); 
            if (overlay.parentNode !== document.body) document.body.appendChild(overlay);
            overlay.classList.remove('hidden');
            requestAnimationFrame(() => { 
                overlay.classList.add('active'); 
                const content = document.getElementById(contentId); 
                if(content) { 
                    content.classList.remove('opacity-0', 'scale-95'); 
                    content.classList.add('opacity-100', 'scale-100'); 
                } 
            });
        }
        function fecharModalEspecifico(overlayId, contentId, callback) {
            const overlay = document.getElementById(overlayId); if (!overlay) return;
            overlay.classList.remove('active'); 
            const content = document.getElementById(contentId); 
            if(content) { 
                content.classList.remove('opacity-100', 'scale-100'); 
                content.classList.add('opacity-0', 'scale-95'); 
            }
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                // document.documentElement.style.overflow = originalDocOverflowEspecifico; 
                // document.body.style.overflow = originalBodyOverflowEspecifico;           
                if (callback) callback(); 
                overlay.classList.remove('interactive-theme-modal'); 
            }, 300); // tempo para transição
        }
        // --- FIM MODAL FUNCTIONS ---


        window.abrirModalNovoClienteRapido = () => { const form = document.getElementById('formNovoClienteRapido'); if(form) form.reset(); abrirModalEspecifico('modalNovoClienteRapidoOverlay', 'modalNovoClienteRapidoContent'); };
        window.fecharModalNovoClienteRapido = () => fecharModalEspecifico('modalNovoClienteRapidoOverlay', 'modalNovoClienteRapidoContent');
        window.abrirModalEditarCodigoFuncionario=(fId,nome,cA)=>{ document.getElementById('funcionarioIdParaEditarCodigo').value=fId; document.getElementById('nomeFuncionarioParaEditarCodigo').textContent=`Funcionário: ${nome}`; document.getElementById('novoCodigoAcesso').value=cA||''; abrirModalEspecifico('modalEditarCodigoFuncionarioOverlay','modalEditarCodigoFuncionarioContent'); }
        window.fecharModalEditarCodigoFuncionario=()=>fecharModalEspecifico('modalEditarCodigoFuncionarioOverlay','modalEditarCodigoFuncionarioContent');
        
        window.toggleEtapaStatus = async (pedidoId, itemIndex, etapa, isChecked) => {
            if (!auth.currentUser) {
                exibirMensagem("Sem permissão para alterar. Faça o login novamente.", "error");
                return;
            }
            
            const rolesPermitidas = {
                impressao: ['admin', 'impressor'],
                producao: ['admin', 'producao']
            };

            if (!rolesPermitidas[etapa] || !rolesPermitidas[etapa].includes(loggedInUserRole)) {
                exibirMensagem(`Não tem permissão para alterar a etapa de ${etapa}.`, "error");
                const checkbox = document.getElementById(`${etapa}-check-${pedidoId}-${itemIndex}`);
                if (checkbox) {
                    checkbox.checked = !isChecked;
                    checkbox.parentElement.classList.toggle('completed', !isChecked);
                }
                return;
            }

            const pedidoDocRef = doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId);
            const pedidoParaAtualizar = todosOsPedidosCache.find(p => p.id === pedidoId);

            if (pedidoParaAtualizar && pedidoParaAtualizar.itens[itemIndex] != null) {
                const novosItens = [...pedidoParaAtualizar.itens];
                const item = novosItens[itemIndex];
                
                // Ensure the 'etapas' structure exists, migrating if necessary
                if (!item.etapas) {
                    item.etapas = {
                        impressao: { concluido: item.concluido || false, concluidoPor: item.concluidoPor || null, concluidoEm: item.concluidoEm || null },
                        producao: { concluido: false, concluidoPor: null, concluidoEm: null }
                    };
                }
                
                if (!item.etapas[etapa]) {
                    item.etapas[etapa] = {};
                }

                item.etapas[etapa].concluido = isChecked;

                if (isChecked) {
                    item.etapas[etapa].concluidoPor = loggedInUserName;
                    item.etapas[etapa].concluidoEm = Timestamp.now();
                } else {
                    item.etapas[etapa].concluidoPor = null;
                    item.etapas[etapa].concluidoEm = null;
                }
                
                try {
                    await updateDoc(pedidoDocRef, { itens: novosItens });
                    exibirMensagem(`Etapa de ${etapa} do item ${itemIndex + 1} atualizada.`, 'success', 2000);
                } catch (error) {
                    console.error("Erro ao atualizar etapa do item:", error);
                    exibirMensagem("Erro ao atualizar o item.", "error");
                }
            } else {
                 exibirMensagem("Não foi possível encontrar o pedido ou o item para atualizar.", "error");
            }
        };


        window.abrirDetalhesPedidoNovaGuia = (pedido) => {
            const reconstructTimestamp = (tsObj) => (tsObj && typeof tsObj.seconds === 'number' && typeof tsObj.nanoseconds === 'number') ? new Timestamp(tsObj.seconds, tsObj.nanoseconds) : null;
            const formatDate = (ts) => { const t = reconstructTimestamp(ts); return t ? t.toDate().toLocaleDateString('pt-BR') : 'N/A'; };
            const formatDateTime = (ts) => { const t = reconstructTimestamp(ts); return t ? t.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'; };
            
            const rolesPermitidasParaMarcar = ['admin', 'producao', 'impressor'];
            const podeMarcarItens = loggedInUserRole && rolesPermitidasParaMarcar.includes(loggedInUserRole);

            let dataPedidoTexto = formatDateTime(pedido.dataPedido);
            let dataEntregaFormatada = formatDate(pedido.dataEntrega);
            const dataEntregaTS = reconstructTimestamp(pedido.dataEntrega);
            if (dataEntregaTS && (dataEntregaTS.toDate().getHours() !== 0 || dataEntregaTS.toDate().getMinutes() !== 0)) {
                dataEntregaFormatada = formatDateTime(pedido.dataEntrega);
            }
            
            let descricaoGeralHtml = pedido.descricaoGeral ? `<div class="section-title">Descrição Geral</div><p><strong>${pedido.descricaoGeral.replace(/\n/g, '<br>')}</strong></p>` : '';

            let itensHtml = pedido.itens?.length > 0 ? pedido.itens.map((item, index) => {
                // Handle old data structure for backward compatibility
                if (!item.etapas) {
                    item.etapas = {
                        impressao: { concluido: item.concluido || false, concluidoPor: item.concluidoPor, concluidoEm: item.concluidoEm },
                        producao: { concluido: false, concluidoPor: null, concluidoEm: null }
                    };
                }

                const impressao = item.etapas.impressao || { concluido: false };
                const producao = item.etapas.producao || { concluido: false };

                const impressaoCheckId = `impressao-check-${pedido.id}-${index}`;
                const producaoCheckId = `producao-check-${pedido.id}-${index}`;
                
                const rolesImpressao = ['admin', 'impressor'];
                const podeMarcarImpressao = loggedInUserRole && rolesImpressao.includes(loggedInUserRole);

                const rolesProducao = ['admin', 'producao'];
                const podeMarcarProducao = loggedInUserRole && rolesProducao.includes(loggedInUserRole);

                let impressaoInfo = '';
                if (impressao.concluido && impressao.concluidoPor && impressao.concluidoEm) {
                    const dataConclusao = formatDateTime(impressao.concluidoEm);
                    impressaoInfo = `<span class="info-icon" title="Impresso por: ${impressao.concluidoPor} em ${dataConclusao}">ⓘ</span>`;
                }

                let producaoInfo = '';
                if (producao.concluido && producao.concluidoPor && producao.concluidoEm) {
                     const dataConclusao = formatDateTime(producao.concluidoEm);
                    producaoInfo = `<span class="info-icon" title="Produzido por: ${producao.concluidoPor} em ${dataConclusao}">ⓘ</span>`;
                }
                
                const itemDesc = item.descricao ? `<br><small style="color: #555; padding-left: 15px;">&hookrightarrow; ${item.descricao}</small>` : '';
                const dimensoes = item.tipoProduto === 'metro' && item.largura && item.altura ? ` (${item.largura.toFixed(2)}m x ${item.altura.toFixed(2)}m)` : '';
                const mainLabel = `${item.quantidade}x ${item.produtoNome}${dimensoes} - R$ ${item.valorItem.toFixed(2).replace('.', ',')}${itemDesc}`;
                
                const impressaoArea = `
                    <div class="etapa ${impressao.concluido ? 'completed' : ''}" ${podeMarcarImpressao ? `onclick="document.getElementById('${impressaoCheckId}').click()"` : ''} data-interactive="${podeMarcarImpressao}">
                        <input type="checkbox" id="${impressaoCheckId}" onchange="this.parentElement.classList.toggle('completed', this.checked); window.opener.toggleEtapaStatus('${pedido.id}', ${index}, 'impressao', this.checked)" ${impressao.concluido ? 'checked' : ''} ${!podeMarcarImpressao ? 'disabled' : ''}>
                        <label for="${impressaoCheckId}">Impressão</label>
                        ${impressaoInfo}
                    </div>`;

                const producaoArea = `
                    <div class="etapa ${producao.concluido ? 'completed' : ''}" ${podeMarcarProducao ? `onclick="document.getElementById('${producaoCheckId}').click()"` : ''} data-interactive="${podeMarcarProducao}">
                        <input type="checkbox" id="${producaoCheckId}" onchange="this.parentElement.classList.toggle('completed', this.checked); window.opener.toggleEtapaStatus('${pedido.id}', ${index}, 'producao', this.checked)" ${producao.concluido ? 'checked' : ''} ${!podeMarcarProducao ? 'disabled' : ''}>
                        <label for="${producaoCheckId}">Produção</label>
                        ${producaoInfo}
                    </div>`;

                return `<li class="item-producao-container"><div class="item-label">${mainLabel}</div><div class="etapas-wrapper">${impressaoArea}${producaoArea}</div></li>`;
            }).join('') : '<li>Nenhum item.</li>';

            let pagamentosHtml = 'Nenhum pagamento.';
            let totalPagoCalculado = 0;
            if (pedido.pagamentos?.length > 0) {
                pagamentosHtml = '<ul>';
                pedido.pagamentos.forEach(pgto => {
                    const dP = pgto.dataPagamento ? formatDateTime(pgto.dataPagamento) : 'N/A';
                    pagamentosHtml += `<li>${pgto.forma}: R$ ${pgto.valorPago.toFixed(2).replace('.',',')} ${pgto.observacao?'('+pgto.observacao+')':''} - Data: ${dP}</li>`;
                    totalPagoCalculado += pgto.valorPago;
                });
                pagamentosHtml += '</ul>';
            }
            
            const valorRestanteCalculado = (pedido.valorTotal || 0) - totalPagoCalculado;
            
            const conteudoHtml = `<html><head><title>Pedido: ${pedido.numeroPedido||'N/A'}</title><style>body{font-family:'Poppins',Arial,sans-serif;margin:20px;background-color:#f1f5f9;color:#334155;font-size:14px}:root{--color-primary: #0ea5e9; --color-text-main: #334155; --color-text-heading: #1e293b; --color-text-muted: #64748b; --color-border-soft: #e2e8f0; --color-border-medium: #cbd5e1; --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);}.container{max-width:700px;margin:auto;background-color:#fff;padding:25px;border-radius:12px;box-shadow:var(--shadow-lg);border:1px solid var(--color-border-soft)}.company-header{display:flex;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid var(--color-border-soft)}.company-header img{max-height:50px;margin-right:20px}.company-header .company-info p{margin:2px 0;font-size:.9em;color:var(--color-text-muted)}.company-header .company-info strong{color:var(--color-text-heading); font-weight:600;}h1{text-align:center;color:var(--color-primary);border-bottom:2px solid var(--color-primary);padding-bottom:10px;margin-bottom:25px;font-size:1.6em;font-weight:600}.section-title{font-size:1.15em;font-weight:600;color:var(--color-text-heading);margin-top:25px;margin-bottom:10px;border-bottom:1px solid var(--color-border-medium);padding-bottom:6px}p{margin-bottom:8px;line-height:1.65}strong{font-weight:500;color:var(--color-text-main)}ul{list-style:none;margin-left:0;padding-left:5px}li.item-producao-container{display:flex;flex-direction:column;align-items:flex-start;padding:10px;border-bottom:1px solid #eee;gap:8px}.item-label{font-weight:500}.etapas-wrapper{display:flex;gap:15px;width:100%}.etapa{display:flex;align-items:center;padding:4px 8px;border:1px solid #ccc;border-radius:15px;font-size:.9em;transition:all .2s ease}.etapa[data-interactive=true]{cursor:pointer}.etapa:not([data-interactive=true]){opacity:.8}.etapa input[type=checkbox]{display:none}.etapa::before{content:'⬜';margin-right:8px;font-size:1.1em}.etapa.completed{background-color:#dcfce7;border-color:#22c55e;color:#15803d}.etapa.completed::before{content:'✅'}.info-icon{margin-left:8px;font-weight:700;color:#64748b;cursor:help;font-size:1.1em;position:relative}.total-section{margin-top:30px;padding-top:20px;border-top:2px solid var(--color-primary);text-align:right}.total-section p{font-size:1.25em;font-weight:600;color:var(--color-primary)}.payment-summary p{font-size:1.05em;margin-bottom:4px;text-align:right}.payment-summary strong{font-weight:600}.print-button-container{text-align:center;margin-top:30px}.print-button{background-color:var(--color-primary);color:white;padding:12px 24px;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:background-color .2s}.print-button:hover{background-color:#0284c7}.footer-note{font-size:.85em;color:var(--color-text-muted);text-align:center;margin-top:30px;padding-top:15px;border-top:1px solid var(--color-border-soft)}img.pedido-preview-print{max-width:100%;max-height:280px;display:block;margin:20px auto;border:1px solid var(--color-border-medium);border-radius:8px;page-break-inside:avoid;object-fit:contain}@media print{body{margin:0;padding:0;background-color:#fff;color:#000;font-size:10pt; --color-primary: #0ea5e9; --color-text-main: #000;}.container{margin:0;padding:10mm;box-shadow:none;border-radius:0;border:none;width:100%;max-width:100%}.print-button-container{display:none}h1{color:var(--color-primary)!important;border-color:var(--color-primary)!important}.info-icon{display:none}.etapa{border:none;padding:2px 0}.etapa.completed label{color:#000}.etapa:not(.completed) label{color:#888}}</style></head><body><div class="container"><div class="company-header"><img src="https://placehold.co/150x50/0ea5e9/FFFFFF?text=SuaGrafica&font=poppins" alt="Logo da Gráfica"><div class="company-info"><p><strong>Empresa:</strong> Gráfica Exemplo</p><p><strong>CNPJ:</strong> 00.000.000/0001-00</p><p><strong>Endereço:</strong> Rua Exemplo, 123, Cidade</p><p><strong>Telefone:</strong> (00) 0000-0000</p><p><strong>Email:</strong> contato@suagrafica.com</p></div></div><h1>Pedido: ${pedido.numeroPedido||'N/A'}</h1><div class="section-title">Cliente</div><p><strong>Nome:</strong> ${pedido.clienteNome||'N/A'}</p><div class="section-title">Pedido</div><p><strong>Número:</strong> ${pedido.numeroPedido||'N/A'}</p><p><strong>Data:</strong> ${dataPedidoTexto}</p><p><strong>Entrega:</strong> ${dataEntregaFormatada}</p><p><strong>Vendedor:</strong> ${pedido.vendedorNome||'N/A'}</p><p><strong>Estado:</strong> ${pedido.status||'N/A'}</p><div class="section-title">Pagamentos</div>${pagamentosHtml}<div class="section-title">Itens</div><ul>${itensHtml}</ul>${descricaoGeralHtml}${pedido.imagemPreviewPedidoBase64?`<div class="section-title">Preview</div><img class="pedido-preview-print" src="${pedido.imagemPreviewPedidoBase64}" alt="Preview" />`:''}<div class="payment-summary total-section"><p><strong>Total Pedido:</strong> R$ ${pedido.valorTotal?.toFixed(2).replace('.',',')||'0,00'}</p><p><strong>Total Pago:</strong> R$ ${totalPagoCalculado.toFixed(2).replace('.',',')}</p>${valorRestanteCalculado>0?`<p style="color:red"><strong>Restante:</strong> R$ ${valorRestanteCalculado.toFixed(2).replace('.',',')}</p>`:'<p style="color:green"><strong>Quitado</strong></p>'}</div><div class="print-button-container"><button class="print-button" onclick="window.print()">Imprimir</button></div><p class="footer-note">Gerado em: ${new Date().toLocaleString('pt-BR')}</p></div></body></html>`; 
            
            const nG = window.open('', '_blank'); 
            if (nG) { 
                nG.document.open(); 
                nG.document.write(conteudoHtml); 
                nG.document.close(); 
            } else { 
                exibirMensagem("Bloqueador de pop-up impediu nova guia.", "warning"); 
            } 
        }

        const formCadastrarCliente = document.getElementById('formCadastrarCliente'); formCadastrarCliente.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const d = { nome:document.getElementById('clienteNome').value, tipoCliente:document.getElementById('clienteTipo').value, telefone:document.getElementById('clienteTelefone').value, email:document.getElementById('clienteEmail').value, cpfCnpj:document.getElementById('clienteCpfCnpj').value, endereco:document.getElementById('clienteEndereco').value, criadoEm:Timestamp.now() }; try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), d); exibirMensagem('Cliente registado com sucesso!', 'success'); formCadastrarCliente.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar cliente.', 'error'); } });
        function renderizarListaClientes() { const lE = document.getElementById('listaClientes'); const pI = document.getElementById('pesquisaClienteInput'); const tP = pI ? pI.value.toLowerCase() : ''; if (!lE) return; lE.innerHTML = ''; const cF = clientesCache.filter(c => (c.nome&&c.nome.toLowerCase().includes(tP))||(c.telefone&&c.telefone.toLowerCase().includes(tP))||(c.email&&c.email.toLowerCase().includes(tP))); if (cF.length === 0) { lE.innerHTML = `<p class="text-sm text-center py-3">${tP?'Nenhum cliente encontrado.':'Nenhum cliente registado.'}</p>`; document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; return; } cF.forEach(c => { const d=document.createElement('div'); d.className=`item-list-display ${c.id===clienteSelecionadoId?'selected':''}`; d.onclick=()=>exibirDetalhesClienteEProcurarPedidos(c.id); let tipo=c.tipoCliente==='revenda'?'Revenda':'Final'; d.innerHTML=`<strong>${c.nome}</strong> <span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle">${tipo}</span><div class="meta">${c.telefone||'S/ Telefone'}</div>`; lE.appendChild(d); }); }
        function exibirDetalhesClienteEProcurarPedidos(id) { clienteSelecionadoId = id; renderizarListaClientes(); const cli = clientesCache.find(c => c.id === id); const dD = document.getElementById('detalhesClienteSelecionado'), iCD = document.getElementById('infoCliente'), pLD = document.getElementById('pedidosDoClienteLista'); if (!cli||!dD||!iCD||!pLD) return; iCD.innerHTML = `<p><strong>Nome:</strong> ${cli.nome||'N/A'}</p><p><strong>Tel:</strong> ${cli.telefone||'N/A'}</p><p><strong>Email:</strong> ${cli.email||'N/A'}</p><p><strong>Tipo:</strong> ${cli.tipoCliente==='revenda'?'Revenda':'Final'}</p>${cli.cpfCnpj?`<p><strong>CPF/CNPJ:</strong> ${cli.cpfCnpj}</p>`:''}${cli.endereco?`<p><strong>Endereço:</strong> ${cli.endereco}</p>`:''}`; dD.classList.remove('hidden'); pLD.innerHTML = '<p class="text-xs text-center py-2">A carregar...</p>'; const pDC = todosOsPedidosCache.filter(p => p.clienteId === id); pDC.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0)); if (pDC.length === 0) { pLD.innerHTML = '<p class="text-xs text-center py-2">Nenhum pedido para este cliente.</p>'; return; } pLD.innerHTML = ''; pDC.forEach(p => { const iPD=document.createElement('div'); iPD.className='p-2.5 border-b text-xs last:border-b-0'; const dP=p.dataPedido?.toDate().toLocaleDateString('pt-BR')||'N/A'; iPD.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium">${p.numeroPedido}</span><span class="text-opacity-80">${dP}</span></div><div class="flex justify-between items-center mt-1"><span>R$ ${p.valorTotal.toFixed(2).replace('.',',')}</span>${getStatusBadgeSimpleHTML(p.status)}</div><button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(p))}')))" class="btn btn-link text-xs p-0 mt-1">Ver detalhes</button>`; pLD.appendChild(iPD); }); }
        function carregarClientes() { if (!auth.currentUser) return; const q = query(collection(db, `artifacts/${shopInstanceAppId}/clientes`)); onSnapshot(q, (snap) => { clientesCache = []; if (snap.empty && activeSectionId === 'cadastrarCliente') document.getElementById('listaClientes').innerHTML = '<p class="text-sm text-center py-3">Nenhum cliente registado.</p>'; snap.forEach(doc => clientesCache.push({ id: doc.id, ...doc.data() })); clientesCache.sort((a, b) => (a.nome||"").localeCompare(b.nome||"")); if (activeSectionId === 'cadastrarCliente') renderizarListaClientes(); if (activeSectionId === 'telaInicial') atualizarDashboard(); }, e => { console.error("Erro clientes:", e); exibirMensagem("Erro ao carregar clientes.", "error"); }); }
        document.getElementById('formNovoClienteRapido').addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const nome=document.getElementById('clienteRapidoNome').value, tel=document.getElementById('clienteRapidoTelefone').value, tipo=document.getElementById('clienteRapidoTipo').value; if (!nome.trim()) { exibirMensagem("Nome do cliente é obrigatório.", "warning"); return; } try { const ref = await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), { nome, telefone:tel, tipoCliente:tipo, email:'', cpfCnpj:'', endereco:'', criadoEm:Timestamp.now() }); exibirMensagem('Cliente registado com sucesso!', 'success'); fecharModalNovoClienteRapido(); document.getElementById('pedidoClienteSearch').value = nome; document.getElementById('pedidoClienteId').value = ref.id; document.getElementById('pedidoClienteResultados').innerHTML = ''; document.getElementById('pedidoClienteResultados').classList.add('hidden'); } catch (err) { console.error(err); exibirMensagem('Erro ao registar cliente.', 'error'); } });
        const pedidoClienteSearchEl = document.getElementById('pedidoClienteSearch'); const pedidoClienteResultadosEl = document.getElementById('pedidoClienteResultados'); const pedidoClienteIdEl = document.getElementById('pedidoClienteId'); if (pedidoClienteSearchEl) { pedidoClienteSearchEl.addEventListener('input', () => { const t=pedidoClienteSearchEl.value.toLowerCase(); pedidoClienteResultadosEl.innerHTML=''; if(t.length<2){pedidoClienteResultadosEl.classList.add('hidden');pedidoClienteIdEl.value='';return;} const res=clientesCache.filter(c=>(c.nome&&c.nome.toLowerCase().includes(t))||(c.telefone&&String(c.telefone).toLowerCase().includes(t))||(c.email&&c.email.toLowerCase().includes(t))); if(res.length>0){res.forEach(cli=>{const d=document.createElement('div');d.textContent=`${cli.nome} ${cli.telefone?'- '+cli.telefone:''}`;d.onclick=()=>{pedidoClienteSearchEl.value=cli.nome;pedidoClienteIdEl.value=cli.id;pedidoClienteResultadosEl.classList.add('hidden');pedidoClienteResultadosEl.innerHTML='';};pedidoClienteResultadosEl.appendChild(d);});pedidoClienteResultadosEl.classList.remove('hidden');}else{const d=document.createElement('div');d.textContent='Nenhum cliente encontrado.';d.classList.add('italic');pedidoClienteResultadosEl.appendChild(d);pedidoClienteResultadosEl.classList.remove('hidden');pedidoClienteIdEl.value='';} }); document.addEventListener('click', (ev) => { if (pedidoClienteSearchEl&&!pedidoClienteSearchEl.contains(ev.target)&&pedidoClienteResultadosEl&&!pedidoClienteResultadosEl.contains(ev.target)) pedidoClienteResultadosEl.classList.add('hidden'); }); }
        window.togglePrecoFields=()=>{const t=document.getElementById('produtoTipoPreco')?.value; if(!t)return; document.getElementById('precoUnidadeFields').classList.toggle('hidden',t==='metro');document.getElementById('precoMetroFields').classList.toggle('hidden',t==='unidade');};
        document.getElementById('formCadastrarProduto').addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const d={nome:document.getElementById('produtoNome').value,tipoPreco:document.getElementById('produtoTipoPreco').value,precoUnidade:parseFloat(document.getElementById('produtoPrecoUnidade').value)||0,precoMetro:parseFloat(document.getElementById('produtoPrecoMetro').value)||0,descricao:document.getElementById('produtoDescricao').value,criadoEm:Timestamp.now()}; if(!d.nome.trim()){exibirMensagem("Nome do produto é obrigatório.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/produtos`), d); exibirMensagem('Produto registado com sucesso!', 'success'); e.target.reset(); togglePrecoFields(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar produto.', 'error'); } });
        function carregarProdutos() { if (!auth.currentUser) return; const q = query(collection(db, `artifacts/${shopInstanceAppId}/produtos`)); onSnapshot(q, (snap) => { const l=document.getElementById('listaProdutos'); if(l)l.innerHTML=''; produtosCache=[]; if(snap.empty){if(l)l.innerHTML='<p class="text-sm text-center py-3">Nenhum produto registado.</p>';} const pS=[]; snap.forEach(doc=>pS.push({id:doc.id,...doc.data()})); pS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); pS.forEach(p=>{produtosCache.push(p);if(l){const d=document.createElement('div');d.className='item-list-display !cursor-default';let i=p.tipoPreco==='metro'?`R$ ${(p.precoMetro||0).toFixed(2).replace('.',',')}/m²`:`R$ ${(p.precoUnidade||0).toFixed(2).replace('.',',')}/un`;d.innerHTML=`<strong>${p.nome}</strong><div class="meta">${i}</div>`;l.appendChild(d);}}); document.querySelectorAll('.produto-select').forEach(s=>popularSelectProduto(s)); }, e => { console.error("Erro produtos:", e); exibirMensagem("Erro ao carregar produtos.", "error"); }); }
        const formCadastrarFuncionario = document.getElementById('formCadastrarFuncionario'); formCadastrarFuncionario.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const d={nome:document.getElementById('funcionarioNome').value,contato:document.getElementById('funcionarioContato').value,cargo:document.getElementById('funcionarioCargo').value.toLowerCase(),codigoAcesso:document.getElementById('funcionarioCodigoAcesso').value,criadoEm:Timestamp.now()}; if(!d.nome.trim()||!d.cargo.trim()||!d.codigoAcesso.trim()){exibirMensagem("Preencha todos os campos obrigatórios do funcionário.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`), d); exibirMensagem('Funcionário registado com sucesso!', 'success'); formCadastrarFuncionario.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar funcionário.', 'error'); } });
        function carregarFuncionarios() { if (!auth.currentUser) return; const q=query(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`)); onSnapshot(q, (snap)=>{ const selPV=document.getElementById('pedidoVendedor'), lF=document.getElementById('listaFuncionarios'), fVS=document.getElementById('filtroVendedor'); if(selPV)selPV.innerHTML='<option value="">Selecione funcionário</option>'; if(lF)lF.innerHTML=''; if(fVS)fVS.innerHTML='<option value="">Todos Funcionários</option>'; funcionariosCache=[]; if(snap.empty){if(lF)lF.innerHTML='<p class="text-sm text-center py-3">Nenhum funcionário registado.</p>';} const fS=[]; snap.forEach(doc=>fS.push({id:doc.id,...doc.data()})); fS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); fS.forEach(f=>{funcionariosCache.push(f);if(selPV){const o=document.createElement('option');o.value=f.id;o.textContent=f.nome;selPV.appendChild(o);} if(lF){const d=document.createElement('div');d.className='item-list-display !cursor-default flex justify-between items-center'; let cD=loggedInUserRole==='admin'?`<span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle ml-2">Código: ${f.codigoAcesso||'N/D'}</span>`:''; let eB=loggedInUserRole==='admin'?`<button onclick="abrirModalEditarCodigoFuncionario('${f.id}','${f.nome}','${f.codigoAcesso||''}')" class="btn-icon-action text-blue-500 ml-2" title="Editar Código"><i class="fas fa-key"></i></button>`:''; d.innerHTML=`<div><strong>${f.nome}</strong><span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle ml-1">${f.cargo||'N/A'}</span>${cD}<div class="meta">Contacto: ${f.contato||'N/A'}</div></div>${eB}`;lF.appendChild(d);} if(fVS){const o=document.createElement('option');o.value=f.id;o.textContent=f.nome;fVS.appendChild(o);}}); }, e => { console.error("Erro funcionários:", e); exibirMensagem("Erro ao carregar funcionários.", "error"); }); }
        async function handleSalvarNovoCodigoFuncionario(ev){ev.preventDefault();if(!auth.currentUser||loggedInUserRole!=='admin'){exibirMensagem("Apenas administradores podem alterar códigos.","error");return;}const fId=document.getElementById('funcionarioIdParaEditarCodigo').value,nC=document.getElementById('novoCodigoAcesso').value;if(!nC.trim()){exibirMensagem("O novo código de acesso não pode estar vazio.","warning");return;}try{const fR=doc(db,`artifacts/${shopInstanceAppId}/funcionarios`,fId);await updateDoc(fR,{codigoAcesso:nC});exibirMensagem("Código de acesso atualizado com sucesso!","success");fecharModalEditarCodigoFuncionario();}catch(err){console.error(err);exibirMensagem("Erro ao atualizar código de acesso.","error");}}
        const formCadastrarFornecedor = document.getElementById('formCadastrarFornecedor'); formCadastrarFornecedor.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const d={nome:document.getElementById('fornecedorNome').value,contato:document.getElementById('fornecedorContato').value,tipoMaterial:document.getElementById('fornecedorMaterial').value,criadoEm:Timestamp.now()}; if(!d.nome.trim()){exibirMensagem("Nome do fornecedor é obrigatório.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`), d); exibirMensagem('Fornecedor registado com sucesso!', 'success'); formCadastrarFornecedor.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar fornecedor.', 'error'); } });
        function carregarFornecedores() { if (!auth.currentUser) return; const q=query(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`)); onSnapshot(q, (snap)=>{ const l=document.getElementById('listaFornecedores');if(l)l.innerHTML='';fornecedoresCache=[];if(snap.empty){if(l)l.innerHTML='<p class="text-sm text-center py-3">Nenhum fornecedor registado.</p>';} const fS=[];snap.forEach(doc=>fS.push({id:doc.id,...doc.data()}));fS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); fS.forEach(f=>{fornecedoresCache.push(f);if(l){const d=document.createElement('div');d.className='item-list-display !cursor-default';let cD=f.contato||'N/A';const cCC=f.contato?String(f.contato).replace(/\D/g,''):'';if(cCC.length>=8&&cCC.length<=15&&/^\d+$/.test(cCC)){ let wN=cCC; if(!wN.startsWith('55')&&(wN.length===10||wN.length===11))wN='55'+wN;else if(wN.startsWith('55')&&wN.length>13){const p=wN.split('55');if(p.length>1)wN='55'+p.pop();}cD=`<a href="https://wa.me/${wN}" target="_blank" class="text-green-500 hover:text-green-600 hover:underline inline-flex items-center"><i class="fab fa-whatsapp mr-1.5"></i> ${f.contato}</a>`;}else if(f.contato&&f.contato.includes('@'))cD=`<a href="mailto:${f.contato}" class="text-[var(--color-primary)] hover:underline">${f.contato}</a>`;d.innerHTML=`<strong>${f.nome}</strong><div class="meta">Contacto: ${cD}</div><div class="meta">Material: ${f.tipoMaterial||'N/A'}</div>`;l.appendChild(d);}}); }, e => { console.error("Erro fornecedores:", e); exibirMensagem("Erro ao carregar fornecedores.", "error"); }); }
        
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processImageFilePedido(file) {
            const pI = document.getElementById('pedidoImagemPreview');
            const pH = document.getElementById('pedidoImagemPreviewPlaceholder');

            if (file && file.type.startsWith('image/')) {
                try {
                    // Redimensiona para um máximo de 800x800 com 70% de qualidade JPEG
                    const resizedBase64 = await resizeImage(file, 800, 800, 0.7);
                    pedidoImagemBase64 = resizedBase64;
                    
                    if (pI && pH) {
                        pI.src = resizedBase64;
                        pI.classList.remove('hidden');
                        pH.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Erro ao redimensionar imagem:", error);
                    exibirMensagem("Não foi possível processar a imagem.", "error");
                    pedidoImagemBase64 = null;
                    if (pI && pH) {
                        pI.src = "#";
                        pI.classList.add('hidden');
                        pH.classList.remove('hidden');
                    }
                }
            } else {
                pedidoImagemBase64 = null;
                if (pI && pH) {
                    pI.src = "#";
                    pI.classList.add('hidden');
                    pH.classList.remove('hidden');
                }
                if (file) {
                    exibirMensagem("Arquivo de imagem inválido.", "warning");
                }
            }
        }
        
        window.handleImagemFilePedido=(ev)=>{processImageFilePedido(ev.target.files[0]);ev.target.value=null;}
        function handlePasteImagePedido(ev){ev.preventDefault();const iT=(ev.clipboardData||ev.originalEvent.clipboardData).items;for(let i in iT){const it=iT[i];if(it.kind==='file'&&it.type.startsWith('image/')){processImageFilePedido(it.getAsFile());break;}}}
        function popularSelectProduto(sel){sel.innerHTML='<option value="">Selecione produto</option>';produtosCache.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.nome;o.dataset.tipo=p.tipoPreco;o.dataset.precoMetro=p.precoMetro||0;o.dataset.precoUnidade=p.precoUnidade||0;sel.appendChild(o);});}
        window.adicionarItemPedidoForm = (itemParaEditar = null) => {
            itemPedidoCount++;
            const c = document.getElementById('itensPedidoContainer');
            const d = document.createElement('div');
            d.className = 'p-3.5 border rounded-lg space-y-2.5 item-pedido-form relative';
            d.id = `itemPedido-${itemPedidoCount}`;
            d.innerHTML = `
                <button type="button" onclick="removerItemPedidoForm(${itemPedidoCount})" class="absolute top-1.5 right-1.5 text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 transition-colors text-xs"><i class="fas fa-times"></i></button>
                <h4 class="font-medium text-sm">Item ${itemPedidoCount}</h4>
                <div>
                    <label class="label-text text-xs">Produto:</label>
                    <select class="input-field input-field-sm produto-select" id="itemProduto-${itemPedidoCount}" onchange="toggleCamposProduto(${itemPedidoCount})"></select>
                </div>
                <div class="mt-2">
                    <label class="label-text text-xs">Descrição do Item (Opcional):</label>
                    <input type="text" class="input-field input-field-sm item-descricao" id="itemDescricao-${itemPedidoCount}" placeholder="Ex: com laminação fosca...">
                </div>
                <div id="camposProdutoMetro-${itemPedidoCount}" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-text text-xs">Largura (m):</label>
                        <input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemLargura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})">
                    </div>
                    <div>
                        <label class="label-text text-xs">Altura (m):</label>
                        <input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemAltura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})">
                    </div>
                </div>
                <div>
                    <label class="label-text text-xs">Qtd:</label>
                    <input type="number" value="1" min="1" class="input-field input-field-sm quantidade-produto" id="itemQuantidade-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})">
                </div>
                <div>
                    <label class="label-text text-xs">Valor Item:</label>
                    <input type="text" class="input-field input-field-sm valor-item-produto font-medium cursor-not-allowed" id="itemValor-${itemPedidoCount}" readonly value="R$ 0,00">
                </div>`;
            c.appendChild(d);
            const selectProduto = d.querySelector('.produto-select');
            popularSelectProduto(selectProduto);

            if (itemParaEditar) {
                selectProduto.value = itemParaEditar.produtoId;
                selectProduto.dispatchEvent(new Event('change'));
                d.querySelector('.quantidade-produto').value = itemParaEditar.quantidade;
                d.querySelector('.item-descricao').value = itemParaEditar.descricao || '';
                if (itemParaEditar.tipoProduto === 'metro') {
                    d.querySelector('.dimensoes-produto[id^="itemLargura"]').value = itemParaEditar.largura;
                    d.querySelector('.dimensoes-produto[id^="itemAltura"]').value = itemParaEditar.altura;
                }
                if (itemParaEditar.etapas) {
                     d.dataset.etapas = JSON.stringify(itemParaEditar.etapas);
                }
                calcularValorItem(itemPedidoCount);
            }

            d.querySelectorAll('.input-field').forEach(el => el.classList.add('py-1.5', 'text-sm'));
        };

        window.removerItemPedidoForm=(id)=>{const el=document.getElementById(`itemPedido-${id}`);if(el)el.remove();atualizarValorTotalPedido();}
        window.toggleCamposProduto=(id)=>{const s=document.getElementById(`itemProduto-${id}`),o=s.options[s.selectedIndex],t=o.dataset.tipo;document.getElementById(`camposProdutoMetro-${id}`).classList.toggle('hidden',t!=='metro');calcularValorItem(id);}
        window.calcularValorItem=(id)=>{const s=document.getElementById(`itemProduto-${id}`),o=s.options[s.selectedIndex];if(!o||!o.value){document.getElementById(`itemValor-${id}`).value="R$ 0,00";atualizarValorTotalPedido();return;}const t=o.dataset.tipo,pm=parseFloat(o.dataset.precoMetro),pu=parseFloat(o.dataset.precoUnidade),q=parseInt(document.getElementById(`itemQuantidade-${id}`).value)||1;let v=0;if(t==='metro'){const l=parseFloat(document.getElementById(`itemLargura-${id}`).value)||0,a=parseFloat(document.getElementById(`itemAltura-${id}`).value)||0;if(l>0&&a>0&&pm>0)v=(l*a*pm)*q;}else{if(pu>0)v=pu*q;}document.getElementById(`itemValor-${id}`).value=`R$ ${v.toFixed(2).replace('.',',')}`;atualizarValorTotalPedido();}
        function atualizarValorTotalPedido(){let tI=0;document.querySelectorAll('.valor-item-produto').forEach(i=>{const v=i.value.replace('R$ ','').replace(',','.');tI+=parseFloat(v)||0;});document.getElementById('pedidoValorTotal').value=`R$ ${tI.toFixed(2).replace('.',',')}`;calcularTotaisPagamento();}
        window.adicionarPagamentoForm=()=>{pagamentoCount++;const c=document.getElementById('pagamentosContainer');const d=document.createElement('div');d.className='grid grid-cols-1 sm:grid-cols-[2fr,1fr,auto] gap-3 items-end p-3 border rounded-lg pagamento-form-item';d.id=`pagamentoItem-${pagamentoCount}`;d.innerHTML=`<div><label class="label-text text-xs">Forma:</label><select class="input-field input-field-sm py-1.5 forma-pagamento"><option value="Dinheiro">Dinheiro</option><option value="Cartão de Crédito">Crédito</option><option value="Cartão de Débito">Débito</option><option value="PIX">PIX</option><option value="Boleto">Boleto</option><option value="Pendente">Pendente</option></select></div><div><label class="label-text text-xs">Valor (R$):</label><input type="number" step="0.01" class="input-field input-field-sm py-1.5 valor-pago" placeholder="0,00" oninput="window.calcularTotaisPagamento()"></div><button type="button" onclick="removerPagamentoForm(${pagamentoCount})" class="btn btn-danger btn-small text-xs py-1.5 px-2 self-center sm:self-end h-8"><i class="fas fa-trash"></i></button><div class="sm:col-span-3"><label class="label-text text-xs">Obs:</label><input type="text" class="input-field input-field-sm py-1.5 observacao-pagamento" placeholder="Ex: Entrada..."></div>`;c.appendChild(d);calcularTotaisPagamento();}
        window.removerPagamentoForm=(id)=>{const el=document.getElementById(`itemPedido-${id}`);if(el)el.remove();calcularTotaisPagamento();}
        function calcularTotaisPagamento(){let tP=0;document.querySelectorAll('.pagamento-form-item .valor-pago').forEach(i=>{tP+=parseFloat(i.value)||0;});document.getElementById('pedidoTotalPago').value=`R$ ${tP.toFixed(2).replace('.',',')}`;const vTS=document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.'),vT=parseFloat(vTS)||0,vR=vT-tP;document.getElementById('pedidoValorRestante').value=`R$ ${vR.toFixed(2).replace('.',',')}`; }
        window.calcularTotaisPagamento = calcularTotaisPagamento; 
        document.getElementById('formNovoPedido').addEventListener('submit', async (e) => { 
            e.preventDefault(); if (!auth.currentUser) return; 
            editingOrderId = document.getElementById('editingOrderIdField').value; 
            const d={
                clienteId:document.getElementById('pedidoClienteId').value,
                clienteNome:document.getElementById('pedidoClienteSearch').value,
                vendedorId:document.getElementById('pedidoVendedor').value,
                vendedorNome:document.getElementById('pedidoVendedor').options[document.getElementById('pedidoVendedor').selectedIndex]?.text,
                dataEntregaStr:document.getElementById('pedidoDataEntrega').value,
                horaEntregaStr:document.getElementById('pedidoHoraEntrega').value,
                status:document.getElementById('pedidoStatus').value,
                valorTotal:parseFloat(document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.')),
                itens:[],
                pagamentos:[],
                imagemPreviewPedidoBase64:pedidoImagemBase64,
                descricaoGeral: document.getElementById('pedidoDescricaoGeral').value
            }; 
            if(!d.clienteId||!d.vendedorId||!d.dataEntregaStr){exibirMensagem("Preencha campos obrigatórios.","warning");return;} 
            let dEFinal;
            if(d.dataEntregaStr&&d.horaEntregaStr){const[a,m,dia]=d.dataEntregaStr.split('-');const[h,min]=d.horaEntregaStr.split(':');dEFinal=Timestamp.fromDate(new Date(a,parseInt(m)-1,dia,h,min));}
            else if(d.dataEntregaStr){dEFinal=Timestamp.fromDate(new Date(d.dataEntregaStr+"T00:00:00"));}
            else{exibirMensagem("Data entrega inválida.","error");return;} 
            
            const iForms=document.querySelectorAll('.item-pedido-form');
            if(iForms.length===0){exibirMensagem("Adicione pelo menos um item ao pedido.","warning");return;} 
            
            let formValido=true;
            iForms.forEach((iF,idx)=>{
                const cId=iF.id.split('-')[1];
                const pS=document.getElementById(`itemProduto-${cId}`);
                const pId=pS.value,pN=pS.options[pS.selectedIndex]?.text,tP=pS.options[pS.selectedIndex]?.dataset.tipo;
                const q=parseInt(document.getElementById(`itemQuantidade-${cId}`).value),vI=parseFloat(document.getElementById(`itemValor-${cId}`).value.replace('R$ ','').replace(',','.'));
                const desc = document.getElementById(`itemDescricao-${cId}`).value;
                let l=null,a=null;
                if(tP==='metro'){l=parseFloat(document.getElementById(`itemLargura-${cId}`).value)||0;a=parseFloat(document.getElementById(`itemAltura-${cId}`).value)||0;}
                if(pId&&q>0&&vI>=0) {
                     let etapas = iF.dataset.etapas ? JSON.parse(iF.dataset.etapas) : {
                        impressao: { concluido: false, concluidoPor: null, concluidoEm: null },
                        producao: { concluido: false, concluidoPor: null, concluidoEm: null }
                     };
                     // Reconstituir timestamps se estiverem em formato JSON
                     if (etapas.impressao.concluidoEm && typeof etapas.impressao.concluidoEm.seconds === 'number') {
                        etapas.impressao.concluidoEm = new Timestamp(etapas.impressao.concluidoEm.seconds, etapas.impressao.concluidoEm.nanoseconds);
                     }
                     if (etapas.producao.concluidoEm && typeof etapas.producao.concluidoEm.seconds === 'number') {
                        etapas.producao.concluidoEm = new Timestamp(etapas.producao.concluidoEm.seconds, etapas.producao.concluidoEm.nanoseconds);
                     }
                     d.itens.push({produtoId:pId,produtoNome:pN,tipoProduto:tP,quantidade:q,largura:l,altura:a,valorItem:vI, descricao: desc, etapas: etapas});
                }
                else{exibirMensagem(`Item ${idx+1} inválido.`,"warning");formValido=false;}
            });
            if(!formValido)return;
            
            document.querySelectorAll('.pagamento-form-item').forEach(i=>{const f=i.querySelector('.forma-pagamento').value,vP=parseFloat(i.querySelector('.valor-pago').value)||0,o=i.querySelector('.observacao-pagamento').value;if(f&&vP>0||f==="Pendente")d.pagamentos.push({forma:f,valorPago:vP,observacao:o,dataPagamento:Timestamp.now()});else if(f&&vP<=0&&f!=="Pendente"){exibirMensagem(`Valor para ${f} > 0.`,"warning");formValido=false;}});if(!formValido)return;if(d.pagamentos.length===0){exibirMensagem("Adicione pelo menos um método de pagamento.","warning");return;} 
            
            const pData={clienteId:d.clienteId,clienteNome:d.clienteNome,vendedorId:d.vendedorId,vendedorNome:d.vendedorNome,pagamentos:d.pagamentos,dataEntrega:dEFinal,status:d.status,valorTotal:d.valorTotal,itens:d.itens,imagemPreviewPedidoBase64:d.imagemPreviewPedidoBase64, descricaoGeral: d.descricaoGeral}; 
            
            try{const pCP=`artifacts/${shopInstanceAppId}/pedidos`;if(editingOrderId){const pR=doc(db,pCP,editingOrderId);const oPD=todosOsPedidosCache.find(p=>p.id===editingOrderId);pData.dataPedido=oPD?.dataPedido||Timestamp.now();pData.numeroPedido=oPD?.numeroPedido||`PED-${Date.now().toString().slice(-6)}`;await setDoc(pR,pData);exibirMensagem('Pedido atualizado com sucesso!', 'success');}else{pData.dataPedido=Timestamp.now();pData.numeroPedido=`PED-${Date.now().toString().slice(-6)}`;await addDoc(collection(db,pCP),pData);exibirMensagem('Pedido guardado com sucesso!', 'success');} document.getElementById('formNovoPedido').reset();document.getElementById('editingOrderIdField').value='';editingOrderId=null;document.querySelector('#formNovoPedido button[type="submit"]').innerHTML='<i class="fas fa-check mr-1.5"></i>Guardar Pedido';document.getElementById('itensPedidoContainer').innerHTML='';document.getElementById('pagamentosContainer').innerHTML='';pagamentoCount=0;pedidoImagemBase64=null;const pIP=document.getElementById('pedidoImagemPreview'),pIPH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pIP&&pIPH){pIP.src="#";pIP.classList.add('hidden');pIPH.classList.remove('hidden');}itemPedidoCount=0;atualizarValorTotalPedido();mostrarSecao('telaInicial',true);}catch(err){console.error(err);exibirMensagem('Erro ao processar pedido.','error');} 
        });
        function getStatusBadgeSimpleHTML(status){let bC='neutral';if(status==='Entregue')bC='success';else if(status==='Cancelado')bC='danger';else if(status==='Pronto para Retirada')bC='primary';else if(status.startsWith('Em Produção')||status==='Em Rota de Entrega')bC='info';else if(status==='Aguardando Aprovação')bC='warning';return`<span class="status-badge-simple ${bC}">${status}</span>`;}
        function renderizarListaCompletaPedidos() { const tbody = document.getElementById('listaTodosPedidos'); if (!tbody) return; tbody.innerHTML = ''; const fNC=document.getElementById('filtroNomeCliente')?.value.toLowerCase()||'',fNP=document.getElementById('filtroNumeroPedido')?.value.toLowerCase()||'',fDPS=document.getElementById('filtroDataPedido')?.value||'',fMP=document.getElementById('filtroMaterialProduto')?.value.toLowerCase()||''; let fSP=document.getElementById('filtroStatusPedido')?.value||''; const fC=document.getElementById('filtroClassificacaoPedido')?.value||'dataPedido_desc',fVI=document.getElementById('filtroVendedor')?.value||''; if(!fSP){if(loggedInUserRole==='impressor')fSP='Em Produção (Impressão)';} let pF=[...todosOsPedidosCache]; if(fNC)pF=pF.filter(p=>p.clienteNome&&p.clienteNome.toLowerCase().includes(fNC)); if(fNP)pF=pF.filter(p=>p.numeroPedido&&p.numeroPedido.toLowerCase().includes(fNP)); if(fDPS){const dF=new Date(fDPS+"T00:00:00");pF=pF.filter(p=>{if(p.dataPedido&&p.dataPedido.toDate){const dPO=p.dataPedido.toDate();return dPO.getFullYear()===dF.getFullYear()&&dPO.getMonth()===dF.getMonth()&&dPO.getDate()===dF.getDate();}return false;});} if(fMP)pF=pF.filter(p=>{if(p.itens&&Array.isArray(p.itens))return p.itens.some(i=>i.produtoNome&&i.produtoNome.toLowerCase().includes(fMP));return false;}); if(loggedInUserRole==='producao'&&!document.getElementById('filtroStatusPedido')?.value){const sP=["Em Produção (Arte)","Em Produção (Impressão)","Em Produção (Acabamento)"];pF=pF.filter(p=>sP.includes(p.status));}else if(fSP){pF=pF.filter(p=>p.status===fSP);} if(fVI)pF=pF.filter(p=>p.vendedorId===fVI); switch(fC){case'dataPedido_asc':pF.sort((a,b)=>(a.dataPedido?.toMillis()||0)-(b.dataPedido?.toMillis()||0));break;case'dataPedido_desc':pF.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));break;case'dataEntrega_asc':pF.sort((a,b)=>(a.dataEntrega?.toMillis()||0)-(b.dataEntrega?.toMillis()||0));break;case'dataEntrega_desc':pF.sort((a,b)=>(b.dataEntrega?.toMillis()||0)-(a.dataEntrega?.toMillis()||0));break;case'clienteNome_asc':pF.sort((a,b)=>(a.clienteNome||"").localeCompare(b.clienteNome||""));break;case'clienteNome_desc':pF.sort((a,b)=>(b.clienteNome||"").localeCompare(a.clienteNome||""));break;case'numeroPedido_asc':pF.sort((a,b)=>(a.numeroPedido||"").localeCompare(b.numeroPedido||"",undefined,{numeric:true}));break;case'numeroPedido_desc':pF.sort((a,b)=>(b.numeroPedido||"").localeCompare(a.numeroPedido||"",undefined,{numeric:true}));break;default:pF.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));} if(pF.length===0){ tbody.innerHTML='<tr><td colspan="7" class="text-center py-10">Nenhum pedido encontrado com os filtros aplicados.</td></tr>'; return; } pF.forEach(p=>{ const tr = document.createElement('tr'); const pM=JSON.stringify(p); const dPF=p.dataPedido?.toDate?p.dataPedido.toDate().toLocaleString('pt-BR',{day:'2-digit', month:'2-digit', year:'numeric'}):'N/A'; const dEF=p.dataEntrega?.toDate?p.dataEntrega.toDate().toLocaleDateString('pt-BR'):'N/A';
        const agora = new Date(); const dataEntrega = p.dataEntrega?.toDate ? p.dataEntrega.toDate() : null; let statusAtrasoClass = ''; if (dataEntrega && p.status !== 'Entregue' && p.status !== 'Cancelado') { const diffHoras = (dataEntrega - agora) / (1000 * 60 * 60); if (diffHoras < 0) { statusAtrasoClass = 'late'; } else if (diffHoras <= 1) { statusAtrasoClass = 'nearly-late'; } }
        tr.innerHTML=` <td class="pedido-numero ${statusAtrasoClass}">${p.numeroPedido}</td> <td class="cliente-nome">${p.clienteNome}</td> <td>${dPF}</td> <td>${dEF}</td> <td class="font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td> <td>${getStatusBadgeSimpleHTML(p.status)}</td> <td class="text-xs space-x-1.5 whitespace-nowrap"> <button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Ver Detalhes"><i class="fas fa-eye"></i></button> <button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Editar Pedido"><i class="fas fa-edit"></i></button> <button onclick="excluirPedido('${p.id}', '${p.numeroPedido}')" class="btn-icon-action text-red-500 hover:text-red-700" title="Excluir Pedido"><i class="fas fa-trash"></i></button> </td>`; tbody.appendChild(tr); }); }
        function carregarUltimosPedidos() { if(!auth.currentUser)return;const tb=document.getElementById('ultimosPedidosTableBody');if(!tb)return;tb.innerHTML=''; const pODB=[...todosOsPedidosCache].sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));const pPD=pODB.slice(0,5); if(pPD.length===0)tb.innerHTML=`<tr><td colspan="6" class="text-center text-slate-500 py-10">Nenhum pedido recente.</td></tr>`; else pPD.forEach(p=>{const tr=document.createElement('tr');const pPM=JSON.stringify(p);const dPF=p.dataPedido?.toDate?p.dataPedido.toDate().toLocaleDateString('pt-BR'):'N/A';
        const agora = new Date(); const dataEntrega = p.dataEntrega?.toDate ? p.dataEntrega.toDate() : null; let statusAtrasoClass = ''; if (dataEntrega && p.status !== 'Entregue' && p.status !== 'Cancelado') { const diffHoras = (dataEntrega - agora) / (1000 * 60 * 60); if (diffHoras < 0) { statusAtrasoClass = 'late'; } else if (diffHoras <= 1) { statusAtrasoClass = 'nearly-late'; } }
        tr.innerHTML=`<td class="pedido-numero font-medium ${statusAtrasoClass}">${p.numeroPedido}</td><td>${p.clienteNome}</td><td>${dPF}</td><td class="font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td><td>${getStatusBadgeSimpleHTML(p.status)}</td><td class="text-xs space-x-1 whitespace-nowrap"><button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pPM)}')))" class="btn-icon-action text-sky-600 hover:text-sky-700" title="Detalhes"><i class="fas fa-eye"></i></button><button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pPM)}')))" class="btn-icon-action text-indigo-600 hover:text-indigo-700" title="Editar"><i class="fas fa-edit"></i></button><button onclick="excluirPedido('${p.id}', '${p.numeroPedido}')" class="btn-icon-action text-red-600 hover:text-red-700" title="Excluir"><i class="fas fa-trash"></i></button></td>`;tb.appendChild(tr);}); }
        function carregarTodosPedidos() { 
            if(!auth.currentUser) return; 
            const q=query(collection(db,`artifacts/${shopInstanceAppId}/pedidos`)); 
            onSnapshot(q,(snap)=>{
                todosOsPedidosCache=[];
                snap.forEach(doc=>todosOsPedidosCache.push({id:doc.id,...doc.data()}));
                
                atualizarEstatisticasUsuario();
                carregarUltimosPedidos();
                if(activeSectionId==='telaInicial') atualizarDashboard();
                if(activeSectionId==='visualizarPedidos') renderizarListaCompletaPedidos();
                if(activeSectionId==='cadastrarCliente'&&clienteSelecionadoId) exibirDetalhesClienteEProcurarPedidos(clienteSelecionadoId);
            },e=>{console.error("Erro todos pedidos:",e);exibirMensagem("Erro todos pedidos.","error");}); 
        }
        function atualizarDashboard() { const mPH=document.getElementById('metricPedidosHoje'),mPP=document.getElementById('metricPedidosPendentes'),mFM=document.getElementById('metricFaturamentoMes'),mTC=document.getElementById('metricTotalClientes'); if(!mPH||!mPP||!mFM||!mTC)return; if(!todosOsPedidosCache)todosOsPedidosCache=[];if(!clientesCache)clientesCache=[];mTC.textContent=clientesCache.length; if(todosOsPedidosCache.length===0){mPH.textContent='0';mPP.textContent='0';mFM.textContent='R$ 0,00';return;} const h=new Date(),dH=h.getDate(),mH=h.getMonth(),aH=h.getFullYear(),iM=new Date(aH,mH,1); let pH=0,pP=0,fM=0; todosOsPedidosCache.forEach(p=>{if(!p.dataPedido||typeof p.dataPedido.toDate!=='function')return;const dP=p.dataPedido.toDate();if(dP.getDate()===dH&&dP.getMonth()===mH&&dP.getFullYear()===aH)pH++;if(p.status!=='Entregue'&&p.status!=='Cancelado')pP++;if(dP>=iM&&p.status!=='Cancelado')fM+=p.valorTotal||0;}); mPH.textContent=pH;mPP.textContent=pP;mFM.textContent=`R$ ${fM.toFixed(2).replace('.',',')}`; }
        
        window.prepararEdicaoPedido = (pObj) => {
            if (!pObj || !pObj.id) {
                exibirMensagem("Dados do pedido inválidos para edição.", "error");
                return;
            }
            editingOrderId = pObj.id;
            document.getElementById('editingOrderIdField').value = pObj.id;
            document.getElementById('formNovoPedido').reset();
            document.getElementById('itensPedidoContainer').innerHTML = '';
            document.getElementById('pagamentosContainer').innerHTML = '';
            itemPedidoCount = 0;
            pagamentoCount = 0;
            
            document.getElementById('pedidoDescricaoGeral').value = pObj.descricaoGeral || '';
            document.getElementById('pedidoClienteSearch').value = pObj.clienteNome || "";
            document.getElementById('pedidoClienteId').value = pObj.clienteId || "";
            document.getElementById('pedidoClienteResultados').classList.add('hidden');
            document.getElementById('pedidoVendedor').value = pObj.vendedorId || "";
            document.getElementById('pedidoStatus').value = pObj.status || "Aguardando Aprovação";
            const dETS = pObj.dataEntrega && typeof pObj.dataEntrega.seconds === 'number' ? new Timestamp(pObj.dataEntrega.seconds, pObj.dataEntrega.nanoseconds) : null;
            if (dETS) {
                const dED = dETS.toDate();
                document.getElementById('pedidoDataEntrega').value = dED.toISOString().split('T')[0];
                document.getElementById('pedidoHoraEntrega').value = dED.toTimeString().split(' ')[0].substring(0, 5);
            } else {
                document.getElementById('pedidoDataEntrega').value = "";
                document.getElementById('pedidoHoraEntrega').value = "";
            }
            pedidoImagemBase64 = pObj.imagemPreviewPedidoBase64 || null;
            const pI = document.getElementById('pedidoImagemPreview'), pH = document.getElementById('pedidoImagemPreviewPlaceholder');
            if (pedidoImagemBase64) {
                pI.src = pedidoImagemBase64;
                pI.classList.remove('hidden');
                pH.classList.add('hidden');
            } else {
                pI.src = "#";
                pI.classList.add('hidden');
                pH.classList.remove('hidden');
            }
            if (pObj.itens && Array.isArray(pObj.itens)) {
                pObj.itens.forEach(item => {
                    adicionarItemPedidoForm(item);
                });
            }
            if (pObj.pagamentos && Array.isArray(pObj.pagamentos)) {
                pObj.pagamentos.forEach(pgto => {
                    adicionarPagamentoForm();
                    const cPFI = pagamentoCount;
                    const pIE = document.getElementById(`pagamentoItem-${cPFI}`);
                    if (pIE) {
                        pIE.querySelector('.forma-pagamento').value = pgto.forma;
                        pIE.querySelector('.valor-pago').value = pgto.valorPago;
                        pIE.querySelector('.observacao-pagamento').value = pgto.observacao || "";
                    }
                });
            }
            atualizarValorTotalPedido();
            document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-save mr-1.5"></i>Atualizar Pedido';
            mostrarSecao('novoPedido', false);
            setActiveMenuLink('novoPedido');
        };

        window.excluirPedido = async (pedidoId, numeroPedido) => { 
            if (!auth.currentUser || !pedidoId) { 
                showNotification({ message: "Erro: ID do pedido ou utilizador inválido.", type: "error" });
                return; 
            } 
            const numPed = numeroPedido || `ID ${pedidoId.substring(0,6)}...`; 
            showNotification({ 
                message: `Tem certeza que deseja excluir o pedido ${numPed}? Esta ação não pode ser desfeita.`, 
                type: 'confirm-delete',
                confirmText: 'Excluir',
                cancelText: 'Cancelar',
                onConfirm: async () => { 
                    try { 
                        await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId)); 
                        console.log(`Pedido ${numPed} excluído.`); 
                        showNotification({ message: `Pedido ${numPed} excluído com sucesso!`, type: 'success' });
                        if (activeSectionId === 'cadastrarCliente' && clienteSelecionadoId) { 
                            exibirDetalhesClienteEProcurarPedidos(clienteSelecionadoId); 
                        } 
                    } catch (error) { 
                        console.error("Erro ao excluir pedido: ", error); 
                        showNotification({ message: `Erro ao excluir pedido ${numPed}.`, type: 'error' });
                    } 
                } 
            }); 
        }
        const produtoTipoPrecoEl = document.getElementById('produtoTipoPreco'); if (produtoTipoPrecoEl) togglePrecoFields(); 
    </script>
</body>
</html>
