<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gráfica Rápida - Design Interativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Variáveis do tema Interativo (escuro com gradientes) */
            --interactive-font-family: 'Inter', sans-serif;
            --interactive-bg-dark-primary: #1a1a2e; /* Fundo principal da aplicação */
            --interactive-bg-dark-secondary: #24283b; /* Fundo de containers de seção, barra de info usuário */
            --interactive-bg-dark-tertiary: #2a2f45; /* Fundo para tabelas/elementos destacados */
            --interactive-header-top-bg: #2c3e50; /* Fundo da barra do topo */
            
            --interactive-bg-gradient-main: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); /* Para cards principais, menu */
            --interactive-bg-gradient-alt: linear-gradient(135deg, #2575fc 0%, #5a89e0 100%); /* Para submenus, modais */
            --interactive-bg-gradient-header-text: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); /* Para títulos H1 */

            --interactive-text-light-primary: #ffffff;
            --interactive-text-light-secondary: #e0e7ff; /* Um pouco mais suave */
            --interactive-text-muted: #c0c5e0; /* Para texto menos importante, placeholders */
            
            --interactive-border-color-soft: rgba(255, 255, 255, 0.15);
            --interactive-border-color-medium: rgba(255, 255, 255, 0.25);
            --interactive-border-color-strong: rgba(255, 255, 255, 0.4);

            --interactive-input-bg: rgba(255, 255, 255, 0.08); /* Mantendo o fundo sutil */
            --interactive-input-border: #38bdf8; /* Cor da borda azul claro (sky-400) */
            --interactive-input-focus-border: #0ea5e9; /* Cor da borda em foco azul (sky-500) */
            --interactive-input-focus-shadow: 0 0 0 3px rgba(14, 165, 233, 0.4); /* Sombra azul claro */

            --interactive-button-primary-bg: rgba(255, 255, 255, 0.1);
            --interactive-button-primary-border: rgba(255, 255, 255, 0.3);
            --interactive-button-primary-hover-bg: rgba(255, 255, 255, 0.2);
            
            --interactive-button-secondary-bg: rgba(0,0,0,0.2);
            --interactive-button-secondary-border: rgba(255,255,255,0.15);
            --interactive-button-secondary-hover-bg: rgba(0,0,0,0.3);

            --interactive-button-action-text: #9fa8da; /* Para ícones de ação em tabelas */
            --interactive-button-action-hover-text: #ffffff;
            --interactive-button-action-hover-bg: rgba(255,255,255,0.1);

            --interactive-shadow-md: 0 8px 15px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.15);
            --interactive-shadow-lg: 0 15px 30px rgba(0,0,0,0.4), 0 10px 15px rgba(0,0,0,0.3);
            --interactive-shadow-xl: 0 20px 40px rgba(0,0,0,0.5), 0 12px 20px rgba(0,0,0,0.35);
        }

        body {
            font-family: 'Poppins', sans-serif; 
            background-color: var(--interactive-bg-dark-primary); 
            color: var(--interactive-text-light-secondary); 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease;
            display: flex; 
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            padding: 0; 
            box-sizing: border-box;
        }
        body.app-visible {
            font-family: var(--interactive-font-family);
            display: flex; /* Alterado para flex para o rodapé */
            flex-direction: column; /* Empilhar conteúdo e rodapé */
        }
        
        .hidden { display: none !important; }

        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--interactive-bg-dark-primary); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; font-family: var(--interactive-font-family); 
            z-index: 10000; box-sizing: border-box;
        }
        #loginScreen .login-card { background: var(--interactive-bg-gradient-main); padding: 35px 40px; border-radius: 12px; box-shadow: var(--interactive-shadow-lg); color: var(--interactive-text-light-primary); width: 100%; max-width: 400px; text-align: center; transition: all 0.3s ease-in-out; }
        #loginScreen .login-card:hover { transform: translateY(-5px); box-shadow: var(--interactive-shadow-xl); }
        #loginScreen .login-card img { margin-bottom: 1.5rem; height: 3rem; margin-left: auto; margin-right: auto; }
        #loginScreen h2.login-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.75rem; }
        #loginScreen p.login-subtitle { color: var(--interactive-text-light-secondary); margin-bottom: 2rem; font-size: 0.95rem; }
        #loginScreen input#codigoAcesso { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-input-border); color: var(--interactive-text-light-primary); border-radius: 8px; padding: 14px 18px; width: 100%; margin-bottom: 1.5rem; font-size: 1rem; box-sizing: border-box; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #loginScreen input#codigoAcesso::placeholder { color: var(--interactive-text-muted); opacity: 1; }
        #loginScreen input#codigoAcesso:focus { background-color: rgba(255,255,255,0.12); border-color: var(--interactive-input-focus-border); outline: none; box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        #loginScreen button.login-button { background-color: var(--interactive-button-primary-bg); border: 1px solid var(--interactive-button-primary-border); color: var(--interactive-text-light-primary); padding: 14px 20px; border-radius: 8px; width: 100%; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        #loginScreen button.login-button:hover { background-color: var(--interactive-button-primary-hover-bg); border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }
        #loginScreen button.login-button:focus { outline: none; box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        #loginScreen p#loginErrorMessage { color: #ffcdd2; background-color: rgba(239,83,80,0.2); border: 1px solid rgba(239,83,80,0.4); padding: 0.75rem 1rem; border-radius: 6px; margin-top: 1.5rem; font-size: 0.875rem; }
        #loginScreen p#loginErrorMessage.hidden { display: none; }

        /* Header Superior (Logotipo e Sair) */
        .exo-menu-container {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; 
            box-shadow: var(--interactive-shadow-md);
        }
        .exo-menu-container .header-top-row { 
            background-color: var(--interactive-header-top-bg); 
            color: var(--interactive-text-light-primary); 
            padding: 0.75rem 1.5rem; 
            border-bottom: 1px solid #34495e; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 60px; 
            box-sizing: border-box;
        }
        .exo-menu-container .header-top-row .logo-area { flex-shrink: 0; }
        .exo-menu-container .header-top-row .site-title { 
            color: #ecf0f1; 
            font-weight: 600; 
            font-family: var(--interactive-font-family); 
            font-size: 1.25rem; 
            text-align: center;
            flex-grow: 1; 
        }
        .exo-menu-container .header-top-row .actions-area { 
            flex-shrink: 0; 
            width: auto; 
        }
        .exo-menu-container .header-top-row .actions-area #logoutButton { 
            background-color: var(--interactive-button-secondary-bg); 
            border: 1px solid var(--interactive-button-secondary-border); 
            color: var(--interactive-text-light-secondary); 
            font-family: var(--interactive-font-family);
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
            border-radius: 8px;
        }
        .exo-menu-container .header-top-row .actions-area #logoutButton:hover { 
            background-color: var(--interactive-button-secondary-hover-bg); 
            color: var(--interactive-text-light-primary);
        }
        
        /* NOVA BARRA DE INFORMAÇÕES DO USUÁRIO */
        .exo-menu-container .user-info-bar {
            background-color: var(--interactive-bg-dark-secondary);
            color: var(--interactive-text-light-secondary);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 1rem;
            font-family: var(--interactive-font-family);
            border-bottom: 1px solid var(--interactive-border-color-soft); 
        }
        .exo-menu-container .user-info-bar #loggedInUserNameDisplay {
            font-weight: 600;
            font-size: 1rem;
            color: var(--interactive-text-light-primary);
        }
        .exo-menu-container .user-info-bar .user-stats {
            display: flex;
            gap: 1.5rem; 
            font-size: 0.875rem;
        }
        .exo-menu-container .user-info-bar .user-stats span {
            color: var(--interactive-text-muted);
        }
        .exo-menu-container .user-info-bar .user-stats strong {
            color: var(--interactive-text-light-primary);
            font-weight: 500;
        }
        
        /* Barra de Menu Principal (com gradiente) */
        .exo-menu-container .menu-bar-wrapper { background: var(--interactive-bg-gradient-main); padding: 10px 20px; border-radius: 0 0 10px 10px; box-shadow: var(--interactive-shadow-md); margin: 0; display: block; font-family: var(--interactive-font-family); position: relative; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu { list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; gap: 8px; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li { position: relative; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a { color: var(--interactive-text-light-primary); text-decoration: none; padding: 10px 15px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: all 0.2s ease-in-out; position: relative; overflow: hidden; font-size: 0.9rem; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a .icon,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a .icon { transition: transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a .icon .fa,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a .icon .fa { font-size: 16px; line-height: 1; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a::before { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: #f0f0f0; opacity: 0.8; transition: width 0.25s ease-in-out; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul > li > a.active::before { width: 70%; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active { background-color: rgba(255,255,255,0.1); color: #f0f0f0; }
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a:hover .icon,
        .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a.active .icon { transform: scale(1.05); }
        .exo-menu-container .menu-bar-wrapper li.drop-down > a .arrow { margin-left: auto; padding-left: 8px; transition: transform 0.3s ease-in-out; font-size: 0.7em; display: inline-block; }
        .exo-menu-container .menu-bar-wrapper li.drop-down:hover > a .arrow,
        .exo-menu-container .menu-bar-wrapper li.drop-down.open > a .arrow { transform: rotate(180deg); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul { list-style: none; padding: 8px 0; margin: 0; position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--interactive-bg-gradient-alt); border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.25); z-index: 100; min-width: 220px; opacity: 0; visibility: hidden; transform-origin: top center; transition: opacity 0.25s ease-in-out, visibility 0.25s ease-in-out, transform 0.25s ease-in-out; border-top: 1px solid var(--interactive-border-color-soft); }
        .exo-menu-container .menu-bar-wrapper li.drop-down:hover > ul.drop-down-ul { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0) scaleY(1); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a { padding: 10px 20px; display: block; white-space: nowrap; border-radius: 0; font-size: 0.85rem; }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a:hover,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a.active { background-color: rgba(255,255,255,0.15); transform: translateX(3px); color: var(--interactive-text-light-primary); }
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a:hover::before,
        .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a.active::before { width: 60%; }
        .exo-menu-container .menu-bar-wrapper .toggle-menu { display: none; color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-border-color-medium); padding: 8px 10px; border-radius: 6px; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); cursor: pointer; }
        .exo-menu-container .menu-bar-wrapper .toggle-menu:hover { background-color: rgba(255,255,255,0.1); }
        @media (max-width: 768px) {
            .exo-menu-container .header-top-row { flex-direction: column; height: auto; gap: 0.5rem; padding: 0.75rem; }
            .exo-menu-container .header-top-row .site-title { order: -1; margin-bottom: 0.5rem; font-size: 1.1rem;}
            .exo-menu-container .header-top-row .logo-area { order: -2; margin-bottom: 0.5rem; }
            .exo-menu-container .header-top-row .actions-area { width: 100%; text-align: center; margin-top: 0.5rem; }
            .exo-menu-container .user-info-bar { flex-direction: column; align-items: flex-start; text-align: left; padding: 0.75rem; }
            .exo-menu-container .user-info-bar .user-stats { flex-direction: column; gap: 0.5rem; align-items: flex-start;}

            .exo-menu-container .menu-bar-wrapper { padding: 10px; margin: 5px 0; } 
            .exo-menu-container .menu-bar-wrapper .toggle-menu { display: block; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu { display: none; flex-direction: column; align-items: stretch; width: 100%; gap: 5px; padding-top: 10px; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu.display { display: flex; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu > li { width: 100%; }
            .exo-menu-container .menu-bar-wrapper ul.exo-menu > li > a { justify-content: flex-start; padding: 12px 15px; }
            .exo-menu-container .menu-bar-wrapper ul.drop-down-ul { position: static; width: 100%; box-shadow: none; border-radius: 6px; margin-top: 5px; background: rgba(0,0,0,0.15); opacity: 1; visibility: visible; transform: none; display: none; padding: 5px; }
            .exo-menu-container .menu-bar-wrapper li.drop-down.open > ul.drop-down-ul { display: block; }
            .exo-menu-container .menu-bar-wrapper ul.drop-down-ul li a { padding: 10px 15px; }
        }

        /* Container de Conteúdo Principal da Aplicação */
        .main-layout { width: 100%; flex-grow: 1; /* Para ocupar o espaço restante */ }
        .content-area {  padding: 20px; width: 100%; box-sizing: border-box;} /* Adicionado padding lateral ao content-area */
        
        .main-content-section.interactive-theme { background-color: var(--interactive-bg-dark-secondary); color: var(--interactive-text-light-secondary); padding: 20px; border-radius: 16px; box-shadow: var(--interactive-shadow-lg); margin-bottom: 2rem; }
        .main-content-section.interactive-theme:hover { box-shadow: var(--interactive-shadow-xl); }
        .main-content-section.interactive-theme h2,
        .main-content-section.interactive-theme h3,
        .main-content-section.interactive-theme h4 { color: var(--interactive-text-light-primary); border-bottom-color: var(--interactive-border-color-soft); }
        .main-content-section.interactive-theme .label-text { color: var(--interactive-text-muted); font-weight: 500; }
        .main-content-section.interactive-theme .input-field,
        .main-content-section.interactive-theme select.input-field { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-input-border); color: var(--interactive-text-light-primary); border-radius: 8px; box-shadow: none; padding: 10px 14px; }
        .main-content-section.interactive-theme select.input-field option {
            background-color: var(--interactive-bg-dark-tertiary);
            color: var(--interactive-text-light-primary);
        }
        .main-content-section.interactive-theme .input-field::placeholder { color: var(--interactive-text-muted); opacity: 0.8; }
        .main-content-section.interactive-theme .input-field:focus,
        .main-content-section.interactive-theme select.input-field:focus { background-color: rgba(255,255,255,0.1); border-color: var(--interactive-input-focus-border); box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        .main-content-section.interactive-theme .input-field[readonly] { background-color: rgba(255,255,255,0.04) !important; color: var(--interactive-text-muted) !important; cursor: not-allowed; }
        .main-content-section.interactive-theme .input-field[readonly].text-\[\!var\(--color-primary\)\] { color: var(--interactive-text-light-primary) !important; }
        .main-content-section.interactive-theme .input-field[readonly].text-green-600 { color: theme('colors.green.400') !important; }
        .main-content-section.interactive-theme .input-field[readonly].text-red-600 { color: theme('colors.red.400') !important; }
        
        .main-content-section.interactive-theme .btn { font-family: var(--interactive-font-family); border-radius: 8px; }
        .main-content-section.interactive-theme .btn:hover { transform: translateY(-2px); }
        .main-content-section.interactive-theme .btn-primary { background-color: var(--interactive-button-primary-bg); color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-button-primary-border); }
        .main-content-section.interactive-theme .btn-primary:hover { background-color: var(--interactive-button-primary-hover-bg); }
        .main-content-section.interactive-theme .btn-secondary { background-color: var(--interactive-button-secondary-bg); color: var(--interactive-text-muted); border: 1px solid var(--interactive-button-secondary-border); }
        .main-content-section.interactive-theme .btn-secondary:hover { background-color: var(--interactive-button-secondary-hover-bg); color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .btn-outline { background-color: transparent; border: 2px solid var(--interactive-button-primary-border); color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .btn-outline:hover { background-color: var(--interactive-button-primary-bg); }
        .main-content-section.interactive-theme .btn-link { color: theme('colors.purple.400'); background: none; border: none; padding: 0; text-decoration: underline; }
        .main-content-section.interactive-theme .btn-link:hover { color: theme('colors.purple.300'); }

        /* Estilos de Alerta de Pedidos */
        .pedido-numero.late { color: theme('colors.red.400'); font-weight: 700; }
        .pedido-numero.late::before { content: '⚠️ '; color: theme('colors.red.400'); }
        .pedido-numero.nearly-late { color: theme('colors.amber.400'); font-weight: 700; }
        .pedido-numero.nearly-late::before { content: '⏳ '; color: theme('colors.amber.400'); }


        /* Tela Inicial Dashboard (#telaInicial) */
        #telaInicial.interactive-theme-dashboard { background-color: transparent; padding: 0; box-shadow: none; }
        #telaInicial.interactive-theme-dashboard .dashboard-header h1 { font-size: 2.25rem; font-weight: 800; color: var(--interactive-text-light-primary); text-align: center; background: var(--interactive-bg-gradient-header-text); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 25px; }
        #telaInicial.interactive-theme-dashboard .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard { background: var(--interactive-bg-gradient-main); padding: 20px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); color: var(--interactive-text-light-primary); display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s ease-in-out; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 25px rgba(40, 10, 90, 0.5); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-header-color { display:none; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-content { display: block; padding: 0;}
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .icon-wrapper-dashboard { width: 32px; height: 32px; background-color: rgba(255,255,255,0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard:hover .icon-wrapper-dashboard { transform: rotate(10deg) scale(1.1); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .icon-wrapper-dashboard i { font-size: 18px; color: var(--interactive-text-light-primary); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-label-dashboard { font-size: 0.9rem; font-weight: 500; color: var(--interactive-text-light-secondary); }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-value-dashboard { font-size: 1.8rem; font-weight: 700; margin-top: auto; line-height: 1.2; }
        #telaInicial.interactive-theme-dashboard .metric-card-dashboard .metric-value-dashboard.currency { font-size: 1.6rem; }

        #telaInicial.interactive-theme-dashboard .material-table-card { background-color: var(--interactive-bg-dark-tertiary); padding: 25px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); margin-top: 30px; }
        #telaInicial.interactive-theme-dashboard .material-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: none; padding: 0; }
        #telaInicial.interactive-theme-dashboard .material-table-header h2 { font-size: 1.5rem; font-weight: 700; color: var(--interactive-text-light-primary); }
        #telaInicial.interactive-theme-dashboard .material-table-header .btn-primary { background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(46,204,113,0.3); }
        #telaInicial.interactive-theme-dashboard .material-table-header .btn-primary:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 12px rgba(46,204,113,0.5); background: linear-gradient(45deg, #27ae60, #2ecc71); }
        #telaInicial.interactive-theme-dashboard .material-table-container { overflow-x: auto; }
        #telaInicial.interactive-theme-dashboard .material-data-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 700px; }
        #telaInicial.interactive-theme-dashboard .material-data-table th, #telaInicial.interactive-theme-dashboard .material-data-table td { padding: 12px 15px; text-align: left; vertical-align: middle; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th { background-color: rgba(76,84,119,0.5); color: var(--interactive-text-muted); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th:first-child { border-radius: 8px 0 0 8px; }
        #telaInicial.interactive-theme-dashboard .material-data-table thead th:last-child { border-radius: 0 8px 8px 0; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody tr { background-color: #343a50; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, background-color 0.2s ease; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody tr:hover { transform: scale(1.015); background-color: #3e445c; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #telaInicial.interactive-theme-dashboard .material-data-table td { font-size: 0.9rem; color: var(--interactive-text-light-secondary); }
        #telaInicial.interactive-theme-dashboard .material-data-table td.font-medium { color: var(--interactive-text-light-primary); } 
        #telaInicial.interactive-theme-dashboard .material-data-table tbody td:first-child { border-radius: 8px 0 0 8px; }
        #telaInicial.interactive-theme-dashboard .material-data-table tbody td:last-child { border-radius: 0 8px 8px 0; }
        #telaInicial.interactive-theme-dashboard .status-badge-simple { padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; display: inline-block; color: #fff; }
        #telaInicial.interactive-theme-dashboard .status-badge-simple.warning { background-color: #f39c12; } 
        #telaInicial.interactive-theme-dashboard .status-badge-simple.info { background-color: #3498db; }   
        #telaInicial.interactive-theme-dashboard .status-badge-simple.danger { background-color: #e74c3c; }  
        #telaInicial.interactive-theme-dashboard .status-badge-simple.success { background-color: #2ecc71; } 
        #telaInicial.interactive-theme-dashboard .btn-icon-action { color: var(--interactive-button-action-text); margin-right: 8px; transition: color 0.2s ease; }
        #telaInicial.interactive-theme-dashboard .btn-icon-action:hover { color: var(--interactive-button-action-hover-text); }
        #telaInicial.interactive-theme-dashboard .btn-icon-action i { font-size: 18px; }

        /* Tabela Visualizar Pedidos */
        #visualizarPedidos.interactive-theme { background-color: var(--interactive-bg-dark-secondary); }
        #visualizarPedidos.interactive-theme .pedidos-table-container { background-color: var(--interactive-bg-dark-tertiary); padding: 25px; border-radius: 12px; box-shadow: var(--interactive-shadow-md); }
        #visualizarPedidos.interactive-theme .pedidos-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 700px; }
        #visualizarPedidos.interactive-theme .pedidos-table th { background-color: rgba(76,84,119,0.5); color: var(--interactive-text-muted); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 15px; text-align: left; }
        #visualizarPedidos.interactive-theme .pedidos-table th:first-child { border-radius: 8px 0 0 8px; }
        #visualizarPedidos.interactive-theme .pedidos-table th:last-child { border-radius: 0 8px 8px 0; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody tr { background-color: #343a50; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, background-color 0.2s ease; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody tr:hover { transform: scale(1.015); background-color: #3e445c; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #visualizarPedidos.interactive-theme .pedidos-table td { padding: 12px 15px; text-align: left; vertical-align: middle; font-size: 0.9rem; color: var(--interactive-text-light-secondary); }
        #visualizarPedidos.interactive-theme .pedidos-table tbody td:first-child { border-radius: 8px 0 0 8px; }
        #visualizarPedidos.interactive-theme .pedidos-table tbody td:last-child { border-radius: 0 8px 8px 0; }
        #visualizarPedidos.interactive-theme .pedidos-table .pedido-numero,
        #visualizarPedidos.interactive-theme .pedidos-table .cliente-nome,
        #visualizarPedidos.interactive-theme .pedidos-table .font-medium { 
            color: var(--interactive-text-light-primary); font-weight: 500;
        }
        #visualizarPedidos.interactive-theme .btn-icon-action { color: var(--interactive-button-action-text); }
        #visualizarPedidos.interactive-theme .btn-icon-action:hover { color: var(--interactive-button-action-hover-text); background-color: var(--interactive-button-action-hover-bg); }
        #visualizarPedidos.interactive-theme .status-badge-simple { padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; display: inline-block; color: #fff; }
        .status-badge-simple.interactive-button { border: none; width: 100%; text-align: left; cursor: pointer; transition: filter 0.2s ease; }
        .status-badge-simple.interactive-button:hover { filter: brightness(1.15); }
        #visualizarPedidos.interactive-theme .status-badge-simple.warning { background-color: #f39c12; }
        #visualizarPedidos.interactive-theme .status-badge-simple.info { background-color: #3498db; }
        #visualizarPedidos.interactive-theme .status-badge-simple.danger { background-color: #e74c3c; }
        #visualizarPedidos.interactive-theme .status-badge-simple.success { background-color: #2ecc71; }
        #visualizarPedidos.interactive-theme .status-badge-simple.primary { background-color: theme('colors.indigo.500'); }
        #visualizarPedidos.interactive-theme .status-badge-simple.neutral { background-color: theme('colors.slate.500'); }

        #visualizarPedidos.interactive-theme .mb-6.p-4 { 
            background-color: rgba(255,255,255,0.03); 
            border-color: var(--interactive-border-color-soft);
        }

        .main-content-section.interactive-theme .image-drop-area { border-color: var(--interactive-border-color-medium); background-color: var(--interactive-input-bg); }
        .main-content-section.interactive-theme .image-drop-area:hover { border-color: var(--interactive-border-color-strong); background-color: rgba(255,255,255,0.1); }
        .main-content-section.interactive-theme .image-drop-area .text-\[\!var\(--color-text-muted\)\] { color: var(--interactive-text-muted) !important; }
        .main-content-section.interactive-theme .image-drop-area .text-slate-400 { color: var(--interactive-text-muted) !important; opacity: 0.7; }

        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-overlay .modal-content-wrapper {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content-wrapper {
            transform: scale(1);
        }
        .modal-overlay.interactive-theme-modal .modal-content-wrapper { 
            background: var(--interactive-bg-gradient-alt); color: var(--interactive-text-light-primary); 
            border-radius: 12px; 
            box-shadow: var(--interactive-shadow-xl); 
        }
        .modal-overlay.interactive-theme-modal .modal-content-wrapper .h-2 { background-color: rgba(255,255,255,0.2); }
        .modal-overlay.interactive-theme-modal .universal-modal-close-x { color: var(--interactive-text-muted); }
        .modal-overlay.interactive-theme-modal .universal-modal-close-x:hover { color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal h3,
        .modal-overlay.interactive-theme-modal .universal-modal-title { color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal p, 
        .modal-overlay.interactive-theme-modal .universal-modal-body,
        .modal-overlay.interactive-theme-modal .text-slate-600 { color: var(--interactive-text-light-secondary); }
        .modal-overlay.interactive-theme-modal .label-text { color: var(--interactive-text-muted); }
        .modal-overlay.interactive-theme-modal .input-field { background-color: var(--interactive-input-bg); border-color: var(--interactive-input-border); color: var(--interactive-text-light-primary); }
        .modal-overlay.interactive-theme-modal select.input-field option {
            background-color: var(--interactive-bg-dark-tertiary);
            color: var(--interactive-text-light-primary);
        }
        .modal-overlay.interactive-theme-modal .input-field:focus { box-shadow: 0 0 0 3px var(--interactive-input-focus-shadow); }
        .modal-overlay.interactive-theme-modal .universal-modal-footer { background-color: rgba(0,0,0,0.25); border-top-color: var(--interactive-border-color-soft); }
        .modal-overlay.interactive-theme-modal .btn-primary { background-color: var(--interactive-button-primary-bg); color: var(--interactive-text-light-primary); border: 1px solid var(--interactive-button-primary-border); }
        .modal-overlay.interactive-theme-modal .btn-primary:hover { background-color: var(--interactive-button-primary-hover-bg); }
        .modal-overlay.interactive-theme-modal .btn-secondary { background-color: var(--interactive-button-secondary-bg); color: var(--interactive-text-muted); border: 1px solid var(--interactive-button-secondary-border); }
        .modal-overlay.interactive-theme-modal .btn-secondary:hover { background-color: var(--interactive-button-secondary-hover-bg); color: var(--interactive-text-light-primary); }
        
        /* Notification Bar Styles */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            color: var(--interactive-text-light-primary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10001; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transform: translateY(-150%); 
            opacity: 0;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            font-family: var(--interactive-font-family);
            box-sizing: border-box;
        }
        .notification-bar.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-bar .notification-content { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .notification-bar #notificationIcon i { font-size: 1.5rem; }
        .notification-bar #notificationMessage { font-size: 0.95rem; flex-grow: 1; }
        .notification-bar #notificationActions { display: flex; gap: 10px; }
        .notification-bar #notificationActions .btn { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; color: var(--interactive-text-light-primary); border: 1px solid transparent; cursor: pointer; }
        .notification-bar #notificationActions .btn-confirm-action { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); }
        .notification-bar #notificationActions .btn-confirm-action:hover { background-color: rgba(255,255,255,0.3); }
        .notification-bar #notificationActions .btn-cancel-action { background-color: rgba(0,0,0,0.25); border-color: rgba(255,255,255,0.15); }
        .notification-bar #notificationActions .btn-cancel-action:hover { background-color: rgba(0,0,0,0.35); }

        .notification-bar.success { background: linear-gradient(135deg, theme('colors.green.600') 0%, theme('colors.green.400') 100%); }
        .notification-bar.success #notificationIcon i { color: theme('colors.green.100'); }
        .notification-bar.error { background: linear-gradient(135deg, theme('colors.red.700') 0%, theme('colors.red.500') 100%); }
        .notification-bar.error #notificationIcon i { color: theme('colors.red.100'); }
        .notification-bar.warning { background: linear-gradient(135deg, theme('colors.amber.600') 0%, theme('colors.amber.400') 100%); }
        .notification-bar.warning #notificationIcon i { color: theme('colors.amber.100'); }
        .notification-bar.info { background: linear-gradient(135deg, theme('colors.sky.700') 0%, theme('colors.sky.500') 100%); }
        .notification-bar.info #notificationIcon i { color: theme('colors.sky.100'); }
        .notification-bar.confirm-delete { background: linear-gradient(135deg, theme('colors.red.700') 0%, theme('colors.red.500') 100%); }
        .notification-bar.confirm-delete #notificationIcon i { color: theme('colors.red.100'); }
        .notification-bar.confirm-delete #notificationActions .btn-confirm-action { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); } 
        .notification-bar.confirm-delete #notificationActions .btn-confirm-action:hover { background-color: rgba(255,255,255,0.3); }
        
        .main-content-section.interactive-theme #pedidoClienteResultados { background-color: #3a3163; border-color: var(--interactive-border-color-medium); }
        .main-content-section.interactive-theme #pedidoClienteResultados div { color: var(--interactive-text-muted); }
        .main-content-section.interactive-theme #pedidoClienteResultados div:hover { background-color: #4a3c80; color: var(--interactive-text-light-primary); }
        
        .main-content-section.interactive-theme .item-list-display { background-color: var(--interactive-input-bg); border: 1px solid var(--interactive-border-color-soft); color: var(--interactive-text-muted); padding: 0.65rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; }
        .main-content-section.interactive-theme .item-list-display strong { color: var(--interactive-text-light-primary); }
        .main-content-section.interactive-theme .item-list-display .meta { font-size: 0.8rem; opacity: 0.8; }
        .main-content-section.interactive-theme .item-list-display.selected { background-color: rgba(106,27,154,0.5); border-color: rgba(171,71,188,0.7); }
        .main-content-section.interactive-theme #infoCliente { background-color: rgba(0,0,0,0.15); border-color: var(--interactive-border-color-soft); color: var(--interactive-text-muted); }
        .main-content-section.interactive-theme #pedidosDoClienteLista { background-color: rgba(0,0,0,0.1); border-color: var(--interactive-border-color-soft); }
        .main-content-section.interactive-theme #pedidosDoClienteLista .p-2\.5 { border-bottom-color: var(--interactive-border-color-soft) !important; }
        .main-content-section.interactive-theme #pedidosDoClienteLista .font-medium { color: theme('colors.purple.300') !important; }
        #appContainer .main-layout { /* O padding-top é controlado pelo JS (ajustarPaddingBody) */ }

        /* NOVO RODAPÉ */
        .site-footer {
            background-color: var(--interactive-header-top-bg); /* Mesmo fundo da barra do topo */
            color: var(--interactive-text-muted);
            padding: 1.5rem 1rem;
            text-align: center;
            font-family: var(--interactive-font-family);
            font-size: 0.875rem;
            border-top: 1px solid #34495e;
            margin-top: auto; /* Empurra o rodapé para baixo se o conteúdo for curto */
        }
        .site-footer p {
            margin: 0.25rem 0;
        }
        .site-footer strong {
            color: var(--interactive-text-light-secondary);
        }

    </style>
</head>
<body>
    <!-- Barra de Notificações (NOVA) -->
    <div id="notificationBar" class="notification-bar">
        <div class="notification-content">
            <span id="notificationIcon" class="text-xl"></span>
            <span id="notificationMessage"></span>
        </div>
        <div id="notificationActions">
            <!-- Botões serão injetados aqui -->
        </div>
    </div>

    <!-- Container da Tela de Login -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="https://placehold.co/150x60/0ea5e9/FFFFFF?text=SuaGraficaPRO&font=poppins" alt="Logo Gráfica PRO">
            <h2 class="login-title">Acesso ao Sistema</h2>
            <p class="login-subtitle">Insira o seu código de funcionário para continuar.</p>
            <form id="loginForm">
                <input type="password" id="codigoAcesso" placeholder="Código de Acesso" required>
                <button type="submit" class="login-button">Entrar</button>
            </form>
            <p id="loginErrorMessage" class="hidden"></p>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="appContainer" class="hidden">
        <div class="exo-menu-container"> <!-- Este é o container geral do cabeçalho agora -->
            <div class="header-top-row flex justify-between items-center">
                <div class="logo-area flex-shrink-0">
                    <img src="https://placehold.co/120x32/ffffff/1e293b?text=SuaLogo&font=poppins" alt="Logo Gráfica" class="h-6 sm:h-8">
                </div>
                <h1 class="site-title text-lg sm:text-xl">Sistema de Gestão PRO</h1>
                <div class="actions-area flex-shrink-0"> 
                    <button id="logoutButton" class="text-xs py-1.5 px-3 rounded"><i class="fas fa-sign-out-alt mr-1.5"></i>Sair</button>
                </div>
            </div>

            <div class="user-info-bar">
                <span id="loggedInUserNameDisplay" class="font-semibold"></span>
                <div class="user-stats">
                    <span>Pedidos Mês: <strong id="userPedidosMes">0</strong></span>
                    <span>Em Finalização: <strong id="userPedidosFinalizacao">0</strong></span>
                    <span>Finalizados: <strong id="userPedidosFinalizados">0</strong></span>
                </div>
            </div>
        
            <div class="menu-bar-wrapper"> 
                <ul class="exo-menu clearfix">
                    <li data-role-access="all">
                        <a href="#" onclick="mostrarSecao('telaInicial', true)" data-section="telaInicial">
                            <span class="icon"><i class="fa fa-home"></i></span>Home
                        </a>
                    </li>
                    <li data-role-access="admin,vendedor">
                        <a href="#" onclick="mostrarSecao('novoPedido', true)" data-section="novoPedido">
                            <span class="icon"><i class="fa fa-plus"></i></span>Novo Pedido
                        </a>
                    </li>
                    <li class="drop-down" data-role-access="admin,vendedor,designer,impressor,producao" id="dropdownCadastrosMenu">
                        <a href="#">
                            <span class="icon"><i class="fa fa-archive"></i></span>
                            Cadastros
                            <span class="arrow">&#9662;</span>
                        </a>
                        <ul class="drop-down-ul">
                            <li data-role-access="admin,vendedor">
                                <a href="#" onclick="mostrarSecao('cadastrarCliente', true)" data-section="cadastrarCliente">
                                     <span class="icon"><i class="fa fa-users"></i></span>Clientes
                                </a>
                            </li>
                            <li data-role-access="admin,designer">
                                <a href="#" onclick="mostrarSecao('cadastrarProduto', true)" data-section="cadastrarProduto">
                                    <span class="icon"><i class="fa fa-box"></i></span>Produtos
                                </a>
                            </li>
                            <li data-role-access="admin">
                                <a href="#" onclick="mostrarSecao('cadastrarFuncionario', true)" data-section="cadastrarFuncionario">
                                    <span class="icon"><i class="fa fa-user-tie"></i></span>Funcionários
                                </a>
                            </li>
                            <li data-role-access="admin">
                                <a href="#" onclick="mostrarSecao('cadastrarFornecedor', true)" data-section="cadastrarFornecedor">
                                    <span class="icon"><i class="fa fa-truck"></i></span>Fornecedores
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li data-role-access="all">
                        <a href="#" onclick="mostrarSecao('visualizarPedidos', true)" data-section="visualizarPedidos">
                            <span class="icon"><i class="fa fa-list-alt"></i></span>Pedidos
                        </a>
                    </li>
                </ul>
                <a href="#" class="toggle-menu"><i class="fas fa-bars"></i></a>
            </div>
        </div>

        <div class="main-layout"> <main id="mainContentArea" class="content-area w-full"> 
                <section id="telaInicial" class="main-content-section max-w-7xl mx-auto"> 
                    <h1 class="dashboard-header">Painel de Controlo</h1> 
                    <div class="summary-cards">
                        <div class="metric-card-dashboard card">
                            <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-calendar-day"></i></span>
                                <h3 class="metric-label-dashboard card-title">Pedidos Hoje</h3>
                            </div>
                            <p id="metricPedidosHoje" class="metric-value-dashboard card-value">0</p>
                        </div>
                        <div class="metric-card-dashboard card">
                             <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-hourglass-half"></i></span>
                                <h3 class="metric-label-dashboard card-title">Pendentes</h3>
                            </div>
                            <p id="metricPedidosPendentes" class="metric-value-dashboard card-value">0</p>
                        </div>
                        <div class="metric-card-dashboard card">
                            <div class="card-header">
                                <span class="icon-wrapper-dashboard icon"><i class="fas fa-dollar-sign"></i></span>
                                <h3 class="metric-label-dashboard card-title">Faturamento Mês</h3>
                            </div>
                            <p id="metricFaturamentoMes" class="metric-value-dashboard card-value currency">R$0,00</p>
                        </div>
                        <div class="metric-card-dashboard card">
                           <div class="card-header">
                               <span class="icon-wrapper-dashboard icon"><i class="fas fa-users"></i></span>
                                <h3 class="metric-label-dashboard card-title">Total Clientes</h3>
                            </div>
                            <p id="metricTotalClientes" class="metric-value-dashboard card-value">0</p>
                        </div>
                    </div>

                    <div class="material-table-card recent-orders">
                        <div class="material-table-header recent-orders-header">
                            <h2>Últimos Pedidos</h2>
                            <button onclick="mostrarSecao('visualizarPedidos', true)" class="btn btn-primary btn-view-all text-xs py-2 px-3"><i class="fas fa-list-ul mr-2"></i>Ver Todos</button>
                        </div>
                        <div class="material-table-container orders-table-wrapper">
                            <table class="material-data-table orders-table">
                                <thead>
                                    <tr>
                                        <th>Nº Pedido</th>
                                        <th>Cliente</th>
                                        <th>Data</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ultimosPedidosTableBody">
                                    <tr><td colspan="6" class="text-center py-10">Nenhum pedido recente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="novoPedido" class="main-content-section interactive-theme hidden max-w-3xl mx-auto">
                    <h2 class="text-xl font-semibold mb-6 pb-4 border-b">Novo Pedido</h2>
                    <form id="formNovoPedido" class="space-y-6">
                        <input type="hidden" id="editingOrderIdField"> 
                        <div>
                            <label for="pedidoDataHora" class="label-text">Data e Hora do Pedido:</label>
                            <input type="text" id="pedidoDataHora" class="input-field" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="relative">
                                <label for="pedidoClienteSearch" class="label-text">Cliente:</label>
                                <input type="text" id="pedidoClienteSearch" class="input-field" placeholder="Pesquisar cliente...">
                                <input type="hidden" id="pedidoClienteId">
                                <div id="pedidoClienteResultados" class="absolute z-20 w-full border rounded-md mt-1 shadow-lg max-h-48 overflow-y-auto hidden">
                                </div>
                                <button type="button" onclick="abrirModalNovoClienteRapido()" class="mt-2 btn btn-link text-xs">Registar novo cliente</button>
                            </div>
                            <div>
                                <label for="pedidoVendedor" class="label-text">Funcionário (Vendedor):</label>
                                <select id="pedidoVendedor" class="input-field">
                                    <option value="">Selecione um funcionário</option>
                                </select>
                            </div>
                        </div>

                        <div class="pt-5 border-t">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Itens do Pedido</h3>
                            </div>
                            <div id="itensPedidoContainer" class="space-y-4"></div>
                            <button type="button" onclick="adicionarItemPedidoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-plus mr-1.5"></i>Adicionar Produto</button>
                        </div>
                        
                        <div class="pt-5 border-t space-y-4">
                            <div>
                                <label for="pedidoDescricaoGeral" class="label-text">Descrição Geral do Pedido:</label>
                                <textarea id="pedidoDescricaoGeral" rows="2" class="input-field text-lg font-semibold" placeholder="Ex: Kit Adesivos para Vitrine..."></textarea>
                            </div>

                            <div>
                                <label class="label-text">Preview do Pedido (Opcional):</label>
                                <div id="pedidoImageDropArea" class="image-drop-area" onclick="document.getElementById('pedidoImagemFile').click();">
                                    <input type="file" accept="image/*" class="hidden" id="pedidoImagemFile" onchange="handleImagemFilePedido(event)">
                                    <img src="#" alt="Preview do Pedido" id="pedidoImagemPreview" class="hidden preview-image">
                                    <span id="pedidoImagemPreviewPlaceholder" class="text-sm">
                                        <i class="fas fa-image fa-2x mb-1.5"></i><br>
                                        Cole ou clique para carregar imagem
                                    </span>
                                </div>
                            </div>
                        </div>


                        <div class="pt-5 border-t">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Detalhes do Pagamento</h3>
                            </div>
                            <div id="pagamentosContainer" class="space-y-4">
                            </div>
                            <button type="button" onclick="adicionarPagamentoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-dollar-sign mr-1.5"></i>Adicionar Pagamento</button>
                            
                            <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label class="label-text">Valor Total do Pedido:</label>
                                    <input type="text" id="pedidoValorTotal" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                                <div>
                                    <label class="label-text">Total Pago:</label>
                                    <input type="text" id="pedidoTotalPago" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                                 <div>
                                    <label class="label-text">Valor Restante:</label>
                                    <input type="text" id="pedidoValorRestante" class="input-field text-lg font-semibold" readonly value="R$ 0,00">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-5 border-t">
                            <div class="grid grid-cols-2 gap-4">
                                 <div>
                                    <label for="pedidoDataEntrega" class="label-text">Data Entrega:</label>
                                    <input type="date" id="pedidoDataEntrega" class="input-field">
                                </div>
                                <div>
                                    <label for="pedidoHoraEntrega" class="label-text">Hora Entrega:</label>
                                    <input type="time" id="pedidoHoraEntrega" class="input-field">
                                </div>
                            </div>
                             <div>
                                <label for="pedidoStatus" class="label-text">Estado do Pedido:</label>
                                <select id="pedidoStatus" class="input-field">
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                       
                        <div class="flex justify-end space-x-3 pt-6 border-t">
                            <button type="button" onclick="mostrarSecao('telaInicial', true); document.getElementById('editingOrderIdField').value = ''; document.querySelector('#formNovoPedido button[type=\'submit\']').innerHTML = '<i class=\'fas fa-check mr-1.5\'></i>Guardar Pedido';" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-check mr-1.5"></i>Guardar Pedido</button>
                        </div>
                    </form>
                </section>

                <section id="cadastrarCliente" class="main-content-section interactive-theme hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-5">Registar Cliente</h2>
                            <form id="formCadastrarCliente" class="space-y-4">
                                <div>
                                    <label for="clienteNome" class="label-text">Nome Completo / Razão Social:</label>
                                    <input type="text" id="clienteNome" class="input-field" required>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteTipo" class="label-text">Tipo de Cliente:</label>
                                        <select id="clienteTipo" class="input-field">
                                            <option value="final">Cliente Final</option>
                                            <option value="revenda">Revenda</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="clienteTelefone" class="label-text">Telefone:</label>
                                        <input type="tel" id="clienteTelefone" class="input-field">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteEmail" class="label-text">Email:</label>
                                        <input type="email" id="clienteEmail" class="input-field">
                                    </div>
                                    <div>
                                        <label for="clienteCpfCnpj" class="label-text">CPF/CNPJ (Opcional):</label>
                                        <input type="text" id="clienteCpfCnpj" class="input-field">
                                    </div>
                                </div>
                                <div>
                                    <label for="clienteEndereco" class="label-text">Endereço (Opcional):</label>
                                    <input type="text" id="clienteEndereco" class="input-field">
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Cliente</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-lg font-semibold mb-1">Clientes Registados</h3>
                            <div class="search-input-wrapper relative">
                                <i class="fas fa-search absolute top-1/2 left-3.5 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="pesquisaClienteInput" class="input-field w-full pl-10" placeholder="Pesquisar cliente por nome, telefone...">
                            </div>
                            <div id="listaClientes" class="space-y-2.5 max-h-60 sm:max-h-72 lg:max-h-[calc(100vh-340px)] overflow-y-auto pr-1 mt-3">
                                <p class="text-sm text-center py-3">Nenhum cliente registado.</p>
                            </div>
                            
                            <div id="detalhesClienteSelecionado" class="mt-6 hidden">
                                <h4 class="text-md font-semibold mb-2 border-t pt-4">Detalhes do Cliente</h4>
                                <div id="infoCliente" class="p-3 border rounded-md mb-4 text-sm space-y-1">
                                </div>
                                <h4 class="text-md font-semibold mb-2">Pedidos do Cliente</h4>
                                <div id="pedidosDoClienteLista" class="space-y-2.5 max-h-40 sm:max-h-48 overflow-y-auto pr-1 border rounded-md p-2">
                                    <p class="text-xs text-center py-2">Selecione um cliente para ver os seus pedidos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="cadastrarProduto" class="main-content-section interactive-theme hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-5">Registar Produto</h2>
                            <form id="formCadastrarProduto" class="space-y-4">
                                <div>
                                    <label for="produtoNome" class="label-text">Nome do Produto:</label>
                                    <input type="text" id="produtoNome" class="input-field" required> </div>
                                <div>
                                    <label for="produtoTipoPreco" class="label-text">Tipo de Precificação:</label>
                                    <select id="produtoTipoPreco" class="input-field" onchange="togglePrecoFields()">
                                        <option value="unidade">Por Unidade/Pacote</option>
                                        <option value="metro">Por Metro Quadrado (m²)</option>
                                    </select>
                                </div>
                                <div id="precoUnidadeFields">
                                    <label for="produtoPrecoUnidade" class="label-text">Preço Unitário (R$):</label>
                                    <input type="number" step="0.01" id="produtoPrecoUnidade" class="input-field">
                                </div>
                                <div id="precoMetroFields" class="hidden">
                                    <label for="produtoPrecoMetro" class="label-text">Preço por Metro Quadrado (R$/m²):</label>
                                    <input type="number" step="0.01" id="produtoPrecoMetro" class="input-field">
                                </div>
                                <div>
                                    <label for="produtoDescricao" class="label-text">Descrição (Opcional):</label>
                                    <textarea id="produtoDescricao" rows="3" class="input-field"></textarea>
                                    </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-box mr-1.5"></i>Guardar Produto</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-md font-semibold mb-3">Produtos Registados</h3>
                            <div id="listaProdutos" class="space-y-2.5 max-h-[calc(100vh-300px)] overflow-y-auto pr-1">
                                <p class="text-sm text-center py-3">Nenhum produto registado.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFuncionario" class="main-content-section interactive-theme hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-5">Registar Funcionário</h2>
                            <form id="formCadastrarFuncionario" class="space-y-4">
                                <div>
                                    <label for="funcionarioNome" class="label-text">Nome do Funcionário:</label>
                                    <input type="text" id="funcionarioNome" class="input-field" required>
                                </div>
                                <div>
                                    <label for="funcionarioContato" class="label-text">Contacto (Telefone/Email - Opcional):</label>
                                    <input type="text" id="funcionarioContato" class="input-field">
                                </div>
                                <div>
                                    <label for="funcionarioCargo" class="label-text">Cargo:</label>
                                    <select id="funcionarioCargo" class="input-field">
                                        <option value="admin">Administrador</option>
                                        <option value="vendedor" selected>Vendedor</option>
                                        <option value="producao">Produção</option>
                                        <option value="impressor">Impressor</option>
                                        <option value="designer">Designer</option>
                                        <option value="freelancer">Freelancer</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="funcionarioCodigoAcesso" class="label-text">Código de Acesso:</label>
                                    <input type="text" id="funcionarioCodigoAcesso" class="input-field" placeholder="Ex: 123456" required>
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Funcionário</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-md font-semibold mb-3">Funcionários Registados</h3>
                            <div id="listaFuncionarios" class="space-y-2.5 max-h-[calc(100vh-300px)] overflow-y-auto pr-1">
                                <p class="text-sm text-center py-3">Nenhum funcionário registado.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFornecedor" class="main-content-section interactive-theme hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold mb-5">Registar Fornecedor</h2>
                            <form id="formCadastrarFornecedor" class="space-y-4">
                                <div>
                                    <label for="fornecedorNome" class="label-text">Nome do Fornecedor:</label>
                                    <input type="text" id="fornecedorNome" class="input-field" required>
                                </div>
                                <div>
                                    <label for="fornecedorContato" class="label-text">Contacto (Telefone/Email):</label>
                                    <input type="text" id="fornecedorContato" class="input-field">
                                </div>
                                <div>
                                    <label for="fornecedorMaterial" class="label-text">Tipo de Material Fornecido:</label>
                                    <input type="text" id="fornecedorMaterial" class="input-field">
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-1.5"></i>Guardar Fornecedor</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-md font-semibold mb-3">Fornecedores Registados</h3>
                            <div id="listaFornecedores" class="space-y-2.5 max-h-[calc(100vh-300px)] overflow-y-auto pr-1">
                                <p class="text-sm text-center py-3">Nenhum fornecedor registado.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="visualizarPedidos" class="main-content-section interactive-theme hidden">
                     <h2 class="text-xl font-semibold mb-5 pb-3 border-b">Todos os Pedidos</h2>
                    <div class="mb-6 p-4 border rounded-lg bg-[rgba(255,255,255,0.05)]">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3 items-end">
                            <div>
                                <label for="filtroNomeCliente" class="label-text text-xs">Nome do Cliente:</label>
                                <input type="text" id="filtroNomeCliente" class="input-field input-field-sm py-1.5" placeholder="Pesquisar nome...">
                            </div>
                            <div>
                                <label for="filtroNumeroPedido" class="label-text text-xs">Nº do Pedido:</label>
                                <input type="text" id="filtroNumeroPedido" class="input-field input-field-sm py-1.5" placeholder="Pesquisar número...">
                            </div>
                            <div>
                                <label for="filtroDataPedido" class="label-text text-xs">Data do Pedido:</label>
                                <input type="date" id="filtroDataPedido" class="input-field input-field-sm py-1.5">
                            </div>
                            <div>
                                <label for="filtroMaterialProduto" class="label-text text-xs">Produto/Material (nos Itens):</label>
                                <input type="text" id="filtroMaterialProduto" class="input-field input-field-sm py-1.5" placeholder="Pesquisar item...">
                            </div>
                            <div>
                                <label for="filtroStatusPedido" class="label-text text-xs">Estado do Pedido:</label>
                                <select id="filtroStatusPedido" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Estados</option>
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroVendedor" class="label-text text-xs">Funcionário (Vendedor):</label>
                                <select id="filtroVendedor" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Funcionários</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroClassificacaoPedido" class="label-text text-xs">Classificar por:</label>
                                <select id="filtroClassificacaoPedido" class="input-field input-field-sm py-1.5">
                                    <option value="dataPedido_desc">Data Pedido (Mais Recentes)</option>
                                    <option value="dataPedido_asc">Data Pedido (Mais Antigos)</option>
                                    <option value="dataEntrega_asc">Data Entrega (Mais Próximos)</option>
                                    <option value="dataEntrega_desc">Data Entrega (Mais Distantes)</option>
                                    <option value="clienteNome_asc">Nome Cliente (A-Z)</option>
                                    <option value="clienteNome_desc">Nome Cliente (Z-A)</option>
                                    <option value="numeroPedido_asc">Nº Pedido (Crescente)</option>
                                    <option value="numeroPedido_desc">Nº Pedido (Decrescente)</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 lg:col-span-1 lg:col-start-3">
                                 <button id="limparFiltrosPedidos" class="btn btn-secondary w-full text-sm py-2"><i class="fas fa-times mr-2"></i>Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    <div id="listaTodosPedidosContainer" class="pedidos-table-container">
                        <table class="pedidos-table">
                            <thead>
                                <tr>
                                    <th>Nº Pedido</th>
                                    <th>Cliente</th>
                                    <th>Data Pedido</th>
                                    <th>Data Entrega</th>
                                    <th>Valor Total</th>
                                    <th>Estado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaTodosPedidos">
                                <tr><td colspan="7" class="text-center py-10">Nenhum pedido encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
        <footer class="site-footer">
            <p>Sistema de Gestão PRO para Gráficas: Crie pedidos, controle clientes, produtos e o fluxo de produção de forma eficiente.</p>
            <p><strong>Criado por: Jeffweb3</strong></p>
        </footer>
    </div>

    <!-- ===== MODAIS ===== -->

    <!-- Modal Novo Cliente Rápido -->
    <div id="modalNovoClienteRapidoOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-md">
            <div class="h-2"></div> 
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalNovoClienteRapido()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Registo Rápido de Cliente</h3>
                <form id="formNovoClienteRapido" class="space-y-4">
                    <div>
                        <label for="clienteRapidoNome" class="label-text">Nome:</label>
                        <input type="text" id="clienteRapidoNome" class="input-field" required>
                    </div>
                    <div>
                        <label for="clienteRapidoTelefone" class="label-text">Telefone:</label>
                        <input type="tel" id="clienteRapidoTelefone" class="input-field">
                    </div>
                    <div>
                        <label for="clienteRapidoTipo" class="label-text">Tipo de Cliente:</label>
                        <select id="clienteRapidoTipo" class="input-field">
                            <option value="final" selected>Cliente Final</option>
                            <option value="revenda">Revenda</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2.5 pt-4">
                        <button type="button" onclick="fecharModalNovoClienteRapido()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Cliente -->
    <div id="modalEditarClienteOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-lg">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarCliente()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Editar Cliente</h3>
                <form id="formEditarCliente" class="space-y-4">
                    <input type="hidden" id="clienteIdParaEditar">
                    <div>
                        <label for="clienteNomeEditar" class="label-text">Nome / Razão Social:</label>
                        <input type="text" id="clienteNomeEditar" class="input-field" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="clienteTipoEditar" class="label-text">Tipo de Cliente:</label>
                            <select id="clienteTipoEditar" class="input-field">
                                <option value="final">Cliente Final</option>
                                <option value="revenda">Revenda</option>
                            </select>
                        </div>
                        <div>
                            <label for="clienteTelefoneEditar" class="label-text">Telefone:</label>
                            <input type="tel" id="clienteTelefoneEditar" class="input-field">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="clienteEmailEditar" class="label-text">Email:</label>
                            <input type="email" id="clienteEmailEditar" class="input-field">
                        </div>
                        <div>
                            <label for="clienteCpfCnpjEditar" class="label-text">CPF/CNPJ:</label>
                            <input type="text" id="clienteCpfCnpjEditar" class="input-field">
                        </div>
                    </div>
                    <div>
                        <label for="clienteEnderecoEditar" class="label-text">Endereço:</label>
                        <input type="text" id="clienteEnderecoEditar" class="input-field">
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="fecharModalEditarCliente()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Produto -->
    <div id="modalEditarProdutoOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-md">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarProduto()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Editar Produto</h3>
                <form id="formEditarProduto" class="space-y-4">
                    <input type="hidden" id="produtoIdParaEditar">
                    <div>
                        <label for="produtoNomeEditar" class="label-text">Nome do Produto:</label>
                        <input type="text" id="produtoNomeEditar" class="input-field" required>
                    </div>
                    <div>
                        <label for="produtoTipoPrecoEditar" class="label-text">Tipo de Precificação:</label>
                        <select id="produtoTipoPrecoEditar" class="input-field" onchange="togglePrecoFieldsEditar()">
                            <option value="unidade">Por Unidade/Pacote</option>
                            <option value="metro">Por Metro Quadrado (m²)</option>
                        </select>
                    </div>
                    <div id="precoUnidadeFieldsEditar">
                        <label for="produtoPrecoUnidadeEditar" class="label-text">Preço Unitário (R$):</label>
                        <input type="number" step="0.01" id="produtoPrecoUnidadeEditar" class="input-field">
                    </div>
                    <div id="precoMetroFieldsEditar" class="hidden">
                        <label for="produtoPrecoMetroEditar" class="label-text">Preço por Metro Quadrado (R$/m²):</label>
                        <input type="number" step="0.01" id="produtoPrecoMetroEditar" class="input-field">
                    </div>
                    <div>
                        <label for="produtoDescricaoEditar" class="label-text">Descrição:</label>
                        <textarea id="produtoDescricaoEditar" rows="3" class="input-field"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="fecharModalEditarProduto()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Funcionário -->
    <div id="modalEditarFuncionarioOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-md">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarFuncionario()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Editar Funcionário</h3>
                <form id="formEditarFuncionario" class="space-y-4">
                    <input type="hidden" id="funcionarioIdParaEditar">
                    <div>
                        <label for="funcionarioNomeEditar" class="label-text">Nome:</label>
                        <input type="text" id="funcionarioNomeEditar" class="input-field" required>
                    </div>
                    <div>
                        <label for="funcionarioContatoEditar" class="label-text">Contacto:</label>
                        <input type="text" id="funcionarioContatoEditar" class="input-field">
                    </div>
                    <div>
                        <label for="funcionarioCargoEditar" class="label-text">Cargo:</label>
                        <select id="funcionarioCargoEditar" class="input-field">
                            <option value="admin">Administrador</option>
                            <option value="vendedor">Vendedor</option>
                            <option value="producao">Produção</option>
                            <option value="impressor">Impressor</option>
                            <option value="designer">Designer</option>
                            <option value="freelancer">Freelancer</option>
                        </select>
                    </div>
                    <div>
                        <label for="funcionarioCodigoAcessoEditar" class="label-text">Código de Acesso:</label>
                        <input type="text" id="funcionarioCodigoAcessoEditar" class="input-field" required>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalEditarFuncionario()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Fornecedor -->
    <div id="modalEditarFornecedorOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-md">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarFornecedor()">&times;</button>
                <h3 class="text-lg font-semibold mb-5">Editar Fornecedor</h3>
                <form id="formEditarFornecedor" class="space-y-4">
                    <input type="hidden" id="fornecedorIdParaEditar">
                    <div>
                        <label for="fornecedorNomeEditar" class="label-text">Nome:</label>
                        <input type="text" id="fornecedorNomeEditar" class="input-field" required>
                    </div>
                    <div>
                        <label for="fornecedorContatoEditar" class="label-text">Contacto:</label>
                        <input type="text" id="fornecedorContatoEditar" class="input-field">
                    </div>
                    <div>
                        <label for="fornecedorMaterialEditar" class="label-text">Material Fornecido:</label>
                        <input type="text" id="fornecedorMaterialEditar" class="input-field">
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalEditarFornecedor()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Mudar Status do Pedido -->
    <div id="modalMudarStatusOverlay" class="modal-overlay interactive-theme-modal hidden">
        <div class="modal-content-wrapper max-w-sm">
            <div class="h-2"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalMudarStatus()">&times;</button>
                <h3 class="text-lg font-semibold mb-2">Alterar Estado do Pedido</h3>
                <p id="infoPedidoParaMudarStatus" class="text-sm mb-4"></p>
                <form id="formMudarStatus">
                    <input type="hidden" id="pedidoIdParaMudarStatus">
                    <div>
                        <label for="novoStatusPedido" class="label-text">Novo Estado:</label>
                        <select id="novoStatusPedido" class="input-field">
                            <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                            <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                            <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                            <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                            <option value="Pronto para Retirada">Pronto para Retirada</option>
                            <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                            <option value="Entregue">Entregue</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalMudarStatus()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Alteração</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDocs, 
            query, 
            limit,
            onSnapshot, 
            Timestamp,
            writeBatch,
            deleteDoc, 
            setDoc,
            updateDoc, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyDOg6A8HFA_JCP_4iS7JcRCTRgdnzcP4Xk",
             authDomain: "sistema-grafica-pro.firebaseapp.com",
             projectId: "sistema-grafica-pro",
             storageBucket: "sistema-grafica-pro.firebasestorage.app",
             messagingSenderId: "1043193530848",
             appId: "1:1043193530848:web:b0effc9640a2e8ed6f8385"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();

        const auth = getAuth(app);
        const db = getFirestore(app);
        const shopInstanceAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = null, produtosCache = [], pedidoImagemBase64 = null, todosOsPedidosCache = [], clientesCache = [], fornecedoresCache = [], funcionariosCache = [];
        let itemPedidoCount = 0, pagamentoCount = 0, clienteSelecionadoId = null, editingOrderId = null, loggedInUserRole = null, loggedInUserName = null, loggedInUserIdGlobal = null; 
        let notificationTimeout;
        let activeSectionId = 'telaInicial';


        async function criarDadosIniciaisSeNaoExistirem() {
            if (!auth.currentUser) {
                console.log("Aguardando autenticação para criar dados iniciais.");
                return;
            }
            console.log("Verificando se dados iniciais existem...");
            
            const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`; 
            let funcionariosSnapshot = await getDocs(query(collection(db, funcionariosPath), limit(1)));
            if (funcionariosSnapshot.empty) {
                console.log("Nenhum funcionário encontrado. Criando dados de amostra...");
                const batch = writeBatch(db);
                
                const funcionariosAmostra = [
                    { nome: "Admin Master", contato: "admin@grafica.com", cargo: "admin", codigoAcesso: "010101", criadoEm: Timestamp.now() },
                    { nome: "Vendedor Padrão", contato: "vendedor@grafica.com", cargo: "vendedor", codigoAcesso: "111111", criadoEm: Timestamp.now() },
                    { nome: "Impressor Teste", contato: "impressor@grafica.com", cargo: "impressor", codigoAcesso: "222222", criadoEm: Timestamp.now() },
                    { nome: "Produção Teste", contato: "producao@grafica.com", cargo: "producao", codigoAcesso: "333333", criadoEm: Timestamp.now() }
                ];
                funcionariosAmostra.forEach(f => batch.set(doc(collection(db, funcionariosPath)), f));

                await batch.commit();
                console.log("Funcionários de amostra criados.");
            } else {
                console.log("Dados de funcionários já existem.");
            }
        }

        onAuthStateChanged(auth, async (user) => {
            console.log("Estado de autenticação alterado. Usuário:", user ? user.uid : "Nenhum");
            if (user) {
                userId = user.uid; 
                
                try {
                    await criarDadosIniciaisSeNaoExistirem(); 
                    await Promise.all([ carregarClientes(), carregarProdutos(), carregarFuncionarios(), carregarFornecedores() ]);
                    carregarTodosPedidos(); 
                } catch(e) {
                    console.error("Erro ao carregar dados iniciais:", e);
                    exibirMensagem("Falha ao carregar dados do sistema.", "error");
                }
                
                document.getElementById('loginForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('codigoAcesso').value); });
                document.getElementById('logoutButton')?.addEventListener('click', logout);

                const dropdowns = document.querySelectorAll('.exo-menu-container .menu-bar-wrapper li.drop-down');
                dropdowns.forEach(dropdown => {
                    const link = dropdown.querySelector('a');
                    const submenu = dropdown.querySelector('.drop-down-ul');
                    if(link && submenu){
                        link.addEventListener('click', function(event) {
                            if (window.innerWidth <= 768) { 
                                event.preventDefault();
                                dropdown.classList.toggle('open');
                            }
                        });
                    }
                });
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 768) {
                        dropdowns.forEach(dropdown => {
                            if (!dropdown.contains(event.target) && dropdown.classList.contains('open')) {
                                dropdown.classList.remove('open');
                            }
                        });
                    }
                });

                const storedRole = localStorage.getItem('loggedInUserRole');
                const storedName = localStorage.getItem('loggedInUserName');
                const storedId = localStorage.getItem('loggedInUserId');

                if (storedRole && storedName && storedId) {
                    loggedInUserRole = storedRole;
                    loggedInUserName = storedName;
                    loggedInUserIdGlobal = storedId;
                    
                    const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
                    if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`; }
                    
                    atualizarEstatisticasUsuario();

                    document.body.classList.add('app-visible'); 
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    
                    configurarAcessoPorCargo(loggedInUserRole);
                    if (loggedInUserRole === 'impressor' || loggedInUserRole === 'producao') {
                        setActiveMenuLink('visualizarPedidos');
                        mostrarSecao('visualizarPedidos', true);
                    } else {
                        setActiveMenuLink('telaInicial');
                        mostrarSecao('telaInicial', false); 
                    }
                    ajustarPaddingBody();

                } else {
                    document.body.classList.remove('app-visible');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('appContainer').classList.add('hidden');
                    document.body.style.paddingTop = '0px'; 
                }
                
                document.getElementById('pedidoImageDropArea')?.addEventListener('paste', handlePasteImagePedido);
                document.getElementById('pesquisaClienteInput')?.addEventListener('input', () => renderizarListaClientes());
                
                const toggleMenuBtn = document.querySelector('.exo-menu-container .toggle-menu');
                const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                if (toggleMenuBtn && exoMenuEl) {
                    toggleMenuBtn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        exoMenuEl.classList.toggle('display'); 
                        ajustarPaddingBody(); 
                    });
                }

                document.getElementById('formEditarCliente')?.addEventListener('submit', handleSalvarEdicaoCliente);
                document.getElementById('formEditarProduto')?.addEventListener('submit', handleSalvarEdicaoProduto);
                document.getElementById('formEditarFuncionario')?.addEventListener('submit', handleSalvarEdicaoFuncionario);
                document.getElementById('formEditarFornecedor')?.addEventListener('submit', handleSalvarEdicaoFornecedor);
                document.getElementById('formMudarStatus')?.addEventListener('submit', handleSalvarNovoStatus);

                ['filtroNomeCliente', 'filtroNumeroPedido', 'filtroMaterialProduto'].forEach(id => {
                    document.getElementById(id)?.addEventListener('input', renderizarListaCompletaPedidos);
                });
                ['filtroDataPedido', 'filtroStatusPedido', 'filtroClassificacaoPedido', 'filtroVendedor'].forEach(id => {
                    document.getElementById(id)?.addEventListener('change', renderizarListaCompletaPedidos);
                });

                document.getElementById('limparFiltrosPedidos')?.addEventListener('click', () => {
                    ['filtroNomeCliente', 'filtroNumeroPedido', 'filtroDataPedido', 'filtroMaterialProduto', 'filtroStatusPedido', 'filtroVendedor'].forEach(id => {
                        const el = document.getElementById(id); if (el) el.value = '';
                    });
                    const classificacaoEl = document.getElementById('filtroClassificacaoPedido');
                    if(classificacaoEl) classificacaoEl.value = 'dataPedido_desc';
                    renderizarListaCompletaPedidos(); 
                });

            } else { 
                console.log("Usuário não autenticado. Tentando login anônimo...");
                document.body.classList.remove('app-visible');
                try { 
                    await signInAnonymously(auth);
                    console.log("Login anônimo bem-sucedido.");
                } catch (error) { 
                    console.error("Erro no login anônimo:", error);
                    exibirMensagem("Falha crítica na autenticação.", "error");
                }
            }
        });

        async function handleLogin(codigo) {
            console.log(`Tentativa de login com o código: ${codigo}`);
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('appContainer');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            const codigoAcessoInput = document.getElementById('codigoAcesso');
            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
            
            loginErrorMessage.classList.add('hidden'); 

            if (codigo === '000000') {
                console.log("Código mestre detectado.");
                loggedInUserRole = 'admin';
                loggedInUserName = 'Super Admin';
                loggedInUserIdGlobal = 'master_admin_id';

                localStorage.setItem('loggedInUserRole', loggedInUserRole);
                localStorage.setItem('loggedInUserName', loggedInUserName);
                localStorage.setItem('loggedInUserId', loggedInUserIdGlobal);

                if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`; }
                atualizarEstatisticasUsuario();
                document.body.classList.add('app-visible'); 
                loginScreen.classList.add('hidden'); 
                appContainer.classList.remove('hidden'); 
                codigoAcessoInput.value = ''; 
                
                configurarAcessoPorCargo(loggedInUserRole);
                setActiveMenuLink('telaInicial');
                mostrarSecao('telaInicial', false); 
                ajustarPaddingBody();

                exibirMensagem('Login mestre efetuado! Crie um novo admin.', 'success', 8000);
                return;
            }

            if (!auth.currentUser) { 
                loginErrorMessage.textContent = "Aguardando autenticação. Tente novamente."; 
                loginErrorMessage.classList.remove('hidden'); 
                console.log("Falha no login: auth.currentUser é nulo.");
                return; 
            }

            try {
                console.log("Consultando o Firestore para o código de acesso...");
                const funcionariosRef = collection(db, `artifacts/${shopInstanceAppId}/funcionarios`);
                const q = query(funcionariosRef, where("codigoAcesso", "==", codigo));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const funcionarioData = querySnapshot.docs[0].data();
                    const funcionarioId = querySnapshot.docs[0].id;
                    console.log("Funcionário encontrado:", funcionarioData.nome);
                    
                    loggedInUserRole = funcionarioData.cargo.toLowerCase(); 
                    loggedInUserName = funcionarioData.nome; 
                    loggedInUserIdGlobal = funcionarioId;

                    localStorage.setItem('loggedInUserRole', loggedInUserRole);
                    localStorage.setItem('loggedInUserName', loggedInUserName);
                    localStorage.setItem('loggedInUserId', loggedInUserIdGlobal);

                    if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`; }
                    
                    atualizarEstatisticasUsuario();

                    document.body.classList.add('app-visible'); 
                    loginScreen.classList.add('hidden'); 
                    appContainer.classList.remove('hidden'); 
                    codigoAcessoInput.value = ''; 
                    
                    configurarAcessoPorCargo(loggedInUserRole);
                    if (loggedInUserRole === 'impressor' || loggedInUserRole === 'producao') {
                        setActiveMenuLink('visualizarPedidos');
                        mostrarSecao('visualizarPedidos', true);
                    } else {
                        setActiveMenuLink('telaInicial');
                        mostrarSecao('telaInicial', false); 
                    }
                    ajustarPaddingBody();

                } else {
                    console.log("Nenhum funcionário encontrado com o código fornecido.");
                    loginErrorMessage.textContent = "Código inválido."; 
                    loginErrorMessage.classList.remove('hidden'); 
                    loggedInUserRole = null; 
                    loggedInUserName = null; 
                    loggedInUserIdGlobal = null;
                }
            } catch (error) { 
                console.error("Erro no login ao consultar o Firestore:", error); 
                loginErrorMessage.textContent = "Erro ao tentar fazer login. Tente novamente."; 
                loginErrorMessage.classList.remove('hidden'); 
                loggedInUserRole = null; 
                loggedInUserName = null; 
                loggedInUserIdGlobal = null;
            }
        }

        function logout() {
            loggedInUserRole = null; loggedInUserName = null; loggedInUserIdGlobal = null;
            localStorage.removeItem('loggedInUserRole');
            localStorage.removeItem('loggedInUserName');
            localStorage.removeItem('loggedInUserId');

            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
             if (loggedInUserNameDisplay) { loggedInUserNameDisplay.textContent = '';}
            document.body.classList.remove('app-visible');
            document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('codigoAcesso').value = ''; 
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) filtroStatusPedidoEl.value = '';
            document.body.style.paddingTop = '0px'; 
        }

        function atualizarEstatisticasUsuario() {
            if (!loggedInUserIdGlobal || !todosOsPedidosCache) {
                document.getElementById('userPedidosMes').textContent = '0';
                document.getElementById('userPedidosFinalizacao').textContent = '0';
                document.getElementById('userPedidosFinalizados').textContent = '0';
                return;
            }

            let pedidosFiltrados = todosOsPedidosCache;
            if (loggedInUserRole !== 'admin') {
                pedidosFiltrados = todosOsPedidosCache.filter(p => p.vendedorId === loggedInUserIdGlobal);
            }
            
            const agora = new Date();
            const inicioDoMes = new Date(agora.getFullYear(), agora.getMonth(), 1);

            const pedidosEsteMes = pedidosFiltrados.filter(p => {
                if (!p.dataPedido || typeof p.dataPedido.toDate !== 'function') return false;
                const dataPedido = p.dataPedido.toDate();
                return dataPedido >= inicioDoMes;
            });

            const statusEmFinalizacao = [ "Aguardando Aprovação", "Em Produção (Arte)", "Em Produção (Impressão)", "Em Produção (Acabamento)", "Pronto para Retirada", "Em Rota de Entrega" ];
            const pedidosEmFinalizacao = pedidosFiltrados.filter(p => statusEmFinalizacao.includes(p.status));
            const pedidosFinalizados = pedidosFiltrados.filter(p => p.status === 'Entregue');

            document.getElementById('userPedidosMes').textContent = pedidosEsteMes.length;
            document.getElementById('userPedidosFinalizacao').textContent = pedidosEmFinalizacao.length;
            document.getElementById('userPedidosFinalizados').textContent = pedidosFinalizados.length;
        }

        function configurarAcessoPorCargo(role) {
            document.querySelectorAll('[data-role-access]').forEach(item => {
                const acessoPermitido = item.dataset.roleAccess;
                if (acessoPermitido) { item.classList.toggle('hidden', !(acessoPermitido === "all" || (role && acessoPermitido.includes(role)))); }
            });
            const cadastrosDropdown = document.getElementById('dropdownCadastrosMenu'); 
            if (cadastrosDropdown) {
                const subItensVisiveis = cadastrosDropdown.querySelectorAll('ul.drop-down-ul > li:not(.hidden)');
                cadastrosDropdown.classList.toggle('hidden', subItensVisiveis.length === 0);
            }
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) {
                if (role === 'impressor') filtroStatusPedidoEl.value = 'Em Produção (Impressão)';
                else if (role === 'producao') filtroStatusPedidoEl.value = 'Em Produção (Acabamento)';
                else if (!filtroStatusPedidoEl.dataset.userChanged) { filtroStatusPedidoEl.value = ''; }
            }
            if (activeSectionId === 'visualizarPedidos') renderizarListaCompletaPedidos();
        }

        function ajustarPaddingBody() {
            const menuGlobalContainer = document.querySelector('.exo-menu-container'); 
            const bodyEl = document.body;
            let totalOffset = menuGlobalContainer?.offsetHeight || 0;
            const notificationBar = document.getElementById('notificationBar');
            if (notificationBar?.classList.contains('visible')) { totalOffset += notificationBar.offsetHeight; }
            bodyEl.style.paddingTop = totalOffset + 'px';
        }
        window.addEventListener('resize', ajustarPaddingBody); 

        new MutationObserver(ajustarPaddingBody).observe(document.querySelector('.exo-menu-container .exo-menu'), { attributes: true, subtree: true, attributeFilter: ['class', 'style'] });

        function setActiveMenuLink(targetSectionId) { 
            document.querySelectorAll('.exo-menu a[data-section]').forEach(link => { 
                link.classList.remove('active');
                if (link.dataset.section === targetSectionId) {
                    link.classList.add('active');
                    const parentLi = link.closest('li.drop-down');
                    if (parentLi) { parentLi.querySelector('a:first-child').classList.add('active'); }
                }
            });
        }

        window.mostrarSecao = function(idSecao, isMenuLink = false) { 
            if (!loggedInUserRole && idSecao !== 'loginScreen') { logout(); return; }
            
            document.querySelectorAll('.main-content-section').forEach(secao => {
                secao.classList.add('hidden');
            });

            const targetSection = document.getElementById(idSecao);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.toggle('interactive-theme-dashboard', idSecao === 'telaInicial');
                targetSection.classList.toggle('interactive-theme', idSecao !== 'telaInicial' && idSecao !== 'loginScreen');
                
                activeSectionId = idSecao; 
                document.getElementById('mainContentArea').scrollTop = 0;
                if (isMenuLink) {
                    setActiveMenuLink(idSecao);
                    const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                    if (window.innerWidth <= 768 && exoMenuEl?.classList.contains('display')) {
                        document.querySelector('.exo-menu-container .toggle-menu')?.click(); 
                    }
                    document.querySelectorAll('.exo-menu-container li.drop-down.open').forEach(openDropdown => {
                       openDropdown.classList.remove('open');
                    });
                }
            } else { if (loggedInUserRole) mostrarSecao('telaInicial', true); return; }

            if (idSecao === 'novoPedido' && !editingOrderId) {
                document.getElementById('pedidoDataHora').value = new Date().toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                document.getElementById('formNovoPedido').reset(); 
                document.getElementById('itensPedidoContainer').innerHTML = ''; document.getElementById('pagamentosContainer').innerHTML = ''; 
                itemPedidoCount = 0; pagamentoCount = 0; pedidoImagemBase64 = null; 
                const prevImg = document.getElementById('pedidoImagemPreview'), ph = document.getElementById('pedidoImagemPreviewPlaceholder');
                if (prevImg && ph) { prevImg.src = "#"; prevImg.classList.add('hidden'); ph.classList.remove('hidden'); }
                atualizarValorTotalPedido(); 
                document.querySelector('#formNovoPedido button[type=\'submit\']').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
                document.getElementById('editingOrderIdField').value = ''; 
            } else if (editingOrderId && activeSectionId !== 'novoPedido') {
                editingOrderId = null; 
                document.getElementById('editingOrderIdField').value = '';
                document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
            }
            if (idSecao === 'telaInicial') atualizarDashboard(); 
            if (idSecao === 'cadastrarCliente') { document.getElementById('pesquisaClienteInput').value = ''; renderizarListaClientes(); document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; }
            if (idSecao === 'cadastrarFornecedor') document.getElementById('formCadastrarFornecedor').reset();
            if (idSecao === 'visualizarPedidos') renderizarListaCompletaPedidos();
            ajustarPaddingBody();
        }

        function showNotification(config) {
            const bar = document.getElementById('notificationBar');
            if (!bar) return;
            if (notificationTimeout) clearTimeout(notificationTimeout);
            
            const iconMap = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle', 'confirm-delete': 'fa-exclamation-triangle' };
            bar.className = `notification-bar ${config.type}`;
            document.getElementById('notificationIcon').innerHTML = `<i class="fas ${iconMap[config.type] || 'fa-info-circle'}"></i>`;
            document.getElementById('notificationMessage').textContent = config.message;
            const actions = document.getElementById('notificationActions');
            actions.innerHTML = '';

            if (config.type === 'confirm-delete') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = config.confirmText || 'Excluir';
                confirmBtn.className = 'btn btn-confirm-action';
                confirmBtn.onclick = () => { if (config.onConfirm) config.onConfirm(); hideNotification(); };
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = config.cancelText || 'Cancelar';
                cancelBtn.className = 'btn btn-cancel-action';
                cancelBtn.onclick = () => { if (config.onCancel) config.onCancel(); hideNotification(); };
                
                actions.append(confirmBtn, cancelBtn);
            } else {
                notificationTimeout = setTimeout(hideNotification, config.duration || 5000);
            }
            bar.classList.add('visible');
            ajustarPaddingBody(); 
        }

        function hideNotification() {
            document.getElementById('notificationBar')?.classList.remove('visible');
            if (notificationTimeout) clearTimeout(notificationTimeout);
            setTimeout(ajustarPaddingBody, 400);
        }
        window.exibirMensagem = (message, type = 'info', duration = 5000) => { showNotification({ message, type, duration }); }

        function abrirModalEspecifico(overlayId) {
            const overlay = document.getElementById(overlayId); if (!overlay) return;
            overlay.classList.remove('hidden');
            requestAnimationFrame(() => overlay.classList.add('active'));
        }
        function fecharModalEspecifico(overlayId) {
            const overlay = document.getElementById(overlayId); if (!overlay) return;
            overlay.classList.remove('active');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        window.abrirModalNovoClienteRapido = () => { document.getElementById('formNovoClienteRapido')?.reset(); abrirModalEspecifico('modalNovoClienteRapidoOverlay'); };
        window.fecharModalNovoClienteRapido = () => fecharModalEspecifico('modalNovoClienteRapidoOverlay');
        window.abrirModalMudarStatus = (pedidoId, numeroPedido, clienteNome, statusAtual) => {
            document.getElementById('pedidoIdParaMudarStatus').value = pedidoId;
            document.getElementById('infoPedidoParaMudarStatus').innerHTML = `<strong>Pedido:</strong> ${numeroPedido}<br><strong>Cliente:</strong> ${clienteNome}`;
            document.getElementById('novoStatusPedido').value = statusAtual;
            abrirModalEspecifico('modalMudarStatusOverlay');
        }
        window.fecharModalMudarStatus = () => fecharModalEspecifico('modalMudarStatusOverlay');

        async function handleSalvarNovoStatus(event) {
            event.preventDefault();
            if (!auth.currentUser) { exibirMensagem("Sem permissão.", "error"); return; }
            const pedidoId = document.getElementById('pedidoIdParaMudarStatus').value;
            const novoStatus = document.getElementById('novoStatusPedido').value;
            if (!pedidoId || !novoStatus) { exibirMensagem("Erro nos dados.", "error"); return; }

            try {
                await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId), { status: novoStatus });
                exibirMensagem("Estado atualizado!", "success");
                fecharModalMudarStatus();
            } catch (error) { console.error("Erro ao mudar estado:", error); exibirMensagem("Erro ao atualizar.", "error"); }
        }

        // --- Funções de Controlo de Admin ---
        // Clientes
        window.abrirModalEditarCliente = (clienteId) => { const c = clientesCache.find(cli => cli.id === clienteId); if(!c) return; document.getElementById('clienteIdParaEditar').value = c.id; document.getElementById('clienteNomeEditar').value = c.nome; document.getElementById('clienteTipoEditar').value = c.tipoCliente; document.getElementById('clienteTelefoneEditar').value = c.telefone; document.getElementById('clienteEmailEditar').value = c.email; document.getElementById('clienteCpfCnpjEditar').value = c.cpfCnpj; document.getElementById('clienteEnderecoEditar').value = c.endereco; abrirModalEspecifico('modalEditarClienteOverlay'); };
        window.fecharModalEditarCliente = () => fecharModalEspecifico('modalEditarClienteOverlay');
        async function handleSalvarEdicaoCliente(e) { e.preventDefault(); const id = document.getElementById('clienteIdParaEditar').value; const dados = { nome: document.getElementById('clienteNomeEditar').value, tipoCliente: document.getElementById('clienteTipoEditar').value, telefone: document.getElementById('clienteTelefoneEditar').value, email: document.getElementById('clienteEmailEditar').value, cpfCnpj: document.getElementById('clienteCpfCnpjEditar').value, endereco: document.getElementById('clienteEnderecoEditar').value, }; try { await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/clientes`, id), dados); exibirMensagem('Cliente atualizado!', 'success'); fecharModalEditarCliente(); } catch(err){ exibirMensagem('Erro ao atualizar.', 'error'); console.error(err); }}
        window.excluirCliente = (id, nome) => { showNotification({ message: `Excluir o cliente ${nome}?`, type: 'confirm-delete', onConfirm: async () => { try { await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/clientes`, id)); exibirMensagem('Cliente excluído.', 'success'); } catch(err) { exibirMensagem('Erro ao excluir.', 'error'); console.error(err); } } }); };

        // Produtos
        window.abrirModalEditarProduto = (produtoId) => { const p = produtosCache.find(prod => prod.id === produtoId); if(!p) return; document.getElementById('produtoIdParaEditar').value = p.id; document.getElementById('produtoDescricaoEditar').value = p.descricao; document.getElementById('produtoTipoPrecoEditar').value = p.tipoPreco; togglePrecoFieldsEditar(); document.getElementById('produtoPrecoUnidadeEditar').value = p.precoUnidade; document.getElementById('produtoPrecoMetroEditar').value = p.precoMetro; document.getElementById('produtoNomeEditar').value = p.nome; abrirModalEspecifico('modalEditarProdutoOverlay'); };
        window.fecharModalEditarProduto = () => fecharModalEspecifico('modalEditarProdutoOverlay');
        window.togglePrecoFieldsEditar = () => { const t = document.getElementById('produtoTipoPrecoEditar').value; document.getElementById('precoUnidadeFieldsEditar').classList.toggle('hidden', t === 'metro'); document.getElementById('precoMetroFieldsEditar').classList.toggle('hidden', t === 'unidade'); };
        async function handleSalvarEdicaoProduto(e) { e.preventDefault(); const id = document.getElementById('produtoIdParaEditar').value; const dados = { nome: document.getElementById('produtoNomeEditar').value, tipoPreco: document.getElementById('produtoTipoPrecoEditar').value, precoUnidade: parseFloat(document.getElementById('produtoPrecoUnidadeEditar').value) || 0, precoMetro: parseFloat(document.getElementById('produtoPrecoMetroEditar').value) || 0, descricao: document.getElementById('produtoDescricaoEditar').value }; try { await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/produtos`, id), dados); exibirMensagem('Produto atualizado!', 'success'); fecharModalEditarProduto(); } catch (err) { exibirMensagem('Erro ao atualizar.', 'error'); console.error(err); } }
        window.excluirProduto = (id, nome) => { showNotification({ message: `Excluir o produto ${nome}?`, type: 'confirm-delete', onConfirm: async () => { try { await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/produtos`, id)); exibirMensagem('Produto excluído.', 'success'); } catch(err) { exibirMensagem('Erro ao excluir.', 'error'); console.error(err); } } }); };

        // Funcionários
        window.abrirModalEditarFuncionario = (funcId) => { const f = funcionariosCache.find(func => func.id === funcId); if (!f) return; document.getElementById('funcionarioIdParaEditar').value = f.id; document.getElementById('funcionarioNomeEditar').value = f.nome; document.getElementById('funcionarioContatoEditar').value = f.contato; document.getElementById('funcionarioCargoEditar').value = f.cargo; document.getElementById('funcionarioCodigoAcessoEditar').value = f.codigoAcesso; abrirModalEspecifico('modalEditarFuncionarioOverlay'); };
        window.fecharModalEditarFuncionario = () => fecharModalEspecifico('modalEditarFuncionarioOverlay');
        async function handleSalvarEdicaoFuncionario(e) { e.preventDefault(); const id = document.getElementById('funcionarioIdParaEditar').value; const dados = { nome: document.getElementById('funcionarioNomeEditar').value, contato: document.getElementById('funcionarioContatoEditar').value, cargo: document.getElementById('funcionarioCargoEditar').value, codigoAcesso: document.getElementById('funcionarioCodigoAcessoEditar').value }; try { await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/funcionarios`, id), dados); exibirMensagem('Funcionário atualizado!', 'success'); fecharModalEditarFuncionario(); } catch (err) { exibirMensagem('Erro ao atualizar.', 'error'); console.error(err); } }
        window.excluirFuncionario = (id, nome) => { showNotification({ message: `Excluir o funcionário ${nome}?`, type: 'confirm-delete', onConfirm: async () => { try { await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/funcionarios`, id)); exibirMensagem('Funcionário excluído.', 'success'); } catch (err) { exibirMensagem('Erro ao excluir.', 'error'); console.error(err); } } }); };

        // Fornecedores
        window.abrirModalEditarFornecedor = (fornId) => { const f = fornecedoresCache.find(forn => forn.id === fornId); if (!f) return; document.getElementById('fornecedorIdParaEditar').value = f.id; document.getElementById('fornecedorNomeEditar').value = f.nome; document.getElementById('fornecedorContatoEditar').value = f.contato; document.getElementById('fornecedorMaterialEditar').value = f.tipoMaterial; abrirModalEspecifico('modalEditarFornecedorOverlay'); };
        window.fecharModalEditarFornecedor = () => fecharModalEspecifico('modalEditarFornecedorOverlay');
        async function handleSalvarEdicaoFornecedor(e) { e.preventDefault(); const id = document.getElementById('fornecedorIdParaEditar').value; const dados = { nome: document.getElementById('fornecedorNomeEditar').value, contato: document.getElementById('fornecedorContatoEditar').value, tipoMaterial: document.getElementById('fornecedorMaterialEditar').value }; try { await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/fornecedores`, id), dados); exibirMensagem('Fornecedor atualizado!', 'success'); fecharModalEditarFornecedor(); } catch (err) { exibirMensagem('Erro ao atualizar.', 'error'); console.error(err); } }
        window.excluirFornecedor = (id, nome) => { showNotification({ message: `Excluir o fornecedor ${nome}?`, type: 'confirm-delete', onConfirm: async () => { try { await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/fornecedores`, id)); exibirMensagem('Fornecedor excluído.', 'success'); } catch(err) { exibirMensagem('Erro ao excluir.', 'error'); console.error(err); } } }); };


        window.toggleItemProductionStep = async (pedidoId, itemIndex, stepName, isChecked) => {
            if (!auth.currentUser) { exibirMensagem("Sem permissão.", "error"); return; }

            let podeMarcar = ['admin', 'designer'].includes(loggedInUserRole) || (loggedInUserRole === 'impressor' && stepName === 'impressao') || (loggedInUserRole === 'producao' && stepName === 'acabamento');
            if (!podeMarcar) {
                exibirMensagem(`Seu cargo não permite marcar a etapa '${stepName}'.`, "error");
                const printWindowCheckbox = window.opener?.document.getElementById(`step-${stepName}-${pedidoId}-${itemIndex}`);
                if (printWindowCheckbox) printWindowCheckbox.checked = !isChecked;
                return;
            }

            const pedidoDocRef = doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId);
            const pedidoParaAtualizar = todosOsPedidosCache.find(p => p.id === pedidoId);

            if (pedidoParaAtualizar?.itens[itemIndex] != null) {
                const novosItens = [...pedidoParaAtualizar.itens];
                const item = novosItens[itemIndex];
                
                if (!item.productionSteps) item.productionSteps = { impressao: {}, acabamento: {} };
                item.productionSteps[stepName] = { concluido: isChecked, concluidoPor: isChecked ? loggedInUserName : null, concluidoEm: isChecked ? Timestamp.now() : null };
                
                try {
                    await updateDoc(pedidoDocRef, { itens: novosItens });
                    exibirMensagem(`Etapa '${stepName}' atualizada.`, 'success', 2000);
                } catch (error) { console.error("Erro ao atualizar etapa:", error); exibirMensagem("Erro ao atualizar a etapa.", "error"); }
            } else { exibirMensagem("Pedido ou item não encontrado.", "error"); }
        };


        window.marcarComoEntregue = async (pedidoId) => {
            if (!auth.currentUser || !pedidoId) { exibirMensagem("Ação inválida.", "error"); return; }
            const dadosUpdate = { status: 'Entregue', entreguePorNome: loggedInUserName, entreguePorId: loggedInUserIdGlobal, entregueEm: Timestamp.now() };
            try {
                await updateDoc(doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId), dadosUpdate);
                exibirMensagem("Pedido marcado como Entregue!", "success");
            } catch (error) { console.error("Erro ao marcar como entregue:", error); exibirMensagem("Erro ao atualizar o pedido.", "error"); }
        };

        window.abrirDetalhesPedidoNovaGuia = (pedido) => {
            const reconstructTimestamp = (tsObj) => (tsObj?.seconds != null) ? new Timestamp(tsObj.seconds, tsObj.nanoseconds) : null;
            const formatDateTime = (ts) => { const t = reconstructTimestamp(ts); return t ? t.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'; };
            const podeMarcarImpressao = ['admin', 'designer', 'impressor'].includes(loggedInUserRole);
            const podeMarcarAcabamento = ['admin', 'designer', 'producao'].includes(loggedInUserRole);
            const dataPedidoTexto = formatDateTime(pedido.dataPedido);
            let dataEntregaFormatada = formatDateTime(pedido.dataEntrega);
            
            let entregaHtml = (pedido.entreguePorNome && pedido.entregueEm) ? `<p><strong>Entrega confirmada por:</strong> ${pedido.entreguePorNome} em ${formatDateTime(pedido.entregueEm)}</p>` : '';
            let descricaoGeralHtml = pedido.descricaoGeral ? `<div class="section-title">Descrição Geral</div><p><strong>${pedido.descricaoGeral.replace(/\n/g, '<br>')}</strong></p>` : '';

            let itensHtml = pedido.itens?.map((item, index) => {
                const itemDesc = item.descricao ? `<br><small style="color: #555; padding-left: 15px;">&hookrightarrow; ${item.descricao}</small>` : '';
                const dimensoes = item.tipoProduto === 'metro' && item.largura && item.altura ? ` (${item.largura.toFixed(2)}m x ${item.altura.toFixed(2)}m)` : '';
                const steps = item.productionSteps || { impressao: {}, acabamento: {} };
                const impressaoInfo = steps.impressao?.concluido ? `<span class="info-icon" title="Por: ${steps.impressao.concluidoPor || 'N/A'} em ${formatDateTime(steps.impressao.concluidoEm) || 'N/A'}">ⓘ</span>` : '';
                const acabamentoInfo = steps.acabamento?.concluido ? `<span class="info-icon" title="Por: ${steps.acabamento.concluidoPor || 'N/A'} em ${formatDateTime(steps.acabamento.concluidoEm) || 'N/A'}">ⓘ</span>` : '';

                return `<li><div class="item-details">${item.quantidade}x ${item.produtoNome}${dimensoes} - R$ ${item.valorItem.toFixed(2).replace('.', ',')}${itemDesc}</div>
                    <div class="production-steps">
                        <span class="step"><input type="checkbox" id="step-impressao-${pedido.id}-${index}" onchange="window.opener.toggleItemProductionStep('${pedido.id}',${index},'impressao',this.checked)" ${steps.impressao?.concluido ? 'checked' : ''} ${!podeMarcarImpressao ? 'disabled' : ''}><label for="step-impressao-${pedido.id}-${index}" class="${!podeMarcarImpressao ? 'disabled-label' : ''}">Impressão</label>${impressaoInfo}</span>
                        <span class="step"><input type="checkbox" id="step-acabamento-${pedido.id}-${index}" onchange="window.opener.toggleItemProductionStep('${pedido.id}',${index},'acabamento',this.checked)" ${steps.acabamento?.concluido ? 'checked' : ''} ${!podeMarcarAcabamento ? 'disabled' : ''}><label for="step-acabamento-${pedido.id}-${index}" class="${!podeMarcarAcabamento ? 'disabled-label' : ''}">Acabamento</label>${acabamentoInfo}</span>
                    </div></li>`;
            }).join('') || '<li>Nenhum item.</li>';

            let totalPagoCalculado = pedido.pagamentos?.reduce((acc, pgto) => acc + pgto.valorPago, 0) || 0;
            let pagamentosHtml = pedido.pagamentos?.length > 0 ? '<ul>' + pedido.pagamentos.map(pgto => `<li>${pgto.forma}: R$ ${pgto.valorPago.toFixed(2).replace('.',',')} ${pgto.observacao?'('+pgto.observacao+')':''} - Data: ${formatDateTime(pgto.dataPagamento)}</li>`).join('') + '</ul>' : 'Nenhum pagamento.';
            
            const valorRestanteCalculado = (pedido.valorTotal || 0) - totalPagoCalculado;
            const restanteHtml = valorRestanteCalculado > 0 ? `<p style="color:red"><strong>Restante:</strong> R$ ${valorRestanteCalculado.toFixed(2).replace('.',',')}</p>` : '<p style="color:green"><strong>Quitado</strong></p>';
            
            const conteudoHtml = `<html><head><title>Pedido: ${pedido.numeroPedido||'N/A'}</title><style>body{font-family:'Poppins',Arial,sans-serif;margin:20px;background-color:#f1f5f9;color:#334155;font-size:14px}:root{--color-primary:#0ea5e9;--color-text-main:#334155;--color-text-heading:#1e293b;--color-text-muted:#64748b;--color-border-soft:#e2e8f0;--color-border-medium:#cbd5e1;--shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.07),0 4px 6px -4px rgb(0 0 0 / 0.07)}.container{max-width:700px;margin:auto;background-color:#fff;padding:25px;border-radius:12px;box-shadow:var(--shadow-lg);border:1px solid var(--color-border-soft)}.company-header{display:flex;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid var(--color-border-soft)}.company-header img{max-height:50px;margin-right:20px}.company-header .company-info p{margin:2px 0;font-size:.9em;color:var(--color-text-muted)}.company-header .company-info strong{color:var(--color-text-heading);font-weight:600}h1{text-align:center;color:var(--color-primary);border-bottom:2px solid var(--color-primary);padding-bottom:10px;margin-bottom:25px;font-size:1.6em;font-weight:600}.section-title{font-size:1.15em;font-weight:600;color:var(--color-text-heading);margin-top:25px;margin-bottom:10px;border-bottom:1px solid var(--color-border-medium);padding-bottom:6px}p{margin-bottom:8px;line-height:1.65}strong{font-weight:500;color:var(--color-text-main)}ul{list-style:none;margin-left:0;padding-left:5px}li{margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:flex-start;padding-bottom:8px;border-bottom:1px dashed #e2e8f0}.item-details{flex-grow:1;margin-bottom:5px;width:100%}.production-steps{display:flex;gap:20px;padding-left:15px;width:100%}.production-steps .step{display:flex;align-items:center;gap:5px}.production-steps .step label{cursor:pointer;font-size:.9em}.production-steps .step input[type=checkbox]:disabled + label{cursor:not-allowed;color:#9ca3af;}.info-icon{margin-left:5px;font-weight:bold;color:#64748b;cursor:help;font-size:1.1em}.total-section{margin-top:30px;padding-top:20px;border-top:2px solid var(--color-primary);text-align:right}.total-section p{font-size:1.25em;font-weight:600;color:var(--color-primary)}.payment-summary p{font-size:1.05em;margin-bottom:4px;text-align:right}.payment-summary strong{font-weight:600}.print-button-container{text-align:center;margin-top:30px}.print-button{background-color:var(--color-primary);color:white;padding:12px 24px;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:background-color .2s}.print-button:hover{background-color:#0284c7}.footer-note{font-size:.85em;color:var(--color-text-muted);text-align:center;margin-top:30px;padding-top:15px;border-top:1px solid var(--color-border-soft)}img.pedido-preview-print{max-width:100%;max-height:280px;display:block;margin:20px auto;border:1px solid var(--color-border-medium);border-radius:8px;page-break-inside:avoid;object-fit:contain}@media print{body{margin:0;padding:0;background-color:#fff;color:#000;font-size:10pt;--color-primary:#0ea5e9;--color-text-main:#000}.container{margin:0;padding:10mm;box-shadow:none;border-radius:0;border:none;width:100%;max-width:100%}.print-button-container{display:none}h1{color:var(--color-primary)!important;border-color:var(--color-primary)!important}}</style></head><body><div class="container"><div class="company-header"><img src="https://placehold.co/150x50/0ea5e9/FFFFFF?text=SuaGrafica&font=poppins" alt="Logo da Gráfica"><div class="company-info"><p><strong>Empresa:</strong> Gráfica Exemplo</p><p><strong>CNPJ:</strong> 00.000.000/0001-00</p><p><strong>Endereço:</strong> Rua Exemplo, 123, Cidade</p><p><strong>Telefone:</strong> (00) 0000-0000</p><p><strong>Email:</strong> contato@suagrafica.com</p></div></div><h1>Pedido: ${pedido.numeroPedido||'N/A'}</h1><div class="section-title">Cliente</div><p><strong>Nome:</strong> ${pedido.clienteNome||'N/A'}</p><div class="section-title">Pedido</div><p><strong>Número:</strong> ${pedido.numeroPedido||'N/A'}</p><p><strong>Data:</strong> ${dataPedidoTexto}</p><p><strong>Entrega:</strong> ${dataEntregaFormatada}</p><p><strong>Vendedor:</strong> ${pedido.vendedorNome||'N/A'}</p><p><strong>Estado:</strong> ${pedido.status||'N/A'}</p>${entregaHtml}<div class="section-title">Pagamentos</div>${pagamentosHtml}<div class="section-title">Itens</div><ul>${itensHtml}</ul>${descricaoGeralHtml}${pedido.imagemPreviewPedidoBase64?`<div class="section-title">Preview</div><img class="pedido-preview-print" src="${pedido.imagemPreviewPedidoBase64}" alt="Preview" />`:''}<div class="payment-summary total-section"><p><strong>Total Pedido:</strong> R$ ${pedido.valorTotal?.toFixed(2).replace('.',',')||'0,00'}</p><p><strong>Total Pago:</strong> R$ ${totalPagoCalculado.toFixed(2).replace('.',',')}</p>${restanteHtml}</div><div class="print-button-container"><button class="print-button" onclick="window.print()">Imprimir</button></div><p class="footer-note">Gerado em: ${new Date().toLocaleString('pt-BR')}</p></div></body></html>`; 
            
            const newTab = window.open('', `Pedido: ${pedido.numeroPedido || 'detalhes'}`); 
            if (newTab) { newTab.document.write(conteudoHtml); newTab.document.close(); } 
            else { exibirMensagem("Bloqueador de pop-up impediu a abertura da guia.", "warning"); } 
        }

        document.getElementById('formCadastrarCliente')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), { nome:document.getElementById('clienteNome').value, tipoCliente:document.getElementById('clienteTipo').value, telefone:document.getElementById('clienteTelefone').value, email:document.getElementById('clienteEmail').value, cpfCnpj:document.getElementById('clienteCpfCnpj').value, endereco:document.getElementById('clienteEndereco').value, criadoEm:Timestamp.now() }); exibirMensagem('Cliente registado!', 'success'); e.target.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar.', 'error'); } });
        function renderizarListaClientes() { const listaEl = document.getElementById('listaClientes'); const termo = document.getElementById('pesquisaClienteInput')?.value.toLowerCase() || ''; if (!listaEl) return; const filtrados = clientesCache.filter(c => (c.nome?.toLowerCase().includes(termo)) || (c.telefone?.includes(termo)) || (c.email?.toLowerCase().includes(termo))); listaEl.innerHTML = ''; if (filtrados.length === 0) { listaEl.innerHTML = `<p class="text-sm text-center py-3">${termo?'Nenhum cliente encontrado.':'Nenhum cliente registado.'}</p>`; document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; return; } filtrados.forEach(c => { const itemDiv = document.createElement('div'); itemDiv.className=`item-list-display !cursor-pointer relative flex justify-between items-center ${c.id === clienteSelecionadoId ? 'selected' : ''}`; itemDiv.addEventListener('click', () => exibirDetalhesClienteEProcurarPedidos(c.id)); const infoDiv = document.createElement('div'); infoDiv.innerHTML = `<strong>${c.nome}</strong> <span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle">${c.tipoCliente==='revenda'?'Revenda':'Final'}</span><div class="meta">${c.telefone||'S/ Telefone'}</div>`; itemDiv.appendChild(infoDiv); if (loggedInUserRole === 'admin') { const adminButtons = document.createElement('div'); adminButtons.className = 'flex items-center space-x-1'; adminButtons.innerHTML = `<button class="btn-icon-action" title="Editar Cliente"><i class="fas fa-edit"></i></button><button class="btn-icon-action text-red-400 hover:text-red-600" title="Excluir Cliente"><i class="fas fa-trash"></i></button>`; adminButtons.querySelector('button:first-child').addEventListener('click', (e) => { e.stopPropagation(); abrirModalEditarCliente(c.id); }); adminButtons.querySelector('button:last-child').addEventListener('click', (e) => { e.stopPropagation(); excluirCliente(c.id, c.nome); }); itemDiv.appendChild(adminButtons); } listaEl.appendChild(itemDiv); }); }
        function exibirDetalhesClienteEProcurarPedidos(id) { clienteSelecionadoId = id; renderizarListaClientes(); const cli = clientesCache.find(c => c.id === id); const detalhesEl = document.getElementById('detalhesClienteSelecionado'), infoEl = document.getElementById('infoCliente'), pedidosEl = document.getElementById('pedidosDoClienteLista'); if (!cli||!detalhesEl) return; infoEl.innerHTML = `<p><strong>Nome:</strong> ${cli.nome||'N/A'}</p><p><strong>Tel:</strong> ${cli.telefone||'N/A'}</p><p><strong>Email:</strong> ${cli.email||'N/A'}</p><p><strong>Tipo:</strong> ${cli.tipoCliente==='revenda'?'Revenda':'Final'}</p>${cli.cpfCnpj?`<p><strong>CPF/CNPJ:</strong> ${cli.cpfCnpj}</p>`:''}${cli.endereco?`<p><strong>Endereço:</strong> ${cli.endereco}</p>`:''}`; detalhesEl.classList.remove('hidden'); pedidosEl.innerHTML = '<p class="text-xs text-center py-2">A carregar...</p>'; const pFiltrados = todosOsPedidosCache.filter(p => p.clienteId === id).sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0)); if (pFiltrados.length === 0) { pedidosEl.innerHTML = '<p class="text-xs text-center py-2">Nenhum pedido para este cliente.</p>'; return; } pedidosEl.innerHTML = pFiltrados.map(p => `<div class='p-2.5 border-b text-xs last:border-b-0'><div class="flex justify-between items-center"><span class="font-medium">${p.numeroPedido}</span><span class="text-opacity-80">${p.dataPedido?.toDate().toLocaleDateString('pt-BR')||'N/A'}</span></div><div class="flex justify-between items-center mt-1"><span>R$ ${p.valorTotal.toFixed(2).replace('.',',')}</span>${getStatusBadgeSimpleHTML(p)}</div><button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(p))}')))" class="btn btn-link text-xs p-0 mt-1">Ver detalhes</button></div>`).join(''); }
        function carregarClientes() { if (!auth.currentUser) return; onSnapshot(query(collection(db, `artifacts/${shopInstanceAppId}/clientes`)), (snap) => { clientesCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.nome||"").localeCompare(b.nome||"")); if (activeSectionId === 'cadastrarCliente') renderizarListaClientes(); if (activeSectionId === 'telaInicial') atualizarDashboard(); }, e => { console.error("Erro clientes:", e); exibirMensagem("Erro ao carregar clientes.", "error"); }); }
        document.getElementById('formNovoClienteRapido')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const nome=document.getElementById('clienteRapidoNome').value, tel=document.getElementById('clienteRapidoTelefone').value, tipo=document.getElementById('clienteRapidoTipo').value; if (!nome.trim()) { exibirMensagem("Nome é obrigatório.", "warning"); return; } try { const ref = await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), { nome, telefone:tel, tipoCliente:tipo, criadoEm:Timestamp.now() }); exibirMensagem('Cliente registado!', 'success'); fecharModalNovoClienteRapido(); document.getElementById('pedidoClienteSearch').value = nome; document.getElementById('pedidoClienteId').value = ref.id; document.getElementById('pedidoClienteResultados').classList.add('hidden'); } catch (err) { console.error(err); exibirMensagem('Erro ao registar.', 'error'); } });
        const pedidoClienteSearchEl = document.getElementById('pedidoClienteSearch'), pedidoClienteResultadosEl = document.getElementById('pedidoClienteResultados'), pedidoClienteIdEl = document.getElementById('pedidoClienteId'); if (pedidoClienteSearchEl) { pedidoClienteSearchEl.addEventListener('input', () => { const t=pedidoClienteSearchEl.value.toLowerCase(); pedidoClienteResultadosEl.innerHTML=''; if(t.length<2){pedidoClienteResultadosEl.classList.add('hidden');pedidoClienteIdEl.value='';return;} const res=clientesCache.filter(c=>(c.nome?.toLowerCase().includes(t))||(c.telefone?.includes(t))); pedidoClienteResultadosEl.classList.remove('hidden'); if(res.length>0){pedidoClienteResultadosEl.innerHTML = res.map(cli => `<div data-id="${cli.id}" data-nome="${cli.nome}">${cli.nome} ${cli.telefone?'- '+cli.telefone:''}</div>`).join('');}else{pedidoClienteResultadosEl.innerHTML='<div>Nenhum cliente encontrado.</div>'; pedidoClienteIdEl.value='';} }); pedidoClienteResultadosEl.addEventListener('click', (e) => { if(e.target.dataset.id){ pedidoClienteSearchEl.value = e.target.dataset.nome; pedidoClienteIdEl.value = e.target.dataset.id; pedidoClienteResultadosEl.classList.add('hidden'); } }); document.addEventListener('click', (ev) => { if (!pedidoClienteSearchEl.contains(ev.target)&&!pedidoClienteResultadosEl.contains(ev.target)) pedidoClienteResultadosEl.classList.add('hidden'); }); }

        window.togglePrecoFields=()=>{const t=document.getElementById('produtoTipoPreco')?.value; document.getElementById('precoUnidadeFields').classList.toggle('hidden',t==='metro');document.getElementById('precoMetroFields').classList.toggle('hidden',t==='unidade');};
        document.getElementById('formCadastrarProduto')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const dados={nome:document.getElementById('produtoNome').value,tipoPreco:document.getElementById('produtoTipoPreco').value,precoUnidade:parseFloat(document.getElementById('produtoPrecoUnidade').value)||0,precoMetro:parseFloat(document.getElementById('produtoPrecoMetro').value)||0,descricao:document.getElementById('produtoDescricao').value,criadoEm:Timestamp.now()}; if(!dados.nome.trim()){exibirMensagem("Nome do produto é obrigatório.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/produtos`), dados); exibirMensagem('Produto registado!', 'success'); e.target.reset(); togglePrecoFields(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar.', 'error'); } });
        function carregarProdutos() { if (!auth.currentUser) return; onSnapshot(query(collection(db, `artifacts/${shopInstanceAppId}/produtos`)), (snap) => { const listaEl=document.getElementById('listaProdutos'); produtosCache = snap.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); if(listaEl) { listaEl.innerHTML = ''; if (produtosCache.length > 0) { produtosCache.forEach(p => { const itemDiv = document.createElement('div'); itemDiv.className = 'item-list-display !cursor-default flex justify-between items-center'; const infoDiv = document.createElement('div'); infoDiv.innerHTML = `<strong>${p.nome}</strong><div class="meta">${p.tipoPreco==='metro'?`R$ ${(p.precoMetro||0).toFixed(2).replace('.',',')}/m²`:`R$ ${(p.precoUnidade||0).toFixed(2).replace('.',',')}/un`}</div>`; itemDiv.appendChild(infoDiv); if (loggedInUserRole === 'admin') { const adminBtns = document.createElement('div'); adminBtns.className = 'flex items-center space-x-1'; adminBtns.innerHTML = `<button class="btn-icon-action" title="Editar"><i class="fas fa-edit"></i></button><button class="btn-icon-action text-red-400 hover:text-red-600" title="Excluir"><i class="fas fa-trash"></i></button>`; adminBtns.querySelector('button:first-child').addEventListener('click', () => abrirModalEditarProduto(p.id)); adminBtns.querySelector('button:last-child').addEventListener('click', () => excluirProduto(p.id, p.nome)); itemDiv.appendChild(adminBtns); } listaEl.appendChild(itemDiv); }); } else { listaEl.innerHTML = '<p class="text-sm text-center py-3">Nenhum produto registado.</p>'; } } document.querySelectorAll('.produto-select').forEach(s=>popularSelectProduto(s)); }, e => { console.error("Erro produtos:", e); exibirMensagem("Erro ao carregar produtos.", "error"); }); }

        document.getElementById('formCadastrarFuncionario')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const dados={nome:document.getElementById('funcionarioNome').value,contato:document.getElementById('funcionarioContato').value,cargo:document.getElementById('funcionarioCargo').value,codigoAcesso:document.getElementById('funcionarioCodigoAcesso').value,criadoEm:Timestamp.now()}; if(!dados.nome||!dados.cargo||!dados.codigoAcesso){exibirMensagem("Preencha todos os campos.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`), dados); exibirMensagem('Funcionário registado!', 'success'); e.target.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar.', 'error'); } });
        function carregarFuncionarios() { if (!auth.currentUser) return; onSnapshot(query(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`)), (snap)=>{ const selPV=document.getElementById('pedidoVendedor'), listaEl=document.getElementById('listaFuncionarios'), selFiltro=document.getElementById('filtroVendedor'); if(selPV)selPV.innerHTML='<option value="">Selecione funcionário</option>'; if(selFiltro)selFiltro.innerHTML='<option value="">Todos Funcionários</option>'; funcionariosCache = snap.docs.map(doc => ({id:doc.id,...doc.data()})).sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); if(listaEl) { listaEl.innerHTML = ''; if (funcionariosCache.length > 0) { funcionariosCache.forEach(f => { const itemDiv = document.createElement('div'); itemDiv.className = 'item-list-display !cursor-default flex justify-between items-center'; const infoDiv = document.createElement('div'); infoDiv.innerHTML = `<strong>${f.nome}</strong><span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle ml-1">${f.cargo||'N/A'}</span><div class="meta">Contacto: ${f.contato||'N/A'}</div>`; itemDiv.appendChild(infoDiv); if (loggedInUserRole === 'admin') { const adminBtns = document.createElement('div'); adminBtns.className = 'flex items-center space-x-1'; adminBtns.innerHTML = `<button class="btn-icon-action" title="Editar"><i class="fas fa-user-edit"></i></button><button class="btn-icon-action text-red-400 hover:text-red-600" title="Excluir"><i class="fas fa-user-times"></i></button>`; adminBtns.querySelector('button:first-child').addEventListener('click', () => abrirModalEditarFuncionario(f.id)); adminBtns.querySelector('button:last-child').addEventListener('click', () => excluirFuncionario(f.id, f.nome)); itemDiv.appendChild(adminBtns); } listaEl.appendChild(itemDiv); }); } else { listaEl.innerHTML = '<p class="text-sm text-center py-3">Nenhum funcionário registado.</p>'; } } funcionariosCache.forEach(f => { if(selPV) selPV.innerHTML += `<option value="${f.id}">${f.nome}</option>`; if(selFiltro) selFiltro.innerHTML += `<option value="${f.id}">${f.nome}</option>`; }); }, e => { console.error("Erro funcionários:", e); exibirMensagem("Erro ao carregar funcionários.", "error"); }); }

        document.getElementById('formCadastrarFornecedor')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const dados={nome:document.getElementById('fornecedorNome').value,contato:document.getElementById('fornecedorContato').value,tipoMaterial:document.getElementById('fornecedorMaterial').value,criadoEm:Timestamp.now()}; if(!dados.nome.trim()){exibirMensagem("Nome do fornecedor é obrigatório.","warning");return;} try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`), dados); exibirMensagem('Fornecedor registado!', 'success'); e.target.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar.', 'error'); } });
        function carregarFornecedores() { if (!auth.currentUser) return; onSnapshot(query(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`)), (snap)=>{ const listaEl = document.getElementById('listaFornecedores'); fornecedoresCache=snap.docs.map(doc=>({id:doc.id,...doc.data()})).sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); if(listaEl) { listaEl.innerHTML = ''; if (fornecedoresCache.length > 0) { fornecedoresCache.forEach(f => { const itemDiv = document.createElement('div'); itemDiv.className = 'item-list-display !cursor-default flex justify-between items-center'; const infoDiv = document.createElement('div'); const cDisplay = f.contato?.includes('@') ? `<a href="mailto:${f.contato}" class="text-sky-400 hover:underline">${f.contato}</a>` : (f.contato || 'N/A'); infoDiv.innerHTML = `<strong>${f.nome}</strong><div class="meta">Contacto: ${cDisplay}</div><div class="meta">Material: ${f.tipoMaterial||'N/A'}</div>`; itemDiv.appendChild(infoDiv); if (loggedInUserRole === 'admin') { const adminBtns = document.createElement('div'); adminBtns.className = 'flex items-center space-x-1'; adminBtns.innerHTML = `<button class="btn-icon-action" title="Editar"><i class="fas fa-edit"></i></button><button class="btn-icon-action text-red-400 hover:text-red-600" title="Excluir"><i class="fas fa-trash"></i></button>`; adminBtns.querySelector('button:first-child').addEventListener('click', () => abrirModalEditarFornecedor(f.id)); adminBtns.querySelector('button:last-child').addEventListener('click', () => excluirFornecedor(f.id, f.nome)); itemDiv.appendChild(adminBtns); } listaEl.appendChild(itemDiv); }); } else { listaEl.innerHTML = '<p class="text-sm text-center py-3">Nenhum fornecedor registado.</p>'; } } }, e => { console.error("Erro fornecedores:", e); exibirMensagem("Erro ao carregar fornecedores.", "error"); }); }

        async function processImageFilePedido(file) {
            const pI = document.getElementById('pedidoImagemPreview'), pH = document.getElementById('pedidoImagemPreviewPlaceholder');
            if (file?.type.startsWith('image/')) {
                try {
                    const resizedBase64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { let w = img.width, h = img.height; if(w > h){if(w > 800){h *= 800/w; w=800;}}else{if(h > 800){w *= 800/h; h=800;}} const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); });
                    pedidoImagemBase64 = resizedBase64;
                    if (pI && pH) { pI.src = resizedBase64; pI.classList.remove('hidden'); pH.classList.add('hidden'); }
                } catch (error) { console.error("Erro imagem:", error); exibirMensagem("Não foi possível processar a imagem.", "error"); pedidoImagemBase64 = null; if (pI && pH) { pI.src = "#"; pI.classList.add('hidden'); pH.classList.remove('hidden'); } }
            } else { pedidoImagemBase64 = null; if (pI && pH) { pI.src = "#"; pI.classList.add('hidden'); pH.classList.remove('hidden'); } if (file) exibirMensagem("Arquivo de imagem inválido.", "warning"); }
        }
        window.handleImagemFilePedido=(ev)=>{processImageFilePedido(ev.target.files[0]);ev.target.value=null;}
        function handlePasteImagePedido(ev){ev.preventDefault();const items=(ev.clipboardData||window.clipboardData).items;for(const item of items)if(item.kind==='file'&&item.type.startsWith('image/')){processImageFilePedido(item.getAsFile());break;}}
        function popularSelectProduto(sel){sel.innerHTML='<option value="">Selecione produto</option>'+produtosCache.map(p=>`<option value="${p.id}" data-tipo="${p.tipoPreco}" data-preco-metro="${p.precoMetro||0}" data-preco-unidade="${p.precoUnidade||0}">${p.nome}</option>`).join('');}
        window.adicionarItemPedidoForm = (itemParaEditar = null) => {
            itemPedidoCount++;
            const c = document.getElementById('itensPedidoContainer');
            const d = document.createElement('div');
            d.className = 'p-3.5 border rounded-lg space-y-2.5 item-pedido-form relative'; d.id = `itemPedido-${itemPedidoCount}`;
            d.innerHTML = `<button type="button" onclick="removerItemPedidoForm(${itemPedidoCount})" class="absolute top-1.5 right-1.5 text-red-400 hover:text-red-600 p-1"><i class="fas fa-times"></i></button><h4 class="font-medium text-sm">Item ${itemPedidoCount}</h4><div><label class="label-text text-xs">Produto:</label><select class="input-field input-field-sm produto-select" id="itemProduto-${itemPedidoCount}" onchange="toggleCamposProduto(${itemPedidoCount})"></select></div><div class="mt-2"><label class="label-text text-xs">Descrição do Item (Opcional):</label><input type="text" class="input-field input-field-sm item-descricao" id="itemDescricao-${itemPedidoCount}" placeholder="Ex: com laminação fosca..."></div><div id="camposProdutoMetro-${itemPedidoCount}" class="hidden grid grid-cols-2 gap-3"><div><label class="label-text text-xs">Largura (m):</label><input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemLargura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div><div><label class="label-text text-xs">Altura (m):</label><input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemAltura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div></div><div><label class="label-text text-xs">Qtd:</label><input type="number" value="1" min="1" class="input-field input-field-sm quantidade-produto" id="itemQuantidade-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div><div><label class="label-text text-xs">Valor Item:</label><input type="text" class="input-field input-field-sm valor-item-produto font-medium" id="itemValor-${itemPedidoCount}" readonly value="R$ 0,00"></div>`;
            c.appendChild(d);
            const selectProduto = d.querySelector('.produto-select'); popularSelectProduto(selectProduto);
            if (itemParaEditar) { selectProduto.value = itemParaEditar.produtoId; selectProduto.dispatchEvent(new Event('change')); d.querySelector('.quantidade-produto').value = itemParaEditar.quantidade; d.querySelector('.item-descricao').value = itemParaEditar.descricao || ''; if (itemParaEditar.tipoProduto === 'metro') { d.querySelector('.dimensoes-produto[id^="itemLargura"]').value = itemParaEditar.largura; d.querySelector('.dimensoes-produto[id^="itemAltura"]').value = itemParaEditar.altura; } if(itemParaEditar.productionSteps) { d.dataset.productionSteps = JSON.stringify(itemParaEditar.productionSteps); } calcularValorItem(itemPedidoCount); }
            d.querySelectorAll('.input-field').forEach(el => el.classList.add('py-1.5', 'text-sm'));
        };

        window.removerItemPedidoForm=(id)=>{document.getElementById(`itemPedido-${id}`)?.remove();atualizarValorTotalPedido();}
        window.removerPagamentoForm=(id)=>{document.getElementById(`pagamentoItem-${id}`)?.remove();calcularTotaisPagamento();}
        window.toggleCamposProduto=(id)=>{const s=document.getElementById(`itemProduto-${id}`);document.getElementById(`camposProdutoMetro-${id}`).classList.toggle('hidden',s.options[s.selectedIndex]?.dataset.tipo!=='metro');calcularValorItem(id);}
        window.calcularValorItem=(id)=>{const s=document.getElementById(`itemProduto-${id}`),o=s.options[s.selectedIndex],vI=document.getElementById(`itemValor-${id}`);if(!o||!o.value){vI.value="R$ 0,00";atualizarValorTotalPedido();return;}const t=o.dataset.tipo,pm=parseFloat(o.dataset.precoMetro),pu=parseFloat(o.dataset.precoUnidade),q=parseInt(document.getElementById(`itemQuantidade-${id}`).value)||1;let v=0;if(t==='metro'){const l=parseFloat(document.getElementById(`itemLargura-${id}`).value)||0,a=parseFloat(document.getElementById(`itemAltura-${id}`).value)||0;if(l>0&&a>0&&pm>0)v=(l*a*pm)*q;}else{if(pu>0)v=pu*q;}vI.value=`R$ ${v.toFixed(2).replace('.',',')}`;atualizarValorTotalPedido();}
        function atualizarValorTotalPedido(){let tI=0;document.querySelectorAll('.valor-item-produto').forEach(i=>{tI+=parseFloat(i.value.replace('R$ ','').replace(',','.'))||0;});document.getElementById('pedidoValorTotal').value=`R$ ${tI.toFixed(2).replace('.',',')}`;calcularTotaisPagamento();}
        window.adicionarPagamentoForm=()=>{pagamentoCount++;const c=document.getElementById('pagamentosContainer');const d=document.createElement('div');d.className='grid grid-cols-1 sm:grid-cols-[2fr,1fr,auto] gap-3 items-end p-3 border rounded-lg pagamento-form-item';d.id=`pagamentoItem-${pagamentoCount}`;d.innerHTML=`<div><label class="label-text text-xs">Forma:</label><select class="input-field input-field-sm py-1.5 forma-pagamento"><option value="Dinheiro">Dinheiro</option><option value="Cartão de Crédito">Crédito</option><option value="Cartão de Débito">Débito</option><option value="PIX">PIX</option><option value="Boleto">Boleto</option><option value="Pendente">Pendente</option></select></div><div><label class="label-text text-xs">Valor (R$):</label><input type="number" step="0.01" class="input-field input-field-sm py-1.5 valor-pago" placeholder="0,00" oninput="window.calcularTotaisPagamento()"></div><button type="button" onclick="removerPagamentoForm(${pagamentoCount})" class="btn btn-danger btn-small text-xs py-1.5 px-2 h-8"><i class="fas fa-trash"></i></button><div class="sm:col-span-3"><label class="label-text text-xs">Obs:</label><input type="text" class="input-field input-field-sm py-1.5 observacao-pagamento" placeholder="Ex: Entrada..."></div>`;c.appendChild(d);calcularTotaisPagamento();}

        window.calcularTotaisPagamento=()=>{let tP=0;document.querySelectorAll('.pagamento-form-item .valor-pago').forEach(i=>{tP+=parseFloat(i.value)||0;});document.getElementById('pedidoTotalPago').value=`R$ ${tP.toFixed(2).replace('.',',')}`;const vT=parseFloat(document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.'))||0;document.getElementById('pedidoValorRestante').value=`R$ ${(vT-tP).toFixed(2).replace('.',',')}`;};
        document.getElementById('formNovoPedido')?.addEventListener('submit', async (e) => { 
            e.preventDefault(); if (!auth.currentUser) return; 
            editingOrderId = document.getElementById('editingOrderIdField').value; 
            const dados={clienteId:document.getElementById('pedidoClienteId').value,vendedorId:document.getElementById('pedidoVendedor').value,dataEntregaStr:document.getElementById('pedidoDataEntrega').value,horaEntregaStr:document.getElementById('pedidoHoraEntrega').value,}; 
            if(!dados.clienteId||!dados.vendedorId||!dados.dataEntregaStr){exibirMensagem("Cliente, Vendedor e Data de Entrega são obrigatórios.","warning");return;} 
            let dEFinal=Timestamp.fromDate(new Date(`${dados.dataEntregaStr}T${dados.horaEntregaStr||'00:00:00'}`));
            const itensForms=document.querySelectorAll('.item-pedido-form'); if(itensForms.length===0){exibirMensagem("Adicione pelo menos um item.","warning");return;} 
            let itensPedido=[], pagamentosPedido=[], formValido=true;
            itensForms.forEach((iF,idx)=>{const cId=iF.id.split('-')[1];const pS=document.getElementById(`itemProduto-${cId}`);if(!pS.value){formValido=false;exibirMensagem(`Selecione um produto para o item ${idx+1}.`,"warning");return;}const q=parseInt(document.getElementById(`itemQuantidade-${cId}`).value);if(q<=0){formValido=false;exibirMensagem(`Quantidade do item ${idx+1} inválida.`,"warning");return;}const o=pS.options[pS.selectedIndex];let pSteps={};try{pSteps=iF.dataset.productionSteps?JSON.parse(iF.dataset.productionSteps):{impressao:{},acabamento:{}};}catch(e){pSteps={impressao:{},acabamento:{}};}itensPedido.push({produtoId:pS.value,produtoNome:o.text,tipoProduto:o.dataset.tipo,quantidade:q,largura:parseFloat(document.getElementById(`itemLargura-${cId}`)?.value)||null,altura:parseFloat(document.getElementById(`itemAltura-${cId}`)?.value)||null,valorItem:parseFloat(document.getElementById(`itemValor-${cId}`).value.replace('R$ ','').replace(',','.')),descricao:document.getElementById(`itemDescricao-${cId}`).value,productionSteps:pSteps});});if(!formValido)return;
            document.querySelectorAll('.pagamento-form-item').forEach(i=>{const f=i.querySelector('.forma-pagamento').value,v=parseFloat(i.querySelector('.valor-pago').value);if(f&&v>=0||f==="Pendente")pagamentosPedido.push({forma:f,valorPago:v||0,observacao:i.querySelector('.observacao-pagamento').value,dataPagamento:f!=="Pendente"?Timestamp.now():null});});if(pagamentosPedido.length===0){exibirMensagem("Adicione um pagamento.","warning");return;}
            const pData={clienteId:dados.clienteId,clienteNome:document.getElementById('pedidoClienteSearch').value,vendedorId:dados.vendedorId,vendedorNome:document.getElementById('pedidoVendedor').options[document.getElementById('pedidoVendedor').selectedIndex].text,pagamentos:pagamentosPedido,dataEntrega:dEFinal,status:document.getElementById('pedidoStatus').value,valorTotal:parseFloat(document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.')),itens:itensPedido,imagemPreviewPedidoBase64,descricaoGeral:document.getElementById('pedidoDescricaoGeral').value};
            try{if(editingOrderId){const oPD=todosOsPedidosCache.find(p=>p.id===editingOrderId);pData.dataPedido=oPD?.dataPedido||Timestamp.now();pData.numeroPedido=oPD?.numeroPedido||`PED-${Date.now().toString().slice(-6)}`;await setDoc(doc(db,`artifacts/${shopInstanceAppId}/pedidos`,editingOrderId),pData);exibirMensagem('Pedido atualizado!', 'success');}else{pData.dataPedido=Timestamp.now();pData.numeroPedido=`PED-${Date.now().toString().slice(-6)}`;await addDoc(collection(db,`artifacts/${shopInstanceAppId}/pedidos`),pData);exibirMensagem('Pedido guardado!', 'success');}document.getElementById('formNovoPedido').reset();document.getElementById('editingOrderIdField').value='';editingOrderId=null;document.querySelector('#formNovoPedido button[type="submit"]').innerHTML='<i class="fas fa-check mr-1.5"></i>Guardar Pedido';document.getElementById('itensPedidoContainer').innerHTML='';document.getElementById('pagamentosContainer').innerHTML='';pagamentoCount=0;pedidoImagemBase64=null;const pIP=document.getElementById('pedidoImagemPreview'),pIPH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pIP&&pIPH){pIP.src="#";pIP.classList.add('hidden');pIPH.classList.remove('hidden');}itemPedidoCount=0;atualizarValorTotalPedido();mostrarSecao('telaInicial',true);}catch(err){console.error(err);exibirMensagem('Erro ao processar pedido.','error');} 
        });

        function getStatusBadgeSimpleHTML(pedido) { const s=pedido.status;let c='neutral';if(s==='Entregue')c='success';else if(s==='Cancelado')c='danger';else if(s==='Pronto para Retirada')c='primary';else if(s?.startsWith('Em Produção')||s==='Em Rota de Entrega')c='info';else if(s==='Aguardando Aprovação')c='warning';return `<button type="button" class="status-badge-simple interactive-button ${c}" onclick="abrirModalMudarStatus('${pedido.id}','${(pedido.numeroPedido||'').replace(/'/g,"\\'")}', '${(pedido.clienteNome||'').replace(/'/g,"\\'")}', '${(s||'').replace(/'/g,"\\'")}')" title="Alterar estado">${s}</button>`; }
        function renderizarListaCompletaPedidos() { const tbody = document.getElementById('listaTodosPedidos'); if (!tbody) return; let pF=[...todosOsPedidosCache]; const f={nC:document.getElementById('filtroNomeCliente')?.value.toLowerCase(),nP:document.getElementById('filtroNumeroPedido')?.value.toLowerCase(),dP:document.getElementById('filtroDataPedido')?.value,mP:document.getElementById('filtroMaterialProduto')?.value.toLowerCase(),sP:document.getElementById('filtroStatusPedido')?.value,c:document.getElementById('filtroClassificacaoPedido')?.value,vI:document.getElementById('filtroVendedor')?.value}; if(f.nC)pF=pF.filter(p=>p.clienteNome?.toLowerCase().includes(f.nC));if(f.nP)pF=pF.filter(p=>p.numeroPedido?.toLowerCase().includes(f.nP));if(f.dP){const dFil=new Date(f.dP+"T00:00:00");pF=pF.filter(p=>{const dP=p.dataPedido?.toDate();return dP&&dP.getFullYear()===dFil.getFullYear()&&dP.getMonth()===dFil.getMonth()&&dP.getDate()===dFil.getDate();});}if(f.mP)pF=pF.filter(p=>p.itens?.some(i=>i.produtoNome?.toLowerCase().includes(f.mP)));if(f.sP)pF=pF.filter(p=>p.status===f.sP);if(f.vI)pF=pF.filter(p=>p.vendedorId===f.vI);const sF={'dataPedido_desc':(a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0),'dataPedido_asc':(a,b)=>(a.dataPedido?.toMillis()||0)-(b.dataPedido?.toMillis()||0),'dataEntrega_asc':(a,b)=>(a.dataEntrega?.toMillis()||0)-(b.dataEntrega?.toMillis()||0),'dataEntrega_desc':(a,b)=>(b.dataEntrega?.toMillis()||0)-(a.dataEntrega?.toMillis()||0),'clienteNome_asc':(a,b)=>(a.clienteNome||"").localeCompare(b.clienteNome||""),'clienteNome_desc':(a,b)=>(b.clienteNome||"").localeCompare(a.clienteNome||""),'numeroPedido_asc':(a,b)=>(a.numeroPedido||"").localeCompare(b.numeroPedido||"",undefined,{numeric:true}),'numeroPedido_desc':(a,b)=>(b.numeroPedido||"").localeCompare(a.numeroPedido||"",undefined,{numeric:true})};pF.sort(sF[f.c]||sF['dataPedido_desc']); if(pF.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center py-10">Nenhum pedido encontrado.</td></tr>'; return;} tbody.innerHTML = pF.map(p => { const pM=JSON.stringify(p); const dE=p.dataEntrega?.toDate(); let sAC='';if(dE&&p.status!=='Entregue'&&p.status!=='Cancelado'){const dH=(dE-(new Date()))/36e5;if(dH<0)sAC='late';else if(dH<=24)sAC='nearly-late';} let aB=`<button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Detalhes"><i class="fas fa-eye"></i></button>`;if(['vendedor','admin'].includes(loggedInUserRole)){const bE=(p.status!=='Entregue'&&p.status!=='Cancelado')?`<button onclick="marcarComoEntregue('${p.id}')" class="btn-icon-action" title="Entregue">📦</button>`:'';aB+=` <button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Editar"><i class="fas fa-edit"></i></button>${bE}<button onclick="excluirPedido('${p.id}','${p.numeroPedido}')" class="btn-icon-action text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash"></i></button>`;}return `<tr><td class="pedido-numero ${sAC}">${p.numeroPedido}</td><td class="cliente-nome">${p.clienteNome}</td><td>${p.dataPedido?.toDate().toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})||'N/A'}</td><td>${dE?.toLocaleDateString('pt-BR')||'N/A'}</td><td class="font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td><td>${getStatusBadgeSimpleHTML(p)}</td><td class="text-xs space-x-1.5 whitespace-nowrap">${aB}</td></tr>`;}).join(''); }
        function carregarUltimosPedidos() { const tb=document.getElementById('ultimosPedidosTableBody');if(!tb)return;const pRecentes=[...todosOsPedidosCache].sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0)).slice(0,5);if(pRecentes.length===0)tb.innerHTML=`<tr><td colspan="6" class="text-center py-10">Nenhum pedido recente.</td></tr>`;else tb.innerHTML=pRecentes.map(p=>{const pM=JSON.stringify(p);const dE=p.dataEntrega?.toDate();let sAC='';if(dE&&p.status!=='Entregue'&&p.status!=='Cancelado'){const dH=(dE-(new Date()))/36e5;if(dH<0)sAC='late';else if(dH<=24)sAC='nearly-late';}let aB=`<button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Detalhes"><i class="fas fa-eye"></i></button>`;if(['vendedor','admin'].includes(loggedInUserRole)){const bE=(p.status!=='Entregue'&&p.status!=='Cancelado')?`<button onclick="marcarComoEntregue('${p.id}')" class="btn-icon-action" title="Entregue">📦</button>`:'';aB+=` <button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Editar"><i class="fas fa-edit"></i></button>${bE}<button onclick="excluirPedido('${p.id}','${p.numeroPedido}')" class="btn-icon-action text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash"></i></button>`;}return `<tr><td class="pedido-numero font-medium ${sAC}">${p.numeroPedido}</td><td>${p.clienteNome}</td><td>${p.dataPedido?.toDate().toLocaleDateString('pt-BR')||'N/A'}</td><td class="font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td><td>${getStatusBadgeSimpleHTML(p)}</td><td class="text-xs space-x-1 whitespace-nowrap">${aB}</td></tr>`;}).join('');}
        function carregarTodosPedidos() { if(!auth.currentUser)return;onSnapshot(query(collection(db,`artifacts/${shopInstanceAppId}/pedidos`)),(snap)=>{todosOsPedidosCache=snap.docs.map(doc=>({id:doc.id,...doc.data()}));atualizarEstatisticasUsuario();carregarUltimosPedidos();if(activeSectionId==='telaInicial')atualizarDashboard();if(activeSectionId==='visualizarPedidos')renderizarListaCompletaPedidos();if(activeSectionId==='cadastrarCliente'&&clienteSelecionadoId)exibirDetalhesClienteEProcurarPedidos(clienteSelecionadoId);},e=>{console.error("Erro pedidos:",e);exibirMensagem("Erro ao carregar pedidos.","error");});}
        function atualizarDashboard() { const m={h:document.getElementById('metricPedidosHoje'),p:document.getElementById('metricPedidosPendentes'),f:document.getElementById('metricFaturamentoMes'),c:document.getElementById('metricTotalClientes')}; if(!m.h||!m.p||!m.f||!m.c)return; m.c.textContent=clientesCache.length; if(todosOsPedidosCache.length===0){m.h.textContent='0';m.p.textContent='0';m.f.textContent='R$ 0,00';return;} const h=new Date(),hoje=new Date(h.getFullYear(),h.getMonth(),h.getDate()),iM=new Date(h.getFullYear(),h.getMonth(),1); let pH=0,pP=0,fM=0; todosOsPedidosCache.forEach(p=>{const dP=p.dataPedido?.toDate();if(!dP)return;if(dP>=hoje)pH++;if(p.status!=='Entregue'&&p.status!=='Cancelado')pP++;if(dP>=iM&&p.status!=='Cancelado')fM+=p.valorTotal||0;}); m.h.textContent=pH;m.p.textContent=pP;m.f.textContent=`R$ ${fM.toFixed(2).replace('.',',')}`; }

        window.prepararEdicaoPedido = (pObj) => {
            if (!pObj || !pObj.id) {
                exibirMensagem("Dados do pedido inválidos para edição.", "error");
                return;
            }
            editingOrderId = pObj.id;
            document.getElementById('editingOrderIdField').value = pObj.id;
            document.getElementById('formNovoPedido').reset();
            document.getElementById('itensPedidoContainer').innerHTML = '';
            document.getElementById('pagamentosContainer').innerHTML = '';
            itemPedidoCount = 0;
            pagamentoCount = 0;
            
            ['pedidoDescricaoGeral','pedidoClienteSearch','pedidoVendedor','pedidoStatus'].forEach(id => {
                const key = id.replace('pedido','').toLowerCase().replace('search','Nome');
                document.getElementById(id).value = pObj[key] || '';
            });
            
            document.getElementById('pedidoClienteId').value = pObj.clienteId || "";

            const dETS = pObj.dataEntrega && typeof pObj.dataEntrega.seconds === 'number' 
                ? new Timestamp(pObj.dataEntrega.seconds, pObj.dataEntrega.nanoseconds) 
                : null;
            const dE = dETS?.toDate();

            if (dE) {
                document.getElementById('pedidoDataEntrega').value = dE.toISOString().split('T')[0];
                document.getElementById('pedidoHoraEntrega').value = dE.toTimeString().split(' ')[0].substring(0, 5);
            } else {
                document.getElementById('pedidoDataEntrega').value = "";
                document.getElementById('pedidoHoraEntrega').value = "";
            }

            pedidoImagemBase64 = pObj.imagemPreviewPedidoBase64 || null;
            const pI = document.getElementById('pedidoImagemPreview'), pH = document.getElementById('pedidoImagemPreviewPlaceholder');
            if (pedidoImagemBase64) {
                pI.src = pedidoImagemBase64;
                pI.classList.remove('hidden');
                pH.classList.add('hidden');
            } else {
                pI.src = "#";
                pI.classList.add('hidden');
                pH.classList.remove('hidden');
            }

            if (pObj.itens && Array.isArray(pObj.itens)) {
                pObj.itens.forEach(item => {
                    adicionarItemPedidoForm(item);
                });
            }

            if (pObj.pagamentos && Array.isArray(pObj.pagamentos)) {
                pObj.pagamentos.forEach(pgto => {
                    adicionarPagamentoForm();
                    const cPFI = pagamentoCount;
                    const pIE = document.getElementById(`pagamentoItem-${cPFI}`);
                    if (pIE) {
                        pIE.querySelector('.forma-pagamento').value = pgto.forma;
                        pIE.querySelector('.valor-pago').value = pgto.valorPago;
                        pIE.querySelector('.observacao-pagamento').value = pgto.observacao || "";
                    }
                });
            }

            atualizarValorTotalPedido();
            document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-save mr-1.5"></i>Atualizar Pedido';
            mostrarSecao('novoPedido');
            setActiveMenuLink('novoPedido');
        };

        window.excluirPedido = (pedidoId, numeroPedido) => { showNotification({ message: `Excluir o pedido ${numeroPedido}?`, type: 'confirm-delete', onConfirm: async () => { try { await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId)); exibirMensagem('Pedido excluído!', 'success'); } catch (error) { console.error("Erro ao excluir pedido:", error); exibirMensagem('Erro ao excluir.', 'error'); } } }); }

        document.addEventListener('DOMContentLoaded', () => { 
            const produtoTipoPrecoEl = document.getElementById('produtoTipoPreco');
            if (produtoTipoPrecoEl) {
                togglePrecoFields();
            }
            const produtoTipoPrecoEditarEl = document.getElementById('produtoTipoPrecoEditar');
            if (produtoTipoPrecoEditarEl) {
                togglePrecoFieldsEditar();
            }
        });
    </script>
</body>
</html>
