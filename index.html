<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gráfica Rápida - Azure Flow (v43 - Persistência Login)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif; 
            background-color: var(--color-bg-app); 
            color: var(--color-text-main); 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease;
        }
        :root {
            /* Azure Flow Theme */
            --color-primary: theme('colors.sky.600');
            --color-primary-hover: theme('colors.sky.700');
            --color-primary-focus-ring: theme('colors.sky.400');
            --color-primary-text: theme('colors.sky.700'); 
            
            --color-text-main: theme('colors.slate.700');
            --color-text-muted: theme('colors.slate.500');
            --color-text-heading: theme('colors.slate.800');
            --color-text-on-primary: theme('colors.white');
            --color-text-on-dark: theme('colors.slate.200');

            --color-bg-app: theme('colors.slate.100'); 
            --color-bg-card: theme('colors.white'); 
            --color-bg-alt: theme('colors.slate.50'); 
            --color-bg-menu: theme('colors.slate.800');
            --color-bg-menu-hover: theme('colors.slate.700');
            
            --color-border-soft: theme('colors.slate.200');
            --color-border-medium: theme('colors.slate.300');
            --color-border-strong: theme('colors.slate.400');

            --color-success: theme('colors.green.500');
            --color-danger: theme('colors.red.600');
            --color-warning: theme('colors.amber.500');
            --color-info: theme('colors.blue.500');

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.06), 0 2px 4px -2px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);
        }

        .btn { 
            @apply font-semibold py-2.5 px-5 rounded-lg shadow-[var(--shadow-sm)] hover:shadow-[var(--shadow-md)] focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center text-sm transform hover:scale-[1.03];
        }
        .btn-primary {
            @apply bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-[var(--color-text-on-primary)] focus:ring-[var(--color-primary-focus-ring)];
        }
        .btn-secondary {
            @apply bg-slate-200 hover:bg-slate-300 text-slate-800 focus:ring-slate-400;
        }
        .btn-danger {
            @apply bg-[var(--color-danger)] hover:bg-red-700 text-white focus:ring-red-400;
        }
        .btn-outline {
            @apply bg-transparent border-2 border-[var(--color-primary)] text-[var(--color-primary)] hover:bg-[var(--color-primary)] hover:text-[var(--color-text-on-primary)] focus:ring-[var(--color-primary-focus-ring)];
        }
        .btn-icon-action { 
            @apply p-2 rounded-md text-[var(--color-text-muted)] hover:bg-slate-200 hover:text-[var(--color-primary)] transition-colors duration-150; 
        }

        .card { 
            @apply bg-[var(--color-bg-card)] p-6 sm:p-8 rounded-xl border border-[var(--color-border-soft)] shadow-[var(--shadow-lg)] transition-all duration-300 hover:shadow-[var(--shadow-xl)]; 
        }
        .input-field { 
            @apply mt-1.5 block w-full px-4 py-3 bg-white border border-[var(--color-border-medium)] rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] sm:text-sm transition-all;
        }
        .label-text {
            @apply block text-sm font-semibold text-[var(--color-text-muted)] mb-1.5; 
        }
        
        .hidden { display: none !important; }
        
        .main-content-section {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 400ms ease-out, transform 400ms ease-out;
        }
        .main-content-section.active-section {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal Universal */
        #universalModalOverlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.65) !important;
            z-index: 9999 !important; 
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 1rem !important; 
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease-in-out !important;
        }
        #universalModalOverlay.active {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        #universalModalContent { 
            background-color: white !important;
            border-radius: 0.75rem !important; 
            box-shadow: var(--shadow-xl) !important;
            width: 100% !important; 
            overflow: hidden !important; 
            transform: scale(0.95);
            opacity: 0;
            transition: opacity 0.25s ease-out, transform 0.25s ease-out !important;
            max-height: calc(100vh - 2rem); 
            display: flex !important; 
            flex-direction: column !important; 
        }
         #universalModalOverlay.active #universalModalContent {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
        .universal-modal-header {
            @apply px-6 py-4 flex justify-between items-center border-b border-[var(--color-border-soft)];
            flex-shrink: 0; 
        }
        .universal-modal-title {
            @apply text-lg font-semibold text-[var(--color-text-heading)];
        }
        .universal-modal-body {
            @apply p-6 text-sm text-[var(--color-text-main)] overflow-y-auto;
            flex-grow: 1; 
            flex-shrink: 1; 
        }
        .universal-modal-footer {
            @apply px-6 py-4 bg-slate-50 flex justify-end space-x-3 border-t border-[var(--color-border-soft)];
            flex-shrink: 0; 
        }
        .universal-modal-close-x { 
            @apply text-slate-400 hover:text-slate-600 text-2xl p-1 cursor-pointer transition-colors duration-150; 
        }


        /* Estilização do Menu */
        .exo-menu-container { background: var(--color-bg-menu); border-bottom: 1px solid theme('colors.slate.700');}
        .header-top-row { border-bottom-color: theme('colors.slate.700'); }
        .header-top-row .site-title { color: var(--color-text-on-dark); }
        ul.exo-menu > li > a { color: theme('colors.slate.400'); border-right-color: theme('colors.slate.700');}
        ul.exo-menu > li > a:hover, ul.exo-menu > li > a.active { background: var(--color-bg-menu-hover); color: var(--color-text-on-primary); }
        li.drop-down:before { color: theme('colors.slate.400'); }
        li.drop-down:hover:before { color: var(--color-text-on-primary); }
        li.drop-down > ul.drop-down-ul { background-color: theme('colors.slate.700'); }
        li.drop-down > ul.drop-down-ul > li > a { color: theme('colors.slate.300'); border-bottom-color: theme('colors.slate.600');}
        li.drop-down > ul.drop-down-ul > li > a:hover { background-color: var(--color-primary); color: var(--color-text-on-primary);}
        a.toggle-menu { color: theme('colors.slate.400'); border-color: theme('colors.slate.600');}
        a.toggle-menu:hover { background-color: theme('colors.slate.700'); color: var(--color-text-on-primary); }
        
        .content-area { @apply flex-1 p-6 sm:p-8 overflow-y-auto; }
        #visualizarPedidos .pedidos-table-container { @apply bg-white rounded-xl shadow-lg overflow-hidden; }
        #visualizarPedidos .pedidos-table { @apply w-full min-w-[800px]; } 
        #visualizarPedidos .pedidos-table th { @apply px-6 py-4 bg-sky-700 text-white text-left text-xs font-semibold uppercase tracking-wider;}
        #visualizarPedidos .pedidos-table td { @apply px-6 py-4 whitespace-nowrap text-sm text-slate-600 border-b border-slate-200;}
        #visualizarPedidos .pedidos-table tbody tr:hover { @apply bg-sky-50;}
        #visualizarPedidos .pedidos-table .pedido-numero { @apply font-medium text-sky-700; }
        #visualizarPedidos .pedidos-table .cliente-nome { @apply text-slate-700 font-medium; }

        .login-input { @apply focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)];}
        .login-button { @apply bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] focus:ring-[var(--color-primary-focus-ring)];}

        .image-drop-area { @apply mt-1 border-2 border-dashed border-[var(--color-border-medium)] p-6 rounded-lg flex flex-col justify-center items-center min-h-[180px] text-center cursor-pointer hover:border-[var(--color-primary)] transition-colors bg-[var(--color-bg-alt)] hover:bg-sky-50; }
        .preview-image { @apply max-w-full max-h-48 object-contain rounded-md; }
        #pedidoClienteResultados { @apply absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto;}
        #pedidoClienteResultados div { @apply px-4 py-2.5 hover:bg-sky-50 cursor-pointer text-sm text-slate-700;}
        .search-input-wrapper .fa-search { @apply absolute top-1/2 left-3.5 transform -translate-y-1/2 text-slate-400; }
        .search-input-wrapper input { @apply pl-10; }
        
        #telaInicial { background-color: var(--dashboard-bg); }
        .dashboard-header { @apply text-2xl sm:text-3xl font-semibold text-[var(--dashboard-text-heading)] mb-8 text-center; }
        .metric-card-dashboard { @apply bg-[var(--dashboard-card-bg)] rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl hover:scale-[1.02];}
        .metric-card-dashboard .card-header-color { @apply h-1.5; }
        .metric-card-dashboard .card-content { @apply p-5 flex items-center space-x-4;}
        .metric-card-dashboard .icon-wrapper-dashboard { @apply text-2xl p-3.5 rounded-lg flex items-center justify-center w-14 h-14; }
        .metric-card-dashboard .metric-details { @apply flex-1; }
        .metric-card-dashboard .metric-label-dashboard { @apply text-sm font-medium text-[var(--dashboard-text-muted)] mb-0.5; }
        .metric-card-dashboard .metric-value-dashboard { @apply text-3xl font-bold text-[var(--dashboard-text-value)];}
        .metric-card-dashboard.pedidos-hoje .card-header-color { background-color: var(--color-accent-teal); }
        .metric-card-dashboard.pedidos-hoje .icon-wrapper-dashboard { background-color: var(--color-accent-teal-light); color: var(--color-accent-teal); }
        .metric-card-dashboard.pedidos-pendentes .card-header-color { background-color: var(--color-accent-orange); }
        .metric-card-dashboard.pedidos-pendentes .icon-wrapper-dashboard { background-color: var(--color-accent-orange-light); color: var(--color-accent-orange); }
        .metric-card-dashboard.faturamento-mes .card-header-color { background-color: var(--color-accent-lime); }
        .metric-card-dashboard.faturamento-mes .icon-wrapper-dashboard { background-color: var(--color-accent-lime-light); color: var(--color-accent-lime); }
        .metric-card-dashboard.total-clientes .card-header-color { background-color: var(--color-accent-purple); }
        .metric-card-dashboard.total-clientes .icon-wrapper-dashboard { background-color: var(--color-accent-purple-light); color: var(--color-accent-purple); }
        .material-table-card { @apply bg-[var(--dashboard-card-bg)] rounded-xl shadow-lg p-0 overflow-hidden mt-10;}
        .material-table-header { @apply p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-[var(--dashboard-border-soft)];}
        .material-table-header h2 { @apply text-xl font-semibold text-[var(--dashboard-text-heading)] mb-3 sm:mb-0; }
        .material-table-header .btn-primary { @apply bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white;}
        .material-table-container { @apply overflow-x-auto;}
        .material-data-table { @apply w-full min-w-[700px]; }
        .material-data-table th, .material-data-table td { @apply px-6 py-4 text-left text-sm whitespace-nowrap text-[var(--dashboard-text-muted)]; }
        .material-data-table td { @apply text-[var(--color-text-main)];}
        .material-data-table thead th { @apply bg-slate-100 text-slate-600 font-semibold uppercase tracking-wider text-xs border-b-2 border-[var(--dashboard-border-medium)]; }
        .material-data-table tbody tr { @apply border-b border-[var(--dashboard-border-soft)]; }
        .material-data-table tbody tr:last-child { @apply border-b-0;}
        .material-data-table tbody tr:hover { @apply bg-slate-50 transition-colors duration-150; }
        
        .status-badge-simple { @apply px-2.5 py-1 text-xs font-semibold rounded-full inline-flex items-center capitalize leading-none;}
        .status-badge-simple.success { @apply bg-green-100 text-green-700; }
        .status-badge-simple.danger { @apply bg-red-100 text-red-700; }
        .status-badge-simple.warning { @apply bg-amber-100 text-amber-700; }
        .status-badge-simple.info { @apply bg-sky-100 text-sky-700; }
        .status-badge-simple.primary { @apply bg-indigo-100 text-indigo-700; } 
        .status-badge-simple.neutral { @apply bg-slate-200 text-slate-600; }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-card">
            <img src="https://placehold.co/150x60/0ea5e9/FFFFFF?text=SuaGraficaPRO&font=poppins" alt="Logo Gráfica PRO" class="mx-auto mb-6 h-12">
            <h2 class="login-title">Acesso ao Sistema</h2>
            <p class="login-subtitle">Insira o seu código de funcionário para continuar.</p>
            <form id="loginForm">
                <input type="password" id="codigoAcesso" class="login-input" placeholder="Código de Acesso" required>
                <button type="submit" class="login-button">Entrar</button>
            </form>
            <p id="loginErrorMessage" class="hidden"></p>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <div class="exo-menu-container">
            <div class="header-top-row">
                <div class="logo-area flex-shrink-0 flex items-center">
                    <img src="https://placehold.co/120x32/0ea5e9/FFFFFF?text=SuaLogo&font=poppins" alt="Logo Gráfica" class="h-6 sm:h-8">
                    <span id="loggedInUserNameDisplay" class="ml-3 text-slate-100 font-semibold hidden"></span>
                </div>
                <h1 class="site-title">Sistema de Gestão PRO</h1>
                <div class="actions-area flex-shrink-0 w-[120px] sm:w-[150px]"> 
                    <button id="logoutButton" class="btn btn-secondary-dark text-xs py-1.5 px-3"><i class="fas fa-sign-out-alt mr-1.5"></i>Sair</button>
                </div>
            </div>
        
            <div class="menu-bar-wrapper"> 
                <ul class="exo-menu clearfix">
                    <li data-role-access="all"><a href="#" class="active" onclick="mostrarSecao('telaInicial', true)" data-section="telaInicial"><i class="fa fa-home"></i> Home</a></li>
                    <li data-role-access="admin,vendedor"><a href="#" onclick="mostrarSecao('novoPedido', true)" data-section="novoPedido"><i class="fa fa-plus"></i> Novo Pedido</a></li>
                    <li class="drop-down" data-role-access="admin,vendedor,designer">
                        <a href="#"><i class="fa fa-archive"></i> Cadastros</a>
                        <ul class="drop-down-ul">
                            <li data-role-access="admin,vendedor"><a href="#" onclick="mostrarSecao('cadastrarCliente', true)" data-section="cadastrarCliente">Clientes</a></li>
                            <li data-role-access="admin,designer"><a href="#" onclick="mostrarSecao('cadastrarProduto', true)" data-section="cadastrarProduto">Produtos</a></li>
                            <li data-role-access="admin"><a href="#" onclick="mostrarSecao('cadastrarFuncionario', true)" data-section="cadastrarFuncionario">Funcionários</a></li>
                            <li data-role-access="admin"><a href="#" onclick="mostrarSecao('cadastrarFornecedor', true)" data-section="cadastrarFornecedor">Fornecedores</a></li>
                        </ul>
                    </li>
                    <li data-role-access="all"><a href="#" onclick="mostrarSecao('visualizarPedidos', true)" data-section="visualizarPedidos"><i class="fa fa-list-alt"></i> Pedidos</a></li>
                </ul>
                <a href="#" class="toggle-menu"><i class="fas fa-bars"></i></a>
            </div>
        </div>


        <div class="main-layout" style="padding-top: 0;"> <main id="mainContentArea" class="content-area w-full"> 
                <section id="telaInicial" class="main-content-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> 
                    <h1 class="dashboard-header">Painel de Controlo</h1> 
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card-dashboard pedidos-hoje">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard"><i class="fas fa-calendar-day"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Pedidos Hoje</div>
                                    <div id="metricPedidosHoje" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard pedidos-pendentes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard"><i class="fas fa-hourglass-half"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Pendentes</div>
                                    <div id="metricPedidosPendentes" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard faturamento-mes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard"><i class="fas fa-dollar-sign"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Faturamento Mês</div>
                                    <div id="metricFaturamentoMes" class="metric-value-dashboard">R$0,00</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard total-clientes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                               <div class="icon-wrapper-dashboard"><i class="fas fa-users"></i></div>
                                <div class="metric-details">
                                   <div class="metric-label-dashboard">Total Clientes</div>
                                   <div id="metricTotalClientes" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="material-table-card">
                        <div class="material-table-header">
                            <h2>Últimos Pedidos</h2>
                            <button onclick="mostrarSecao('visualizarPedidos', true)" class="btn btn-primary text-xs py-2 px-3"><i class="fas fa-list-ul mr-2"></i>Ver Todos</button>
                        </div>
                        <div class="material-table-container">
                            <table class="material-data-table">
                                <thead>
                                    <tr>
                                        <th>Nº Pedido</th>
                                        <th>Cliente</th>
                                        <th>Data</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ultimosPedidosTableBody">
                                    <tr><td colspan="6" class="text-center text-slate-500 py-10">Nenhum pedido recente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="novoPedido" class="main-content-section hidden card max-w-3xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-6 pb-4 border-b border-[var(--color-border-soft)]">Novo Pedido</h2>
                    <form id="formNovoPedido" class="space-y-6">
                        <input type="hidden" id="editingOrderIdField"> 
                        <div>
                            <label for="pedidoDataHora" class="label-text">Data e Hora do Pedido:</label>
                            <input type="text" id="pedidoDataHora" class="input-field bg-slate-100 cursor-not-allowed" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="relative">
                                <label for="pedidoClienteSearch" class="label-text">Cliente:</label>
                                <input type="text" id="pedidoClienteSearch" class="input-field" placeholder="Pesquisar cliente...">
                                <input type="hidden" id="pedidoClienteId">
                                <div id="pedidoClienteResultados" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 shadow-lg max-h-48 overflow-y-auto hidden">
                                </div>
                                <button type="button" onclick="abrirModalNovoClienteRapido()" class="mt-2 btn btn-link text-xs">Registar novo cliente</button>
                            </div>
                            <div>
                                <label for="pedidoVendedor" class="label-text">Funcionário (Vendedor):</label>
                                <select id="pedidoVendedor" class="input-field">
                                    <option value="">Selecione um funcionário</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="label-text">Preview do Pedido (Opcional):</label>
                            <div id="pedidoImageDropArea" class="image-drop-area" onclick="document.getElementById('pedidoImagemFile').click();">
                                <input type="file" accept="image/*" class="hidden" id="pedidoImagemFile" onchange="handleImagemFilePedido(event)">
                                <img src="#" alt="Preview do Pedido" id="pedidoImagemPreview" class="hidden preview-image">
                                <span id="pedidoImagemPreviewPlaceholder" class="text-[var(--color-text-muted)] text-sm">
                                    <i class="fas fa-image fa-2x mb-1.5 text-slate-400"></i><br>
                                    Cole ou clique para carregar imagem
                                </span>
                            </div>
                        </div>
                        <div class="pt-5 border-t border-[var(--color-border-soft)]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-[var(--color-text-heading)]">Itens do Pedido</h3>
                            </div>
                            <div id="itensPedidoContainer" class="space-y-4"></div>
                            <button type="button" onclick="adicionarItemPedidoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-plus mr-1.5"></i>Adicionar Produto</button>
                        </div>
                        
                        <div class="pt-5 border-t border-[var(--color-border-soft)]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-[var(--color-text-heading)]">Detalhes do Pagamento</h3>
                            </div>
                            <div id="pagamentosContainer" class="space-y-4">
                            </div>
                            <button type="button" onclick="adicionarPagamentoForm()" class="mt-4 btn btn-outline btn-small text-sm"><i class="fas fa-dollar-sign mr-1.5"></i>Adicionar Pagamento</button>
                            
                            <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label class="label-text">Valor Total do Pedido:</label>
                                    <input type="text" id="pedidoValorTotal" class="input-field bg-slate-100 text-lg font-semibold text-[var(--color-primary)] cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                                <div>
                                    <label class="label-text">Total Pago:</label>
                                    <input type="text" id="pedidoTotalPago" class="input-field bg-slate-100 text-lg font-semibold text-green-600 cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                                 <div>
                                    <label class="label-text">Valor Restante:</label>
                                    <input type="text" id="pedidoValorRestante" class="input-field bg-slate-100 text-lg font-semibold text-red-600 cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                            </div>
                        </div>


                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-5 border-t border-[var(--color-border-soft)]">
                            <div class="grid grid-cols-2 gap-4">
                                 <div>
                                    <label for="pedidoDataEntrega" class="label-text">Data Entrega:</label>
                                    <input type="date" id="pedidoDataEntrega" class="input-field">
                                </div>
                                <div>
                                    <label for="pedidoHoraEntrega" class="label-text">Hora Entrega:</label>
                                    <input type="time" id="pedidoHoraEntrega" class="input-field">
                                </div>
                            </div>
                             <div>
                                <label for="pedidoStatus" class="label-text">Estado do Pedido:</label>
                                <select id="pedidoStatus" class="input-field">
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                       
                        <div class="flex justify-end space-x-3 pt-6 border-t border-[var(--color-border-soft)]">
                            <button type="button" onclick="mostrarSecao('telaInicial', true); document.getElementById('editingOrderIdField').value = ''; document.querySelector('#formNovoPedido button[type=\'submit\']').innerHTML = '<i class=\'fas fa-check mr-1.5\'></i>Guardar Pedido';" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-check mr-1.5"></i>Guardar Pedido</button>
                        </div>
                    </form>
                </section>

                <section id="cadastrarCliente" class="main-content-section hidden card">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5">Registar Cliente</h2>
                            <form id="formCadastrarCliente" class="space-y-4">
                                <div>
                                    <label for="clienteNome" class="label-text">Nome Completo / Razão Social:</label>
                                    <input type="text" id="clienteNome" class="input-field" required>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteTipo" class="label-text">Tipo de Cliente:</label>
                                        <select id="clienteTipo" class="input-field">
                                            <option value="final">Cliente Final</option>
                                            <option value="revenda">Revenda</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="clienteTelefone" class="label-text">Telefone:</label>
                                        <input type="tel" id="clienteTelefone" class="input-field">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteEmail" class="label-text">Email:</label>
                                        <input type="email" id="clienteEmail" class="input-field">
                                    </div>
                                    <div>
                                        <label for="clienteCpfCnpj" class="label-text">CPF/CNPJ (Opcional):</label>
                                        <input type="text" id="clienteCpfCnpj" class="input-field">
                                    </div>
                                </div>
                                <div>
                                    <label for="clienteEndereco" class="label-text">Endereço (Opcional):</label>
                                    <input type="text" id="clienteEndereco" class="input-field">
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Cliente</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-lg font-semibold text-[var(--color-text-heading)] mb-1">Clientes Registados</h3>
                            <div class="search-input-wrapper">
                                <i class="fas fa-search"></i>
                                <input type="text" id="pesquisaClienteInput" class="input-field w-full" placeholder="Pesquisar cliente por nome, telefone...">
                            </div>
                            <div id="listaClientes" class="space-y-2.5 max-h-60 sm:max-h-72 lg:max-h-[calc(100vh-340px)] overflow-y-auto pr-1">
                                <p class="text-[var(--color-text-muted)] text-sm">Nenhum cliente registado.</p>
                            </div>
                            
                            <div id="detalhesClienteSelecionado" class="mt-6 hidden">
                                <h4 class="text-md font-semibold text-[var(--color-text-heading)] mb-2 border-t pt-4">Detalhes do Cliente</h4>
                                <div id="infoCliente" class="p-3 border border-[var(--color-border-soft)] rounded-md bg-slate-50 mb-4 text-sm space-y-1">
                                </div>
                                <h4 class="text-md font-semibold text-[var(--color-text-heading)] mb-2">Pedidos do Cliente</h4>
                                <div id="pedidosDoClienteLista" class="space-y-2.5 max-h-40 sm:max-h-48 overflow-y-auto pr-1 border rounded-md p-2 bg-slate-50">
                                    <p class="text-[var(--color-text-muted)] text-xs text-center py-2">Selecione um cliente para ver os seus pedidos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="cadastrarProduto" class="main-content-section hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Produto</h2>
                    <form id="formCadastrarProduto" class="space-y-4">
                        <div>
                            <label for="produtoNome" class="label-text">Nome do Produto:</label>
                            <input type="text" id="produtoNome" class="input-field" required> </div>
                        <div>
                            <label for="produtoTipoPreco" class="label-text">Tipo de Precificação:</label>
                            <select id="produtoTipoPreco" class="input-field" onchange="togglePrecoFields()">
                                <option value="unidade">Por Unidade/Pacote</option>
                                <option value="metro">Por Metro Quadrado (m²)</option>
                            </select>
                        </div>
                        <div id="precoUnidadeFields">
                            <label for="produtoPrecoUnidade" class="label-text">Preço Unitário (R$):</label>
                            <input type="number" step="0.01" id="produtoPrecoUnidade" class="input-field">
                        </div>
                        <div id="precoMetroFields" class="hidden">
                            <label for="produtoPrecoMetro" class="label-text">Preço por Metro Quadrado (R$/m²):</label>
                            <input type="number" step="0.01" id="produtoPrecoMetro" class="input-field">
                        </div>
                        <div>
                            <label for="produtoDescricao" class="label-text">Descrição (Opcional):</label>
                            <textarea id="produtoDescricao" rows="3" class="input-field"></textarea>
                            </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-box mr-1.5"></i>Guardar Produto</button>
                        </div>
                    </form>
                     <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Produtos Registados</h3>
                        <div id="listaProdutos" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                             <p class="text-[var(--color-text-muted)] text-sm">Nenhum produto registado.</p>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFuncionario" class="main-content-section hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Funcionário</h2>
                    <form id="formCadastrarFuncionario" class="space-y-4">
                        <div>
                            <label for="funcionarioNome" class="label-text">Nome do Funcionário:</label>
                            <input type="text" id="funcionarioNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="funcionarioContato" class="label-text">Contacto (Telefone/Email - Opcional):</label>
                            <input type="text" id="funcionarioContato" class="input-field">
                        </div>
                        <div>
                            <label for="funcionarioCargo" class="label-text">Cargo:</label>
                            <select id="funcionarioCargo" class="input-field">
                                <option value="Administrador">Administrador</option>
                                <option value="Vendedor" selected>Vendedor</option>
                                <option value="Produção">Produção</option>
                                <option value="Impressor">Impressor</option>
                                <option value="Designer">Designer</option>
                                <option value="Freelancer">Freelancer</option>
                            </select>
                        </div>
                         <div>
                            <label for="funcionarioCodigoAcesso" class="label-text">Código de Acesso:</label>
                            <input type="text" id="funcionarioCodigoAcesso" class="input-field" placeholder="Ex: 123456" required>
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Funcionário</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Funcionários Registados</h3>
                        <div id="listaFuncionarios" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-[var(--color-text-muted)] text-sm">Nenhum funcionário registado.</p>
                        </div>
                    </div>
                </section>

                <section id="cadastrarFornecedor" class="main-content-section hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Fornecedor</h2>
                    <form id="formCadastrarFornecedor" class="space-y-4">
                        <div>
                            <label for="fornecedorNome" class="label-text">Nome do Fornecedor:</label>
                            <input type="text" id="fornecedorNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="fornecedorContato" class="label-text">Contacto (Telefone/Email):</label>
                            <input type="text" id="fornecedorContato" class="input-field">
                        </div>
                        <div>
                            <label for="fornecedorMaterial" class="label-text">Tipo de Material Fornecido:</label>
                            <input type="text" id="fornecedorMaterial" class="input-field">
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-1.5"></i>Guardar Fornecedor</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Fornecedores Registados</h3>
                        <div id="listaFornecedores" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-[var(--color-text-muted)] text-sm">Nenhum fornecedor registado.</p>
                        </div>
                    </div>
                </section>

                <section id="visualizarPedidos" class="main-content-section hidden card">
                     <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Todos os Pedidos</h2>
                    <div class="mb-6 p-4 border border-[var(--color-border-soft)] rounded-lg bg-slate-50">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3 items-end">
                            <div>
                                <label for="filtroNomeCliente" class="label-text text-xs">Nome do Cliente:</label>
                                <input type="text" id="filtroNomeCliente" class="input-field input-field-sm py-1.5" placeholder="Pesquisar nome...">
                            </div>
                            <div>
                                <label for="filtroNumeroPedido" class="label-text text-xs">Nº do Pedido:</label>
                                <input type="text" id="filtroNumeroPedido" class="input-field input-field-sm py-1.5" placeholder="Pesquisar número...">
                            </div>
                            <div>
                                <label for="filtroDataPedido" class="label-text text-xs">Data do Pedido:</label>
                                <input type="date" id="filtroDataPedido" class="input-field input-field-sm py-1.5">
                            </div>
                            <div>
                                <label for="filtroMaterialProduto" class="label-text text-xs">Produto/Material (nos Itens):</label>
                                <input type="text" id="filtroMaterialProduto" class="input-field input-field-sm py-1.5" placeholder="Pesquisar item...">
                            </div>
                            <div>
                                <label for="filtroStatusPedido" class="label-text text-xs">Estado do Pedido:</label>
                                <select id="filtroStatusPedido" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Estados</option>
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroVendedor" class="label-text text-xs">Funcionário (Vendedor):</label>
                                <select id="filtroVendedor" class="input-field input-field-sm py-1.5">
                                    <option value="">Todos os Funcionários</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroClassificacaoPedido" class="label-text text-xs">Classificar por:</label>
                                <select id="filtroClassificacaoPedido" class="input-field input-field-sm py-1.5">
                                    <option value="dataPedido_desc">Data Pedido (Mais Recentes)</option>
                                    <option value="dataPedido_asc">Data Pedido (Mais Antigos)</option>
                                    <option value="dataEntrega_asc">Data Entrega (Mais Próximos)</option>
                                    <option value="dataEntrega_desc">Data Entrega (Mais Distantes)</option>
                                    <option value="clienteNome_asc">Nome Cliente (A-Z)</option>
                                    <option value="clienteNome_desc">Nome Cliente (Z-A)</option>
                                    <option value="numeroPedido_asc">Nº Pedido (Crescente)</option>
                                    <option value="numeroPedido_desc">Nº Pedido (Decrescente)</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 lg:col-span-1 lg:col-start-3">
                                 <button id="limparFiltrosPedidos" class="btn btn-secondary w-full text-sm py-2"><i class="fas fa-times mr-2"></i>Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    <div id="listaTodosPedidosContainer" class="pedidos-table-container">
                        <table class="pedidos-table">
                            <thead>
                                <tr>
                                    <th>Nº Pedido</th>
                                    <th>Cliente</th>
                                    <th>Data Pedido</th>
                                    <th>Data Entrega</th>
                                    <th>Valor Total</th>
                                    <th>Estado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaTodosPedidos">
                                <tr><td colspan="7" class="text-center text-slate-500 py-10">Nenhum pedido encontrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal Novo Cliente Rápido -->
    <div id="modalNovoClienteRapidoOverlay" class="modal-overlay hidden">
        <div id="modalNovoClienteRapidoContent" class="modal-content-wrapper max-w-md">
            <div class="h-2 bg-[var(--color-primary)] rounded-t-lg"></div> 
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalNovoClienteRapido()">&times;</button>
                <h3 class="text-lg font-semibold text-[var(--color-text-heading)] mb-5">Registo Rápido de Cliente</h3>
                <form id="formNovoClienteRapido" class="space-y-4">
                    <div>
                        <label for="clienteRapidoNome" class="label-text">Nome:</label>
                        <input type="text" id="clienteRapidoNome" class="input-field" required>
                    </div>
                    <div>
                        <label for="clienteRapidoTelefone" class="label-text">Telefone:</label>
                        <input type="tel" id="clienteRapidoTelefone" class="input-field">
                    </div>
                    <div>
                        <label for="clienteRapidoTipo" class="label-text">Tipo de Cliente:</label>
                        <select id="clienteRapidoTipo" class="input-field">
                            <option value="final" selected>Cliente Final</option>
                            <option value="revenda">Revenda</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2.5 pt-4">
                        <button type="button" onclick="fecharModalNovoClienteRapido()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Código Funcionário -->
    <div id="modalEditarCodigoFuncionarioOverlay" class="modal-overlay hidden">
        <div id="modalEditarCodigoFuncionarioContent" class="modal-content-wrapper max-w-sm">
            <div class="h-2 bg-[var(--color-primary)] rounded-t-lg"></div>
            <div class="p-6 relative">
                <button type="button" class="universal-modal-close-x no-print absolute top-4 right-4" onclick="fecharModalEditarCodigoFuncionario()">&times;</button>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Editar Código de Acesso</h3>
                <p class="text-sm text-slate-600 mb-4" id="nomeFuncionarioParaEditarCodigo"></p>
                <form id="formEditarCodigoFuncionario">
                    <input type="hidden" id="funcionarioIdParaEditarCodigo">
                    <div>
                        <label for="novoCodigoAcesso" class="label-text">Novo Código:</label>
                        <input type="text" id="novoCodigoAcesso" class="input-field" required>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalEditarCodigoFuncionario()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Código</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal Universal -->
    <div id="universalModalOverlay" class="modal-overlay hidden">
        <div id="universalModalContent" class="modal-content-wrapper max-w-md">
            {/* O conteúdo será injetado aqui pelo JavaScript */}
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDocs, 
            query, 
            limit,
            onSnapshot, 
            Timestamp,
            writeBatch,
            deleteDoc, 
            setDoc,
            updateDoc, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyDOg6A8HFA_JCP_4iS7JcRCTRgdnzcP4Xk",
  authDomain: "sistema-grafica-pro.firebaseapp.com",
  projectId: "sistema-grafica-pro",
  storageBucket: "sistema-grafica-pro.firebasestorage.app",
  messagingSenderId: "1043193530848",
  appId: "1:1043193530848:web:b0effc9640a2e8ed6f8385"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const shopInstanceAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let userId = null, produtosCache = [], pedidoImagemBase64 = null, todosOsPedidosCache = [], clientesCache = [], fornecedoresCache = [], funcionariosCache = [];
        let itemPedidoCount = 0, pagamentoCount = 0, clienteSelecionadoId = null, editingOrderId = null, loggedInUserRole = null, loggedInUserName = null; 
        let currentUniversalModalConfirmCallback = null;
        let currentUniversalModalCancelCallback = null;

        async function criarDadosIniciaisSeNaoExistirem() {
            if (!auth.currentUser) { return; }
            const clientesPath = `artifacts/${shopInstanceAppId}/clientes`;
            let clientesSnapshot = await getDocs(query(collection(db, clientesPath), limit(1)));
            if (clientesSnapshot.empty) {
                const clientesAmostra = [
                    { nome: "Carlos Silva", tipoCliente: "final", telefone: "(11) 98765-4321", email: "carlos.silva@example.com", cpfCnpj: "123.456.789-00", endereco: "Rua das Palmeiras, 123", criadoEm: Timestamp.now() },
                    { nome: "Padaria Pão Quente Ltda", tipoCliente: "revenda", telefone: "(21) 91234-5678", email: "contato@paoquente.com.br", cpfCnpj: "12.345.678/0001-99", endereco: "Av. Central, 456", criadoEm: Timestamp.now() }
                ];
                const batchClientes = writeBatch(db);
                clientesAmostra.forEach(cliente => { batchClientes.set(doc(collection(db, clientesPath)), cliente); });
                await batchClientes.commit();
            }
            const produtosPath = `artifacts/${shopInstanceAppId}/produtos`;
            let produtosSnapshot = await getDocs(query(collection(db, produtosPath), limit(1)));
            if (produtosSnapshot.empty) {
                const produtosAmostra = [
                    { nome: "Banner Lona Fosca 440g", tipoPreco: "metro", precoMetro: 55.00, precoUnidade: 0, descricao: "Banner em lona fosca.", criadoEm: Timestamp.now() },
                    { nome: "Cartão de Visita Couchê 300g (Milheiro)", tipoPreco: "unidade", precoUnidade: 120.00, precoMetro: 0, descricao: "Milheiro de cartões.", criadoEm: Timestamp.now() },
                    { nome: "Adesivo Vinil Recorte", tipoPreco: "metro", precoMetro: 70.00, precoUnidade: 0, descricao: "Adesivo com recorte.", criadoEm: Timestamp.now() }
                ];
                const batchProdutos = writeBatch(db);
                produtosAmostra.forEach(produto => { batchProdutos.set(doc(collection(db, produtosPath)), produto); });
                await batchProdutos.commit();
            }
            const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`; 
            let funcionariosSnapshot = await getDocs(query(collection(db, funcionariosPath), limit(1)));
            if (funcionariosSnapshot.empty) {
                const batchFuncionarios = writeBatch(db);
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Admin Master", contato: "admin@grafica.com", cargo: "admin", codigoAcesso: "010101", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Vendedor Padrão", contato: "vendedor@grafica.com", cargo: "vendedor", codigoAcesso: "111111", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Impressor Teste", contato: "impressor@grafica.com", cargo: "impressor", codigoAcesso: "222222", criadoEm: Timestamp.now() });
                batchFuncionarios.set(doc(collection(db, funcionariosPath)), { nome: "Produção Teste", contato: "producao@grafica.com", cargo: "producao", codigoAcesso: "333333", criadoEm: Timestamp.now() });
                await batchFuncionarios.commit();
            }
            const fornecedoresPath = `artifacts/${shopInstanceAppId}/fornecedores`;
            let fornecedoresSnapshot = await getDocs(query(collection(db, fornecedoresPath), limit(1)));
            if (fornecedoresSnapshot.empty) {
                const fornecedoresAmostra = [
                    { nome: "Fornecedor de Lonas ABC", contato: "vendas@lonasabc.com", tipoMaterial: "Lonas e Vinis", criadoEm: Timestamp.now() },
                    { nome: "Papelaria Central", contato: "(11) 3333-4444", tipoMaterial: "Papéis Especiais", criadoEm: Timestamp.now() }
                ];
                const batchFornecedores = writeBatch(db);
                fornecedoresAmostra.forEach(fornecedor => { batchFornecedores.set(doc(collection(db, fornecedoresPath)), fornecedor); });
                await batchFornecedores.commit();
            }
            const pedidosPath = `artifacts/${shopInstanceAppId}/pedidos`;
            const pedidosQuery = query(collection(db, pedidosPath), limit(1));
            const pedidosSnapshot = await getDocs(pedidosQuery);
            const clientesAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/clientes`));
            let tempClientesCache = [];
            clientesAtualizadosSnapshot.forEach(doc => tempClientesCache.push({ id: doc.id, ...doc.data() }));
            const produtosAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/produtos`));
            let tempProdutosCache = [];
            produtosAtualizadosSnapshot.forEach(doc => tempProdutosCache.push({ id: doc.id, ...doc.data() }));
            const funcionariosAtualizadosSnapshot = await getDocs(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`));
            let tempFuncionariosCache = [];
            funcionariosAtualizadosSnapshot.forEach(doc => tempFuncionariosCache.push({ id: doc.id, ...doc.data() }));

            if (pedidosSnapshot.empty && tempClientesCache.length > 0 && tempProdutosCache.length > 0 && tempFuncionariosCache.length > 0) {
                const batchPedidos = writeBatch(db);
                const statusPossiveis = ["Aguardando Aprovação", "Em Produção (Arte)", "Em Produção (Impressão)", "Pronto para Retirada", "Entregue", "Cancelado"];
                const formasPagamentoPossiveis = ["Dinheiro", "Cartão de Crédito", "PIX", "Pendente"];
                for (let i = 0; i < 20; i++) {
                    const clienteAleatorio = tempClientesCache[Math.floor(Math.random() * tempClientesCache.length)];
                    const funcionarioAleatorio = tempFuncionariosCache[Math.floor(Math.random() * tempFuncionariosCache.length)]; 
                    const dataPedido = new Date(); dataPedido.setDate(dataPedido.getDate() - Math.floor(Math.random() * 30)); 
                    const dataEntrega = new Date(dataPedido); dataEntrega.setDate(dataPedido.getDate() + Math.floor(Math.random() * 7) + 1); 
                    const itensPedidoExemplo = []; let valorTotalPedidoExemplo = 0;
                    const numItens = Math.floor(Math.random() * 3) + 1; 
                    for (let j = 0; j < numItens; j++) {
                        const produtoAleatorio = tempProdutosCache[Math.floor(Math.random() * tempProdutosCache.length)];
                        const quantidade = Math.floor(Math.random() * 5) + 1; let valorItem = 0; let largura = null, altura = null;
                        if (produtoAleatorio.tipoPreco === 'metro') {
                            largura = parseFloat((Math.random() * 2 + 0.5).toFixed(2)); altura = parseFloat((Math.random() * 2 + 0.5).toFixed(2));  
                            valorItem = largura * altura * (produtoAleatorio.precoMetro || 0) * quantidade;
                        } else { valorItem = (produtoAleatorio.precoUnidade || 0) * quantidade; }
                        itensPedidoExemplo.push({ produtoId: produtoAleatorio.id, produtoNome: produtoAleatorio.nome, tipoProduto: produtoAleatorio.tipoPreco, quantidade, largura, altura, valorItem });
                        valorTotalPedidoExemplo += valorItem;
                    }
                    const pagamentosExemplo = []; const numPagamentos = Math.random() > 0.6 ? 2 : 1; let valorPagoTotalExemplo = 0;
                    if (numPagamentos === 1) {
                        pagamentosExemplo.push({ forma: formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)], valorPago: valorTotalPedidoExemplo, observacao: "Pagamento integral", dataPagamento: Timestamp.fromDate(dataPedido) });
                        valorPagoTotalExemplo = valorTotalPedidoExemplo;
                    } else {
                        const valorMetade = parseFloat((valorTotalPedidoExemplo / 2).toFixed(2));
                        pagamentosExemplo.push({ forma: formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)], valorPago: valorMetade, observacao: "50% de entrada", dataPagamento: Timestamp.fromDate(dataPedido) });
                        valorPagoTotalExemplo += valorMetade;
                        const formaSegundoPagamento = formasPagamentoPossiveis[Math.floor(Math.random() * formasPagamentoPossiveis.length)];
                        if (formaSegundoPagamento !== "Pendente") {
                             pagamentosExemplo.push({ forma: formaSegundoPagamento, valorPago: valorTotalPedidoExemplo - valorMetade, observacao: "Restante", dataPagamento: Timestamp.fromDate(dataEntrega) });
                            valorPagoTotalExemplo += (valorTotalPedidoExemplo - valorMetade);
                        } else { pagamentosExemplo.push({ forma: "Pendente", valorPago: 0, observacao: "Restante pendente", dataPagamento: null }); }
                    }
                    const novoPedidoExemplo = { clienteId: clienteAleatorio.id, clienteNome: clienteAleatorio.nome, vendedorId: funcionarioAleatorio.id, vendedorNome: funcionarioAleatorio.nome, pagamentos: pagamentosExemplo, dataEntrega: Timestamp.fromDate(dataEntrega), status: statusPossiveis[Math.floor(Math.random() * statusPossiveis.length)], valorTotal: valorTotalPedidoExemplo, itens: itensPedidoExemplo, imagemPreviewPedidoBase64: null, dataPedido: Timestamp.fromDate(dataPedido), numeroPedido: `PED-EX${Date.now().toString().slice(-5) + i}` };
                    batchPedidos.set(doc(collection(db, pedidosPath)), novoPedidoExemplo);
                }
                await batchPedidos.commit();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid; 
                await criarDadosIniciaisSeNaoExistirem(); 
                await Promise.all([ carregarClientes(), carregarProdutos(), carregarFuncionarios(), carregarFornecedores() ]);
                carregarTodosPedidos(); 
                
                const loginForm = document.getElementById('loginForm');
                if(loginForm) loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('codigoAcesso').value); });
                
                const logoutButton = document.getElementById('logoutButton');
                if(logoutButton) logoutButton.addEventListener('click', logout);

                // Verifica se há sessão guardada no localStorage
                const storedRole = localStorage.getItem('loggedInUserRole');
                const storedName = localStorage.getItem('loggedInUserName');

                if (storedRole && storedName) {
                    loggedInUserRole = storedRole;
                    loggedInUserName = storedName;
                    
                    const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
                    const logoImg = document.querySelector('.logo-area img');
                    if (loggedInUserNameDisplay && logoImg) {
                        loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`;
                        logoImg.classList.add('hidden');
                        loggedInUserNameDisplay.classList.remove('hidden');
                    }
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    configurarAcessoPorCargo(loggedInUserRole);
                    setActiveMenuLink('telaInicial');
                    mostrarSecao('telaInicial', false); 
                    ajustarPaddingBody();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('appContainer').classList.add('hidden');
                }
                
                const pedidoDropArea = document.getElementById('pedidoImageDropArea');
                if (pedidoDropArea) pedidoDropArea.addEventListener('paste', handlePasteImagePedido);
                
                const pesquisaClienteInputEl = document.getElementById('pesquisaClienteInput');
                if(pesquisaClienteInputEl) pesquisaClienteInputEl.addEventListener('input', () => renderizarListaClientes());
                
                const toggleMenuBtn = document.querySelector('.exo-menu-container .toggle-menu');
                const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                if (toggleMenuBtn && exoMenuEl) toggleMenuBtn.addEventListener('click', (e) => { e.preventDefault(); exoMenuEl.classList.toggle('display'); });

                const formEditarCodigoFuncionarioEl = document.getElementById('formEditarCodigoFuncionario');
                if(formEditarCodigoFuncionarioEl) formEditarCodigoFuncionarioEl.addEventListener('submit', handleSalvarNovoCodigoFuncionario);

                const filtroNomeClienteEl = document.getElementById('filtroNomeCliente');
                const filtroNumeroPedidoEl = document.getElementById('filtroNumeroPedido');
                const filtroDataPedidoEl = document.getElementById('filtroDataPedido');
                const filtroMaterialProdutoEl = document.getElementById('filtroMaterialProduto');
                const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
                const filtroClassificacaoPedidoEl = document.getElementById('filtroClassificacaoPedido');
                const filtroVendedorEl = document.getElementById('filtroVendedor'); 
                const limparFiltrosPedidosBtn = document.getElementById('limparFiltrosPedidos');

                if (filtroNomeClienteEl) filtroNomeClienteEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroNumeroPedidoEl) filtroNumeroPedidoEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroDataPedidoEl) filtroDataPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroMaterialProdutoEl) filtroMaterialProdutoEl.addEventListener('input', renderizarListaCompletaPedidos);
                if (filtroStatusPedidoEl) filtroStatusPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroClassificacaoPedidoEl) filtroClassificacaoPedidoEl.addEventListener('change', renderizarListaCompletaPedidos);
                if (filtroVendedorEl) filtroVendedorEl.addEventListener('change', renderizarListaCompletaPedidos); 

                if (limparFiltrosPedidosBtn) {
                    limparFiltrosPedidosBtn.addEventListener('click', () => {
                        if (filtroNomeClienteEl) filtroNomeClienteEl.value = '';
                        if (filtroNumeroPedidoEl) filtroNumeroPedidoEl.value = '';
                        if (filtroDataPedidoEl) filtroDataPedidoEl.value = '';
                        if (filtroMaterialProdutoEl) filtroMaterialProdutoEl.value = '';
                        if (filtroStatusPedidoEl) filtroStatusPedidoEl.value = '';
                        if (filtroClassificacaoPedidoEl) filtroClassificacaoPedidoEl.value = 'dataPedido_desc'; 
                        if (filtroVendedorEl) filtroVendedorEl.value = ''; 
                        renderizarListaCompletaPedidos(); 
                    });
                }

            } else { 
                try { await signInAnonymously(auth); } catch (error) { console.error("Erro login anônimo:", error); exibirMensagem("Erro autenticação.", "error");}
            }
        });

        async function handleLogin(codigo) {
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('appContainer');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            const codigoAcessoInput = document.getElementById('codigoAcesso');
            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
            const logoImg = document.querySelector('.logo-area img');

            loginErrorMessage.classList.add('hidden'); 
            if (!auth.currentUser) { loginErrorMessage.textContent = "Aguardando autenticação. Tente novamente."; loginErrorMessage.classList.remove('hidden'); return; }

            try {
                const funcionariosRef = collection(db, `artifacts/${shopInstanceAppId}/funcionarios`);
                const q = query(funcionariosRef, where("codigoAcesso", "==", codigo));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const funcionarioData = querySnapshot.docs[0].data();
                    loggedInUserRole = funcionarioData.cargo.toLowerCase(); 
                    loggedInUserName = funcionarioData.nome; 

                    // Guardar no localStorage
                    localStorage.setItem('loggedInUserRole', loggedInUserRole);
                    localStorage.setItem('loggedInUserName', loggedInUserName);

                    if (loggedInUserNameDisplay && logoImg) { loggedInUserNameDisplay.textContent = `Olá, ${loggedInUserName}`; logoImg.classList.add('hidden'); loggedInUserNameDisplay.classList.remove('hidden'); }
                    loginScreen.classList.add('hidden'); appContainer.classList.remove('hidden'); codigoAcessoInput.value = ''; 
                    configurarAcessoPorCargo(loggedInUserRole); setActiveMenuLink('telaInicial'); mostrarSecao('telaInicial', false); ajustarPaddingBody();
                } else {
                    loginErrorMessage.textContent = "Código inválido."; loginErrorMessage.classList.remove('hidden'); loggedInUserRole = null; loggedInUserName = null;
                }
            } catch (error) { console.error("Erro login:", error); loginErrorMessage.textContent = "Erro. Tente novamente."; loginErrorMessage.classList.remove('hidden'); loggedInUserRole = null; loggedInUserName = null;}
        }

        function logout() {
            loggedInUserRole = null; loggedInUserName = null; 
            // Limpar do localStorage
            localStorage.removeItem('loggedInUserRole');
            localStorage.removeItem('loggedInUserName');

            const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
            const logoImg = document.querySelector('.logo-area img');
            if (loggedInUserNameDisplay && logoImg) { loggedInUserNameDisplay.textContent = ''; loggedInUserNameDisplay.classList.add('hidden'); logoImg.classList.remove('hidden'); }
            document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('codigoAcesso').value = ''; 
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) filtroStatusPedidoEl.value = '';
            ajustarPaddingBody(); 
        }

        function configurarAcessoPorCargo(role) {
            document.querySelectorAll('.exo-menu > li, .exo-menu .drop-down-ul > li').forEach(item => {
                const acessoPermitido = item.dataset.roleAccess;
                if (acessoPermitido) { item.classList.toggle('hidden', !(acessoPermitido === "all" || (role && acessoPermitido.includes(role)))); }
            });
            const cadastrosDropdown = document.querySelector('.exo-menu > li.drop-down');
            if (cadastrosDropdown) {
                const subItensVisiveis = cadastrosDropdown.querySelectorAll('ul.drop-down-ul > li:not(.hidden)');
                cadastrosDropdown.classList.toggle('hidden', subItensVisiveis.length === 0);
            }
            const filtroStatusPedidoEl = document.getElementById('filtroStatusPedido');
            if (filtroStatusPedidoEl) {
                if (role === 'impressor') filtroStatusPedidoEl.value = 'Em Produção (Impressão)';
                else filtroStatusPedidoEl.value = ''; 
            }
            if (activeSectionId === 'visualizarPedidos') renderizarListaCompletaPedidos();
        }

        function ajustarPaddingBody() {
            const menuContainer = document.querySelector('.exo-menu-container');
            document.body.style.paddingTop = (menuContainer && !document.getElementById('appContainer').classList.contains('hidden')) ? menuContainer.offsetHeight + 'px' : '0px';
        }
        window.addEventListener('resize', ajustarPaddingBody); 

        let activeSectionId = 'telaInicial';
        function setActiveMenuLink(targetSectionId) { 
            document.querySelectorAll('.exo-menu > li > a').forEach(link => { link.classList.remove('active'); if (link.dataset.section === targetSectionId) link.classList.add('active'); });
            document.querySelectorAll('.exo-menu li.drop-down').forEach(dd => {
                let hasActiveChild = false;
                dd.querySelectorAll('ul.drop-down-ul li a').forEach(childLink => { childLink.classList.remove('active'); if (childLink.dataset.section === targetSectionId) { childLink.classList.add('active'); hasActiveChild = true; } });
                const parentLink = dd.querySelector('a:first-child'); 
                if (parentLink) { parentLink.classList.toggle('active', hasActiveChild || parentLink.dataset.section === targetSectionId); }
            });
        }
        
        function mostrarSecao(idSecao, isMenuLink = false) { 
            if (!loggedInUserRole && idSecao !== 'loginScreen') { logout(); return; }
            
            document.querySelectorAll('.main-content-section').forEach(secao => {
                secao.classList.add('hidden');
                secao.classList.remove('active-section'); 
            });

            const targetSection = document.getElementById(idSecao);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                void targetSection.offsetWidth; 
                targetSection.classList.add('active-section');

                activeSectionId = idSecao; 
                document.getElementById('mainContentArea').scrollTop = 0;
                if (isMenuLink) {
                    setActiveMenuLink(idSecao);
                    const exoMenuEl = document.querySelector('.exo-menu-container .exo-menu');
                    if (window.innerWidth < 768 && exoMenuEl && exoMenuEl.classList.contains('display')) exoMenuEl.classList.remove('display');
                }
            } else { if (loggedInUserRole) mostrarSecao('telaInicial', true); return; }

            if (idSecao === 'novoPedido') {
                 if (!editingOrderId) { 
                    document.getElementById('pedidoDataHora').value = new Date().toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                    document.getElementById('formNovoPedido').reset(); 
                    document.getElementById('itensPedidoContainer').innerHTML = ''; document.getElementById('pagamentosContainer').innerHTML = ''; 
                    itemPedidoCount = 0; pagamentoCount = 0; pedidoImagemBase64 = null; 
                    const prevImg = document.getElementById('pedidoImagemPreview'), ph = document.getElementById('pedidoImagemPreviewPlaceholder');
                    if (prevImg && ph) { prevImg.src = "#"; prevImg.classList.add('hidden'); ph.classList.remove('hidden'); }
                    atualizarValorTotalPedido(); 
                    document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
                    document.getElementById('editingOrderIdField').value = ''; document.getElementById('pedidoClienteSearch').value = ''; 
                    document.getElementById('pedidoClienteId').value = ''; document.getElementById('pedidoClienteResultados').classList.add('hidden'); 
                }
            } else {
                if (editingOrderId && activeSectionId !== 'novoPedido') {
                    editingOrderId = null; document.getElementById('editingOrderIdField').value = '';
                    document.querySelector('#formNovoPedido button[type="submit"]').innerHTML = '<i class="fas fa-check mr-1.5"></i>Guardar Pedido';
                }
            }
            if (idSecao === 'telaInicial') atualizarDashboard(); 
            if (idSecao === 'cadastrarCliente') { document.getElementById('pesquisaClienteInput').value = ''; renderizarListaClientes(); document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; }
            if (idSecao === 'cadastrarFornecedor') document.getElementById('formCadastrarFornecedor').reset();
            if (idSecao === 'visualizarPedidos') renderizarListaCompletaPedidos();
        }
        window.mostrarSecao = mostrarSecao; 

        // Funções do Modal Universal (Atualizadas)
        function abrirUniversalModal(config) {
            const overlay = document.getElementById('universalModalOverlay');
            const contentHost = document.getElementById('universalModalContent');
            const mainContentArea = document.getElementById('mainContentArea'); // Referência à área de conteúdo principal

            if (!overlay || !contentHost) {
                console.error("Elementos do Modal Universal não encontrados.");
                return;
            }

            currentUniversalModalConfirmCallback = config.confirmCallback || null;
            currentUniversalModalCancelCallback = config.cancelCallback || null;

            let headerColorClass = 'bg-sky-600'; 
            let iconHtml = '<i class="fas fa-info-circle text-sky-500 text-4xl"></i>';
            let confirmButtonClasses = 'btn btn-primary'; 
            let confirmButtonText = 'OK';
            let cancelButtonText = 'Cancelar';
            let showCancelButton = false;
            let modalSizeClass = 'max-w-sm'; 

            switch (config.type) {
                case 'success':
                    headerColorClass = 'bg-green-500';
                    iconHtml = '<i class="fas fa-check-circle text-green-500 text-5xl"></i>';
                    confirmButtonClasses = 'btn bg-green-500 hover:bg-green-600 text-white focus:ring-green-400';
                    break;
                case 'error':
                    headerColorClass = 'bg-red-600';
                    iconHtml = '<i class="fas fa-times-circle text-red-600 text-5xl"></i>';
                    confirmButtonClasses = 'btn bg-red-600 hover:bg-red-700 text-white focus:ring-red-400';
                    break;
                case 'warning':
                    headerColorClass = 'bg-amber-500';
                    iconHtml = '<i class="fas fa-exclamation-triangle text-amber-500 text-5xl"></i>';
                    confirmButtonClasses = 'btn bg-amber-500 hover:bg-amber-600 text-white focus:ring-amber-400';
                    break;
                case 'delete-confirm':
                    headerColorClass = 'bg-red-600';
                    iconHtml = '<i class="fas fa-exclamation-triangle text-red-600 text-4xl"></i>';
                    confirmButtonClasses = 'btn btn-danger';
                    confirmButtonText = 'Excluir';
                    showCancelButton = true;
                    modalSizeClass = config.size === 'md' ? 'max-w-md' : (config.size === 'lg' ? 'max-w-lg' : 'max-w-sm');
                    break;
                case 'confirm':
                    headerColorClass = 'bg-sky-600';
                    iconHtml = '<i class="fas fa-question-circle text-sky-500 text-4xl"></i>';
                    confirmButtonClasses = 'btn btn-primary';
                    confirmButtonText = 'Sim';
                    showCancelButton = true;
                    modalSizeClass = config.size === 'md' ? 'max-w-md' : (config.size === 'lg' ? 'max-w-lg' : 'max-w-sm');
                    break;
                case 'alert': 
                default:
                     modalSizeClass = config.size === 'md' ? 'max-w-md' : (config.size === 'lg' ? 'max-w-lg' : 'max-w-sm');
                    break;
            }
            
            contentHost.className = `modal-content-wrapper ${modalSizeClass} transform transition-all duration-300 opacity-0 scale-95`;

            contentHost.innerHTML = `
                <div class="h-2.5 ${headerColorClass} rounded-t-xl"></div>
                <div class="universal-modal-header">
                    <h3 class="universal-modal-title">${config.title || 'Alerta'}</h3>
                    <button id="universalModalCloseX" class="universal-modal-close-x">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="universal-modal-body ${config.type !== 'confirm' && config.type !== 'delete-confirm' ? 'text-center' : ''}">
                    ${(config.type !== 'confirm' && config.type !== 'delete-confirm' && config.type !== 'alert-no-icon') ? `<div class="mb-5">${iconHtml}</div>` : ''}
                    <p class="leading-relaxed">${config.message}</p>
                </div>
                <div class="universal-modal-footer">
                    ${showCancelButton ? `<button id="universalModalGeneratedCancelButton" class="btn btn-secondary">${cancelButtonText}</button>` : ''}
                    <button id="universalModalGeneratedConfirmButton" class="${confirmButtonClasses} ${!showCancelButton ? 'w-full sm:w-auto' : ''}">${confirmButtonText}</button>
                </div>
            `;

            document.getElementById('universalModalCloseX').addEventListener('click', () => fecharUniversalModal(config.cancelCallback));
            if (showCancelButton) {
                document.getElementById('universalModalGeneratedCancelButton').addEventListener('click', () => fecharUniversalModal(currentUniversalModalCancelCallback));
            }
            document.getElementById('universalModalGeneratedConfirmButton').addEventListener('click', () => {
                fecharUniversalModal(() => { // Passa o callback de confirmação para ser executado APÓS o fecho do modal
                    if (currentUniversalModalConfirmCallback) {
                        currentUniversalModalConfirmCallback();
                    }
                });
            });
            
            if (overlay.parentNode !== document.body) {
                 document.body.appendChild(overlay); 
            }
            document.documentElement.style.overflow = 'hidden'; 
            document.body.style.overflow = 'hidden'; 
            // if(mainContentArea) mainContentArea.style.overflow = 'hidden'; // Desabilitado para ver se html/body é suficiente

            overlay.classList.remove('hidden');
            requestAnimationFrame(() => { 
                overlay.classList.add('active');
                contentHost.classList.remove('opacity-0', 'scale-95');
                contentHost.classList.add('opacity-100', 'scale-100');
            });
        }

        function fecharUniversalModal(onClosedCallback) { // Renomeado para onClosedCallback
            const overlay = document.getElementById('universalModalOverlay');
            const contentHost = document.getElementById('universalModalContent');
            // const mainContentArea = document.getElementById('mainContentArea'); // Não precisa mais
            if (!overlay || !contentHost) return;

            overlay.classList.remove('active');
            contentHost.classList.remove('opacity-100', 'scale-100');
            contentHost.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                overlay.classList.add('hidden');
                contentHost.innerHTML = ''; 
                document.documentElement.style.overflow = ''; 
                document.body.style.overflow = '';
                // if(mainContentArea) mainContentArea.style.overflow = 'auto'; // Desabilitado
                
                if (onClosedCallback && typeof onClosedCallback === 'function') {
                    onClosedCallback(); 
                }
                currentUniversalModalConfirmCallback = null;
                currentUniversalModalCancelCallback = null;
            }, 250); 
        }

        window.exibirMensagem = (mensagem, tipo = 'success') => { 
            let title = "Sucesso!";
            if (tipo === 'error') title = "Erro!";
            else if (tipo === 'warning') title = "Atenção!";
            else if (tipo === 'info') title = "Informação";
            
            abrirUniversalModal({
                title: title,
                message: mensagem,
                type: tipo, 
                confirmCallback: () => {} // Callback vazio para o botão OK
            });
        }
        
        // Funções para os modais específicos (Novo Cliente, Editar Código)
        function abrirModalEspecifico(overlayId, contentId) {
            const overlay = document.getElementById(overlayId);
            const mainContentArea = document.getElementById('mainContentArea');
            if (!overlay) return;
            if (overlay.parentNode !== document.body) document.body.appendChild(overlay);
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            // if(mainContentArea) mainContentArea.style.overflow = 'hidden'; // Desabilitado
            overlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                overlay.classList.add('active'); 
                const content = document.getElementById(contentId);
                if(content) {
                    content.classList.remove('opacity-0', 'scale-95');
                    content.classList.add('opacity-100', 'scale-100');
                }
            });
        }

        function fecharModalEspecifico(overlayId, contentId, callback) {
            const overlay = document.getElementById(overlayId);
            const mainContentArea = document.getElementById('mainContentArea');
            if (!overlay) return;
            overlay.classList.remove('active');
            const content = document.getElementById(contentId);
            if(content) {
                content.classList.remove('opacity-100', 'scale-100');
                content.classList.add('opacity-0', 'scale-95');
            }
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.documentElement.style.overflow = '';
                document.body.style.overflow = '';
                // if(mainContentArea) mainContentArea.style.overflow = 'auto'; // Desabilitado
                if (callback) callback();
            }, 250);
        }


        window.abrirModalNovoClienteRapido = () => { 
            const form = document.getElementById('formNovoClienteRapido');
            if(form) form.reset(); 
            abrirModalEspecifico('modalNovoClienteRapidoOverlay', 'modalNovoClienteRapidoContent'); 
        };
        window.fecharModalNovoClienteRapido = () => fecharModalEspecifico('modalNovoClienteRapidoOverlay', 'modalNovoClienteRapidoContent');
        
        window.abrirModalEditarCodigoFuncionario=(fId,nome,cA)=>{
            document.getElementById('funcionarioIdParaEditarCodigo').value=fId;
            document.getElementById('nomeFuncionarioParaEditarCodigo').textContent=`Funcionário: ${nome}`;
            document.getElementById('novoCodigoAcesso').value=cA||'';
            abrirModalEspecifico('modalEditarCodigoFuncionarioOverlay','modalEditarCodigoFuncionarioContent');
        }
        window.fecharModalEditarCodigoFuncionario=()=>fecharModalEspecifico('modalEditarCodigoFuncionarioOverlay','modalEditarCodigoFuncionarioContent');

        window.abrirDetalhesPedidoNovaGuia = (pedido) => {
            const reconstructTimestamp = (tsObj) => (tsObj && typeof tsObj.seconds === 'number' && typeof tsObj.nanoseconds === 'number') ? new Timestamp(tsObj.seconds, tsObj.nanoseconds) : null;
            const formatDate = (ts) => { const t = reconstructTimestamp(ts); return t ? t.toDate().toLocaleDateString('pt-BR') : 'N/A'; };
            const formatDateTime = (ts) => { const t = reconstructTimestamp(ts); return t ? t.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'; };
            let dataPedidoTexto = formatDateTime(pedido.dataPedido);
            let dataEntregaFormatada = formatDate(pedido.dataEntrega);
            const dataEntregaTS = reconstructTimestamp(pedido.dataEntrega);
            if (dataEntregaTS && (dataEntregaTS.toDate().getHours() !== 0 || dataEntregaTS.toDate().getMinutes() !== 0)) dataEntregaFormatada = formatDateTime(pedido.dataEntrega);
            let itensHtml = pedido.itens?.length > 0 ? pedido.itens.map(item => `<li>${item.quantidade}x ${item.produtoNome}${item.tipoProduto==='metro'&&item.largura&&item.altura?` (${item.largura.toFixed(2)}m x ${item.altura.toFixed(2)}m)`:''} - R$ ${item.valorItem.toFixed(2).replace('.',',')}</li>`).join('') : '<li>Nenhum item.</li>';
            let pagamentosHtml = 'Nenhum pagamento.'; let totalPagoCalculado = 0;
            if (pedido.pagamentos?.length > 0) {
                pagamentosHtml = '<ul>';
                pedido.pagamentos.forEach(pgto => { const dP = pgto.dataPagamento ? formatDateTime(pgto.dataPagamento) : 'N/A'; pagamentosHtml += `<li>${pgto.forma}: R$ ${pgto.valorPago.toFixed(2).replace('.',',')} ${pgto.observacao?'('+pgto.observacao+')':''} - Data: ${dP}</li>`; totalPagoCalculado += pgto.valorPago; });
                pagamentosHtml += '</ul>';
            }
            const valorRestanteCalculado = (pedido.valorTotal || 0) - totalPagoCalculado;
            const conteudoHtml = `<html><head><title>Pedido: ${pedido.numeroPedido||'N/A'}</title><style>body{font-family:'Poppins',Arial,sans-serif;margin:20px;background-color:#f1f5f9;color:#334155;font-size:14px}:root{--color-primary: #0ea5e9; --color-text-main: #334155; --color-text-heading: #1e293b; --color-text-muted: #64748b; --color-border-soft: #e2e8f0; --color-border-medium: #cbd5e1; --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);}.container{max-width:700px;margin:auto;background-color:#fff;padding:25px;border-radius:12px;box-shadow:var(--shadow-lg);border:1px solid var(--color-border-soft)}.company-header{display:flex;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid var(--color-border-soft)}.company-header img{max-height:50px;margin-right:20px}.company-header .company-info p{margin:2px 0;font-size:.9em;color:var(--color-text-muted)}.company-header .company-info strong{color:var(--color-text-heading); font-weight:600;}h1{text-align:center;color:var(--color-primary);border-bottom:2px solid var(--color-primary);padding-bottom:10px;margin-bottom:25px;font-size:1.6em;font-weight:600}.section-title{font-size:1.15em;font-weight:600;color:var(--color-text-heading);margin-top:25px;margin-bottom:10px;border-bottom:1px solid var(--color-border-medium);padding-bottom:6px}p{margin-bottom:8px;line-height:1.65}strong{font-weight:500;color:var(--color-text-main)}ul{list-style:disc;margin-left:20px;padding-left:5px}li{margin-bottom:5px}.total-section{margin-top:30px;padding-top:20px;border-top:2px solid var(--color-primary);text-align:right}.total-section p{font-size:1.25em;font-weight:600;color:var(--color-primary)}.payment-summary p{font-size:1.05em;margin-bottom:4px;text-align:right}.payment-summary strong{font-weight:600}.print-button-container{text-align:center;margin-top:30px}.print-button{background-color:var(--color-primary);color:white;padding:12px 24px;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:background-color .2s}.print-button:hover{background-color:#0284c7}.footer-note{font-size:.85em;color:var(--color-text-muted);text-align:center;margin-top:30px;padding-top:15px;border-top:1px solid var(--color-border-soft)}img.pedido-preview-print{max-width:100%;max-height:280px;display:block;margin:20px auto;border:1px solid var(--color-border-medium);border-radius:8px;page-break-inside:avoid;object-fit:contain}@media print{body{margin:0;padding:0;background-color:#fff;color:#000;font-size:10pt; --color-primary: #0ea5e9; --color-text-main: #000;}.container{margin:0;padding:10mm;box-shadow:none;border-radius:0;border:none;width:100%;max-width:100%}.print-button-container{display:none}h1{color:var(--color-primary)!important;border-color:var(--color-primary)!important}}</style></head><body><div class="container"><div class="company-header"><img src="https://placehold.co/150x50/0ea5e9/FFFFFF?text=SuaGrafica&font=poppins" alt="Logo da Gráfica"><div class="company-info"><p><strong>Empresa:</strong> Gráfica Exemplo</p><p><strong>CNPJ:</strong> 00.000.000/0001-00</p><p><strong>Endereço:</strong> Rua Exemplo, 123, Cidade</p><p><strong>Telefone:</strong> (00) 0000-0000</p><p><strong>Email:</strong> contato@suagrafica.com</p></div></div><h1>Pedido: ${pedido.numeroPedido||'N/A'}</h1><div class="section-title">Cliente</div><p><strong>Nome:</strong> ${pedido.clienteNome||'N/A'}</p><div class="section-title">Pedido</div><p><strong>Número:</strong> ${pedido.numeroPedido||'N/A'}</p><p><strong>Data:</strong> ${dataPedidoTexto}</p><p><strong>Entrega:</strong> ${dataEntregaFormatada}</p><p><strong>Vendedor:</strong> ${pedido.vendedorNome||'N/A'}</p><p><strong>Estado:</strong> ${pedido.status||'N/A'}</p><div class="section-title">Pagamentos</div>${pagamentosHtml}${pedido.imagemPreviewPedidoBase64?`<div class="section-title">Preview</div><img class="pedido-preview-print" src="${pedido.imagemPreviewPedidoBase64}" alt="Preview" />`:''}<div class="section-title">Itens</div><ul>${itensHtml}</ul><div class="payment-summary total-section"><p><strong>Total Pedido:</strong> R$ ${pedido.valorTotal?.toFixed(2).replace('.',',')||'0,00'}</p><p><strong>Total Pago:</strong> R$ ${totalPagoCalculado.toFixed(2).replace('.',',')}</p>${valorRestanteCalculado>0?`<p style="color:red"><strong>Restante:</strong> R$ ${valorRestanteCalculado.toFixed(2).replace('.',',')}</p>`:'<p style="color:green"><strong>Quitado</strong></p>'}</div><div class="print-button-container"><button class="print-button" onclick="window.print()">Imprimir</button></div><p class="footer-note">Gerado em: ${new Date().toLocaleString('pt-BR')}</p></div></body></html>`;
            const nG = window.open('', '_blank');
            if (nG) { nG.document.open(); nG.document.write(conteudoHtml); nG.document.close(); } else { exibirMensagem("Bloqueador de pop-up impediu nova guia.", "warning"); }
        }
        
        const formCadastrarCliente = document.getElementById('formCadastrarCliente');
        formCadastrarCliente.addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            const d = { nome:document.getElementById('clienteNome').value, tipoCliente:document.getElementById('clienteTipo').value, telefone:document.getElementById('clienteTelefone').value, email:document.getElementById('clienteEmail').value, cpfCnpj:document.getElementById('clienteCpfCnpj').value, endereco:document.getElementById('clienteEndereco').value, criadoEm:Timestamp.now() };
            try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), d); exibirMensagem('Cliente registado com sucesso!', 'success'); formCadastrarCliente.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar cliente.', 'error'); }
        });

        function renderizarListaClientes() {
            const lE = document.getElementById('listaClientes'); const pI = document.getElementById('pesquisaClienteInput');
            const tP = pI ? pI.value.toLowerCase() : ''; if (!lE) return; lE.innerHTML = '';
            const cF = clientesCache.filter(c => (c.nome&&c.nome.toLowerCase().includes(tP))||(c.telefone&&c.telefone.toLowerCase().includes(tP))||(c.email&&c.email.toLowerCase().includes(tP)));
            if (cF.length === 0) { lE.innerHTML = `<p class="text-[var(--color-text-muted)] text-sm text-center py-3">${tP?'Nenhum cliente encontrado.':'Nenhum cliente registado.'}</p>`; document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); clienteSelecionadoId = null; return; }
            cF.forEach(c => { const d=document.createElement('div'); d.className=`item-list-display ${c.id===clienteSelecionadoId?'selected':''}`; d.onclick=()=>exibirDetalhesClienteEProcurarPedidos(c.id); let tipo=c.tipoCliente==='revenda'?'Revenda':'Final'; d.innerHTML=`<strong>${c.nome}</strong> <span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle">${tipo}</span><div class="meta">${c.telefone||'S/ Telefone'}</div>`; lE.appendChild(d); });
        }

        function exibirDetalhesClienteEProcurarPedidos(id) {
            clienteSelecionadoId = id; renderizarListaClientes(); 
            const cli = clientesCache.find(c => c.id === id);
            const dD = document.getElementById('detalhesClienteSelecionado'), iCD = document.getElementById('infoCliente'), pLD = document.getElementById('pedidosDoClienteLista');
            if (!cli||!dD||!iCD||!pLD) return;
            iCD.innerHTML = `<p><strong>Nome:</strong> ${cli.nome||'N/A'}</p><p><strong>Tel:</strong> ${cli.telefone||'N/A'}</p><p><strong>Email:</strong> ${cli.email||'N/A'}</p><p><strong>Tipo:</strong> ${cli.tipoCliente==='revenda'?'Revenda':'Final'}</p>${cli.cpfCnpj?`<p><strong>CPF/CNPJ:</strong> ${cli.cpfCnpj}</p>`:''}${cli.endereco?`<p><strong>Endereço:</strong> ${cli.endereco}</p>`:''}`;
            dD.classList.remove('hidden'); pLD.innerHTML = '<p class="text-[var(--color-text-muted)] text-xs text-center py-2">A carregar...</p>';
            const pDC = todosOsPedidosCache.filter(p => p.clienteId === id); pDC.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));
            if (pDC.length === 0) { pLD.innerHTML = '<p class="text-[var(--color-text-muted)] text-xs text-center py-2">Nenhum pedido para este cliente.</p>'; return; }
            pLD.innerHTML = ''; pDC.forEach(p => { const iPD=document.createElement('div'); iPD.className='p-2.5 border-b border-[var(--color-border-soft)] text-xs last:border-b-0'; const dP=p.dataPedido?.toDate().toLocaleDateString('pt-BR')||'N/A'; iPD.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-[var(--color-primary)]">${p.numeroPedido}</span><span class="text-[var(--color-text-muted)]">${dP}</span></div><div class="flex justify-between items-center mt-1"><span>R$ ${p.valorTotal.toFixed(2).replace('.',',')}</span>${getStatusBadgeSimpleHTML(p.status)}</div><button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(p))}')))" class="btn btn-link text-xs p-0 mt-1">Ver detalhes</button>`; pLD.appendChild(iPD); });
        }

        function carregarClientes() {
            if (!auth.currentUser) return; 
            const q = query(collection(db, `artifacts/${shopInstanceAppId}/clientes`)); 
            onSnapshot(q, (snap) => {
                clientesCache = []; 
                if (snap.empty && activeSectionId === 'cadastrarCliente') document.getElementById('listaClientes').innerHTML = '<p class="text-[var(--color-text-muted)] text-sm text-center py-3">Nenhum cliente registado.</p>'; 
                snap.forEach(doc => clientesCache.push({ id: doc.id, ...doc.data() })); 
                clientesCache.sort((a, b) => (a.nome||"").localeCompare(b.nome||""));
                if (activeSectionId === 'cadastrarCliente') renderizarListaClientes(); 
                if (activeSectionId === 'telaInicial') atualizarDashboard();
            }, e => { console.error("Erro clientes:", e); exibirMensagem("Erro ao carregar clientes.", "error"); });
        }

        document.getElementById('formNovoClienteRapido').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            const nome=document.getElementById('clienteRapidoNome').value, tel=document.getElementById('clienteRapidoTelefone').value, tipo=document.getElementById('clienteRapidoTipo').value; 
            if (!nome.trim()) { exibirMensagem("Nome do cliente é obrigatório.", "warning"); return; }
            try { const ref = await addDoc(collection(db, `artifacts/${shopInstanceAppId}/clientes`), { nome, telefone:tel, tipoCliente:tipo, email:'', cpfCnpj:'', endereco:'', criadoEm:Timestamp.now() }); 
                exibirMensagem('Cliente registado com sucesso!', 'success'); fecharModalNovoClienteRapido(); 
                document.getElementById('pedidoClienteSearch').value = nome; document.getElementById('pedidoClienteId').value = ref.id;
                document.getElementById('pedidoClienteResultados').innerHTML = ''; document.getElementById('pedidoClienteResultados').classList.add('hidden');
            } catch (err) { console.error(err); exibirMensagem('Erro ao registar cliente.', 'error'); }
        });

        const pedidoClienteSearchEl = document.getElementById('pedidoClienteSearch');
        const pedidoClienteResultadosEl = document.getElementById('pedidoClienteResultados');
        const pedidoClienteIdEl = document.getElementById('pedidoClienteId');
        if (pedidoClienteSearchEl) {
            pedidoClienteSearchEl.addEventListener('input', () => {
                const t=pedidoClienteSearchEl.value.toLowerCase(); pedidoClienteResultadosEl.innerHTML='';
                if(t.length<2){pedidoClienteResultadosEl.classList.add('hidden');pedidoClienteIdEl.value='';return;}
                const res=clientesCache.filter(c=>(c.nome&&c.nome.toLowerCase().includes(t))||(c.telefone&&String(c.telefone).toLowerCase().includes(t))||(c.email&&c.email.toLowerCase().includes(t)));
                if(res.length>0){res.forEach(cli=>{const d=document.createElement('div');d.textContent=`${cli.nome} ${cli.telefone?'- '+cli.telefone:''}`;d.onclick=()=>{pedidoClienteSearchEl.value=cli.nome;pedidoClienteIdEl.value=cli.id;pedidoClienteResultadosEl.classList.add('hidden');pedidoClienteResultadosEl.innerHTML='';};pedidoClienteResultadosEl.appendChild(d);});pedidoClienteResultadosEl.classList.remove('hidden');}else{const d=document.createElement('div');d.textContent='Nenhum cliente encontrado.';d.classList.add('text-slate-500','italic');pedidoClienteResultadosEl.appendChild(d);pedidoClienteResultadosEl.classList.remove('hidden');pedidoClienteIdEl.value='';}
            });
            document.addEventListener('click', (ev) => { if (pedidoClienteSearchEl&&!pedidoClienteSearchEl.contains(ev.target)&&pedidoClienteResultadosEl&&!pedidoClienteResultadosEl.contains(ev.target)) pedidoClienteResultadosEl.classList.add('hidden'); });
        }

        window.togglePrecoFields=()=>{const t=document.getElementById('produtoTipoPreco')?.value; if(!t)return; document.getElementById('precoUnidadeFields').classList.toggle('hidden',t==='metro');document.getElementById('precoMetroFields').classList.toggle('hidden',t==='unidade');};
        document.getElementById('formCadastrarProduto').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            const d={nome:document.getElementById('produtoNome').value,tipoPreco:document.getElementById('produtoTipoPreco').value,precoUnidade:parseFloat(document.getElementById('produtoPrecoUnidade').value)||0,precoMetro:parseFloat(document.getElementById('produtoPrecoMetro').value)||0,descricao:document.getElementById('produtoDescricao').value,criadoEm:Timestamp.now()};
            if(!d.nome.trim()){exibirMensagem("Nome do produto é obrigatório.","warning");return;}
            try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/produtos`), d); exibirMensagem('Produto registado com sucesso!', 'success'); e.target.reset(); togglePrecoFields(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar produto.', 'error'); }
        });
        function carregarProdutos() {
            if (!auth.currentUser) return; 
            const q = query(collection(db, `artifacts/${shopInstanceAppId}/produtos`));
            onSnapshot(q, (snap) => {
                const l=document.getElementById('listaProdutos'); if(l)l.innerHTML=''; produtosCache=[]; 
                if(snap.empty){if(l)l.innerHTML='<p class="text-[var(--color-text-muted)] text-sm text-center py-3">Nenhum produto registado.</p>';}
                const pS=[]; snap.forEach(doc=>pS.push({id:doc.id,...doc.data()})); pS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); 
                pS.forEach(p=>{produtosCache.push(p);if(l){const d=document.createElement('div');d.className='item-list-display !cursor-default';let i=p.tipoPreco==='metro'?`R$ ${(p.precoMetro||0).toFixed(2).replace('.',',')}/m²`:`R$ ${(p.precoUnidade||0).toFixed(2).replace('.',',')}/un`;d.innerHTML=`<strong>${p.nome}</strong><div class="meta">${i}</div>`;l.appendChild(d);}});
                document.querySelectorAll('.produto-select').forEach(s=>popularSelectProduto(s));
            }, e => { console.error("Erro produtos:", e); exibirMensagem("Erro ao carregar produtos.", "error"); });
        }

        const formCadastrarFuncionario = document.getElementById('formCadastrarFuncionario');
        formCadastrarFuncionario.addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            const d={nome:document.getElementById('funcionarioNome').value,contato:document.getElementById('funcionarioContato').value,cargo:document.getElementById('funcionarioCargo').value.toLowerCase(),codigoAcesso:document.getElementById('funcionarioCodigoAcesso').value,criadoEm:Timestamp.now()};
            if(!d.nome.trim()||!d.cargo.trim()||!d.codigoAcesso.trim()){exibirMensagem("Preencha todos os campos obrigatórios do funcionário.","warning");return;}
            try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`), d); exibirMensagem('Funcionário registado com sucesso!', 'success'); formCadastrarFuncionario.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar funcionário.', 'error'); }
        });
        function carregarFuncionarios() { 
            if (!auth.currentUser) return; 
            const q=query(collection(db, `artifacts/${shopInstanceAppId}/funcionarios`)); 
            onSnapshot(q, (snap)=>{
                const selPV=document.getElementById('pedidoVendedor'), lF=document.getElementById('listaFuncionarios'), fVS=document.getElementById('filtroVendedor'); 
                if(selPV)selPV.innerHTML='<option value="">Selecione funcionário</option>'; if(lF)lF.innerHTML=''; if(fVS)fVS.innerHTML='<option value="">Todos Funcionários</option>';
                funcionariosCache=[]; if(snap.empty){if(lF)lF.innerHTML='<p class="text-[var(--color-text-muted)] text-sm text-center py-3">Nenhum funcionário registado.</p>';}
                const fS=[]; snap.forEach(doc=>fS.push({id:doc.id,...doc.data()})); fS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); 
                fS.forEach(f=>{funcionariosCache.push(f);if(selPV){const o=document.createElement('option');o.value=f.id;o.textContent=f.nome;selPV.appendChild(o);} if(lF){const d=document.createElement('div');d.className='item-list-display !cursor-default flex justify-between items-center'; let cD=loggedInUserRole==='admin'?`<span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle ml-2">Código: ${f.codigoAcesso||'N/D'}</span>`:''; let eB=loggedInUserRole==='admin'?`<button onclick="abrirModalEditarCodigoFuncionario('${f.id}','${f.nome}','${f.codigoAcesso||''}')" class="btn-icon-action text-blue-500 ml-2" title="Editar Código"><i class="fas fa-key"></i></button>`:''; d.innerHTML=`<div><strong>${f.nome}</strong><span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full align-middle ml-1">${f.cargo||'N/A'}</span>${cD}<div class="meta">Contacto: ${f.contato||'N/A'}</div></div>${eB}`;lF.appendChild(d);} if(fVS){const o=document.createElement('option');o.value=f.id;o.textContent=f.nome;fVS.appendChild(o);}});
            }, e => { console.error("Erro funcionários:", e); exibirMensagem("Erro ao carregar funcionários.", "error"); });
        }
        
        async function handleSalvarNovoCodigoFuncionario(ev){ev.preventDefault();if(!auth.currentUser||loggedInUserRole!=='admin'){exibirMensagem("Apenas administradores podem alterar códigos.","error");return;}const fId=document.getElementById('funcionarioIdParaEditarCodigo').value,nC=document.getElementById('novoCodigoAcesso').value;if(!nC.trim()){exibirMensagem("O novo código de acesso não pode estar vazio.","warning");return;}try{const fR=doc(db,`artifacts/${shopInstanceAppId}/funcionarios`,fId);await updateDoc(fR,{codigoAcesso:nC});exibirMensagem("Código de acesso atualizado com sucesso!","success");fecharModalEditarCodigoFuncionario();}catch(err){console.error(err);exibirMensagem("Erro ao atualizar código de acesso.","error");}}

        const formCadastrarFornecedor = document.getElementById('formCadastrarFornecedor');
        formCadastrarFornecedor.addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            const d={nome:document.getElementById('fornecedorNome').value,contato:document.getElementById('fornecedorContato').value,tipoMaterial:document.getElementById('fornecedorMaterial').value,criadoEm:Timestamp.now()};
            if(!d.nome.trim()){exibirMensagem("Nome do fornecedor é obrigatório.","warning");return;}
            try { await addDoc(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`), d); exibirMensagem('Fornecedor registado com sucesso!', 'success'); formCadastrarFornecedor.reset(); } catch (err) { console.error(err); exibirMensagem('Erro ao registar fornecedor.', 'error'); }
        });
        function carregarFornecedores() {
            if (!auth.currentUser) return; 
            const q=query(collection(db, `artifacts/${shopInstanceAppId}/fornecedores`)); 
            onSnapshot(q, (snap)=>{
                const l=document.getElementById('listaFornecedores');if(l)l.innerHTML='';fornecedoresCache=[];if(snap.empty){if(l)l.innerHTML='<p class="text-[var(--color-text-muted)] text-sm text-center py-3">Nenhum fornecedor registado.</p>';}
                const fS=[];snap.forEach(doc=>fS.push({id:doc.id,...doc.data()}));fS.sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
                fS.forEach(f=>{fornecedoresCache.push(f);if(l){const d=document.createElement('div');d.className='item-list-display !cursor-default';let cD=f.contato||'N/A';const cCC=f.contato?String(f.contato).replace(/\D/g,''):'';if(cCC.length>=8&&cCC.length<=15&&/^\d+$/.test(cCC)){
                    let wN=cCC; 
                    if(!wN.startsWith('55')&&(wN.length===10||wN.length===11))wN='55'+wN;else if(wN.startsWith('55')&&wN.length>13){const p=wN.split('55');if(p.length>1)wN='55'+p.pop();}cD=`<a href="https://wa.me/${wN}" target="_blank" class="text-green-500 hover:text-green-600 hover:underline inline-flex items-center"><i class="fab fa-whatsapp mr-1.5"></i> ${f.contato}</a>`;}else if(f.contato&&f.contato.includes('@'))cD=`<a href="mailto:${f.contato}" class="text-[var(--color-primary)] hover:underline">${f.contato}</a>`;d.innerHTML=`<strong>${f.nome}</strong><div class="meta">Contacto: ${cD}</div><div class="meta">Material: ${f.tipoMaterial||'N/A'}</div>`;l.appendChild(d);}});
            }, e => { console.error("Erro fornecedores:", e); exibirMensagem("Erro ao carregar fornecedores.", "error"); });
        }

        function processImageFilePedido(file){if(file&&file.type.startsWith('image/')){const r=new FileReader();r.onload=(e)=>{pedidoImagemBase64=e.target.result;const pI=document.getElementById('pedidoImagemPreview'),pH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pI&&pH){pI.src=e.target.result;pI.classList.remove('hidden');pH.classList.add('hidden');}};r.readAsDataURL(file);}else{pedidoImagemBase64=null;const pI=document.getElementById('pedidoImagemPreview'),pH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pI&&pH){pI.src="#";pI.classList.add('hidden');pH.classList.remove('hidden');}if(file)exibirMensagem("Arquivo de imagem inválido.","warning");}}
        window.handleImagemFilePedido=(ev)=>{processImageFilePedido(ev.target.files[0]);ev.target.value=null;}
        function handlePasteImagePedido(ev){ev.preventDefault();const iT=(ev.clipboardData||ev.originalEvent.clipboardData).items;for(let i in iT){const it=iT[i];if(it.kind==='file'&&it.type.startsWith('image/')){processImageFilePedido(it.getAsFile());break;}}}
        
        function popularSelectProduto(sel){sel.innerHTML='<option value="">Selecione produto</option>';produtosCache.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.nome;o.dataset.tipo=p.tipoPreco;o.dataset.precoMetro=p.precoMetro||0;o.dataset.precoUnidade=p.precoUnidade||0;sel.appendChild(o);});}
        window.adicionarItemPedidoForm=()=>{itemPedidoCount++;const c=document.getElementById('itensPedidoContainer');const d=document.createElement('div');d.className='p-3.5 border border-[var(--color-border-soft)] rounded-lg space-y-2.5 bg-slate-50 item-pedido-form relative';d.id=`itemPedido-${itemPedidoCount}`;d.innerHTML=`<button type="button" onclick="removerItemPedidoForm(${itemPedidoCount})" class="absolute top-1.5 right-1.5 text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 transition-colors text-xs"><i class="fas fa-times"></i></button><h4 class="font-medium text-sm text-[var(--color-text-main)]">Item ${itemPedidoCount}</h4><div><label class="label-text text-xs">Produto:</label><select class="input-field input-field-sm produto-select" id="itemProduto-${itemPedidoCount}" onchange="toggleCamposProduto(${itemPedidoCount})"></select></div><div id="camposProdutoMetro-${itemPedidoCount}" class="hidden grid grid-cols-2 gap-3"><div><label class="label-text text-xs">Largura (m):</label><input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemLargura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div><div><label class="label-text text-xs">Altura (m):</label><input type="number" step="0.01" class="input-field input-field-sm dimensoes-produto" id="itemAltura-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div></div><div><label class="label-text text-xs">Qtd:</label><input type="number" value="1" min="1" class="input-field input-field-sm quantidade-produto" id="itemQuantidade-${itemPedidoCount}" oninput="calcularValorItem(${itemPedidoCount})"></div><div><label class="label-text text-xs">Valor Item:</label><input type="text" class="input-field input-field-sm bg-slate-100 valor-item-produto text-[var(--color-text-main)] font-medium cursor-not-allowed" id="itemValor-${itemPedidoCount}" readonly value="R$ 0,00"></div>`;c.appendChild(d);popularSelectProduto(d.querySelector('.produto-select'));d.querySelectorAll('.input-field').forEach(el=>el.classList.add('py-1.5','text-sm'));}
        window.removerItemPedidoForm=(id)=>{const el=document.getElementById(`itemPedido-${id}`);if(el)el.remove();atualizarValorTotalPedido();}
        window.toggleCamposProduto=(id)=>{const s=document.getElementById(`itemProduto-${id}`),o=s.options[s.selectedIndex],t=o.dataset.tipo;document.getElementById(`camposProdutoMetro-${id}`).classList.toggle('hidden',t!=='metro');calcularValorItem(id);}
        window.calcularValorItem=(id)=>{const s=document.getElementById(`itemProduto-${id}`),o=s.options[s.selectedIndex];if(!o||!o.value){document.getElementById(`itemValor-${id}`).value="R$ 0,00";atualizarValorTotalPedido();return;}const t=o.dataset.tipo,pm=parseFloat(o.dataset.precoMetro),pu=parseFloat(o.dataset.precoUnidade),q=parseInt(document.getElementById(`itemQuantidade-${id}`).value)||1;let v=0;if(t==='metro'){const l=parseFloat(document.getElementById(`itemLargura-${id}`).value)||0,a=parseFloat(document.getElementById(`itemAltura-${id}`).value)||0;if(l>0&&a>0&&pm>0)v=(l*a*pm)*q;}else{if(pu>0)v=pu*q;}document.getElementById(`itemValor-${id}`).value=`R$ ${v.toFixed(2).replace('.',',')}`;atualizarValorTotalPedido();}
        function atualizarValorTotalPedido(){let tI=0;document.querySelectorAll('.valor-item-produto').forEach(i=>{const v=i.value.replace('R$ ','').replace(',','.');tI+=parseFloat(v)||0;});document.getElementById('pedidoValorTotal').value=`R$ ${tI.toFixed(2).replace('.',',')}`;calcularTotaisPagamento();}
        
        window.adicionarPagamentoForm=()=>{pagamentoCount++;const c=document.getElementById('pagamentosContainer');const d=document.createElement('div');d.className='grid grid-cols-1 sm:grid-cols-[2fr,1fr,auto] gap-3 items-end p-3 border border-slate-200 rounded-lg bg-slate-50 pagamento-form-item';d.id=`pagamentoItem-${pagamentoCount}`;d.innerHTML=`<div><label class="label-text text-xs">Forma:</label><select class="input-field input-field-sm py-1.5 forma-pagamento"><option value="Dinheiro">Dinheiro</option><option value="Cartão de Crédito">Crédito</option><option value="Cartão de Débito">Débito</option><option value="PIX">PIX</option><option value="Boleto">Boleto</option><option value="Pendente">Pendente</option></select></div><div><label class="label-text text-xs">Valor (R$):</label><input type="number" step="0.01" class="input-field input-field-sm py-1.5 valor-pago" placeholder="0,00" oninput="window.calcularTotaisPagamento()"></div><button type="button" onclick="removerPagamentoForm(${pagamentoCount})" class="btn btn-danger btn-small text-xs py-1.5 px-2 self-center sm:self-end h-8"><i class="fas fa-trash"></i></button><div class="sm:col-span-3"><label class="label-text text-xs">Obs:</label><input type="text" class="input-field input-field-sm py-1.5 observacao-pagamento" placeholder="Ex: Entrada..."></div>`;c.appendChild(d);calcularTotaisPagamento();}
        window.removerPagamentoForm=(id)=>{const el=document.getElementById(`pagamentoItem-${id}`);if(el)el.remove();calcularTotaisPagamento();}
        function calcularTotaisPagamento(){let tP=0;document.querySelectorAll('.pagamento-form-item .valor-pago').forEach(i=>{tP+=parseFloat(i.value)||0;});document.getElementById('pedidoTotalPago').value=`R$ ${tP.toFixed(2).replace('.',',')}`;const vTS=document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.'),vT=parseFloat(vTS)||0,vR=vT-tP;document.getElementById('pedidoValorRestante').value=`R$ ${vR.toFixed(2).replace('.',',')}`; }
        window.calcularTotaisPagamento = calcularTotaisPagamento; 

        document.getElementById('formNovoPedido').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!auth.currentUser) return; 
            editingOrderId = document.getElementById('editingOrderIdField').value; 
            const d={clienteId:document.getElementById('pedidoClienteId').value,clienteNome:document.getElementById('pedidoClienteSearch').value,vendedorId:document.getElementById('pedidoVendedor').value,vendedorNome:document.getElementById('pedidoVendedor').options[document.getElementById('pedidoVendedor').selectedIndex]?.text,dataEntregaStr:document.getElementById('pedidoDataEntrega').value,horaEntregaStr:document.getElementById('pedidoHoraEntrega').value,status:document.getElementById('pedidoStatus').value,valorTotal:parseFloat(document.getElementById('pedidoValorTotal').value.replace('R$ ','').replace(',','.')),itens:[],pagamentos:[],imagemPreviewPedidoBase64:pedidoImagemBase64};
            if(!d.clienteId||!d.vendedorId||!d.dataEntregaStr){exibirMensagem("Preencha campos obrigatórios.","warning");return;}
            let dEFinal;if(d.dataEntregaStr&&d.horaEntregaStr){const[a,m,dia]=d.dataEntregaStr.split('-');const[h,min]=d.horaEntregaStr.split(':');dEFinal=Timestamp.fromDate(new Date(a,parseInt(m)-1,dia,h,min));}else if(d.dataEntregaStr){dEFinal=Timestamp.fromDate(new Date(d.dataEntregaStr+"T00:00:00"));}else{exibirMensagem("Data entrega inválida.","error");return;}
            const iForms=document.querySelectorAll('.item-pedido-form');if(iForms.length===0&&!editingOrderId){exibirMensagem("Adicione itens.","warning");return;}
            let formValido=true;iForms.forEach((iF,idx)=>{const cId=iF.id.split('-')[1];const pS=document.getElementById(`itemProduto-${cId}`);const pId=pS.value,pN=pS.options[pS.selectedIndex]?.text,tP=pS.options[pS.selectedIndex]?.dataset.tipo;const q=parseInt(document.getElementById(`itemQuantidade-${cId}`).value),vI=parseFloat(document.getElementById(`itemValor-${cId}`).value.replace('R$ ','').replace(',','.'));let l=null,a=null;if(tP==='metro'){l=parseFloat(document.getElementById(`itemLargura-${cId}`).value)||0;a=parseFloat(document.getElementById(`itemAltura-${cId}`).value)||0;}if(pId&&q>0&&vI>=0)d.itens.push({produtoId:pId,produtoNome:pN,tipoProduto:tP,quantidade:q,largura:l,altura:a,valorItem:vI});else{exibirMensagem(`Item ${idx+1} inválido.`,"warning");formValido=false;}});if(!formValido)return;if(d.itens.length===0&&!editingOrderId){exibirMensagem("Adicione itens.","warning");return;}
            document.querySelectorAll('.pagamento-form-item').forEach(i=>{const f=i.querySelector('.forma-pagamento').value,vP=parseFloat(i.querySelector('.valor-pago').value)||0,o=i.querySelector('.observacao-pagamento').value;if(f&&vP>0||f==="Pendente")d.pagamentos.push({forma:f,valorPago:vP,observacao:o,dataPagamento:Timestamp.now()});else if(f&&vP<=0&&f!=="Pendente"){exibirMensagem(`Valor para ${f} > 0.`,"warning");formValido=false;}});if(!formValido)return;if(d.pagamentos.length===0&&!editingOrderId){exibirMensagem("Adicione pagamento.","warning");return;}
            const pData={clienteId:d.clienteId,clienteNome:d.clienteNome,vendedorId:d.vendedorId,vendedorNome:d.vendedorNome,pagamentos:d.pagamentos,dataEntrega:dEFinal,status:d.status,valorTotal:d.valorTotal,itens:d.itens,imagemPreviewPedidoBase64:d.imagemPreviewPedidoBase64};
            try{const pCP=`artifacts/${shopInstanceAppId}/pedidos`;if(editingOrderId){const pR=doc(db,pCP,editingOrderId);const oPD=todosOsPedidosCache.find(p=>p.id===editingOrderId);pData.dataPedido=oPD?.dataPedido||Timestamp.now();pData.numeroPedido=oPD?.numeroPedido||`PED-${Date.now().toString().slice(-6)}`;await setDoc(pR,pData);exibirMensagem('Pedido atualizado com sucesso!', 'success');}else{pData.dataPedido=Timestamp.now();pData.numeroPedido=`PED-${Date.now().toString().slice(-6)}`;await addDoc(collection(db,pCP),pData);exibirMensagem('Pedido guardado com sucesso!', 'success');}
            document.getElementById('formNovoPedido').reset();document.getElementById('editingOrderIdField').value='';editingOrderId=null;document.querySelector('#formNovoPedido button[type="submit"]').innerHTML='<i class="fas fa-check mr-1.5"></i>Guardar Pedido';document.getElementById('itensPedidoContainer').innerHTML='';document.getElementById('pagamentosContainer').innerHTML='';pagamentoCount=0;pedidoImagemBase64=null;const pIP=document.getElementById('pedidoImagemPreview'),pIPH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pIP&&pIPH){pIP.src="#";pIP.classList.add('hidden');pIPH.classList.remove('hidden');}itemPedidoCount=0;atualizarValorTotalPedido();mostrarSecao('telaInicial',true);}catch(err){console.error(err);exibirMensagem('Erro ao processar pedido.','error');}
        });

        function getStatusBadgeSimpleHTML(status){let bC='neutral';if(status==='Entregue')bC='success';else if(status==='Cancelado')bC='danger';else if(status==='Pronto para Retirada')bC='primary';else if(status.startsWith('Em Produção')||status==='Em Rota de Entrega')bC='info';else if(status==='Aguardando Aprovação')bC='warning';return`<span class="status-badge-simple ${bC}">${status}</span>`;}
        
        function renderizarListaCompletaPedidos() { 
            const tbody = document.getElementById('listaTodosPedidos'); 
            if (!tbody) return;
            
            tbody.innerHTML = ''; 

            const fNC=document.getElementById('filtroNomeCliente')?.value.toLowerCase()||'',fNP=document.getElementById('filtroNumeroPedido')?.value.toLowerCase()||'',fDPS=document.getElementById('filtroDataPedido')?.value||'',fMP=document.getElementById('filtroMaterialProduto')?.value.toLowerCase()||'';
            let fSP=document.getElementById('filtroStatusPedido')?.value||'';
            const fC=document.getElementById('filtroClassificacaoPedido')?.value||'dataPedido_desc',fVI=document.getElementById('filtroVendedor')?.value||'';
            if(!fSP){if(loggedInUserRole==='impressor')fSP='Em Produção (Impressão)';}
            let pF=[...todosOsPedidosCache];
            if(fNC)pF=pF.filter(p=>p.clienteNome&&p.clienteNome.toLowerCase().includes(fNC));
            if(fNP)pF=pF.filter(p=>p.numeroPedido&&p.numeroPedido.toLowerCase().includes(fNP));
            if(fDPS){const dF=new Date(fDPS+"T00:00:00");pF=pF.filter(p=>{if(p.dataPedido&&p.dataPedido.toDate){const dPO=p.dataPedido.toDate();return dPO.getFullYear()===dF.getFullYear()&&dPO.getMonth()===dF.getMonth()&&dPO.getDate()===dF.getDate();}return false;});}
            if(fMP)pF=pF.filter(p=>{if(p.itens&&Array.isArray(p.itens))return p.itens.some(i=>i.produtoNome&&i.produtoNome.toLowerCase().includes(fMP));return false;});
            if(loggedInUserRole==='producao'&&!document.getElementById('filtroStatusPedido')?.value){const sP=["Em Produção (Arte)","Em Produção (Impressão)","Em Produção (Acabamento)"];pF=pF.filter(p=>sP.includes(p.status));}else if(fSP){pF=pF.filter(p=>p.status===fSP);}
            if(fVI)pF=pF.filter(p=>p.vendedorId===fVI);
            switch(fC){case'dataPedido_asc':pF.sort((a,b)=>(a.dataPedido?.toMillis()||0)-(b.dataPedido?.toMillis()||0));break;case'dataPedido_desc':pF.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));break;case'dataEntrega_asc':pF.sort((a,b)=>(a.dataEntrega?.toMillis()||0)-(b.dataEntrega?.toMillis()||0));break;case'dataEntrega_desc':pF.sort((a,b)=>(b.dataEntrega?.toMillis()||0)-(a.dataEntrega?.toMillis()||0));break;case'clienteNome_asc':pF.sort((a,b)=>(a.clienteNome||"").localeCompare(b.clienteNome||""));break;case'clienteNome_desc':pF.sort((a,b)=>(b.clienteNome||"").localeCompare(a.clienteNome||""));break;case'numeroPedido_asc':pF.sort((a,b)=>(a.numeroPedido||"").localeCompare(b.numeroPedido||"",undefined,{numeric:true}));break;case'numeroPedido_desc':pF.sort((a,b)=>(b.numeroPedido||"").localeCompare(a.numeroPedido||"",undefined,{numeric:true}));break;default:pF.sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));}
            
            if(pF.length===0){
                tbody.innerHTML='<tr><td colspan="7" class="text-center text-slate-500 py-10">Nenhum pedido encontrado com os filtros aplicados.</td></tr>';
                return;
            }

            pF.forEach(p=>{
                const tr = document.createElement('tr');
                const pM=JSON.stringify(p);
                const dPF=p.dataPedido?.toDate?p.dataPedido.toDate().toLocaleString('pt-BR',{day:'2-digit', month:'2-digit', year:'numeric'}):'N/A';
                const dEF=p.dataEntrega?.toDate?p.dataEntrega.toDate().toLocaleDateString('pt-BR'):'N/A';
                
                tr.innerHTML=`
                    <td class="pedido-numero">${p.numeroPedido}</td>
                    <td class="cliente-nome">${p.clienteNome}</td>
                    <td>${dPF}</td>
                    <td>${dEF}</td>
                    <td class="font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td>
                    <td>${getStatusBadgeSimpleHTML(p.status)}</td>
                    <td class="text-xs space-x-1.5 whitespace-nowrap">
                        <button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                        <button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pM)}')))" class="btn-icon-action" title="Editar Pedido"><i class="fas fa-edit"></i></button>
                        <button onclick="excluirPedido('${p.id}', '${p.numeroPedido}')" class="btn-icon-action text-red-500 hover:text-red-700" title="Excluir Pedido"><i class="fas fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }


        function carregarUltimosPedidos() {
            if(!auth.currentUser)return;const tb=document.getElementById('ultimosPedidosTableBody');if(!tb)return;tb.innerHTML='';
            const pODB=[...todosOsPedidosCache].sort((a,b)=>(b.dataPedido?.toMillis()||0)-(a.dataPedido?.toMillis()||0));const pPD=pODB.slice(0,5);
            if(pPD.length===0)tb.innerHTML=`<tr><td colspan="6" class="text-center text-slate-500 py-10">Nenhum pedido recente.</td></tr>`;
            else pPD.forEach(p=>{const tr=document.createElement('tr');const pPM=JSON.stringify(p);const dPF=p.dataPedido?.toDate?p.dataPedido.toDate().toLocaleDateString('pt-BR'):'N/A';tr.innerHTML=`<td class="text-[var(--color-text-main)] font-medium">${p.numeroPedido}</td><td class="text-[var(--color-text-muted)]">${p.clienteNome}</td><td class="text-[var(--color-text-muted)]">${dPF}</td><td class="text-[var(--color-text-main)] font-medium">R$ ${p.valorTotal.toFixed(2).replace('.',',')}</td><td>${getStatusBadgeSimpleHTML(p.status)}</td><td class="text-xs space-x-1 whitespace-nowrap"><button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pPM)}')))" class="btn-icon-action text-sky-600 hover:text-sky-700" title="Detalhes"><i class="fas fa-eye"></i></button><button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pPM)}')))" class="btn-icon-action text-indigo-600 hover:text-indigo-700" title="Editar"><i class="fas fa-edit"></i></button><button onclick="excluirPedido('${p.id}', '${p.numeroPedido}')" class="btn-icon-action text-red-600 hover:text-red-700" title="Excluir"><i class="fas fa-trash"></i></button></td>`;tb.appendChild(tr);});
        }

        function carregarTodosPedidos() { 
            if(!auth.currentUser)return; 
            const q=query(collection(db,`artifacts/${shopInstanceAppId}/pedidos`));
            onSnapshot(q,(snap)=>{todosOsPedidosCache=[];snap.forEach(doc=>todosOsPedidosCache.push({id:doc.id,...doc.data()}));carregarUltimosPedidos();if(activeSectionId==='telaInicial')atualizarDashboard();if(activeSectionId==='visualizarPedidos')renderizarListaCompletaPedidos();if(activeSectionId==='cadastrarCliente'&&clienteSelecionadoId)exibirDetalhesClienteEProcurarPedidos(clienteSelecionadoId);},e=>{console.error("Erro todos pedidos:",e);exibirMensagem("Erro todos pedidos.","error");});
        }
        
        function atualizarDashboard() {
            const mPH=document.getElementById('metricPedidosHoje'),mPP=document.getElementById('metricPedidosPendentes'),mFM=document.getElementById('metricFaturamentoMes'),mTC=document.getElementById('metricTotalClientes');
            if(!mPH||!mPP||!mFM||!mTC)return;
            if(!todosOsPedidosCache)todosOsPedidosCache=[];if(!clientesCache)clientesCache=[];mTC.textContent=clientesCache.length;
            if(todosOsPedidosCache.length===0){mPH.textContent='0';mPP.textContent='0';mFM.textContent='R$ 0,00';return;}
            const h=new Date(),dH=h.getDate(),mH=h.getMonth(),aH=h.getFullYear(),iM=new Date(aH,mH,1);
            let pH=0,pP=0,fM=0;
            todosOsPedidosCache.forEach(p=>{if(!p.dataPedido||typeof p.dataPedido.toDate!=='function')return;const dP=p.dataPedido.toDate();if(dP.getDate()===dH&&dP.getMonth()===mH&&dP.getFullYear()===aH)pH++;if(p.status!=='Entregue'&&p.status!=='Cancelado')pP++;if(dP>=iM&&p.status!=='Cancelado')fM+=p.valorTotal||0;});
            mPH.textContent=pH;mPP.textContent=pP;mFM.textContent=`R$ ${fM.toFixed(2).replace('.',',')}`;
        }
        
        window.prepararEdicaoPedido=(pObj)=>{if(!pObj||!pObj.id){exibirMensagem("Dados inválidos.","error");return;}editingOrderId=pObj.id;document.getElementById('editingOrderIdField').value=pObj.id;document.getElementById('formNovoPedido').reset();document.getElementById('itensPedidoContainer').innerHTML='';document.getElementById('pagamentosContainer').innerHTML='';itemPedidoCount=0;pagamentoCount=0;document.getElementById('pedidoClienteSearch').value=pObj.clienteNome||"";document.getElementById('pedidoClienteId').value=pObj.clienteId||"";document.getElementById('pedidoClienteResultados').classList.add('hidden');document.getElementById('pedidoVendedor').value=pObj.vendedorId||"";document.getElementById('pedidoStatus').value=pObj.status||"Aguardando Aprovação";const dETS=pObj.dataEntrega&&typeof pObj.dataEntrega.seconds==='number'?new Timestamp(pObj.dataEntrega.seconds,pObj.dataEntrega.nanoseconds):null;if(dETS){const dED=dETS.toDate();document.getElementById('pedidoDataEntrega').value=dED.toISOString().split('T')[0];document.getElementById('pedidoHoraEntrega').value=dED.toTimeString().split(' ')[0].substring(0,5);}else{document.getElementById('pedidoDataEntrega').value="";document.getElementById('pedidoHoraEntrega').value="";}
        pedidoImagemBase64=pObj.imagemPreviewPedidoBase64||null;const pI=document.getElementById('pedidoImagemPreview'),pH=document.getElementById('pedidoImagemPreviewPlaceholder');if(pedidoImagemBase64){pI.src=pedidoImagemBase64;pI.classList.remove('hidden');pH.classList.add('hidden');}else{pI.src="#";pI.classList.add('hidden');pH.classList.remove('hidden');}
        if(pObj.itens&&Array.isArray(pObj.itens)){pObj.itens.forEach(item=>{adicionarItemPedidoForm();const cIFI=itemPedidoCount;const pS=document.getElementById(`itemProduto-${cIFI}`);if(pS)pS.value=item.produtoId;if(pS)pS.dispatchEvent(new Event('change'));const qI=document.getElementById(`itemQuantidade-${cIFI}`);if(qI)qI.value=item.quantidade;if(item.tipoProduto==='metro'){const lI=document.getElementById(`itemLargura-${cIFI}`);const aI=document.getElementById(`itemAltura-${cIFI}`);if(lI)lI.value=item.largura||"";if(aI)aI.value=item.altura||"";}calcularValorItem(cIFI);});}
        if(pObj.pagamentos&&Array.isArray(pObj.pagamentos)){pObj.pagamentos.forEach(pgto=>{adicionarPagamentoForm();const cPFI=pagamentoCount;const pIE=document.getElementById(`pagamentoItem-${cPFI}`);if(pIE){pIE.querySelector('.forma-pagamento').value=pgto.forma;pIE.querySelector('.valor-pago').value=pgto.valorPago;pIE.querySelector('.observacao-pagamento').value=pgto.observacao||"";}}); }
        atualizarValorTotalPedido();document.querySelector('#formNovoPedido button[type="submit"]').innerHTML='<i class="fas fa-save mr-1.5"></i>Atualizar Pedido';mostrarSecao('novoPedido',false);setActiveMenuLink('novoPedido');}

        window.excluirPedido = async (pedidoId, numeroPedido) => { 
            if (!auth.currentUser || !pedidoId) {
                exibirMensagem("Erro: ID do pedido ou utilizador inválido.", "error");
                return;
            }
            const numPed = numeroPedido || `ID ${pedidoId.substring(0,6)}...`;

            abrirUniversalModal({
                title: 'Confirmar Exclusão', 
                message: `Tem certeza que deseja excluir o pedido ${numPed}? Esta ação não pode ser desfeita.`, 
                type: 'delete-confirm', 
                size: 'sm',
                confirmCallback: async () => { 
                    try {
                        await deleteDoc(doc(db, `artifacts/${shopInstanceAppId}/pedidos`, pedidoId));
                        console.log(`Pedido ${numPed} excluído.`); 
                        exibirMensagem(`Pedido ${numPed} excluído com sucesso!`, 'success');
                        if (activeSectionId === 'cadastrarCliente' && clienteSelecionadoId) {
                             exibirDetalhesClienteEProcurarPedidos(clienteSelecionadoId);
                        }
                    } catch (error) {
                        console.error("Erro ao excluir pedido: ", error);
                        exibirMensagem(`Erro ao excluir pedido ${numPed}.`, 'error');
                    }
                }
            });
        }

        const produtoTipoPrecoEl = document.getElementById('produtoTipoPreco');
        if (produtoTipoPrecoEl) togglePrecoFields(); 

    </script>
</body>
</html>