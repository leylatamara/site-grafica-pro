<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gráfica Rápida - Design Minimalista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif; 
            background-color: #f1f5f9; /* slate-100 */
            color: #334155; /* slate-700 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            /* padding-top será ajustado por JS após o carregamento do menu */
            transition: background-color 0.3s ease-in-out;
        }
        :root {
            --color-primary-hex: #0284c7; /* sky-600 */
            --color-primary: theme('colors.sky.600');
            --color-primary-hover: theme('colors.sky.700');
            --color-primary-light: theme('colors.sky.100');
            --color-primary-text-on-light: theme('colors.sky.700');
            --color-primary-focus-ring: theme('colors.sky.300');

            --color-text-main: theme('colors.slate.700');
            --color-text-muted: theme('colors.slate.500');
            --color-text-heading: theme('colors.slate.800');
            
            --color-bg-main: theme('colors.white');
            --color-bg-alt: theme('colors.slate.50');
            --color-border-soft: theme('colors.slate.200');
            --color-border-medium: theme('colors.slate.300');

            /* Cores para o Dashboard */
            --dashboard-bg: theme('colors.slate.900');
            --dashboard-card-bg: theme('colors.slate.800');
            --dashboard-text-heading: theme('colors.slate.100');
            --dashboard-text-muted: theme('colors.slate.400');
            --dashboard-text-value: theme('colors.white');
            --dashboard-border-soft: theme('colors.slate.700');
            --dashboard-border-medium: theme('colors.slate.600');

            --color-accent-teal: theme('colors.teal.500');
            --color-accent-teal-light: theme('colors.teal.600'); 
            --color-accent-orange: theme('colors.orange.500');
            --color-accent-orange-light: theme('colors.orange.600');
            --color-accent-lime: theme('colors.lime.500');
            --color-accent-lime-light: theme('colors.lime.600');
            --color-accent-purple: theme('colors.purple.500');
            --color-accent-purple-light: theme('colors.purple.600');

            --color-success: theme('colors.green.500');
            --color-success-light: theme('colors.green.100');
            --color-danger: theme('colors.red.500');
            --color-danger-light: theme('colors.red.100');
            --color-warning: theme('colors.amber.500');
            --color-warning-light: theme('colors.amber.100');
            --color-info: theme('colors.sky.500'); 
            --color-info-light: theme('colors.sky.100');
        }

        .btn { 
            @apply font-medium py-2.5 px-4 rounded-md shadow-sm hover:shadow transition-all duration-150 ease-in-out flex items-center justify-center text-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white focus:ring-[var(--color-primary)];
        }
        .btn-secondary {
            @apply bg-slate-200 hover:bg-slate-300 text-slate-700 focus:ring-slate-400;
        }
        .btn-secondary-dark { 
            @apply bg-slate-500 hover:bg-slate-400 text-slate-900 focus:ring-slate-300;
        }
        .btn-outline {
            @apply bg-transparent border border-[var(--color-border-medium)] text-[var(--color-text-main)] hover:bg-slate-100 focus:ring-[var(--color-primary)];
        }
        .btn-link {
            @apply text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] font-medium hover:underline text-sm p-0 bg-transparent shadow-none;
        }
        .btn-icon-action { 
             @apply p-1.5 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-200 transition-colors duration-150;
        }
        .btn-icon-action-dark-theme { 
             @apply p-1.5 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors duration-150;
        }


        .card { 
            @apply bg-[var(--color-bg-main)] p-5 sm:p-6 rounded-lg border border-[var(--color-border-soft)] shadow-md; 
        }
        .input-field { 
            @apply mt-1 block w-full px-3.5 py-2 bg-[var(--color-bg-main)] border border-[var(--color-border-medium)] rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] sm:text-sm transition-all;
        }
        .input-field-sm { @apply py-1.5 text-xs; }
        .label-text {
            @apply block text-sm font-medium text-[var(--color-text-muted)] mb-1; 
        }

        /* Modal Styles */
        .modal-overlay { @apply fixed inset-0 bg-black/60 z-50 transition-opacity duration-200 ease-in-out; }
        .modal-content-wrapper { 
            @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl w-11/12 max-h-[90vh] overflow-y-auto transition-all duration-200 ease-in-out z-[60] relative;
        }
        .modal-content-wrapper.max-w-md { @apply sm:max-w-md; }
        .modal-content-wrapper.max-w-sm { @apply sm:max-w-sm; } 
        
        .modal-header-colored { @apply h-2 rounded-t-lg; }
        .modal-body-content { @apply p-6 sm:p-7; }
        .modal-close-x { @apply absolute top-3 right-3 text-slate-400 hover:text-slate-600 text-2xl p-1 cursor-pointer transition-colors duration-150 z-10; }
        
        .hidden { display: none !important; }
        .image-drop-area { @apply mt-1 border-2 border-dashed border-[var(--color-border-medium)] p-6 rounded-lg flex flex-col justify-center items-center min-h-[180px] text-center cursor-pointer hover:border-[var(--color-primary)] transition-colors bg-[var(--color-bg-alt)] hover:bg-sky-50; }
        .preview-image { @apply max-w-full max-h-48 object-contain rounded-md; }
        
        .content-area { 
            @apply flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto bg-[var(--color-bg-alt)];
        }

        /* Dashboard Styles - Tema Escuro */
        #telaInicial {
            background-color: var(--dashboard-bg);
            color: var(--dashboard-text-muted);
        }
        .dashboard-header { 
            @apply text-2xl sm:text-3xl font-semibold text-[var(--dashboard-text-heading)] mb-6 sm:mb-8 text-center; 
        }
        
        .metric-card-dashboard { 
            @apply bg-[var(--dashboard-card-bg)] rounded-xl shadow-xl overflow-hidden transition-all duration-300 hover:shadow-2xl hover:scale-[1.02];
        }
        .metric-card-dashboard .card-header-color { @apply h-1.5; }
        .metric-card-dashboard .card-content { @apply p-5 flex items-center space-x-4; }
        .metric-card-dashboard .icon-wrapper-dashboard { 
            @apply text-2xl p-3.5 rounded-lg flex items-center justify-center w-14 h-14 text-white; 
        }
        .metric-card-dashboard .metric-details { @apply flex-1; }
        .metric-card-dashboard .metric-label-dashboard {
            @apply text-sm font-medium text-[var(--dashboard-text-muted)] mb-0.5;
        }
        .metric-card-dashboard .metric-value-dashboard {
            @apply text-3xl font-bold text-[var(--dashboard-text-value)];
        }

        .metric-card-dashboard.pedidos-hoje .card-header-color { background-color: var(--color-accent-teal); }
        .metric-card-dashboard.pedidos-hoje .icon-wrapper-dashboard { background-color: var(--color-accent-teal-light);  }
        
        .metric-card-dashboard.pedidos-pendentes .card-header-color { background-color: var(--color-accent-orange); }
        .metric-card-dashboard.pedidos-pendentes .icon-wrapper-dashboard { background-color: var(--color-accent-orange-light); }
        
        .metric-card-dashboard.faturamento-mes .card-header-color { background-color: var(--color-accent-lime); }
        .metric-card-dashboard.faturamento-mes .icon-wrapper-dashboard { background-color: var(--color-accent-lime-light); }
        
        .metric-card-dashboard.total-clientes .card-header-color { background-color: var(--color-accent-purple); }
        .metric-card-dashboard.total-clientes .icon-wrapper-dashboard { background-color: var(--color-accent-purple-light); }

        .material-table-card { 
            @apply bg-[var(--dashboard-card-bg)] rounded-xl shadow-xl p-0 overflow-hidden mt-8 sm:mt-10;
        }
        .material-table-header {
            @apply p-5 sm:p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-[var(--dashboard-border-soft)];
        }
        .material-table-header h2 {
            @apply text-xl font-semibold text-[var(--dashboard-text-heading)] mb-3 sm:mb-0;
        }
        .material-table-header .btn-primary { 
            @apply bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white;
        }
        .material-table-container { @apply overflow-x-auto; }
        .material-data-table { @apply w-full min-w-[700px]; }
        .material-data-table th, .material-data-table td {
            @apply px-6 py-4 text-left text-sm whitespace-nowrap text-[var(--dashboard-text-muted)]; 
        }
        .material-data-table td { @apply text-[var(--dashboard-text-value)]; }
        .material-data-table thead th {
            @apply bg-slate-700/50 text-slate-300 font-semibold uppercase tracking-wider text-xs border-b-2 border-[var(--dashboard-border-medium)]; 
        }
        .material-data-table tbody tr { @apply border-b border-[var(--dashboard-border-soft)]; }
        .material-data-table tbody tr:last-child { @apply border-b-0; }
        .material-data-table tbody tr:hover { @apply bg-slate-700/70 transition-colors duration-150; }
        
        .status-badge-simple { 
            @apply px-2 py-0.5 text-xs font-medium rounded-full inline-flex items-center capitalize;
        }
        .status-badge-simple.success { @apply bg-green-700 text-green-100; }
        .status-badge-simple.danger { @apply bg-red-700 text-red-100; }
        .status-badge-simple.warning { @apply bg-amber-700 text-amber-100; }
        .status-badge-simple.info { @apply bg-sky-700 text-sky-100; }
        .status-badge-simple.primary { @apply bg-sky-700 text-sky-100; } 
        .status-badge-simple.neutral { @apply bg-slate-600 text-slate-200; }

        .item-list-display {
            @apply p-3 border border-[var(--color-border-soft)] rounded-md bg-[var(--color-bg-alt)] text-sm cursor-pointer hover:border-[var(--color-primary)] hover:bg-sky-50;
        }
        .item-list-display.selected {
             @apply bg-sky-100 border-sky-300 ring-1 ring-sky-300;
        }
        .item-list-display strong { @apply font-medium text-[var(--color-text-main)];}
        .item-list-display .meta { @apply text-xs text-[var(--color-text-muted)];}
        
        .search-input-wrapper { @apply relative mb-4; }
        .search-input-wrapper .fa-search { @apply absolute top-1/2 left-3 transform -translate-y-1/2 text-slate-400; }
        .search-input-wrapper input { @apply pl-10; }

        #pedidoClienteResultados {
            @apply absolute z-20 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg max-h-48 overflow-y-auto;
        }
        #pedidoClienteResultados div {
            @apply px-4 py-2 hover:bg-sky-100 cursor-pointer text-sm text-slate-700;
        }
        #pedidoClienteResultados div:last-child { @apply border-b-0; }

        /* EXO MENU STYLES - Adaptado */
        *, :after, :before { box-sizing: border-box }
        .clearfix:after, .clearfix:before { content: ''; display: table }
        .clearfix:after { clear: both; display: block }
        
        .exo-menu-container { 
            width: 100%;
            background: #23364B; 
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0.5rem 1rem; 
            border-bottom: 1px solid #365670; 
        }
        .header-top-row .logo-area img {
            height: 2rem; 
        }
        .header-top-row .site-title {
            color: #fefefe;
            font-size: 1rem; 
            font-weight: 600; 
            text-align: center;
            flex-grow: 1;
            padding: 0 1rem; 
        }
        .header-top-row .actions-area {
             min-width: 120px; 
             display: flex; 
             justify-content: flex-end;
        }

        .menu-bar-wrapper { 
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative; 
        }

        ul.exo-menu{
            list-style: none;
            position:relative; 
            margin: 0 auto; 
            padding: 0;
            display: flex; 
            justify-content: center; 
        }
        .exo-menu > li {  
            display: inline-block; 
        }
        .exo-menu > li > a{
            color: #ccc;
            text-decoration: none;
            text-transform: uppercase;
            font-size: 0.8rem; 
            border-right: 1px #365670 dotted;
            transition: color 0.2s linear, background 0.2s linear;
            display:block; 
            padding: 18px 15px; 
        }
        .exo-menu > li:last-child > a {
            border-right: none; 
        }
        .exo-menu > li > a.active,
        .exo-menu > li > a:hover,
        .exo-menu ul.drop-down-ul > li > a:hover{ 
            background:#009FE1;
            color:#fff;
        }
        .exo-menu i.fa, .exo-menu i.fas { /* Especificidade para Font Awesome */
            float: left;
            font-size: 1rem; 
            margin-right: 6px;
            line-height: 20px !important;
        }
        li.drop-down {position:relative;}
        li.drop-down:before { 
            content: "\f107"; 
            color: #ccc; 
            font-family: "Font Awesome 6 Free"; 
            font-weight: 900; 
            font-style: normal;
            display: inline;
            position: absolute;
            right: 8px; 
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px; 
            transition: color 0.2s linear;
        }
        li.drop-down:hover:before {
            color: #fff; 
        }

        li.drop-down>ul.drop-down-ul{ 
            position:absolute; 
            left: 0px;
            min-width: 200px; 
            background-color: #365670; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000; 
            display:none; 
        }
        
        li.drop-down>ul.drop-down-ul>li>a {
            color: #fff;
            display: block;
            padding: 10px 15px; 
            text-decoration: none;
            font-size: 0.75rem; 
            text-transform: none; 
            border-bottom: 1px dotted #547787;
            transition: color 0.2s linear, background 0.2s linear;
        }
        li.drop-down>ul.drop-down-ul>li:last-child>a {
            border-bottom: none; 
        }

        li.drop-down:hover > ul.drop-down-ul {
            display:block;
        }

        a.toggle-menu{
            display: none; 
            position: absolute;
            right: 1rem; 
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 10px; 
            font-size: 18px; 
            background-color: transparent; 
            color: #ccc; 
            border: 1px solid #547787;
            border-radius: 4px;
            line-height: 1; 
        }
        a.toggle-menu:hover {
            background-color: #365670;
            color: #fff;
        }

        @media (max-width:767px){
            .header-top-row .site-title {
                 font-size: 0.9rem; 
                 padding: 0 0.5rem;
            }
            .header-top-row .logo-area img {
                 height: 1.75rem; 
            }
            .header-top-row .actions-area {
                 min-width: auto; 
                 width: 40px; 
            }

            .exo-menu-container { padding: 0; }
            .menu-bar-wrapper { padding: 0 0.5rem; } 
            
            ul.exo-menu { 
                display: none; 
                flex-direction: column; 
                width: 100%;
                background-color: #23364B; 
                position: absolute; 
                top: 100%; 
                left: 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            ul.exo-menu.display { 
                display:flex ; 
            }
            .exo-menu > li {
                width:100%;
                display: block; 
                float: none;
                border-bottom: 1px #365670 dotted;
            }
             .exo-menu > li:last-child {
                border-bottom: none;
            }
            .exo-menu > li > a{
                width:100% ;
                padding: 12px 15px; 
                border-right: none; 
            }
            
            li.drop-down:before { display: block;  } 
            
            li.drop-down > ul.drop-down-ul {
                position:relative; 
                width: 100%;
                box-shadow: none;
                border-top: 1px solid #547787; 
            }
            li.drop-down > ul.drop-down-ul > li > a {
                padding-left: 25px; 
            }
            a.toggle-menu{
                display: block; 
                 top: 18px; 
                 right: 1rem;
            }
            /* body { padding-top: 90px;  } // Removido para ser ajustado por JS */
        }

        /* Login Screen Styles */
        #loginScreen {
            @apply flex flex-col items-center justify-center min-h-screen bg-slate-800 p-4;
        }
        .login-card {
            @apply bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center;
        }
        .login-title {
            @apply text-2xl font-bold text-slate-700 mb-2;
        }
        .login-subtitle {
            @apply text-sm text-slate-500 mb-6;
        }
        .login-input {
            @apply w-full px-4 py-3 border border-slate-300 rounded-md shadow-sm 
                   focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 
                   text-center text-lg tracking-wider;
        }
        .login-button {
            @apply w-full mt-6 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 rounded-md shadow-lg
                   transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2;
        }
        #loginErrorMessage {
            @apply mt-4 text-red-500 text-sm;
        }

    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="https://placehold.co/150x60/0284c7/FFFFFF?text=SuaGraficaPRO" alt="Logo Gráfica PRO" class="mx-auto mb-6 h-12">
            <h2 class="login-title">Acesso ao Sistema</h2>
            <p class="login-subtitle">Insira o seu código de funcionário para continuar.</p>
            <form id="loginForm">
                <input type="password" id="codigoAcesso" class="login-input" placeholder="Código de Acesso" required>
                <button type="submit" class="login-button">Entrar</button>
            </form>
            <p id="loginErrorMessage" class="hidden"></p>
        </div>
    </div>

    <!-- Container Principal do Aplicativo -->
    <div id="appContainer" class="hidden">
        <!-- Cabeçalho e Menu Fixo -->
        <div class="exo-menu-container" id="mainHeader">
            <div class="header-top-row">
                <div class="logo-area flex-shrink-0 flex items-center">
                    <img src="https://placehold.co/120x32/0284c7/FFFFFF?text=SuaLogo" alt="Logo Gráfica" class="h-6 sm:h-8">
                    <span id="loggedInUserNameDisplay" class="ml-3 text-white font-semibold hidden"></span>
                </div>
                <h1 class="site-title">Sistema de gestão de Gráfica PRO</h1>
                <div class="actions-area flex-shrink-0 w-[120px] sm:w-[150px]"> 
                    <button id="logoutButton" class="btn btn-secondary-dark text-xs py-1.5 px-3"><i class="fas fa-sign-out-alt mr-1.5"></i>Sair</button>
                </div>
            </div>
        
            <div class="menu-bar-wrapper"> 
                <ul class="exo-menu clearfix">
                    <li data-role-access="all"><a href="#" class="active" onclick="mostrarSecao('telaInicial', true)" data-section="telaInicial"><i class="fas fa-home"></i> Home</a></li>
                    <li data-role-access="admin,vendedor"><a href="#" onclick="mostrarSecao('novoPedido', true)" data-section="novoPedido"><i class="fas fa-plus"></i> Novo Pedido</a></li>
                    <li class="drop-down" data-role-access="admin,vendedor,designer">
                        <a href="#"><i class="fas fa-archive"></i> Cadastros</a>
                        <ul class="drop-down-ul">
                            <li data-role-access="admin,vendedor"><a href="#" onclick="mostrarSecao('cadastrarCliente', true)" data-section="cadastrarCliente">Clientes</a></li>
                            <li data-role-access="admin,designer"><a href="#" onclick="mostrarSecao('cadastrarProduto', true)" data-section="cadastrarProduto">Produtos</a></li>
                            <li data-role-access="admin"><a href="#" onclick="mostrarSecao('cadastrarFuncionario', true)" data-section="cadastrarFuncionario">Funcionários</a></li>
                            <li data-role-access="admin"><a href="#" onclick="mostrarSecao('cadastrarFornecedor', true)" data-section="cadastrarFornecedor">Fornecedores</a></li>
                        </ul>
                    </li>
                    <li data-role-access="all"><a href="#" onclick="mostrarSecao('visualizarPedidos', true)" data-section="visualizarPedidos"><i class="fas fa-list-alt"></i> Pedidos</a></li>
                </ul>
                <a href="#" class="toggle-menu"><i class="fas fa-bars"></i></a>
            </div>
        </div>

        <!-- Área de Conteúdo Principal (com padding-top aplicado via JS) -->
        <div class="main-layout"> 
            <main id="mainContentArea" class="content-area w-full"> 
                <!-- Seção Home/Dashboard -->
                <section id="telaInicial" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"> 
                    <h1 class="dashboard-header">Painel de Controlo</h1> 
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                        <div class="metric-card-dashboard pedidos-hoje">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard pedidos-hoje"><i class="fas fa-calendar-day"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Pedidos Hoje</div>
                                    <div id="metricPedidosHoje" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard pedidos-pendentes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard pedidos-pendentes"><i class="fas fa-hourglass-half"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Pendentes</div>
                                    <div id="metricPedidosPendentes" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard faturamento-mes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                                <div class="icon-wrapper-dashboard faturamento-mes"><i class="fas fa-dollar-sign"></i></div>
                                <div class="metric-details">
                                    <div class="metric-label-dashboard">Faturamento Mês</div>
                                    <div id="metricFaturamentoMes" class="metric-value-dashboard">R$0,00</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card-dashboard total-clientes">
                            <div class="card-header-color"></div>
                            <div class="card-content">
                               <div class="icon-wrapper-dashboard total-clientes"><i class="fas fa-users"></i></div>
                                <div class="metric-details">
                                   <div class="metric-label-dashboard">Total Clientes</div>
                                   <div id="metricTotalClientes" class="metric-value-dashboard">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="material-table-card">
                        <div class="material-table-header">
                            <h2>Últimos Pedidos</h2>
                            <button onclick="mostrarSecao('visualizarPedidos', true)" class="btn btn-primary text-xs py-2 px-3"><i class="fas fa-list-ul mr-2"></i>Ver Todos</button>
                        </div>
                        <div class="material-table-container">
                            <table class="material-data-table">
                                <thead>
                                    <tr>
                                        <th>Nº Pedido</th>
                                        <th>Cliente</th>
                                        <th>Data</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ultimosPedidosTableBody">
                                    <!-- Conteúdo será preenchido por JS -->
                                    <tr><td colspan="6" class="text-center text-[var(--dashboard-text-muted)] py-10">Nenhum pedido recente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Seção Novo Pedido -->
                <section id="novoPedido" class="hidden card max-w-3xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Novo Pedido</h2>
                    <form id="formNovoPedido" class="space-y-5">
                        <input type="hidden" id="editingOrderIdField"> 
                        <div>
                            <label for="pedidoDataHora" class="label-text">Data e Hora do Pedido:</label>
                            <input type="text" id="pedidoDataHora" class="input-field bg-slate-100 cursor-not-allowed" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="relative">
                                <label for="pedidoClienteSearch" class="label-text">Cliente:</label>
                                <input type="text" id="pedidoClienteSearch" class="input-field" placeholder="Pesquisar cliente...">
                                <input type="hidden" id="pedidoClienteId">
                                <div id="pedidoClienteResultados" class="hidden">
                                    {/* Resultados da pesquisa de clientes aqui */}
                                </div>
                                <button type="button" onclick="abrirModalNovoClienteRapido()" class="mt-1.5 btn btn-link text-xs">Registar novo cliente</button>
                            </div>
                            <div>
                                <label for="pedidoVendedor" class="label-text">Funcionário (Vendedor):</label>
                                <select id="pedidoVendedor" class="input-field">
                                    <option value="">Selecione um funcionário</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="label-text">Preview do Pedido (Opcional):</label>
                            <div id="pedidoImageDropArea" class="image-drop-area" onclick="document.getElementById('pedidoImagemFile').click();">
                                <input type="file" accept="image/*" class="hidden" id="pedidoImagemFile" onchange="handleImagemFilePedido(event)">
                                <img src="#" alt="Preview do Pedido" id="pedidoImagemPreview" class="hidden preview-image">
                                <span id="pedidoImagemPreviewPlaceholder" class="text-[var(--color-text-muted)] text-sm">
                                    <i class="fas fa-image fa-2x mb-1.5 text-slate-400"></i><br>
                                    Cole ou clique para carregar imagem
                                </span>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-[var(--color-border-soft)]">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-md font-semibold text-[var(--color-text-heading)]">Itens do Pedido</h3>
                            </div>
                            <div id="itensPedidoContainer" class="space-y-3.5"></div>
                            <button type="button" onclick="adicionarItemPedidoForm()" class="mt-3 btn btn-outline btn-small text-sm"><i class="fas fa-plus mr-1.5"></i>Adicionar Produto</button>
                        </div>
                        
                        <div class="pt-4 border-t border-[var(--color-border-soft)]">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-md font-semibold text-[var(--color-text-heading)]">Detalhes do Pagamento</h3>
                            </div>
                            <div id="pagamentosContainer" class="space-y-4">
                            </div>
                            <button type="button" onclick="adicionarPagamentoForm()" class="mt-3 btn btn-outline btn-small text-sm"><i class="fas fa-dollar-sign mr-1.5"></i>Adicionar Pagamento</button>
                            
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="label-text">Valor Total do Pedido:</label>
                                    <input type="text" id="pedidoValorTotal" class="input-field bg-slate-100 text-lg font-semibold text-[var(--color-primary)] cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                                <div>
                                    <label class="label-text">Total Pago:</label>
                                    <input type="text" id="pedidoTotalPago" class="input-field bg-slate-100 text-lg font-semibold text-green-600 cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                                <div>
                                    <label class="label-text">Valor Restante:</label>
                                    <input type="text" id="pedidoValorRestante" class="input-field bg-slate-100 text-lg font-semibold text-red-600 cursor-not-allowed" readonly value="R$ 0,00">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="grid grid-cols-2 gap-4">
                                 <div>
                                    <label for="pedidoDataEntrega" class="label-text">Data Entrega:</label>
                                    <input type="date" id="pedidoDataEntrega" class="input-field">
                                </div>
                                <div>
                                    <label for="pedidoHoraEntrega" class="label-text">Hora Entrega:</label>
                                    <input type="time" id="pedidoHoraEntrega" class="input-field">
                                </div>
                            </div>
                             <div>
                                <label for="pedidoStatus" class="label-text">Estado do Pedido:</label>
                                <select id="pedidoStatus" class="input-field">
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t border-[var(--color-border-soft)]">
                            <button type="button" onclick="cancelarEdicaoPedido()" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-check mr-1.5"></i>Guardar Pedido</button>
                        </div>
                    </form>
                </section>

                <!-- Seção Cadastrar Cliente -->
                <section id="cadastrarCliente" class="hidden card">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5">Registar Cliente</h2>
                            <form id="formCadastrarCliente" class="space-y-4">
                                <div>
                                    <label for="clienteNome" class="label-text">Nome Completo / Razão Social:</label>
                                    <input type="text" id="clienteNome" class="input-field" required>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteTipo" class="label-text">Tipo de Cliente:</label>
                                        <select id="clienteTipo" class="input-field">
                                            <option value="final">Cliente Final</option>
                                            <option value="revenda">Revenda</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="clienteTelefone" class="label-text">Telefone:</label>
                                        <input type="tel" id="clienteTelefone" class="input-field">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="clienteEmail" class="label-text">Email:</label>
                                        <input type="email" id="clienteEmail" class="input-field">
                                    </div>
                                    <div>
                                        <label for="clienteCpfCnpj" class="label-text">CPF/CNPJ (Opcional):</label>
                                        <input type="text" id="clienteCpfCnpj" class="input-field">
                                    </div>
                                </div>
                                <div>
                                    <label for="clienteEndereco" class="label-text">Endereço (Opcional):</label>
                                    <input type="text" id="clienteEndereco" class="input-field">
                                </div>
                                <div class="flex justify-end pt-3">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Cliente</button>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 mt-6 lg:mt-0">
                            <h3 class="text-lg font-semibold text-[var(--color-text-heading)] mb-1">Clientes Registados</h3>
                            <div class="search-input-wrapper">
                                <i class="fas fa-search"></i>
                                <input type="text" id="pesquisaClienteInput" class="input-field w-full" placeholder="Pesquisar cliente por nome, telefone...">
                            </div>
                            <div id="listaClientes" class="space-y-2.5 max-h-60 sm:max-h-72 lg:max-h-[calc(100vh-340px)] overflow-y-auto pr-1">
                                <p class="text-[var(--color-text-muted)] text-sm">Nenhum cliente registado.</p>
                            </div>
                            
                            <div id="detalhesClienteSelecionado" class="mt-6 hidden">
                                <h4 class="text-md font-semibold text-[var(--color-text-heading)] mb-2 border-t pt-4">Detalhes do Cliente</h4>
                                <div id="infoCliente" class="p-3 border border-[var(--color-border-soft)] rounded-md bg-slate-50 mb-4 text-sm space-y-1">
                                    {/* Detalhes do cliente serão preenchidos aqui pelo JS */}
                                </div>
                                <h4 class="text-md font-semibold text-[var(--color-text-heading)] mb-2">Pedidos do Cliente</h4>
                                <div id="pedidosDoClienteLista" class="space-y-2.5 max-h-40 sm:max-h-48 overflow-y-auto pr-1 border rounded-md p-2 bg-slate-50">
                                    <p class="text-[var(--color-text-muted)] text-xs text-center py-2">Selecione um cliente para ver os seus pedidos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Cadastrar Produto -->
                <section id="cadastrarProduto" class="hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Produto</h2>
                    <form id="formCadastrarProduto" class="space-y-4">
                        <div>
                            <label for="produtoNome" class="label-text">Nome do Produto:</label>
                            <input type="text" id="produtoNome" class="input-field" required> </div>
                        <div>
                            <label for="produtoTipoPreco" class="label-text">Tipo de Precificação:</label>
                            <select id="produtoTipoPreco" class="input-field" onchange="togglePrecoFields()">
                                <option value="unidade">Por Unidade/Pacote</option>
                                <option value="metro">Por Metro Quadrado (m²)</option>
                            </select>
                        </div>
                        <div id="precoUnidadeFields">
                            <label for="produtoPrecoUnidade" class="label-text">Preço Unitário (R$):</label>
                            <input type="number" step="0.01" id="produtoPrecoUnidade" class="input-field">
                        </div>
                        <div id="precoMetroFields" class="hidden">
                            <label for="produtoPrecoMetro" class="label-text">Preço por Metro Quadrado (R$/m²):</label>
                            <input type="number" step="0.01" id="produtoPrecoMetro" class="input-field">
                        </div>
                        <div>
                            <label for="produtoDescricao" class="label-text">Descrição (Opcional):</label>
                            <textarea id="produtoDescricao" rows="3" class="input-field"></textarea>
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-box mr-1.5"></i>Guardar Produto</button>
                        </div>
                    </form>
                     <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Produtos Registados</h3>
                        <div id="listaProdutos" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                             <p class="text-[var(--color-text-muted)] text-sm">Nenhum produto registado.</p>
                        </div>
                    </div>
                </section>

                <!-- Seção Cadastrar Funcionário -->
                <section id="cadastrarFuncionario" class="hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Funcionário</h2>
                    <form id="formCadastrarFuncionario" class="space-y-4">
                        <div>
                            <label for="funcionarioNome" class="label-text">Nome do Funcionário:</label>
                            <input type="text" id="funcionarioNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="funcionarioContato" class="label-text">Contacto (Telefone/Email - Opcional):</label>
                            <input type="text" id="funcionarioContato" class="input-field">
                        </div>
                        <div>
                            <label for="funcionarioCargo" class="label-text">Cargo:</label>
                            <select id="funcionarioCargo" class="input-field">
                                <option value="admin">Administrador</option>
                                <option value="vendedor" selected>Vendedor</option>
                                <option value="producao">Produção</option>
                                <option value="impressor">Impressor</option>
                                <option value="designer">Designer</option>
                                <option value="freelancer">Freelancer</option>
                            </select>
                        </div>
                         <div>
                            <label for="funcionarioCodigoAcesso" class="label-text">Código de Acesso:</label>
                            <input type="text" id="funcionarioCodigoAcesso" class="input-field" placeholder="Ex: 123456" required>
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus mr-1.5"></i>Guardar Funcionário</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Funcionários Registados</h3>
                        <div id="listaFuncionariosCadSec" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-[var(--color-text-muted)] text-sm">Nenhum funcionário registado.</p>
                        </div>
                    </div>
                </section>

                <!-- Seção Cadastrar Fornecedor -->
                <section id="cadastrarFornecedor" class="hidden card max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Registar Fornecedor</h2>
                    <form id="formCadastrarFornecedor" class="space-y-4">
                        <div>
                            <label for="fornecedorNome" class="label-text">Nome do Fornecedor:</label>
                            <input type="text" id="fornecedorNome" class="input-field" required>
                        </div>
                        <div>
                            <label for="fornecedorContato" class="label-text">Contacto (Telefone/Email):</label>
                            <input type="text" id="fornecedorContato" class="input-field">
                        </div>
                        <div>
                            <label for="fornecedorMaterial" class="label-text">Tipo de Material Fornecido:</label>
                            <input type="text" id="fornecedorMaterial" class="input-field">
                        </div>
                        <div class="flex justify-end pt-3">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-1.5"></i>Guardar Fornecedor</button>
                        </div>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-md font-semibold text-[var(--color-text-heading)] mb-3 border-b pb-2">Fornecedores Registados</h3>
                        <div id="listaFornecedores" class="space-y-2.5 max-h-60 sm:max-h-72 md:max-h-80 overflow-y-auto pr-1">
                            <p class="text-[var(--color-text-muted)] text-sm">Nenhum fornecedor registado.</p>
                        </div>
                    </div>
                </section>

                <!-- Seção Visualizar Pedidos -->
                <section id="visualizarPedidos" class="hidden card">
                     <h2 class="text-xl font-semibold text-[var(--color-text-heading)] mb-5 pb-3 border-b border-[var(--color-border-soft)]">Todos os Pedidos</h2>
                    <div class="mb-6 p-4 border border-[var(--color-border-soft)] rounded-lg bg-slate-50">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3 items-end">
                            <div>
                                <label for="filtroNomeCliente" class="label-text text-xs">Nome do Cliente:</label>
                                <input type="text" id="filtroNomeCliente" class="input-field input-field-sm" placeholder="Pesquisar nome...">
                            </div>
                            <div>
                                <label for="filtroNumeroPedido" class="label-text text-xs">Nº do Pedido:</label>
                                <input type="text" id="filtroNumeroPedido" class="input-field input-field-sm" placeholder="Pesquisar número...">
                            </div>
                            <div>
                                <label for="filtroDataPedido" class="label-text text-xs">Data do Pedido:</label>
                                <input type="date" id="filtroDataPedido" class="input-field input-field-sm">
                            </div>
                            <div>
                                <label for="filtroMaterialProduto" class="label-text text-xs">Produto/Material (nos Itens):</label>
                                <input type="text" id="filtroMaterialProduto" class="input-field input-field-sm" placeholder="Pesquisar item...">
                            </div>
                            <div>
                                <label for="filtroStatusPedido" class="label-text text-xs">Estado do Pedido:</label>
                                <select id="filtroStatusPedido" class="input-field input-field-sm">
                                    <option value="">Todos os Estados</option>
                                    <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                                    <option value="Em Produção (Arte)">Em Produção (Arte)</option>
                                    <option value="Em Produção (Impressão)">Em Produção (Impressão)</option>
                                    <option value="Em Produção (Acabamento)">Em Produção (Acabamento)</option>
                                    <option value="Pronto para Retirada">Pronto para Retirada</option>
                                    <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                                    <option value="Entregue">Entregue</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                             <div>
                                <label for="filtroVendedor" class="label-text text-xs">Funcionário (Vendedor):</label>
                                <select id="filtroVendedor" class="input-field input-field-sm">
                                    <option value="">Todos os Funcionários</option>
                                    {/* Funcionários serão populados por JS */}
                                </select>
                            </div>
                             <div>
                                <label for="filtroClassificacaoPedido" class="label-text text-xs">Classificar por:</label>
                                <select id="filtroClassificacaoPedido" class="input-field input-field-sm">
                                    <option value="dataPedido_desc">Data Pedido (Mais Recentes)</option>
                                    <option value="dataPedido_asc">Data Pedido (Mais Antigos)</option>
                                    <option value="dataEntrega_asc">Data Entrega (Mais Próximos)</option>
                                    <option value="dataEntrega_desc">Data Entrega (Mais Distantes)</option>
                                    <option value="clienteNome_asc">Nome Cliente (A-Z)</option>
                                    <option value="clienteNome_desc">Nome Cliente (Z-A)</option>
                                    <option value="numeroPedido_asc">Nº Pedido (Crescente)</option>
                                    <option value="numeroPedido_desc">Nº Pedido (Decrescente)</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2 lg:col-span-1 lg:col-start-3">
                                 <button id="limparFiltrosPedidos" class="btn btn-secondary w-full text-sm py-2"><i class="fas fa-times mr-2"></i>Limpar Filtros</button>
                            </div>
                        </div>
                    </div>
                    <div id="listaTodosPedidos" class="space-y-4">
                        <p class="text-[var(--color-text-muted)] text-center py-6">Nenhum pedido encontrado.</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal Novo Cliente Rápido -->
    <div id="modalNovoClienteRapidoOverlay" class="modal-overlay hidden opacity-0 pointer-events-none">
        <div id="modalNovoClienteRapidoContent" class="modal-content-wrapper max-w-md opacity-0 scale-95 pointer-events-none">
            <div class="modal-header-colored bg-sky-500"></div> 
            <div class="modal-body-content">
                <button type="button" class="modal-close-x no-print" onclick="fecharModalNovoClienteRapido()">&times;</button>
                <h3 class="text-lg font-semibold text-[var(--color-text-heading)] mb-5">Registo Rápido de Cliente</h3>
                <form id="formNovoClienteRapido" class="space-y-4">
                    <div>
                        <label for="clienteRapidoNome" class="label-text">Nome:</label>
                        <input type="text" id="clienteRapidoNome" class="input-field" required>
                    </div>
                    <div>
                        <label for="clienteRapidoTelefone" class="label-text">Telefone:</label>
                        <input type="tel" id="clienteRapidoTelefone" class="input-field">
                    </div>
                    <div>
                        <label for="clienteRapidoTipo" class="label-text">Tipo de Cliente:</label>
                        <select id="clienteRapidoTipo" class="input-field">
                            <option value="final" selected>Cliente Final</option>
                            <option value="revenda">Revenda</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2.5 pt-4">
                        <button type="button" onclick="fecharModalNovoClienteRapido()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Mensagem Genérico -->
    <div id="messageModalOverlay" class="modal-overlay hidden opacity-0 pointer-events-none">
        <div id="messageModalContent" class="modal-content-wrapper max-w-xs opacity-0 scale-95 pointer-events-none">
            <div id="messageModalHeader" class="modal-header-colored"></div> 
            <div class="modal-body-content text-center">
                <button type="button" class="modal-close-x no-print" onclick="fecharMessageModal()">&times;</button>
                <div id="messageModalIcon" class="text-4xl sm:text-5xl mb-3 sm:mb-4">
                    {/* Ícone será definido por JS */}
                </div>
                <p id="messageModalText" class="text-sm text-[var(--color-text-main)] mb-5 sm:mb-6"></p>
                <button id="messageModalButtonOk" onclick="fecharMessageModal()" class="btn btn-primary w-full">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirmDeleteModalOverlay" class="modal-overlay hidden opacity-0 pointer-events-none">
        <div id="confirmDeleteModalContent" class="modal-content-wrapper max-w-sm opacity-0 scale-95 pointer-events-none">
            <div class="modal-header-colored bg-red-500"></div>
            <div class="modal-body-content">
                <h3 class="text-lg font-semibold text-slate-800 mb-4" id="confirmDeleteModalTitle">Confirmar Exclusão</h3>
                <p id="confirmDeleteModalMessage" class="text-sm text-slate-600 mb-6">Tem certeza de que deseja excluir este item?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="fecharConfirmDeleteModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="button" id="confirmDeleteModalButton" class="btn btn-danger">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Código de Funcionário -->
    <div id="modalEditarCodigoFuncionario" class="modal-overlay hidden opacity-0 pointer-events-none">
        <div class="modal-content-wrapper max-w-sm opacity-0 scale-95 pointer-events-none">
            <div class="modal-header-colored bg-sky-500"></div>
            <div class="modal-body-content">
                <button type="button" class="modal-close-x no-print" onclick="fecharModalEditarCodigoFuncionario()">&times;</button>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Editar Código de Acesso</h3>
                <p class="text-sm text-slate-600 mb-4" id="nomeFuncionarioParaEditarCodigo"></p>
                <form id="formEditarCodigoFuncionario">
                    <input type="hidden" id="funcionarioIdParaEditarCodigo">
                    <div>
                        <label for="novoCodigoAcesso" class="label-text">Novo Código:</label>
                        <input type="text" id="novoCodigoAcesso" class="input-field" required>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalEditarCodigoFuncionario()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Código</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script type="module">
        // =================================================================================
        // INICIALIZAÇÃO DO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================================
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc,
            getDocs, 
            query, 
            limit,
            onSnapshot, 
            Timestamp,
            writeBatch,
            deleteDoc, 
            setDoc,
            updateDoc, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase (substitua pelas suas chaves reais)
        const firebaseConfig = {
            apiKey: "AIzaSyDOg6A8HFA_JCP_4iS7JcRCTRgdnzcP4Xk", // ATENÇÃO: Esta é uma chave de exemplo. Use a sua.
            authDomain: "sistema-grafica-pro.firebaseapp.com",
            projectId: "sistema-grafica-pro",
            storageBucket: "sistema-grafica-pro.firebasestorage.app", // Comum ser .appspot.com
            messagingSenderId: "990637238811",
            appId: "1:1043193530848:web:b0effc9640a2e8ed6f8385"
            // measurementId é opcional e não usado aqui
        };

        // Instâncias dos serviços Firebase
        let app;
        let auth;
        let db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado com sucesso!");
        } catch (error) {
            console.error("ERRO CRÍTICO AO INICIALIZAR FIREBASE:", error);
            // Tenta exibir um alerta mais visível se o modal não funcionar
            const criticalErrorMsg = "Erro crítico ao conectar com o sistema. Verifique o console (F12) para detalhes e contacte o suporte técnico informando este erro.";
            const loginErrorEl = document.getElementById('loginErrorMessage');
            if (loginErrorEl) {
                 loginErrorEl.textContent = criticalErrorMsg;
                 loginErrorEl.classList.remove('hidden');
            } else {
                alert(criticalErrorMsg); // Fallback para alert se o elemento não existir
            }
            throw new Error("Falha na inicialização do Firebase. A aplicação não pode continuar."); // Interrompe a execução
        }
        
        // ID da instância da aplicação (para namespace no Firestore)
        // Alterado para usar um ID fixo, pois __app_id não é fornecido neste contexto.
        // Se precisar de múltiplas "lojas" com dados isolados, este ID precisaria ser dinâmico
        // ou você usaria uma estrutura de coleção diferente.
        const shopInstanceAppId = firebaseConfig.projectId || 'default-app-id'; 
        
        // Variáveis de estado e cache da aplicação
        let userId = null; // ID do usuário Firebase (anônimo ou autenticado)
        let produtosCache = [];
        let pedidoImagemBase64 = null; 
        let todosOsPedidosCache = []; 
        let clientesCache = []; 
        let fornecedoresCache = []; 
        let funcionariosCache = []; // Cache de funcionários
        let itemPedidoCount = 0; 
        let pagamentoCount = 0; 
        let clienteSelecionadoId = null; // ID do cliente selecionado na tela de cadastro
        let editingOrderId = null; // ID do pedido sendo editado
        let loggedInUserRole = null; // Cargo do funcionário logado (ex: 'admin', 'vendedor')
        let loggedInUserName = null; // Nome do funcionário logado

        // Referências a elementos da UI (DOM)
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const codigoAcessoInput = document.getElementById('codigoAcesso');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        const loggedInUserNameDisplay = document.getElementById('loggedInUserNameDisplay');
        const logoutButton = document.getElementById('logoutButton');
        const mainHeader = document.getElementById('mainHeader'); // Usado para calcular altura do menu fixo

        // =================================================================================
        // LÓGICA DE AUTENTICAÇÃO, LOGIN E PERSISTÊNCIA DE SESSÃO
        // =================================================================================

        // Observador do estado de autenticação do Firebase
        onAuthStateChanged(auth, async (user) => {
            if (user) { // Usuário Firebase logado (inicialmente anônimo)
                userId = user.uid;
                console.log("Firebase Auth State Changed: Usuário LOGADO (anônimo ou não). UID:", userId);

                // Verifica se o login com código de acesso já foi validado e persistido no localStorage
                const persistedRole = localStorage.getItem('loggedInUserRole_graficaPro');
                const persistedName = localStorage.getItem('loggedInUserName_graficaPro');
                const codeValidated = localStorage.getItem('codeAccessValidated_graficaPro') === 'true';

                if (codeValidated && persistedRole && persistedName) {
                    // Se o código já foi validado e os dados estão no localStorage, restaura a sessão do funcionário
                    console.log("Sessão de funcionário persistida encontrada:", { role: persistedRole, name: persistedName });
                    loggedInUserRole = persistedRole;
                    loggedInUserName = persistedName;

                    // Transiciona para a interface principal do aplicativo
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loggedInUserNameDisplay.textContent = loggedInUserName || 'Usuário';
                    loggedInUserNameDisplay.classList.remove('hidden');
                    ajustarMenuPorCargo(loggedInUserRole); // Mostra/esconde itens do menu
                    ajustarPaddingBody(); // Ajusta o padding do body para o menu fixo
                    await carregarDadosEssenciais(); // Carrega dados (clientes, produtos, etc.)
                    mostrarSecao('telaInicial', true); // Mostra a tela inicial (dashboard)
                } else { 
                    // Usuário Firebase está logado (anonimamente), mas o código de acesso ainda não foi validado
                    // Mantém na tela de login para inserir o código
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    document.body.style.paddingTop = '0px'; // Remove padding do topo se estiver na tela de login
                    console.log("Usuário anônimo conectado. Aguardando código de acesso do funcionário.");
                }
            } else { // Usuário Firebase está deslogado
                userId = null;
                loggedInUserRole = null;
                loggedInUserName = null;
                
                // Limpa os dados de sessão persistidos do funcionário ao deslogar do Firebase
                localStorage.removeItem('loggedInUserRole_graficaPro');
                localStorage.removeItem('loggedInUserName_graficaPro');
                localStorage.removeItem('codeAccessValidated_graficaPro');
                console.log("Firebase Auth State Changed: Usuário DESLOGADO. localStorage limpo.");
                
                // Mostra a tela de login e esconde o aplicativo
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                loggedInUserNameDisplay.classList.add('hidden');
                loggedInUserNameDisplay.textContent = '';
                document.body.style.paddingTop = '0px'; // Remove padding do topo
            }
        });

        // Tenta realizar login anônimo no Firebase assim que o script carrega
        // Isso é necessário para obter um `userId` para interagir com o Firestore,
        // mesmo antes do funcionário inserir o código de acesso.
        signInAnonymously(auth)
            .then(() => {
                console.log("Login anônimo no Firebase bem-sucedido ou usuário já estava logado anonimamente.");
                // A lógica de UI é tratada pelo onAuthStateChanged
            })
            .catch((error) => {
                console.error("Falha crítica no login anônimo inicial do Firebase:", error);
                exibirMensagemUI(loginErrorMessage, "Falha ao conectar com o sistema de autenticação. Recarregue a página ou contate o suporte.");
            });

        // Manipulador do formulário de login com código de acesso
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Impede o envio padrão do formulário
            const codigo = codigoAcessoInput.value.trim();
            loginErrorMessage.classList.add('hidden');
            loginErrorMessage.textContent = '';

            if (!codigo) {
                exibirMensagemUI(loginErrorMessage, "Por favor, insira seu código de acesso.");
                return;
            }
            if (!userId) { // `userId` é do login anônimo do Firebase
                exibirMensagemUI(loginErrorMessage, "Aguardando conexão com o servidor. Tente novamente em alguns segundos.");
                console.warn("Tentativa de login com código, mas o userId anônimo do Firebase não está definido.");
                return;
            }
            
            console.log(`Tentando validar código de acesso: ${codigo}`);
            try {
                // IMPORTANTE: Define o caminho para a coleção de funcionários.
                // Se os funcionários são globais, o caminho DEVE ser `artifacts/${shopInstanceAppId}/funcionarios`.
                // Se forem por usuário (incomum para esta lógica), seria `artifacts/${shopInstanceAppId}/users/${userId}/funcionarios`.
                // Assumindo lista de funcionários GLOBAL para validação de código de acesso.
                const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`; 
                
                const q = query(collection(db, funcionariosPath), where("codigoAcesso", "==", codigo));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    exibirMensagemUI(loginErrorMessage, "Código de acesso inválido ou não encontrado.");
                    console.log("Código de acesso não encontrado no Firestore em:", funcionariosPath);
                } else {
                    const funcionarioDoc = querySnapshot.docs[0]; // Pega o primeiro funcionário com esse código
                    const funcionarioData = funcionarioDoc.data();
                    
                    console.log("Funcionário encontrado:", funcionarioData);
                    loggedInUserRole = funcionarioData.cargo ? funcionarioData.cargo.toLowerCase() : 'vendedor'; // Cargo em minúsculas
                    loggedInUserName = funcionarioData.nome;

                    // Persiste os dados do funcionário logado no localStorage
                    localStorage.setItem('loggedInUserRole_graficaPro', loggedInUserRole);
                    localStorage.setItem('loggedInUserName_graficaPro', loggedInUserName);
                    localStorage.setItem('codeAccessValidated_graficaPro', 'true'); // Sinaliza que o código foi validado

                    // Transiciona para a interface principal do aplicativo
                    // O onAuthStateChanged também poderia pegar essa mudança, mas fazemos explicitamente para garantir
                    if (auth.currentUser) { 
                         loginScreen.classList.add('hidden');
                         appContainer.classList.remove('hidden');
                         loggedInUserNameDisplay.textContent = loggedInUserName;
                         loggedInUserNameDisplay.classList.remove('hidden');
                         ajustarMenuPorCargo(loggedInUserRole);
                         ajustarPaddingBody();
                         await carregarDadosEssenciais();
                         mostrarSecao('telaInicial', true); 
                         codigoAcessoInput.value = ''; // Limpa o campo do código
                    } else {
                        // Isso não deveria acontecer se o signInAnonymously do Firebase funcionou
                        exibirMensagemUI(loginErrorMessage, "Sessão Firebase (anônima) perdida. Por favor, recarregue a página.");
                    }
                }
            } catch (error) {
                console.error("Erro ao validar código de acesso:", error);
                exibirMensagemUI(loginErrorMessage, "Erro ao verificar o código. Tente novamente.");
            }
        });

        // Manipulador do botão de Logout
        logoutButton.addEventListener('click', () => {
            // Limpa os dados de sessão persistidos do funcionário do localStorage PRIMEIRO
            localStorage.removeItem('loggedInUserRole_graficaPro');
            localStorage.removeItem('loggedInUserName_graficaPro');
            localStorage.removeItem('codeAccessValidated_graficaPro');
            
            // Faz signOut do Firebase (isso disparará o onAuthStateChanged, que tratará a UI)
            signOut(auth).then(() => {
                console.log("Logout do Firebase bem-sucedido. Dados de sessão local limpos.");
            }).catch((error) => {
                console.error("Erro ao fazer logout do Firebase:", error);
            });
        });

        // Função auxiliar para exibir mensagens de erro/sucesso na UI de login
        function exibirMensagemUI(elemento, mensagem) {
            if (elemento) {
                elemento.textContent = mensagem;
                elemento.classList.remove('hidden');
            } else {
                console.warn("Tentativa de exibir mensagem em elemento nulo:", mensagem);
            }
        }

        // Ajusta os itens visíveis no menu com base no cargo do funcionário
        function ajustarMenuPorCargo(cargo) {
            console.log("Ajustando menu para o cargo:", cargo);
            const menuItens = document.querySelectorAll('.exo-menu [data-role-access]');
            menuItens.forEach(item => {
                const rolesPermitidas = item.dataset.roleAccess.split(',');
                if (rolesPermitidas.includes(cargo) || rolesPermitidas.includes('all')) {
                    item.style.display = ''; // Mostra o item do menu
                } else {
                    item.style.display = 'none'; // Esconde o item do menu
                }
            });
        }

        // Ajusta o padding do topo do body para compensar a altura do menu fixo
        function ajustarPaddingBody() {
            if (mainHeader && !appContainer.classList.contains('hidden')) {
                const headerHeight = mainHeader.offsetHeight;
                document.body.style.paddingTop = `${headerHeight}px`;
            } else {
                document.body.style.paddingTop = '0px';
            }
        }
        window.addEventListener('resize', ajustarPaddingBody); // Reajusta em caso de redimensionamento da janela
        

        // =================================================================================
        // CARREGAMENTO DE DADOS E LÓGICA DE DADOS INICIAIS
        // =================================================================================
        
        // Função central para carregar dados essenciais após o login do funcionário ser validado
        async function carregarDadosEssenciais() {
            if (!userId) { // userId é do Firebase Auth (anônimo neste ponto)
                console.warn("carregarDadosEssenciais chamado sem userId do Firebase. Isso não deveria acontecer se o login anônimo funcionou.");
                return;
            }
            console.log("Carregando dados essenciais do aplicativo...");
            
            // Garante que os dados iniciais (como o Admin Master) existam ou sejam criados
            await criarDadosIniciaisSeNaoExistirem(); 
            
            // Carrega caches de dados que podem ser usados em várias partes do app
            await carregarFuncionarios(); // Carrega funcionários para selects e listas
            await carregarClientes();     // Carrega clientes para selects e listas
            await carregarProdutos();   // Carrega produtos para selects e listas
            // await carregarFornecedores(); // Descomente se/quando implementar esta seção

            // Carrega dados específicos para o dashboard
            atualizarMetricasDashboard(); 
            carregarUltimosPedidosDashboard(); // Agora não mostrará mais exemplos fixos
        }
        
        // Popula os selects de funcionários (vendedores) nos formulários
        async function popularSelectVendedores() {
            // Não precisa de !userId aqui pois funcionariosCache já deve ter sido carregado por carregarDadosEssenciais
            const selectVendedorPedido = document.getElementById('pedidoVendedor');
            const filtroSelectVendedor = document.getElementById('filtroVendedor');
            
            if (selectVendedorPedido) selectVendedorPedido.innerHTML = '<option value="">Selecione um funcionário</option>';
            if (filtroSelectVendedor) filtroSelectVendedor.innerHTML = '<option value="">Todos os Funcionários</option>';
            
            if (funcionariosCache.length === 0) {
                console.warn("Cache de funcionários vazio ao tentar popular selects.");
                // Poderia tentar recarregar, mas carregarDadosEssenciais deve ter feito isso.
            }

            funcionariosCache.forEach(func => {
                if (func.cargo === 'vendedor' || func.cargo === 'admin') { 
                    const option = document.createElement('option');
                    option.value = func.id; 
                    option.textContent = func.nome;
                    if (selectVendedorPedido) selectVendedorPedido.appendChild(option.cloneNode(true));
                    if (filtroSelectVendedor) filtroSelectVendedor.appendChild(option);
                }
            });
        }

        // Cria dados de exemplo se as coleções estiverem vazias (Clientes, Produtos, Funcionários)
        // Esta função agora usa o `shopInstanceAppId` para criar dados compartilhados.
        async function criarDadosIniciaisSeNaoExistirem() {
            if (!auth.currentUser) { 
                console.log("Aguardando autenticação anônima do Firebase para criar dados iniciais...");
                return;
            }
            console.log(`Verificando/criando dados iniciais para a instância da loja: ${shopInstanceAppId}`);
            
            try {
                // Caminho GLOBAL para funcionários
                const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`; 
                let todosFuncionariosSnapshot = await getDocs(collection(db, funcionariosPath)); 

                let adminExiste = false;
                let adminDocIdParaAtualizar = null;
                todosFuncionariosSnapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const cargo = data.cargo ? data.cargo.toLowerCase() : '';
                    if (cargo === "admin" && data.codigoAcesso === "010101" && data.nome === "Admin Master") {
                        adminExiste = true;
                    }
                    if (data.nome === "Admin Master") { 
                        adminDocIdParaAtualizar = docSnapshot.id;
                    }
                });

                const precisaCriarAdmin = !adminExiste;
                const precisaCriarExemplosCompletos = todosFuncionariosSnapshot.empty || 
                                                   (adminDocIdParaAtualizar && todosFuncionariosSnapshot.docs.length === 1 && !adminExiste) ||
                                                   (!adminDocIdParaAtualizar && todosFuncionariosSnapshot.docs.length === 0);

                if (precisaCriarAdmin) {
                    console.log("Admin Master (010101) não encontrado. Criando/Atualizando...");
                    const adminData = {
                        nome: "Admin Master", contato: "admin@grafica.com", cargo: "admin", 
                        codigoAcesso: "010101", criadoEm: Timestamp.now()
                    };
                    const adminDocRef = adminDocIdParaAtualizar 
                                        ? doc(db, funcionariosPath, adminDocIdParaAtualizar) 
                                        : doc(collection(db, funcionariosPath)); 
                    await setDoc(adminDocRef, adminData, { merge: !!adminDocIdParaAtualizar }); 
                    console.log("Admin Master (010101) garantido/criado.");
                }

                if (precisaCriarExemplosCompletos) { 
                    const funcionariosAmostraParaCriar = [];
                    const exemplos = [
                        { nome: "Vendedor Padrão", contato: "vendedor@grafica.com", cargo: "vendedor", codigoAcesso: "111111" },
                        { nome: "Designer Teste", contato: "designer@grafica.com", cargo: "designer", codigoAcesso: "222222" },
                        { nome: "Produção Teste", contato: "producao@grafica.com", cargo: "producao", codigoAcesso: "333333" }
                    ];
                    
                    let currentFuncionariosSnapshot = await getDocs(collection(db, funcionariosPath));
                    const existeFuncionarioComCodigo = (codigo) => currentFuncionariosSnapshot.docs.some(d => d.data().codigoAcesso === codigo);

                    exemplos.forEach(ex => {
                        if (!existeFuncionarioComCodigo(ex.codigoAcesso) && ex.nome !== "Admin Master") {
                            funcionariosAmostraParaCriar.push(ex);
                        }
                    });

                    if (funcionariosAmostraParaCriar.length > 0) {
                        console.log(`Criando ${funcionariosAmostraParaCriar.length} outros funcionários de amostra (compartilhados)...`);
                        const batchOutros = writeBatch(db);
                        funcionariosAmostraParaCriar.forEach(func => {
                            const docRef = doc(collection(db, funcionariosPath));
                            batchOutros.set(docRef, { ...func, cargo: func.cargo.toLowerCase(), criadoEm: Timestamp.now() });
                        });
                        await batchOutros.commit();
                        console.log(`${funcionariosAmostraParaCriar.length} outros funcionários de amostra (compartilhados) criados.`);
                    }
                }
                
                // Clientes (Caminho compartilhado)
                const clientesPath = `artifacts/${shopInstanceAppId}/clientes`;
                let clientesQuery = query(collection(db, clientesPath), limit(1));
                let clientesSnapshot = await getDocs(clientesQuery);
                if (clientesSnapshot.empty) {
                    console.log("Criando clientes de amostra (compartilhados)...");
                    const clientesAmostra = [
                        { nome: "Carlos Silva", tipoCliente: "final", telefone: "(11) 98765-4321", email: "carlos.silva@example.com", cpfCnpj: "123.456.789-00", endereco: "Rua das Palmeiras, 123", criadoEm: Timestamp.now() },
                        { nome: "Padaria Pão Quente Ltda", tipoCliente: "revenda", telefone: "(21) 91234-5678", email: "contato@paoquente.com.br", cpfCnpj: "12.345.678/0001-99", endereco: "Av. Central, 456", criadoEm: Timestamp.now() }
                    ];
                    const batchClientes = writeBatch(db);
                    clientesAmostra.forEach(cliente => {
                        const docRef = doc(collection(db, clientesPath));
                        batchClientes.set(docRef, cliente);
                    });
                    await batchClientes.commit();
                    console.log("Clientes de amostra (compartilhados) criados.");
                }

                // Produtos (Caminho compartilhado)
                const produtosPath = `artifacts/${shopInstanceAppId}/produtos`;
                let produtosQuery = query(collection(db, produtosPath), limit(1));
                let produtosSnapshot = await getDocs(produtosQuery);
                if (produtosSnapshot.empty) {
                    console.log("Criando produtos de amostra (compartilhados)...");
                    const produtosAmostra = [
                        { nome: "Banner Lona Fosca 440g", tipoPreco: "metro", precoMetro: 55.00, precoUnidade: 0, descricao: "Banner em lona fosca.", criadoEm: Timestamp.now() },
                        { nome: "Cartão de Visita Couchê 300g (Milheiro)", tipoPreco: "unidade", precoUnidade: 120.00, precoMetro: 0, descricao: "Milheiro de cartões.", criadoEm: Timestamp.now() },
                        { nome: "Adesivo Vinil Recorte", tipoPreco: "metro", precoMetro: 70.00, precoUnidade: 0, descricao: "Adesivo com recorte.", criadoEm: Timestamp.now() }
                    ];
                    const batchProdutos = writeBatch(db);
                    produtosAmostra.forEach(produto => {
                        const docRef = doc(collection(db, produtosPath));
                        batchProdutos.set(docRef, produto);
                    });
                    await batchProdutos.commit();
                    console.log("Produtos de amostra (compartilhados) criados.");
                }
                console.log("Verificação/criação de dados iniciais (compartilhados) concluída.");

            } catch (error) {
                console.error("Erro em criarDadosIniciaisSeNaoExistirem:", error);
                // Não mostrar alerta aqui para não interromper o fluxo se for um erro não crítico na criação de dados de exemplo
            }
        }
        
        // Função para carregar funcionários para cache e UI
        async function carregarFuncionarios() {
            if (!auth.currentUser) { console.warn("carregarFuncionarios: Usuário Firebase não autenticado."); return; }
            // Usa caminho GLOBAL para funcionários
            const funcionariosPath = `artifacts/${shopInstanceAppId}/funcionarios`;
            try {
                const snapshot = await getDocs(collection(db, funcionariosPath));
                funcionariosCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log("Funcionários carregados para o cache (compartilhados):", funcionariosCache);
                popularSelectVendedores(); 
                renderizarListaFuncionarios();
            } catch (error) {
                console.error("Erro ao carregar funcionários (compartilhados):", error);
                // Poderia exibir uma mensagem na UI se apropriado
            }
        }
        
        // Renderiza a lista de funcionários na seção de cadastro
        function renderizarListaFuncionarios() {
            const listaCadFuncEl = document.getElementById('listaFuncionariosCadSec'); // ID da lista na seção de cadastro
            if (!listaCadFuncEl) {
                console.warn("Elemento #listaFuncionariosCadSec para renderizar funcionários não encontrado.");
                return;
            }
            
            listaCadFuncEl.innerHTML = ''; 
            if (funcionariosCache.length === 0) {
                listaCadFuncEl.innerHTML = '<p class="text-[var(--color-text-muted)] text-sm">Nenhum funcionário registado.</p>';
                return;
            }

            funcionariosCache.forEach(func => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-list-display flex justify-between items-center';
                itemDiv.innerHTML = `
                    <div>
                        <strong>${func.nome || 'Nome não definido'}</strong> (${func.cargo || 'Cargo não definido'})
                        <div class="meta">Código: ${func.codigoAcesso || 'N/D'}</div>
                    </div>
                    <div class="space-x-2">
                        <button title="Editar Código" class="btn-icon-action" onclick="abrirModalEditarCodigoFuncionario('${func.id}', '${func.nome || ''}', '${func.codigoAcesso || ''}')"><i class="fas fa-key"></i></button>
                        <button title="Excluir" class="btn-icon-action btn-icon-action-danger" onclick="confirmarExclusaoFuncionario('${func.id}', '${func.nome || ''}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                listaCadFuncEl.appendChild(itemDiv);
            });
        }
        // Abre o modal para editar o código de acesso de um funcionário
        window.abrirModalEditarCodigoFuncionario = (id, nome, codigoAtual) => { 
            document.getElementById('funcionarioIdParaEditarCodigo').value = id;
            document.getElementById('nomeFuncionarioParaEditarCodigo').textContent = `Funcionário: ${nome}`;
            document.getElementById('novoCodigoAcesso').value = codigoAtual;
            const modalOverlay = document.getElementById('modalEditarCodigoFuncionario');
            const modalContent = modalOverlay.querySelector('.modal-content-wrapper');
            modalOverlay.classList.remove('hidden');
            setTimeout(() => { // Para permitir a transição de opacidade
                modalOverlay.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
            }, 10);
        };
        // Fecha o modal de edição de código
        window.fecharModalEditarCodigoFuncionario = () => {
            const modalOverlay = document.getElementById('modalEditarCodigoFuncionario');
            const modalContent = modalOverlay.querySelector('.modal-content-wrapper');
            modalOverlay.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            setTimeout(() => {
                 modalOverlay.classList.add('hidden');
            }, 200); // Tempo da transição
        };
        // Salva o novo código de acesso do funcionário
        document.getElementById('formEditarCodigoFuncionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser || loggedInUserRole !== 'admin') {
                exibirMensagemUI(document.getElementById('modalEditarCodigoFuncionario').querySelector('.modal-body-content'), "Apenas administradores podem alterar códigos.", 'error'); // Exibe msg no modal
                return;
            }
            const funcId = document.getElementById('funcionarioIdParaEditarCodigo').value;
            const novoCodigo = document.getElementById('novoCodigoAcesso').value.trim();
            if (!funcId || !novoCodigo) {
                exibirMensagemUI(document.getElementById('modalEditarCodigoFuncionario').querySelector('.modal-body-content'), 'ID do funcionário ou novo código ausente.', 'warning');
                return;
            }
            try {
                // Caminho GLOBAL para funcionários
                const funcRef = doc(db, `artifacts/${shopInstanceAppId}/funcionarios`, funcId);
                await updateDoc(funcRef, { codigoAcesso: novoCodigo });
                showMessageModal('Sucesso!', 'Código de acesso atualizado com sucesso.', 'success');
                await carregarFuncionarios(); // Recarrega e re-renderiza a lista
                fecharModalEditarCodigoFuncionario();
            } catch (error) {
                console.error("Erro ao atualizar código de acesso:", error);
                exibirMensagemUI(document.getElementById('modalEditarCodigoFuncionario').querySelector('.modal-body-content'), 'Erro ao atualizar código. Tente novamente.', 'error');
            }
        });


        // Atualiza as métricas do dashboard (ainda com simulação, mas usando caches quando possível)
        function atualizarMetricasDashboard() {
            const metricPedidosHojeEl = document.getElementById('metricPedidosHoje');
            const metricPedidosPendentesEl = document.getElementById('metricPedidosPendentes');
            const metricFaturamentoMesEl = document.getElementById('metricFaturamentoMes');
            const metricTotalClientesEl = document.getElementById('metricTotalClientes');
            
            if (!metricPedidosHojeEl || !metricPedidosPendentesEl || !metricFaturamentoMesEl || !metricTotalClientesEl) { 
                console.warn("Elementos de métrica do dashboard não encontrados.");
                return;
            }
            
            // Atualiza total de clientes baseado no cache
            metricTotalClientesEl.textContent = clientesCache.length;

            // Lógica para calcular outras métricas a partir de `todosOsPedidosCache`
            if (todosOsPedidosCache.length === 0) {
                metricPedidosHojeEl.textContent = '0';
                metricPedidosPendentesEl.textContent = '0';
                metricFaturamentoMesEl.textContent = 'R$ 0,00';
                return;
            }

            const hoje = new Date();
            const diaHoje = hoje.getDate();
            const mesHoje = hoje.getMonth();
            const anoHoje = hoje.getFullYear();
            const inicioMes = new Date(anoHoje, mesHoje, 1);

            let pedidosHoje = 0;
            let pedidosPendentes = 0;
            let faturamentoMes = 0;
            
            todosOsPedidosCache.forEach(pedido => {
                if (!pedido.dataPedido || typeof pedido.dataPedido.toDate !== 'function') {
                    console.warn("Pedido com dataPedido inválida no dashboard:", pedido);
                    return; 
                }
                const dataPedido = pedido.dataPedido.toDate(); 
                if (dataPedido.getDate() === diaHoje && dataPedido.getMonth() === mesHoje && dataPedido.getFullYear() === anoHoje) { pedidosHoje++; }
                if (pedido.status !== 'Entregue' && pedido.status !== 'Cancelado') { pedidosPendentes++; }
                if (dataPedido >= inicioMes && pedido.status !== 'Cancelado') { faturamentoMes += pedido.valorTotal || 0; }
            });

            metricPedidosHojeEl.textContent = pedidosHoje;
            metricPedidosPendentesEl.textContent = pedidosPendentes;
            metricFaturamentoMesEl.textContent = `R$ ${faturamentoMes.toFixed(2).replace('.', ',')}`;
        }

        // Carrega os últimos pedidos para o dashboard (usando cache)
        // MODIFICADO PARA NÃO USAR DADOS FIXOS
        function carregarUltimosPedidosDashboard() {
            const tbody = document.getElementById('ultimosPedidosTableBody');
            if (!tbody) return;
            tbody.innerHTML = ''; // Limpa a tabela
            
            // Ordena os pedidos do cache por data (mais recentes primeiro)
            const pedidosOrdenadosDashboard = [...todosOsPedidosCache].sort((a, b) => (b.dataPedido?.toMillis() || 0) - (a.dataPedido?.toMillis() || 0));
            const pedsParaDashboard = pedidosOrdenadosDashboard.slice(0,5); // Pega os 5 mais recentes

            if (pedsParaDashboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-[var(--dashboard-text-muted)] py-10">Nenhum pedido recente.</td></tr>';
                return;
            }
            pedsParaDashboard.forEach(p=>{ // p é um pedido do cache
                const tr = document.createElement('tr');
                const pedidoParaModal = JSON.stringify(p); // Para passar ao modal
                const dataPedidoFormatada = p.dataPedido?.toDate ? p.dataPedido.toDate().toLocaleDateString('pt-BR') : 'N/A';

                tr.innerHTML = `
                    <td class="text-[var(--dashboard-text-value)] font-medium">${p.numeroPedido || p.id.substring(0,6)}</td>
                    <td class="text-[var(--dashboard-text-muted)]">${p.clienteNome || 'Cliente não informado'}</td>
                    <td class="text-[var(--dashboard-text-muted)]">${dataPedidoFormatada}</td>
                    <td class="text-[var(--dashboard-text-value)] font-medium">R$ ${parseFloat(p.valorTotal || 0).toFixed(2).replace('.',',')}</td>
                    <td>${getStatusBadgeSimpleHTML(p.status)}</td>
                    <td class="text-xs space-x-1 whitespace-nowrap">
                        <button onclick="abrirDetalhesPedidoNovaGuia(JSON.parse(decodeURIComponent('${encodeURIComponent(pedidoParaModal)}')))" class="btn-icon-action-dark-theme" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="prepararEdicaoPedido(JSON.parse(decodeURIComponent('${encodeURIComponent(pedidoParaModal)}')))" class="btn-icon-action-dark-theme" title="Editar Pedido">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="excluirPedido('${p.id}')" class="btn-icon-action-dark-theme text-red-400 hover:text-red-300" title="Excluir Pedido">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- CONTROLES DE UI E NAVEGAÇÃO ---
        // (As funções mostrarSecao, resetFormNovoPedido, modais, etc., permanecem em sua maioria como estavam,
        // apenas com pequenas correções ou melhorias de robustez conforme a versão v6)

        // Exemplo de como a função `mostrarSecao` deve ser (simplificada para foco)
        window.mostrarSecao = (idSecao, isMenuLink = false) => {
            // ... (lógica para esconder outras seções e mostrar a targetSection) ...
            console.log(`Navegando para seção: ${idSecao}`);
            const sections = document.querySelectorAll('#mainContentArea > section');
            sections.forEach(section => section.classList.add('hidden'));
            
            const targetSection = document.getElementById(idSecao);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                activeSectionId = idSecao;
                document.getElementById('mainContentArea').scrollTop = 0;
                if (isMenuLink) {
                    setActiveMenuLink(idSecao);
                    const exoMenuEl = document.querySelector('ul.exo-menu'); // Corrigido seletor
                    if (window.innerWidth < 768 && exoMenuEl && exoMenuEl.classList.contains('display')) {
                        exoMenuEl.classList.remove('display');
                    }
                }
            } else {
                console.error(`Seção ${idSecao} não encontrada! Mostrando telaInicial como fallback.`);
                document.getElementById('telaInicial').classList.remove('hidden'); 
                setActiveMenuLink('telaInicial');
            }

            // Lógica para carregar dados ou resetar forms específicos da seção
            if (idSecao === 'novoPedido' && !editingOrderId) {
                resetFormNovoPedido();
            }
            if (idSecao === 'cadastrarFuncionario') {
                carregarFuncionarios(); 
            }
            if (idSecao === 'telaInicial') {
                 atualizarDashboard();
            }
            if (idSecao === 'visualizarPedidos') {
                renderizarListaCompletaPedidos();
            }
             if (idSecao === 'cadastrarCliente') {
                document.getElementById('pesquisaClienteInput').value = ''; 
                renderizarListaClientes(); 
                document.getElementById('detalhesClienteSelecionado').classList.add('hidden'); 
                clienteSelecionadoId = null;
            }
            if (idSecao === 'cadastrarProduto') {
                document.getElementById('formCadastrarProduto').reset();
                togglePrecoFields();
                carregarProdutos(); // Para mostrar a lista
            }
             if (idSecao === 'cadastrarFornecedor') {
                document.getElementById('formCadastrarFornecedor').reset();
                carregarFornecedores(); // Para mostrar a lista
            }
            ajustarPaddingBody(); // Garante que o padding está correto após mostrar a seção
        };

        // Demais funções de UI, CRUD e auxiliares (como estaban na v6)
        // ... (resetFormNovoPedido, modais, togglePrecoFields, handleImagemFilePedido, etc.)
        // ... (carregarClientes, carregarProdutos, carregarFornecedores, renderizarListas, CRUDs)

        // Inicialização do menu mobile
        const toggleMenuButton = document.querySelector('a.toggle-menu');
        const exoMenu = document.querySelector('ul.exo-menu');
        if (toggleMenuButton && exoMenu) {
            toggleMenuButton.addEventListener('click', function(e){
                e.preventDefault();
                exoMenu.classList.toggle('display');
            });
        }
        document.addEventListener('click', function(event) {
            if (exoMenu && toggleMenuButton) { 
                const isClickInsideMenu = exoMenu.contains(event.target);
                const isClickOnToggleButton = toggleMenuButton.contains(event.target);
                if (!isClickInsideMenu && !isClickOnToggleButton && exoMenu.classList.contains('display')) {
                    exoMenu.classList.remove('display');
                }
            }
        });
        
        // Ajusta o padding do body após o DOM estar carregado e o menu (se visível) ter sua altura calculada.
        document.addEventListener('DOMContentLoaded', () => {
            // A lógica de mostrar/esconder telas e ajustar o padding é tratada principalmente pelo onAuthStateChanged
            // e pela função mostrarSecao. Este é um fallback ou ajuste inicial.
            ajustarPaddingBody(); 
        });

    </script>
</body>
</html>